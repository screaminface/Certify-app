const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/certificateGenerator-DmGm2V6u.js","assets/vendor-misc-D39njv3e.js","assets/vendor-react-oVSxXMwJ.js","assets/vendor-dexie-sCRMG0Q-.js","assets/vendor-dates-qyqZJmaY.js","assets/vendor-uuid-P-OY1HC2.js","assets/vendor-icons-CWatr7yU.js","assets/vendor-supabase-DKUAFRPn.js"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,t=(t,s,a)=>((t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a)(t,"symbol"!=typeof s?s+"":s,a);import{r as s,j as a,R as r,a as n,c as i}from"./vendor-react-oVSxXMwJ.js";import{X as l,u as o}from"./vendor-dexie-sCRMG0Q-.js";import{p as c,f as d,i as u,a as m,s as p}from"./vendor-dates-qyqZJmaY.js";import{v as x}from"./vendor-uuid-P-OY1HC2.js";import{I as h,C as b,T as g,A as f,a as v,b as N,c as w,U as j,X as y,H as S,M as k,d as D,e as C,L as E,S as A,D as O,f as q,g as P,E as T,h as L,G as M,i as I,j as $,k as W,P as G,B as R,l as F,R as B,m as z,F as _,n as U,o as V,p as Y,q as H}from"./vendor-icons-CWatr7yU.js";import{c as K}from"./vendor-supabase-DKUAFRPn.js";import"./vendor-misc-D39njv3e.js";function X(e){const t=function(e){const t=new Date(e),s=t.getDay();if(1===s)return t;const a=0===s?1:8-s;return t.setDate(t.getDate()+a),t}(new Date(e)),s=new Date(t);return s.setDate(s.getDate()+7),{courseStartDate:t.toISOString().split("T")[0],courseEndDate:s.toISOString().split("T")[0]}}!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();let J=!1;function Z(e){J=e}function Q(){if(J){const e=new Error("Read-only mode is enabled. Subscription access has expired.");throw e.name="APP_READ_ONLY_ERROR",e}}const ee=new class extends l{constructor(){super("CourseManagementDB"),t(this,"groups"),t(this,"participants"),t(this,"settings"),t(this,"yearlyArchives"),this.version(1).stores({groups:"id, groupNumber, courseStartDate",participants:"id, groupNumber, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}),this.version(2).stores({groups:"id, groupNumber, courseStartDate",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}).upgrade(e=>e.table("participants").toCollection().modify(e=>{e.autoGroup=e.groupNumber,e.manualGroup=null})),this.version(3).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}).upgrade(e=>{const t=(new Date).toISOString();return e.table("groups").toCollection().modify(e=>{e.status=1===e.groupNumber?"active":"planned",e.createdAt=t,e.updatedAt=t})}),this.version(4).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}).upgrade(e=>{const t=(new Date).toISOString();e.table("participants").toCollection().modify(e=>{e.createdAt=e.createdAt||t,e.updatedAt=e.updatedAt||t,(e.completedComputed||!0===e.completedOverride)&&(e.completedAt=e.completedAt||t)}),e.table("groups").toCollection().modify(e=>{e.isLocked="completed"===e.status})}),this.version(5).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id",yearlyArchives:"id, year"}),this.version(6).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate, egn",settings:"id",yearlyArchives:"id, year"}).upgrade(e=>e.table("participants").toCollection().modify(e=>{e.egn=e.egn||"",e.birthPlace=e.birthPlace||"",e.citizenship=e.citizenship||"българско"})),this.version(7).stores({groups:"id, courseStartDate, status, groupNumber",participants:"id, courseStartDate, uniqueNumber, companyName, personName, egn",settings:"id",yearlyArchives:"id, year"}).upgrade(async e=>{await e.table("participants").toCollection().modify(e=>{delete e.groupNumber,delete e.autoGroup,delete e.manualGroup}),await e.table("groups").toCollection().modify(e=>{"planned"===e.status&&(e.groupNumber=null)})}),[this.groups,this.participants,this.settings,this.yearlyArchives].forEach(e=>{e.hook("creating",()=>{Q()}),e.hook("updating",()=>{Q()}),e.hook("deleting",()=>{Q()})})}};function te(e,t){return`${e.toString().padStart(4,"0")}-${t}`}function se(e){const t=e.match(/^(\d{4})-(\d+)$/);return t?{prefix:parseInt(t[1],10),seq:parseInt(t[2],10)}:null}async function ae(e=!1){const t=await ee.participants.toArray();let s=null;for(const r of t){if(!r.uniqueNumber)continue;const e=se(r.uniqueNumber);e&&(s?(e.prefix>s.prefix||e.prefix===s.prefix&&e.seq>s.seq)&&(s=e):s=e)}const a=await ee.yearlyArchives.toArray();for(const r of a)for(const e of r.participants){if(!e.uniqueNumber)continue;const t=se(e.uniqueNumber);t&&(s?(t.prefix>s.prefix||t.prefix===s.prefix&&t.seq>s.seq)&&(s=t):s=t)}if(!e){const e=await ee.settings.get(1);if(e){const t={prefix:e.lastUniquePrefix,seq:e.lastUniqueSeq};s?(t.prefix>s.prefix||t.prefix===s.prefix&&t.seq>s.seq)&&(s=t):s=t}}return s}async function re(){const e=await ee.settings.get(1);if(!e)throw new Error("Settings not initialized");let t=e.lastUniquePrefix,s=e.lastUniqueSeq;const a=await ae();a&&(a.prefix>t?(t=a.prefix,s=a.seq):a.prefix===t&&a.seq>s&&(s=a.seq));return te(t+1,s+1)}async function ne(e){const t=await ee.groups.get(e);if(!t)return;if("active"!==t.status)return;const s=(await ee.participants.where("courseStartDate").equals(t.courseStartDate).toArray()).filter(e=>!e.uniqueNumber);if(0===s.length)return;s.sort((e,t)=>{const s=new Date(e.createdAt||0).getTime(),a=new Date(t.createdAt||0).getTime();return s!==a?s-a:(e.id||"").localeCompare(t.id||"")});const a=await ee.settings.get(1);if(!a)throw new Error("Settings not initialized");let r=a.lastUniquePrefix,n=a.lastUniqueSeq;const i=await ae();i&&(i.prefix>r?(r=i.prefix,n=i.seq):i.prefix===r&&i.seq>n&&(n=i.seq));const l=[];for(const o of s){r++,n++;const e=te(r,n);l.push({id:o.id,uniqueNumber:e})}for(const o of l)await ee.participants.update(o.id,{uniqueNumber:o.uniqueNumber});await ee.settings.update(1,{lastUniquePrefix:r,lastUniqueSeq:n})}async function ie(e){const t=se(e);if(!t)return;const{prefix:s}=t,a=await ee.participants.filter(e=>!!e.uniqueNumber).toArray(),r=[];for(const i of a){const e=se(i.uniqueNumber);if(e&&e.prefix>s){const t=e.prefix-1,s=e.seq-1,a=te(t,s);r.push({id:i.id,newNum:a,newPrefix:t,newSeq:s})}}for(const i of r)await ee.participants.update(i.id,{uniqueNumber:i.newNum});const n=await ae();n&&await ee.settings.update(1,{lastUniquePrefix:n.prefix,lastUniqueSeq:n.seq})}async function le(e,t){const s=ee.participants.where("uniqueNumber").equals(e),a=await s.toArray();if(t){if(a.length>0&&(a.length>1||a[0].id!==t))return!1}else if(a.length>0)return!1;const r=await ee.yearlyArchives.toArray();for(const n of r)for(const s of n.participants)if(s.uniqueNumber===e){if(t&&s.id===t)continue;return!1}return!0}async function oe(){const e=await ee.participants.toArray(),t=await ee.yearlyArchives.toArray(),s=[...e];for(const n of t)s.push(...n.participants);const a=s.filter(e=>e.uniqueNumber).map(e=>se(e.uniqueNumber)).filter(e=>null!==e).sort((e,t)=>e.prefix!==t.prefix?e.prefix-t.prefix:e.seq-t.seq);if(0===a.length)return null;for(let n=0;n<a.length-1;n++){const e=a[n];if(a[n+1].prefix!==e.prefix+1)return te(e.prefix+1,e.seq+1)}const r=await ee.settings.get(1);if(r&&a.length>0){const e=a[a.length-1];if(r.lastUniquePrefix>e.prefix)return te(e.prefix+1,e.seq+1)}return null}async function ce(e){const t=await ee.participants.where("courseStartDate").equals(e).toArray();for(const a of t)a.uniqueNumber&&await ee.participants.update(a.id,{uniqueNumber:""});const s=await ae(!0);s&&await ee.settings.update(1,{lastUniquePrefix:s.prefix,lastUniqueSeq:s.seq})}function de(e,t){const s=c(e),a=c(t);if(!u(s,a)&&!m(s,a))return!1;return s>=p(a)}function ue(e){try{const t=c(e);return d(t,"dd.MM.yyyy")}catch{return e}}(async function(){try{if(0===await ee.settings.count())await ee.settings.add({id:1,lastUniquePrefix:3533,lastUniqueSeq:0,lastResetYear:null});else{const e=await ee.settings.get(1);e&&e.lastUniquePrefix<=3531&&await ee.settings.update(1,{lastUniquePrefix:3533,lastUniqueSeq:0})}}catch(e){}})().catch(e=>{});const me="Медицинското трябва да е в рамките на 6 месеца преди началото на курса.";async function pe(){return ee.groups.where("status").equals("active").first()}async function xe(e){const t=await ee.groups.where("courseStartDate").equals(e).first();t&&await ne(t.id)}async function he(e){const{courseStartDate:t}=X(e),s=await ee.groups.toArray(),a=s.find(e=>"active"===e.status),r=s.filter(e=>"planned"===e.status).sort((e,t)=>e.courseStartDate.localeCompare(t.courseStartDate));if(a&&t<=a.courseStartDate&&de(e,a.courseStartDate))return{group:a,shouldCreate:!1};const n=s.find(e=>e.courseStartDate===t);if(n&&"completed"===n.status){const s=[];a&&s.push(a),s.push(...r),s.sort((e,t)=>e.courseStartDate.localeCompare(t.courseStartDate));const i=s.find(s=>!(s.courseStartDate<t)&&de(e,s.courseStartDate));return i?{group:i,shouldCreate:!1}:{group:n,shouldCreate:!1}}return n?{group:n,shouldCreate:!1}:a&&t<a.courseStartDate?{group:{id:"stub_past",status:"completed",courseStartDate:t,courseEndDate:"",groupNumber:-1,createdAt:"",updatedAt:"",isLocked:!0},shouldCreate:!1}:{group:null,shouldCreate:!0,createsForDate:t}}async function be(e,t="planned"){const s=await ee.groups.where("courseStartDate").equals(e).first();if(s)return s.status,s;let a=null;"active"===t&&(a=null);const r=new Date(e);r.setDate(r.getDate()+7);const n=(new Date).toISOString(),i={id:x(),groupNumber:a,courseStartDate:e,courseEndDate:r.toISOString().split("T")[0],status:t,createdAt:n,updatedAt:n,isLocked:!1};return await ee.groups.add(i),i}async function ge(){const e=await ee.participants.toArray(),t=await ee.groups.toArray(),s=t.find(e=>"active"===e.status);if(s&&(null===s.groupNumber||void 0===s.groupNumber)){const e=new Set(t.map(e=>e.groupNumber).filter(e=>null!=e&&e>0));let a=1;for(;e.has(a);)a++;await ee.groups.update(s.id,{groupNumber:a,updatedAt:(new Date).toISOString()})}const a=t.filter(e=>"active"===e.status);for(const h of a)await xe(h.courseStartDate);for(const h of t){const t=new Date(h.courseStartDate);if(1!==t.getDay()){const s=t.getDay(),a=0===s?1:8-s,r=new Date(t);r.setDate(t.getDate()+a);const n=r.toISOString().split("T")[0];await ee.groups.update(h.id,{courseStartDate:n,courseEndDate:new Date(r.getTime()+6048e5).toISOString().split("T")[0]});const i=e.filter(e=>e.courseStartDate===h.courseStartDate);for(const e of i)await ee.participants.update(e.id,{courseStartDate:n,courseEndDate:new Date(r.getTime()+6048e5).toISOString().split("T")[0]})}}const r=new Set;let n;if(e.forEach(e=>r.add(e.courseStartDate)),s)n=new Date(s.courseStartDate);else{const e=new Date,t=e.getDay(),s=0===t?1:1===t?0:8-t;n=new Date(e),n.setHours(12,0,0,0),n.setDate(e.getDate()+s)}const i=new Date(n);i.setDate(i.getDate()+7);const l=new Date(n);l.setDate(l.getDate()+14),r.add(i.toISOString().split("T")[0]),r.add(l.toISOString().split("T")[0]);const o=new Set(t.map(e=>e.courseStartDate));for(const h of r)o.has(h)||await be(h,"planned");const c=await ee.groups.toArray(),d=new Map;e.forEach(e=>{d.set(e.courseStartDate,(d.get(e.courseStartDate)||0)+1)});const u=new Map;c.forEach(e=>{const t=u.get(e.courseStartDate)||[];t.push(e),u.set(e.courseStartDate,t)});for(const[h,b]of u)if(b.length>1){const e=b.sort((e,t)=>{const s=e=>"completed"===e.status?3:"active"===e.status?2:1,a=s(e),r=s(t);return a!==r?r-a:0}),t=(e[0],e.slice(1));for(const s of t)await ee.groups.delete(s.id)}const m=await ee.groups.toArray(),p=m.find(e=>"active"===e.status);if(p){const e=m.filter(e=>"planned"===e.status&&e.courseStartDate<p.courseStartDate&&0===(d.get(e.courseStartDate)||0));for(const t of e)await ee.groups.delete(t.id)}const x=(await ee.groups.toArray()).filter(e=>"planned"===e.status);if(x.length>2){const e=x.filter(e=>0===(d.get(e.courseStartDate)||0));let t=x.length;e.sort((e,t)=>t.courseStartDate.localeCompare(e.courseStartDate));for(const s of e){if(t<=2)break;await ee.groups.delete(s.id),t--}}}function fe(e){return!!e&&("completed"===e.status&&e.isLocked)}async function ve(e,t=!1){const s=await ee.groups.get(e);if(!s)throw new Error("Group not found");const a=(new Date).toISOString();if(t){const e=await pe();e&&(await ee.groups.update(e.id,{status:"planned",updatedAt:a,activatedAt:void 0,groupNumber:null}),await ce(e.courseStartDate))}let r=s.groupNumber;if("planned"===s.status&&null===r){const e=await ee.groups.toArray(),t=new Set(e.map(e=>e.groupNumber).filter(e=>null!=e&&e>0));let s=1;for(;t.has(s);)s++;r=s}return await ee.groups.update(e,{groupNumber:r,status:"active",activatedAt:a,updatedAt:a,isLocked:!1}),await ne(e),{success:!0}}async function Ne(e){return ee.participants.get(e)}async function we(e,t){await ee.participants.update(e,t)}async function je(){return(await ee.groups.toArray()).sort((e,t)=>e.courseStartDate.localeCompare(t.courseStartDate))}async function ye(e){return ee.groups.where("courseStartDate").equals(e).first()}function Se(){return{participants:o(()=>async function(){return ee.participants.orderBy("courseStartDate").toArray()}()),addParticipant:async e=>{const{courseStartDate:t}=X(e.medicalDate);if(!de(e.medicalDate,t))throw new Error(me);const{group:s,shouldCreate:a,createsForDate:r}=await he(e.medicalDate),n=s?s.courseStartDate:r||t,i=(()=>{const e=new Date(n);return e.setDate(e.getDate()+7),e.toISOString().split("T")[0]})();if(!de(e.medicalDate,n))throw new Error(me);const l=await async function(e){return ee.groups.where("courseStartDate").equals(e).toArray()}(n);if(l.some(e=>"completed"===e.status))throw new Error("Не може да добавяте нови участници към приключила група (периодът е архивиран).");if("completed"===(null==s?void 0:s.status))throw new Error("Не може да добавяте нови участници към приключила група.");if(a){const e=await pe()?"planned":"active";await be(n,e)}let o;if(e.uniqueNumber){if(!(await le(e.uniqueNumber)))throw new Error("Unique number already exists");o=e.uniqueNumber}else o="active"===(null==s?void 0:s.status)?await re():"";const c=(new Date).toISOString(),d={id:x(),companyName:e.companyName,personName:e.personName,egn:e.egn||"",birthPlace:e.birthPlace||"",citizenship:e.citizenship||"българско",medicalDate:e.medicalDate,courseStartDate:n,courseEndDate:i,uniqueNumber:o,sent:!1,documents:!1,handedOver:!1,paid:!1,completedOverride:null,completedComputed:!1,createdAt:c,updatedAt:c};return await async function(e){await ee.participants.add(e)}(d),await ge(),d},updateParticipant:async(e,t)=>{const s=await Ne(e);if(!s)throw new Error("Participant not found");if(fe(await ye(s.courseStartDate)))throw new Error("Не може да редактирате участник от заключена група. Моля отключете групата първо от Tools.");const a={};let r=null;if(void 0!==t.companyName&&(a.companyName=t.companyName),void 0!==t.personName&&(a.personName=t.personName),void 0!==t.egn&&(a.egn=t.egn),void 0!==t.birthPlace&&(a.birthPlace=t.birthPlace),void 0!==t.citizenship&&(a.citizenship=t.citizenship),t.medicalDate&&t.medicalDate!==s.medicalDate){const{group:e,shouldCreate:n,createsForDate:i}=await he(t.medicalDate),{courseStartDate:l}=X(t.medicalDate),o=e?e.courseStartDate:i||l,c=(()=>{const e=new Date(o);return e.setDate(e.getDate()+7),e.toISOString().split("T")[0]})();if(!de(t.medicalDate,o))throw new Error(me);if("completed"===(null==e?void 0:e.status))throw new Error("Медицинският преглед отговаря на приключила група (периодът е архивиран).");if(n){const e=await pe()?"planned":"active";await be(o,e)}a.medicalDate=t.medicalDate,a.courseStartDate=o,a.courseEndDate=c;const d=await ye(s.courseStartDate),u=(null==d?void 0:d.status)||"planned",m=(null==e?void 0:e.status)||"planned";if("active"===m&&"active"!==u){const e=await oe();a.uniqueNumber=e||await re()}else if("active"===u&&"planned"===m){const e=s.uniqueNumber;a.uniqueNumber="",e&&(r=e)}}if(t.uniqueNumber&&t.uniqueNumber!==s.uniqueNumber){if(!(await le(t.uniqueNumber,e)))throw new Error("Unique number already exists");a.uniqueNumber=t.uniqueNumber}void 0!==t.sent&&(a.sent=t.sent),void 0!==t.documents&&(a.documents=t.documents),void 0!==t.handedOver&&(a.handedOver=t.handedOver),void 0!==t.paid&&(a.paid=t.paid);const n=void 0!==a.sent?a.sent:s.sent,i=void 0!==a.documents?a.documents:s.documents,l=void 0!==a.handedOver?a.handedOver:s.handedOver,o=void 0!==a.paid?a.paid:s.paid,c=n&&i&&l&&o;a.completedComputed=c,a.updatedAt=(new Date).toISOString();const d=null!==s.completedOverride?s.completedOverride:s.completedComputed,u=void 0!==a.completedOverride&&null!==a.completedOverride?a.completedOverride:null===a.completedOverride?c:null!==s.completedOverride?s.completedOverride:c;!d&&u&&(a.completedAt=(new Date).toISOString()),await we(e,a),r&&await ie(r),await ge()},deleteParticipant:async e=>{const t=await Ne(e);await async function(e){await ee.participants.delete(e)}(e),t&&t.uniqueNumber&&await ie(t.uniqueNumber),await ge()},resetCompletedOverride:async e=>{await we(e,{completedOverride:null})},getParticipant:async e=>Ne(e)}}function ke(){return{groups:o(async()=>je()),getGroup:async e=>async function(e){return ee.groups.where("groupNumber").equals(e).first()}(e),getGroupsWithCounts:async()=>{const e=await je();return await Promise.all(e.map(async e=>{const t=await async function(e){return ee.participants.where("courseStartDate").equals(e).count()}(e.courseStartDate);return{...e,participantCount:t}}))}}}const De="groups-collapsed-active",Ce="groups-collapsed-planned",Ee="groups-collapsed-completed";const Ae={},Oe=function(e,t,s){let a=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const e=document.querySelector("meta[property=csp-nonce]"),s=(null==e?void 0:e.nonce)||(null==e?void 0:e.getAttribute("nonce"));a=Promise.allSettled(t.map(e=>{if((e=function(e){return"/Certify-app/"+e}(e))in Ae)return;Ae[e]=!0;const t=e.endsWith(".css"),a=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${a}`))return;const r=document.createElement("link");return r.rel=t?"stylesheet":"modulepreload",t||(r.as="script"),r.crossOrigin="",r.href=e,s&&r.setAttribute("nonce",s),document.head.appendChild(r),t?new Promise((t,s)=>{r.addEventListener("load",t),r.addEventListener("error",()=>s(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function r(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return a.then(t=>{for(const e of t||[])"rejected"===e.status&&r(e.reason);return e().catch(r)})},qe=s.createContext(void 0),Pe=({children:e})=>{const[t,r]=s.useState(()=>{var e;const t=localStorage.getItem("spi.language");if("bg"===t||"en"===t)return t;return(navigator.language||(null==(e=navigator.languages)?void 0:e[0])||"en").toLowerCase().startsWith("bg")?"bg":"en"}),[n,i]=s.useState({});s.useEffect(()=>{(async()=>{const e=await((e,t,s)=>{const a=e[t];return a?"function"==typeof a?a():Promise.resolve(a):new Promise((e,a)=>{("function"==typeof queueMicrotask?queueMicrotask:setTimeout)(a.bind(null,new Error("Unknown variable dynamic import: "+t+(t.split("/").length!==s?". Note that variables only represent file names one level deep.":""))))})})(Object.assign({"../locales/bg.ts":()=>Oe(()=>import("./bg-2-bdpX8K.js"),[]),"../locales/en.ts":()=>Oe(()=>import("./en-BmU_mF-p.js"),[])}),`../locales/${t}.ts`,3);i(e.default)})()},[t]);return a.jsx(qe.Provider,{value:{language:t,setLanguage:e=>{r(e),localStorage.setItem("spi.language",e)},t:(e,t)=>{let s=n[e]||e;return t&&Object.entries(t).forEach(([e,t])=>{s=s.replace(`{${e}}`,t)}),s}},children:e})},Te=()=>{const e=s.useContext(qe);if(!e)throw new Error("useLanguage must be used within LanguageProvider");return e},Le=({isOpen:e,onClose:t,onConfirm:r,title:n,message:i,confirmText:l="Confirm",cancelText:o="Cancel",variant:c="info"})=>{if(s.useEffect(()=>{const s=e=>{"Escape"===e.key&&t()};if(e)return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[e,t]),!e)return null;return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 transition-opacity",onClick:t}),a.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden animate-scale-up transform transition-all",children:[a.jsx("div",{className:"p-6",children:a.jsxs("div",{className:"flex items-start gap-4",children:[a.jsx("div",{className:`p-3 rounded-full flex-shrink-0 ${(()=>{switch(c){case"danger":return"bg-red-50 text-red-900 border-red-100";case"warning":return"bg-amber-50 text-amber-900 border-amber-100";case"success":return"bg-emerald-50 text-emerald-900 border-emerald-100";default:return"bg-blue-50 text-blue-900 border-blue-100"}})()} bg-opacity-50`,children:(()=>{switch(c){case"danger":return a.jsx(g,{className:"w-6 h-6 text-red-600"});case"warning":return a.jsx(g,{className:"w-6 h-6 text-amber-600"});case"success":return a.jsx(b,{className:"w-6 h-6 text-emerald-600"});default:return a.jsx(h,{className:"w-6 h-6 text-blue-600"})}})()}),a.jsxs("div",{className:"flex-1 pt-1",children:[a.jsx("h3",{className:"text-xl font-bold text-slate-900 mb-2 leading-none",children:n}),a.jsx("p",{className:"text-slate-600 leading-relaxed text-sm",children:i})]})]})}),a.jsxs("div",{className:"p-4 bg-slate-50 flex gap-3 justify-end border-t border-slate-100",children:[a.jsx("button",{onClick:t,className:"px-5 py-2.5 bg-white text-slate-700 border border-slate-200 rounded-lg hover:bg-slate-50 hover:text-slate-900 font-medium transition-all duration-200 shadow-sm",children:o}),a.jsx("button",{onClick:()=>{r(),t()},className:`px-5 py-2.5 text-white rounded-lg font-medium shadow-md transition-all duration-200 transform hover:-translate-y-0.5 ${(()=>{switch(c){case"danger":return"bg-red-600 hover:bg-red-700 focus:ring-red-500";case"warning":return"bg-amber-600 hover:bg-amber-700 focus:ring-amber-500";case"success":return"bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500";default:return"bg-blue-600 hover:bg-blue-700 focus:ring-blue-500"}})()}`,children:l})]})]})})]})},Me={Egida:"bg-violet-50 text-violet-700 ring-1 ring-violet-200/50","D-Max":"bg-orange-50 text-orange-700 ring-1 ring-orange-200/50",Multiforce:"bg-cyan-50 text-cyan-700 ring-1 ring-cyan-200/50"},Ie=({companyName:e,className:t=""})=>{const s=Me[e]||"bg-slate-50 text-slate-600 ring-1 ring-slate-200/50";return a.jsx("span",{className:`inline-flex items-center px-2 py-0.5 text-xs rounded-full \n        font-medium tracking-normal transition-all duration-150 \n        hover:ring-2 hover:shadow-sm ${s} ${t}`,"aria-label":`Company: ${e||"Unknown"}`,children:e||"Няма компания"})};const $e=({selectedCount:e,selectedIds:t,onClearSelection:r,onActionComplete:n})=>{const{t:i}=Te(),{bulkSetFlag:l}={bulkSetFlag:async(e,t,s)=>{const a={success:0,failed:0,errors:[]},r=(new Date).toISOString();for(const i of e)try{const e=await Ne(i);if(!e){a.failed++,a.errors.push(`Participant ${i} not found`);continue}const n=await ye(e.courseStartDate);if(n&&"completed"===n.status&&n.isLocked){a.failed++,a.errors.push(`Participant ${e.personName} belongs to locked group (${n.courseStartDate})`);continue}const l={[t]:s,updatedAt:r},o="sent"===t?s:e.sent,c="documents"===t?s:e.documents,d="handedOver"===t?s:e.handedOver,u="paid"===t?s:e.paid,m=o&&c&&d&&u;l.completedComputed=m;const p=null!==e.completedOverride?e.completedOverride:e.completedComputed,x=null!==e.completedOverride?e.completedOverride:m;!p&&x&&(l.completedAt=r),await we(i,l),a.success++}catch(n){a.failed++,a.errors.push(`Failed to update ${i}: ${n.message}`)}return a},bulkSetCompleted:async e=>{const t={success:0,failed:0,errors:[]},s=(new Date).toISOString();for(const r of e)try{const e=await Ne(r);if(!e){t.failed++,t.errors.push(`Participant ${r} not found`);continue}const a=await ye(e.courseStartDate);if(a&&"completed"===a.status&&a.isLocked){t.failed++,t.errors.push(`Participant ${e.personName} belongs to locked group (${a.courseStartDate})`);continue}if(!(e.sent&&e.documents&&e.handedOver&&e.paid)){t.failed++,t.errors.push(`Participant ${e.personName} does not have all 4 flags set`);continue}const n={completedOverride:!0,updatedAt:s,completedAt:s};await we(r,n),t.success++}catch(a){t.failed++,t.errors.push(`Failed to update ${r}: ${a.message}`)}return t}},[o,c]=s.useState(!1),[d,u]=s.useState(!1),[m,p]=s.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}}),x=async(e,s)=>{c(!0);try{const a=await l(t,e,s);a.failed>0?alert(`${i("bulk.completed")}: ${a.success}\n${i("bulk.failed")}: ${a.failed}\n${a.errors.join("\n")}`):alert(`${i("bulk.success")}: ${a.success} ${i("bulk.updated")}`),n()}catch(a){alert(`${i("bulk.error")}: ${a.message}`)}finally{c(!1)}},h=()=>{p({isOpen:!0,title:i("bulk.confirmPaidTitle"),message:i("bulk.confirmPaidMessage"),onConfirm:async()=>{p({...m,isOpen:!1}),await x("paid",!0)}})};return 0===e?null:a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"hidden md:block sticky top-0 bg-blue-600 text-white shadow-lg z-20 mb-4 rounded-lg",children:a.jsxs("div",{className:"px-4 py-3 flex items-center justify-between gap-4",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("button",{onClick:r,className:"p-1 hover:bg-blue-700 rounded transition-colors","aria-label":"Clear selection",children:a.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),a.jsxs("span",{className:"font-semibold",children:[e," ",i("bulk.selected")]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("button",{onClick:()=>x("sent",!0),disabled:o,className:"px-3 py-1.5 bg-white text-blue-600 rounded text-sm font-medium hover:bg-blue-50 disabled:opacity-50 whitespace-nowrap",children:i("bulk.setSent")}),a.jsx("button",{onClick:()=>x("documents",!0),disabled:o,className:"px-3 py-1.5 bg-white text-blue-600 rounded text-sm font-medium hover:bg-blue-50 disabled:opacity-50 whitespace-nowrap",children:i("bulk.setDocuments")}),a.jsx("button",{onClick:()=>x("handedOver",!0),disabled:o,className:"px-3 py-1.5 bg-white text-blue-600 rounded text-sm font-medium hover:bg-blue-50 disabled:opacity-50 whitespace-nowrap",children:i("bulk.setHanded")}),a.jsx("button",{onClick:h,disabled:o,className:"px-3 py-1.5 bg-amber-100 text-amber-800 rounded text-sm font-medium hover:bg-amber-200 disabled:opacity-50 whitespace-nowrap",children:i("bulk.setPaid")}),a.jsx("div",{className:"w-px h-6 bg-blue-400"}),a.jsx("button",{onClick:()=>x("sent",!1),disabled:o,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:i("bulk.clearSent")}),a.jsx("button",{onClick:()=>x("documents",!1),disabled:o,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:i("bulk.clearDocuments")}),a.jsx("button",{onClick:()=>x("handedOver",!1),disabled:o,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:i("bulk.clearHanded")}),a.jsx("button",{onClick:()=>x("paid",!1),disabled:o,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:i("bulk.clearPaid")})]})]})}),a.jsxs("div",{className:"md:hidden fixed bottom-16 left-0 right-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-2xl z-20 rounded-t-2xl",style:{boxShadow:"0 -10px 25px -5px rgba(0, 0, 0, 0.3), 0 -8px 10px -6px rgba(0, 0, 0, 0.1)"},children:[a.jsxs("div",{className:"px-4 py-3 flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("button",{onClick:r,className:"p-1.5 hover:bg-white/20 rounded-full transition-all active:scale-95","aria-label":"Clear selection",children:a.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M6 18L18 6M6 6l12 12"})})}),a.jsxs("div",{className:"flex items-baseline gap-1.5",children:[a.jsx("span",{className:"text-xl font-bold",children:e}),a.jsx("span",{className:"text-sm font-medium opacity-90",children:i("bulk.selected")})]})]}),a.jsxs("button",{onClick:()=>u(!d),className:"px-4 py-2.5 bg-white text-blue-700 rounded-full font-semibold text-sm hover:bg-blue-50 active:scale-95 transition-all shadow-md flex items-center gap-1.5",disabled:o,children:[i("bulk.actions"),a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M19 9l-7 7-7-7"})})]})]}),d&&a.jsxs("div",{className:"fixed inset-0 z-50 flex items-end pointer-events-auto",children:[a.jsx("div",{className:"absolute inset-0 bg-black/40 pointer-events-auto",onClick:()=>u(!1)}),a.jsxs("div",{className:"relative w-full bg-white rounded-t-3xl shadow-2xl max-h-[80vh] overflow-hidden animate-slide-up pointer-events-auto z-10",children:[a.jsxs("div",{className:"sticky top-0 bg-white border-b border-slate-200 px-6 py-3 flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"text-base font-bold text-slate-900",children:i("bulk.actionTitle")}),a.jsxs("p",{className:"text-xs text-slate-600 mt-0",children:[i("bulk.forSelected"),": ",a.jsx("span",{className:"font-semibold",children:e})]})]}),a.jsx("button",{onClick:()=>u(!1),className:"p-2 hover:bg-slate-100 rounded-full transition-colors active:scale-95","aria-label":"Close",children:a.jsx("svg",{className:"w-6 h-6 text-slate-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),a.jsxs("div",{className:"overflow-y-auto",children:[a.jsxs("div",{className:"px-6 pt-3 pb-1",children:[a.jsx("div",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider mb-2",children:i("bulk.set")}),a.jsxs("div",{className:"space-y-0.5",children:[a.jsxs("button",{onClick:()=>{x("sent",!0),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-blue-600 text-lg",children:"✓"}),a.jsx("span",{className:"flex-1 font-medium",children:i("bulk.setSent")})]}),a.jsxs("button",{onClick:()=>{x("documents",!0),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-blue-600 text-lg",children:"✓"}),a.jsx("span",{className:"flex-1 font-medium",children:i("bulk.setDocuments")})]}),a.jsxs("button",{onClick:()=>{x("handedOver",!0),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-blue-600 text-lg",children:"✓"}),a.jsx("span",{className:"flex-1 font-medium",children:i("bulk.setHanded")})]}),a.jsxs("button",{onClick:()=>{h(),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-amber-50 active:bg-amber-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-amber-600 text-lg",children:"✓"}),a.jsx("span",{className:"flex-1 font-medium",children:i("bulk.setPaid")})]})]})]}),a.jsx("div",{className:"my-2 mx-6 border-t border-slate-200"}),a.jsxs("div",{className:"px-6 pb-20",children:[a.jsx("div",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider mb-2",children:i("bulk.clear")}),a.jsxs("div",{className:"space-y-0.5",children:[a.jsxs("button",{onClick:()=>{x("sent",!1),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),a.jsx("span",{className:"flex-1",children:i("bulk.clearSent")})]}),a.jsxs("button",{onClick:()=>{x("documents",!1),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),a.jsx("span",{className:"flex-1",children:i("bulk.clearDocuments")})]}),a.jsxs("button",{onClick:()=>{x("handedOver",!1),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),a.jsx("span",{className:"flex-1",children:i("bulk.clearHanded")})]}),a.jsxs("button",{onClick:()=>{x("paid",!1),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),a.jsx("span",{className:"flex-1",children:i("bulk.clearPaid")})]})]})]})]})]})]})]}),a.jsx(Le,{isOpen:m.isOpen,onClose:()=>p({...m,isOpen:!1}),onConfirm:m.onConfirm,title:m.title,message:m.message,confirmText:i("common.confirm"),cancelText:i("common.cancel")})]})};function We({title:e,count:t,groupNumbers:s,dateRange:r,participantCount:n,isCollapsed:i,onToggle:l,children:o,variant:c="active",showCount:d=!0}){const{t:u}=Te(),m={active:{bg:"bg-blue-50",border:"border-blue-200",accent:"border-l-blue-400",text:"text-blue-900",countBg:"bg-blue-100",countText:"text-blue-700",icon:a.jsx(N,{className:"w-5 h-5 text-blue-600",strokeWidth:2})},planned:{bg:"bg-amber-50",border:"border-amber-200",accent:"border-l-amber-400",text:"text-amber-900",countBg:"bg-amber-100",countText:"text-amber-700",icon:a.jsx(v,{className:"w-5 h-5 text-amber-600",strokeWidth:2})},completed:{bg:"bg-slate-50",border:"border-slate-200",accent:"border-l-slate-400",text:"text-slate-700",countBg:"bg-slate-100",countText:"text-slate-600",icon:a.jsx(f,{className:"w-5 h-5 text-slate-600",strokeWidth:2})}}[c];return a.jsxs("div",{className:"mb-4",children:[a.jsxs("div",{className:`rounded-lg border ${m.border} ${m.bg} border-l-4 ${m.accent} overflow-hidden shadow-sm transition-shadow duration-150`,children:[a.jsxs("button",{onClick:l,className:`w-full flex items-center justify-between px-4 py-3.5 transition-all duration-150 hover:brightness-95 active:scale-[0.99] ${m.text}`,children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"flex-shrink-0",children:m.icon}),a.jsx("span",{className:"font-bold text-base",children:e}),d&&s&&s.length>0&&a.jsx("span",{className:`px-2.5 py-0.5 ${m.countBg} ${m.countText} rounded-full text-xs font-semibold`,children:1===s.length?`№ ${s[0]}`:`№ ${s.join(", ")}`}),r&&a.jsx("span",{className:"text-sm font-medium opacity-75",children:r}),d&&!s&&"planned"===c&&a.jsx("span",{className:`px-2.5 py-0.5 ${m.countBg} ${m.countText} rounded-full text-xs font-semibold`,children:t})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[void 0!==n&&a.jsxs("span",{className:`px-2.5 py-1 ${m.countBg} ${m.countText} rounded-full text-xs font-bold`,children:[n," ",u(1===n?"group.participant_one":"group.participant_other")]}),a.jsx("svg",{className:"w-5 h-5 transition-transform duration-200 ease-out "+(i?"":"rotate-180"),style:{transformOrigin:"center"},fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M19 9l-7 7-7-7"})})]})]}),a.jsx("div",{className:"grid transition-all duration-150 ease-in-out "+(i?"grid-rows-[0fr] opacity-0":"grid-rows-[1fr] opacity-100"),style:{transitionProperty:"grid-template-rows, opacity",willChange:i?"auto":"grid-template-rows, opacity"},children:a.jsx("div",{className:"overflow-hidden",children:a.jsx("div",{className:"px-1.5 sm:px-2 pb-2 transition-transform duration-150 ease-out "+(i?"translate-y-[-8px]":"translate-y-0"),style:{willChange:i?"auto":"transform"},children:o})})})]}),a.jsx("style",{children:"\n        @media (prefers-reduced-motion: reduce) {\n          .grid, button, svg {\n            transition: none !important;\n          }\n        }\n        \n        @media (max-width: 768px) {\n          .grid {\n            transition-duration: 120ms !important;\n          }\n        }\n      "})]})}const Ge=({groupNumber:e,courseStartDate:t,courseEndDate:n,participants:i,renderParticipantRow:l,mode:o="table",defaultExpanded:c=!1})=>{const{t:d}=Te(),[u,m]=s.useState(c),[p,x]=s.useState({key:"uniqueNumber",direction:"desc"}),h=r.useMemo(()=>p.key?[...i].sort((e,t)=>{if("uniqueNumber"===p.key){const s=e.uniqueNumber||"",a=t.uniqueNumber||"";return"asc"===p.direction?s.localeCompare(a):a.localeCompare(s)}return 0}):i,[i,p]);return a.jsxs("div",{className:"border border-slate-300 rounded-lg mb-2 bg-white shadow-sm transition-shadow duration-150",children:[a.jsxs("button",{onClick:()=>m(!u),className:"w-full px-4 py-3 flex items-center justify-between hover:bg-slate-50 transition-all duration-150 rounded-lg active:scale-[0.99]",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("svg",{className:"w-5 h-5 text-slate-600 transition-transform duration-200 ease-out "+(u?"rotate-90":""),style:{transformOrigin:"center"},fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),a.jsxs("div",{className:"text-left",children:[a.jsxs("div",{className:"font-semibold text-slate-900",children:[d("group.group")," ",e]}),a.jsxs("div",{className:"text-sm text-slate-600",children:[ue(t)," - ",ue(n)]})]})]}),a.jsxs("div",{className:"text-sm text-slate-600 font-medium",children:[i.length," ",1===i.length?d("group.participant_one"):d("group.participant_other")]})]}),a.jsx("div",{className:"grid transition-all ease-in-out border-t border-slate-200 "+(u?"grid-rows-[1fr] opacity-100":"grid-rows-[0fr] opacity-0"),style:{transitionDuration:"180ms",transitionProperty:"grid-template-rows, opacity",willChange:u?"grid-template-rows, opacity":"auto"},children:a.jsx("div",{className:"overflow-hidden",children:a.jsx("div",{className:"transition-transform duration-180 ease-out "+(u?"translate-y-0":"translate-y-[-8px]"),style:{willChange:u?"transform":"auto"},children:"table"===o?a.jsx("div",{className:"overflow-x-auto",children:a.jsxs("table",{className:"min-w-full bg-white",children:[a.jsx("thead",{className:"bg-slate-50",children:a.jsxs("tr",{children:[a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.companyName")}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.personName")}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors select-none",onClick:()=>(e=>{let t="asc";p.key===e&&"asc"===p.direction&&(t="desc"),x({key:e,direction:t})})("uniqueNumber"),title:"Sort by Number",children:a.jsxs("div",{className:"flex items-center gap-1",children:[d("participant.uniqueNumber"),"uniqueNumber"===p.key&&a.jsx("span",{className:"text-slate-500",children:"asc"===p.direction?"↑":"↓"})]})}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.medicalDate")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.sent")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.documents")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.handedOver")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.paid")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("filters.status")})]})}),a.jsx("tbody",{className:"divide-y divide-slate-200",children:h.map(l)})]})}):a.jsx("div",{className:"p-3 space-y-2",children:h.map(l)})})})}),a.jsx("style",{children:"\n        @media (prefers-reduced-motion: reduce) {\n          .grid, button, svg {\n            transition: none !important;\n          }\n        }\n      "})]})},Re=({label:e,variant:t,icon:s})=>a.jsxs("span",{className:`\n        inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium border\n        ${{success:"bg-emerald-50 text-emerald-800 ring-1 ring-emerald-200 border-0",neutral:"bg-slate-100 text-slate-700 ring-1 ring-slate-200 border-0",info:"bg-blue-50 text-blue-800 ring-1 ring-blue-200 border-0"}[t]}\n      `,children:["check"===s&&a.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}),"manual"===s&&a.jsxs("svg",{className:"w-3 h-3",fill:"currentColor",viewBox:"0 0 16 16",children:[a.jsx("path",{d:"M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"}),a.jsx("path",{d:"M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"})]}),e]}),Fe=({isOpen:e,onClose:t,title:r,message:n,buttonText:i="OK",variant:l="info"})=>{if(s.useEffect(()=>{const s=e=>{"Escape"===e.key&&t()};if(e)return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[e,t]),s.useEffect(()=>{if(e){const e=setTimeout(()=>{t()},5e3);return()=>clearTimeout(e)}},[e,t]),!e)return null;return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 transition-opacity",onClick:t}),a.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-sm w-full md:max-w-md lg:max-w-lg overflow-hidden animate-scale-up transform transition-all",children:[a.jsxs("div",{className:"p-6 md:p-8 text-center",children:[a.jsx("div",{className:`mx-auto mb-4 w-12 h-12 rounded-full flex items-center justify-center ${(()=>{switch(l){case"danger":case"error":return"bg-red-50 text-red-900 border-red-100";case"warning":return"bg-amber-50 text-amber-900 border-amber-100";case"success":return"bg-emerald-50 text-emerald-900 border-emerald-100";default:return"bg-blue-50 text-blue-900 border-blue-100"}})()}`,children:(()=>{switch(l){case"danger":case"error":return a.jsx(w,{className:"w-6 h-6 text-red-600"});case"warning":return a.jsx(g,{className:"w-6 h-6 text-amber-600"});case"success":return a.jsx(b,{className:"w-6 h-6 text-emerald-600"});default:return a.jsx(h,{className:"w-6 h-6 text-blue-600"})}})()}),a.jsx("h3",{className:"text-xl font-bold text-slate-900 mb-2",children:r}),a.jsx("p",{className:"text-slate-600 text-sm leading-relaxed",children:n})]}),a.jsx("div",{className:"p-4 bg-slate-50 border-t border-slate-100",children:a.jsx("button",{onClick:t,className:`w-full px-5 py-2.5 text-white rounded-lg font-medium shadow-md transition-all duration-200 transform hover:-translate-y-0.5 ${(()=>{switch(l){case"danger":case"error":return"bg-red-600 hover:bg-red-700 focus:ring-red-500";case"warning":return"bg-amber-600 hover:bg-amber-700 focus:ring-amber-500";case"success":return"bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500";default:return"bg-blue-600 hover:bg-blue-700 focus:ring-blue-500"}})()}`,children:i})})]})})]})},Be=({participants:e,onEdit:t,onDelete:r,collapsedSections:n,toggleSection:i,hasActiveFilters:l,onFilterChange:c,groupRefreshKey:d=0})=>{var u;const{updateParticipant:m}=Se(),{t:p}=Te(),[x,h]=s.useState("uniqueNumber"),[b,g]=s.useState("asc"),[f,v]=s.useState(new Set),[N,w]=s.useState({isOpen:!1,participant:void 0}),[j,y]=s.useState(null),[S,k]=s.useState({isOpen:!1,title:"",message:"",variant:"info"}),D=(e,t)=>{const s=e.currentTarget.getBoundingClientRect();y({participant:t,x:s.left,y:s.top-8})},C=()=>{y(null)},E=o(()=>ee.groups.toArray(),[d]),A=s.useMemo(()=>E?new Map(E.map(e=>[e.courseStartDate,e])):new Map,[E]),O=s.useMemo(()=>[...e].sort((e,t)=>{let s=0;return"courseStartDate"===x||"groupNumber"===x?s=e.courseStartDate.localeCompare(t.courseStartDate):"uniqueNumber"===x&&(s=e.uniqueNumber.localeCompare(t.uniqueNumber)),"asc"===b?s:-s}),[e,x,b]),q=s.useMemo(()=>{const e=[],t=[],s=[];return O.forEach(a=>{const r=A.get(a.courseStartDate);r?"active"===r.status?e.push(a):"planned"===r.status?t.push(a):"completed"===r.status&&s.push(a):t.push(a)}),{active:e,planned:t,completed:s}},[O,A]),P=s.useMemo(()=>null==E?void 0:E.find(e=>"active"===e.status),[E]),T=(null==P?void 0:P.groupNumber)?[P.groupNumber]:[],L=P?`${ue(P.courseStartDate)} - ${ue(P.courseEndDate)}`:void 0,M=s.useMemo(()=>{const e=new Map;return null==E||E.forEach(t=>{"active"===t.status&&e.set(t.courseStartDate,{group:t,participants:[]})}),q.active.forEach(t=>{const s=e.get(t.courseStartDate);if(s)s.participants.push(t);else{const s=A.get(t.courseStartDate)||{id:"virt-active-"+t.courseStartDate,courseStartDate:t.courseStartDate,courseEndDate:t.courseEndDate,status:"active",groupNumber:null,isLocked:!1,createdAt:"",updatedAt:""};e.set(t.courseStartDate,{group:s,participants:[t]})}}),Array.from(e.values()).sort((e,t)=>e.group.courseStartDate.localeCompare(t.group.courseStartDate))},[q.active,E,A]),I=s.useMemo(()=>{const e=new Map;!l&&E&&E.forEach(t=>{"planned"===t.status&&e.set(t.courseStartDate,{group:t,participants:[]})}),q.planned.forEach(t=>{let s=A.get(t.courseStartDate);if(s&&!e.has(t.courseStartDate)&&e.set(t.courseStartDate,{group:s,participants:[]}),!s&&!e.has(t.courseStartDate)){const s={id:"virtual-planned-"+t.courseStartDate,groupNumber:null,courseStartDate:t.courseStartDate,courseEndDate:t.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""};e.set(t.courseStartDate,{group:s,participants:[]})}e.has(t.courseStartDate)&&e.get(t.courseStartDate).participants.push(t)});const t=Array.from(e.entries()).sort(([e],[t])=>e.localeCompare(t));return(l?t:t.slice(0,2)).map(([e,t])=>({courseStartDate:e,...t,participants:t.participants.sort((e,t)=>t.createdAt.localeCompare(e.createdAt))}))},[q.planned,A,E,l]),$=s.useMemo(()=>{const e=new Map;return q.completed.forEach(t=>{const s=A.get(t.courseStartDate);s&&(e.has(t.courseStartDate)||e.set(t.courseStartDate,{group:s,participants:[]}),e.get(t.courseStartDate).participants.push(t))}),Array.from(e.entries()).sort(([e],[t])=>t.localeCompare(e)).map(([e,t])=>({courseStartDate:e,...t}))},[q.completed,A]),W=s.useMemo(()=>{const e=new Set,t=new Set,s=new Set;return M.forEach(t=>e.add(t.group.courseStartDate)),!l&&E&&E.forEach(a=>{"active"===a.status&&e.add(a.courseStartDate),"planned"===a.status&&t.add(a.courseStartDate),"completed"===a.status&&s.add(a.courseStartDate)}),q.active.forEach(t=>e.add(t.courseStartDate)),q.planned.forEach(e=>t.add(e.courseStartDate)),q.completed.forEach(e=>s.add(e.courseStartDate)),{active:{count:e.size,numbers:[]},planned:{count:t.size,numbers:[]},completed:{count:s.size,numbers:[]}}},[q,E,M,l]);s.useEffect(()=>{(async()=>{await ge()})()},[]);const G=async(e,t)=>{if(fe(A.get(e.courseStartDate)))k({isOpen:!0,title:p("common.info"),message:p("lock.lockedInfo"),variant:"info"});else try{await m(e.id,{[t]:!e[t]})}catch(s){k({isOpen:!0,title:p("common.error"),message:p("error.updateParticipantFailed"),variant:"error"})}},R=e=>null!==e.completedOverride?e.completedOverride:e.completedComputed,F=e=>null!==e.completedOverride,B=e=>{const s=A.get(e.courseStartDate),r=V(e),n=["hover:bg-slate-100 transition-colors duration-150","active"===(null==s?void 0:s.status)?"bg-slate-50":"","completed"===(null==s?void 0:s.status)?"opacity-90":""].filter(Boolean).join(" ");return a.jsxs("tr",{className:n,children:[a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:f.has(e.id),onChange:()=>U(e.id),disabled:r,className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed","aria-label":`Select ${e.personName}`})}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Ie,{companyName:e.companyName}),r&&a.jsx("span",{className:"text-xs text-slate-500",title:p("lock.lockedInfo"),children:"🔒"})]})}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:a.jsx("div",{className:"max-w-xs truncate cursor-help",onMouseEnter:t=>D(t,e),onMouseLeave:C,children:e.personName})}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:ue(e.medicalDate)}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:ue(e.courseStartDate)}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:ue(e.courseEndDate)}),a.jsx("td",{className:"px-3 py-3 text-sm",children:a.jsx("span",{className:"font-mono text-xs bg-slate-100 px-2 py-0.5 rounded inline-block text-slate-700 cursor-help",title:`Уникален номер на удостоверение\nПротокол: ${(null==s?void 0:s.groupNumber)?5*s.groupNumber:"---"}`,children:e.uniqueNumber||"---"})}),a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:e.sent,onChange:()=>G(e,"sent"),disabled:r,title:"Данните са изпратени към фирмата",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:e.documents,onChange:()=>G(e,"documents"),disabled:r,title:"Получени са всички документи",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:e.handedOver,onChange:()=>G(e,"handedOver"),disabled:r,title:"Удостоверението е предадено",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:e.paid,onChange:()=>G(e,"paid"),disabled:r,title:"Таксата е платена",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsxs("div",{className:"flex items-center justify-center gap-1",children:[a.jsx("button",{onClick:()=>(async e=>{if(fe(A.get(e.courseStartDate)))return void k({isOpen:!0,title:p("common.info"),message:p("lock.lockedInfo"),variant:"info"});const t=null!==e.completedOverride?e.completedOverride:e.completedComputed;try{await m(e.id,{completedOverride:!t})}catch(s){k({isOpen:!0,title:p("common.error"),message:p("error.updateCompletedFailed"),variant:"error"})}})(e),disabled:r,className:"px-3 py-1 rounded-md text-xs font-medium transition-colors duration-150 ring-1 disabled:opacity-50 disabled:cursor-not-allowed "+(R(e)?"bg-emerald-50 text-emerald-800 ring-emerald-200 hover:bg-emerald-100":"bg-slate-100 text-slate-700 ring-slate-200 hover:bg-slate-200"),title:r?p("lock.lockedInfo"):"Click to toggle",children:R(e)?p("completed.done"):p("completed.pending")}),F(e)&&!r&&a.jsx("button",{onClick:()=>(async e=>{if(fe(A.get(e.courseStartDate)))k({isOpen:!0,title:p("common.info"),message:p("lock.lockedInfo"),variant:"info"});else try{await m(e.id,{completedOverride:null})}catch(t){k({isOpen:!0,title:p("common.error"),message:p("error.resetCompletedFailed"),variant:"error"})}})(e),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-50 transition-colors duration-150",title:"Reset to auto","aria-label":"Reset completed to automatic",children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})})]})}),a.jsx("td",{className:"px-3 py-3",children:a.jsxs("div",{className:"flex items-center justify-center gap-1",children:[a.jsx("button",{onClick:()=>t(e),disabled:r,className:"p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-100 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:p(r?"lock.lockedInfo":"common.edit"),"aria-label":`Edit ${e.personName}`,children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),a.jsx("button",{onClick:()=>(async e=>{try{let t=A.get(e.courseStartDate);t||(t={id:"virtual-cert",groupNumber:null,courseStartDate:e.courseStartDate,courseEndDate:e.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""});const{generateCertificate:s}=await Oe(async()=>{const{generateCertificate:e}=await import("./certificateGenerator-DmGm2V6u.js");return{generateCertificate:e}},__vite__mapDeps([0,1,2,3,4,5,6,7]));await s(e,t),k({isOpen:!0,title:p("common.success"),message:p("certificate.generated"),variant:"success"})}catch(t){k({isOpen:!0,title:p("common.error"),message:p("certificate.error")+": "+t.message,variant:"error"})}})(e),className:"p-2 text-green-600 hover:text-green-800 hover:bg-green-50 rounded-lg transition-colors duration-150",title:"Генерирай сертификат","aria-label":`Generate certificate for ${e.personName}`,children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),a.jsx("button",{onClick:()=>w({isOpen:!0,participant:e}),disabled:r,className:"p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:p(r?"lock.lockedInfo":"common.delete"),"aria-label":`Delete ${e.personName}`,children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})})]},e.id)},z=e=>{const s=V(e);return a.jsxs("tr",{className:"hover:bg-slate-100 transition-colors duration-150",children:[a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:f.has(e.id),onChange:()=>U(e.id),disabled:s,className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed","aria-label":`Select ${e.personName}`})}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:a.jsx(Ie,{companyName:e.companyName})}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:a.jsx("div",{className:"max-w-xs truncate cursor-help",onMouseEnter:t=>D(t,e),onMouseLeave:C,children:e.personName})}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:ue(e.medicalDate)}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:ue(e.courseStartDate)}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:ue(e.courseEndDate)}),a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:e.documents,onChange:()=>G(e,"documents"),disabled:s,title:"Получени са всички документи",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:e.paid,onChange:()=>G(e,"paid"),disabled:s,title:"Таксата е платена",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),a.jsx("td",{className:"px-3 py-3",children:a.jsxs("div",{className:"flex items-center justify-center gap-1",children:[a.jsx("button",{onClick:()=>t(e),disabled:s,className:"p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-100 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:p(s?"lock.lockedInfo":"common.edit"),"aria-label":`Edit ${e.personName}`,children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),a.jsx("button",{onClick:()=>w({isOpen:!0,participant:e}),disabled:s,className:"p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:p(s?"lock.lockedInfo":"common.delete"),"aria-label":`Delete ${e.personName}`,children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})})]},e.id)},_=e=>{const t=A.get(e.courseStartDate),s=R(e);return a.jsxs("tr",{className:"hover:bg-slate-50 transition-colors",children:[a.jsx("td",{className:"px-3 py-2 text-sm text-slate-900",children:a.jsx(Ie,{companyName:e.companyName})}),a.jsx("td",{className:"px-3 py-2 text-sm text-slate-900",children:a.jsx("div",{className:"cursor-help",onMouseEnter:t=>D(t,e),onMouseLeave:C,children:e.personName})}),a.jsx("td",{className:"px-3 py-2 text-sm",children:a.jsx("span",{className:"font-mono text-xs bg-slate-100 px-2 py-0.5 rounded inline-block text-slate-700 cursor-help",title:`Уникален номер на удостоверение\nПротокол: ${(null==t?void 0:t.groupNumber)?5*t.groupNumber:"---"}`,children:e.uniqueNumber})}),a.jsx("td",{className:"px-3 py-2 text-sm text-slate-600",children:ue(e.medicalDate)}),a.jsx("td",{className:"px-3 py-2 text-center",children:a.jsx("input",{type:"checkbox",checked:e.sent,disabled:!0,title:"Данните са изпратени към фирмата",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),a.jsx("td",{className:"px-3 py-2 text-center",children:a.jsx("input",{type:"checkbox",checked:e.documents,disabled:!0,title:"Получени са всички документи",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),a.jsx("td",{className:"px-3 py-2 text-center",children:a.jsx("input",{type:"checkbox",checked:e.handedOver,disabled:!0,title:"Удостоверението е предадено",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),a.jsx("td",{className:"px-3 py-2 text-center",children:a.jsx("input",{type:"checkbox",checked:e.paid,disabled:!0,title:"Таксата е платена",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),a.jsx("td",{className:"px-3 py-2 text-center",children:a.jsxs("div",{className:"flex items-center justify-center gap-1",children:[s&&a.jsx(Re,{label:p("participant.completedBadge"),variant:"success",icon:"check"}),F(e)&&a.jsx(Re,{label:p("participant.manual"),variant:"info",icon:"manual"}),!s&&!F(e)&&a.jsx("span",{className:"text-xs text-slate-400 italic",children:p("completed.pending")})]})})]},e.id)},U=e=>{const t=new Set(f);t.has(e)?t.delete(e):t.add(e),v(t)},V=e=>fe(A.get(e.courseStartDate));return 0===O.length?a.jsx("div",{className:"text-center py-12 text-slate-500",children:p("participants.noResults")}):a.jsxs(a.Fragment,{children:[a.jsx($e,{selectedCount:f.size,selectedIds:Array.from(f),onClearSelection:()=>{v(new Set)},onActionComplete:()=>{v(new Set)}}),a.jsx(Fe,{isOpen:S.isOpen,onClose:()=>k(e=>({...e,isOpen:!1})),title:S.title,message:S.message,variant:S.variant}),a.jsxs("div",{className:"space-y-4",children:[(q.active.length>0||!l)&&a.jsx(We,{title:p("groups.activeSection"),count:W.active.count,groupNumbers:M.length<=1?T:[],dateRange:M.length<=1?L:void 0,participantCount:q.active.length,isCollapsed:n.active,onToggle:()=>i("active"),variant:"active",children:0===M.length?a.jsx("div",{className:"text-center py-8 text-slate-500 bg-slate-50 border border-dashed border-slate-200 rounded-lg",children:p("participants.noActive")}):a.jsx("div",{className:"space-y-8",children:M.map(e=>a.jsxs("div",{className:"space-y-3",children:[M.length>1&&a.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-blue-100",children:[a.jsxs("span",{className:"font-bold text-blue-900",children:[ue(e.group.courseStartDate)," - ",ue(e.group.courseEndDate)]}),e.group.groupNumber&&a.jsxs("span",{className:"px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs font-bold",children:["№ ",e.group.groupNumber]})]}),a.jsx("div",{className:"overflow-x-auto max-h-[400px] overflow-y-auto relative rounded-lg border border-slate-200",children:a.jsxs("table",{className:"min-w-full bg-white",children:[a.jsx("thead",{className:"bg-slate-100 sticky top-0 z-10 shadow-sm",children:a.jsxs("tr",{children:[a.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 border-b border-slate-200 w-12",children:a.jsx("input",{type:"checkbox",checked:e.participants.length>0&&e.participants.every(e=>f.has(e.id)),onChange:t=>{const s=new Set(f);t.target.checked?e.participants.filter(e=>!V(e)).forEach(e=>s.add(e.id)):e.participants.forEach(e=>s.delete(e.id)),v(s)},className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer"})}),a.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.companyName")}),a.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.personName")}),a.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.medicalDate")}),a.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.courseStart")}),a.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.courseEnd")}),a.jsxs("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200 cursor-pointer hover:bg-slate-200 transition-colors duration-150",onClick:()=>{var e;x===(e="uniqueNumber")?g(e=>"asc"===e?"desc":"asc"):(h(e),g("asc"))},children:[p("participant.uniqueNumber")," ","uniqueNumber"===x&&("asc"===b?"↑":"↓")]}),a.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.sent")}),a.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.documents")}),a.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.handedOver")}),a.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.paid")}),a.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("filters.status")}),a.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("common.delete")})]})}),a.jsx("tbody",{className:"divide-y divide-slate-200",children:e.participants.length>0?e.participants.map(B):a.jsx("tr",{children:a.jsx("td",{colSpan:13,className:"text-center py-8 text-slate-400 italic",children:p("participants.noParticipantsInGroup")})})})]})})]},e.group.courseStartDate))})}),(q.planned.length>0||!l)&&I.length>0&&a.jsx(We,{title:p("groups.plannedSection"),count:W.planned.count,groupNumbers:I.map(e=>e.group.groupNumber).filter(e=>null!==e),isCollapsed:n.planned,onToggle:()=>i("planned"),variant:"planned",children:a.jsx("div",{className:"space-y-6",children:I.map(({courseStartDate:e,group:t,participants:s})=>a.jsxs("div",{className:"bg-white border border-amber-200 rounded-lg overflow-hidden",children:[a.jsx("div",{className:"bg-amber-50 px-4 py-2 border-b border-amber-200",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[t.groupNumber&&a.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-900 rounded text-xs font-semibold",children:["№ ",t.groupNumber]}),a.jsxs("span",{className:"font-semibold text-amber-900",children:[ue(t.courseStartDate)," - ",ue(t.courseEndDate)]})]}),a.jsxs("span",{className:"text-sm text-amber-700 font-medium",children:[s.length," ",1===s.length?p("group.participant_one"):p("group.participant_other")]})]})}),a.jsx("div",{className:"overflow-x-auto",children:a.jsxs("table",{className:"min-w-full bg-white",children:[a.jsx("thead",{className:"bg-slate-50",children:a.jsxs("tr",{children:[a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 border-b border-slate-200 w-12",children:a.jsx("input",{type:"checkbox",checked:s.length>0&&s.every(e=>f.has(e.id)),onChange:e=>{const t=new Set(f);e.target.checked?s.forEach(e=>t.add(e.id)):s.forEach(e=>t.delete(e.id)),v(t)},className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer"})}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.companyName")}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.personName")}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.medicalDate")}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.courseStart")}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.courseEnd")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.documents")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.paid")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("common.delete")})]})}),a.jsx("tbody",{className:"divide-y divide-slate-200",children:s.length>0?s.map(z):a.jsx("tr",{children:a.jsx("td",{colSpan:10,className:"text-center py-4 text-slate-400 italic",children:p("participants.noParticipantsInGroup")})})})]})})]},e))})}),(q.completed.length>0||!l)&&$.length>0&&a.jsx(We,{title:p("groups.completedSection"),count:W.completed.count,groupNumbers:W.completed.numbers,isCollapsed:n.completed,onToggle:()=>i("completed"),variant:"completed",children:a.jsx("div",{className:"space-y-4",children:$.map(({courseStartDate:e,group:t,participants:s})=>a.jsx("div",{children:a.jsx(Ge,{groupNumber:t.groupNumber||0,courseStartDate:t.courseStartDate,courseEndDate:t.courseEndDate,participants:s,renderParticipantRow:_,defaultExpanded:l})},e))})})]}),l&&0===e.length&&a.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 text-center",children:[a.jsx("div",{className:"text-6xl mb-4",children:"🔍"}),a.jsx("h3",{className:"text-lg font-semibold text-slate-700 mb-2",children:"Няма намерени резултати"}),a.jsx("p",{className:"text-sm text-slate-500 mb-6",children:"Опитай да промениш филтрите или ги изчисти"}),a.jsx("button",{onClick:()=>{c({searchTerm:"",courseStartDate:null,category:null,status:"all"})},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium",children:"Изчисти филтрите"})]}),a.jsx(Le,{isOpen:N.isOpen,onClose:()=>w({isOpen:!1,participant:void 0}),onConfirm:()=>{N.participant&&r(N.participant.id),w({isOpen:!1,participant:void 0})},title:p("modal.deleteTitle"),message:a.jsxs(a.Fragment,{children:[p("modal.deleteMessage").split("{name}")[0],a.jsx("strong",{className:"font-bold text-slate-900",children:(null==(u=N.participant)?void 0:u.personName)||""}),p("modal.deleteMessage").split("{name}")[1]]}),confirmText:p("common.delete"),cancelText:p("common.cancel"),variant:"danger"}),j&&a.jsxs("div",{className:"fixed z-50 bg-slate-800 text-white text-xs p-3 rounded shadow-lg pointer-events-none transform -translate-y-full filter drop-shadow-md",style:{left:j.x,top:j.y,minWidth:"220px"},children:[a.jsx("div",{className:"font-bold mb-2 border-b border-slate-600 pb-1 text-slate-100",children:j.participant.personName}),a.jsxs("div",{className:"grid grid-cols-[auto_1fr] gap-x-3 gap-y-1.5",children:[a.jsxs("span",{className:"text-slate-400 text-right",children:[p("participant.egn"),":"]}),a.jsx("span",{className:"font-mono",children:j.participant.egn||"-"}),a.jsxs("span",{className:"text-slate-400 text-right",children:[p("participant.birthPlace"),":"]}),a.jsx("span",{children:j.participant.birthPlace||"-"}),a.jsxs("span",{className:"text-slate-400 text-right",children:[p("participant.added"),":"]}),a.jsx("span",{children:j.participant.createdAt?ue(j.participant.createdAt):"-"}),a.jsxs("span",{className:"text-slate-400 text-right",children:[p("participant.modified"),":"]}),a.jsx("span",{children:j.participant.updatedAt?ue(j.participant.updatedAt):"-"})]})]})]})},ze=({onEdit:e,onDetails:t,onGenerate:r,onDelete:n})=>{const[i,l]=s.useState(!1),o=s.useRef(null);return s.useEffect(()=>{const e=e=>{o.current&&!o.current.contains(e.target)&&l(!1)},t=e=>{"Escape"===e.key&&l(!1)};if(i)return document.addEventListener("mousedown",e),document.addEventListener("keydown",t),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",t)}},[i]),a.jsxs("div",{className:"relative",ref:o,children:[a.jsx("button",{onClick:()=>l(!i),className:"p-2 hover:bg-slate-100 rounded-lg transition-colors duration-150 min-h-[44px] min-w-[44px] flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-blue-500","aria-label":"More options","aria-expanded":i,children:a.jsxs("svg",{className:"w-5 h-5 text-slate-600",fill:"currentColor",viewBox:"0 0 16 16",children:[a.jsx("circle",{cx:"8",cy:"2",r:"1.5"}),a.jsx("circle",{cx:"8",cy:"8",r:"1.5"}),a.jsx("circle",{cx:"8",cy:"14",r:"1.5"})]})}),i&&a.jsxs("div",{className:"absolute right-0 top-12 bg-white rounded-lg shadow-lg border border-slate-200 py-1 min-w-[140px] z-10 animate-scale-up",children:[e&&a.jsxs("button",{onClick:()=>{e(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-100 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),"Редактирай"]}),t&&a.jsxs("button",{onClick:()=>{t(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-blue-700 hover:bg-blue-50 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),"Детайли"]}),r&&a.jsxs("button",{onClick:()=>{r(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-green-700 hover:bg-green-50 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Генерирай"]}),n&&a.jsxs("button",{onClick:()=>{n(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),"Изтрий"]})]})]})},_e=({isOpen:e,onClose:t,participant:r})=>{const{t:n}=Te();return s.useEffect(()=>{const s=e=>{"Escape"===e.key&&t()};if(e)return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[e,t]),e&&r?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 transition-opacity",onClick:t}),a.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none",children:a.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden animate-scale-up pointer-events-auto",children:[a.jsxs("div",{className:"relative bg-slate-50 px-6 py-4 border-b border-slate-100",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center shrink-0",children:a.jsx(j,{className:"w-5 h-5 text-blue-600"})}),a.jsxs("div",{className:"min-w-0",children:[a.jsx("h3",{className:"text-lg font-bold text-slate-900 truncate pr-6",children:r.personName}),a.jsx("p",{className:"text-xs text-slate-500 truncate",children:r.companyName})]})]}),a.jsx("button",{onClick:t,className:"absolute right-4 top-4 p-1 rounded-full hover:bg-slate-200 transition-colors text-slate-400 hover:text-slate-600",children:a.jsx(y,{className:"w-5 h-5"})})]}),a.jsxs("div",{className:"p-6 space-y-4",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[a.jsx(S,{className:"w-3.5 h-3.5"}),a.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:n("participant.egn")})]}),a.jsx("div",{className:"text-sm font-mono text-slate-900 bg-slate-50 px-2 py-1 rounded",children:r.egn||"---"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[a.jsx(k,{className:"w-3.5 h-3.5"}),a.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:n("participant.birthPlace")})]}),a.jsx("div",{className:"text-sm font-medium text-slate-900 truncate",children:r.birthPlace||"---"})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[a.jsx(D,{className:"w-3.5 h-3.5"}),a.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:n("participant.added")})]}),a.jsx("div",{className:"text-xs text-slate-900",children:r.createdAt?ue(r.createdAt):"---"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[a.jsx(C,{className:"w-3.5 h-3.5"}),a.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:n("participant.modified")})]}),a.jsx("div",{className:"text-xs text-slate-900",children:r.updatedAt?ue(r.updatedAt):"---"})]})]})]}),a.jsx("div",{className:"px-6 py-4 bg-slate-50 flex justify-end",children:a.jsx("button",{onClick:t,className:"px-4 py-2 bg-white text-slate-700 border border-slate-200 rounded-lg hover:bg-slate-100 font-medium text-sm transition-all",children:n("common.close")})})]})})]}):null},Ue=({label:e,isActive:t})=>a.jsxs("div",{className:`\n        flex items-center justify-center gap-1 px-1.5 py-1 rounded text-xs font-medium\n        transition-all duration-150 min-h-[32px] w-full\n        ${t?"bg-emerald-700 border border-emerald-700 text-white":"bg-white border border-slate-300 text-slate-700"}\n      `,children:[t&&a.jsx("svg",{className:"w-3 h-3 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}),a.jsx("span",{className:"text-[10px] whitespace-nowrap",children:e})]}),Ve=({participants:e,onEdit:t,onDelete:r,onSelectionChange:n,collapsedSections:i,toggleSection:l,expandSection:c,hasActiveFilters:d})=>{var u;const{t:m}=Te(),{updateParticipant:p}=Se(),[x,h]=s.useState(new Set),[b,g]=s.useState(null),[f,v]=s.useState({isOpen:!1,participant:void 0}),[N,w]=s.useState({isOpen:!1,participant:void 0}),[j,y]=s.useState(new Set),S=s.useRef(new Map),k=o(()=>ee.groups.toArray(),[]),D=s.useMemo(()=>k?new Map(k.map(e=>[e.courseStartDate,e])):new Map,[k]),C=s.useMemo(()=>{const t=[],s=[],a=[];return e.forEach(e=>{const r=D.get(e.courseStartDate);r?"active"===r.status?t.push(e):"planned"===r.status?s.push(e):"completed"===r.status&&a.push(e):s.push(e)}),{active:t,planned:s,completed:a}},[e,D]),E=s.useMemo(()=>{const e=new Map;!d&&k&&k.forEach(t=>{"planned"===t.status&&e.set(t.courseStartDate,{group:t,participants:[]})}),C.planned.forEach(t=>{let s=D.get(t.courseStartDate);if(s&&!e.has(t.courseStartDate)&&e.set(t.courseStartDate,{group:s,participants:[]}),!s&&!e.has(t.courseStartDate)){const s={id:"virtual-"+t.courseStartDate,groupNumber:null,courseStartDate:t.courseStartDate,courseEndDate:t.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""};e.set(t.courseStartDate,{group:s,participants:[]})}e.has(t.courseStartDate)&&e.get(t.courseStartDate).participants.push(t)});const t=Array.from(e.entries()).sort(([e],[t])=>e.localeCompare(t));return(d?t:t.slice(0,2)).map(([e,t])=>({courseStartDate:e,...t,participants:t.participants.sort((e,t)=>t.createdAt.localeCompare(e.createdAt))}))},[C.planned,D,k,d]),A=s.useMemo(()=>{const e=new Map;return C.completed.forEach(t=>{const s=D.get(t.courseStartDate);s&&(e.has(t.courseStartDate)||e.set(t.courseStartDate,{group:s,participants:[]}),e.get(t.courseStartDate).participants.push(t))}),Array.from(e.entries()).sort(([e],[t])=>t.localeCompare(e)).map(([e,t])=>({courseStartDate:e,...t}))},[C.completed,D]),O=s.useMemo(()=>null==k?void 0:k.find(e=>"active"===e.status),[k]),q=(null==O?void 0:O.groupNumber)?[O.groupNumber]:[],P=O?`${ue(O.courseStartDate)} - ${ue(O.courseEndDate)}`:void 0,T=s.useMemo(()=>{const e=new Map;return null==k||k.forEach(t=>{"active"===t.status&&e.set(t.courseStartDate,{group:t,participants:[]})}),C.active.forEach(t=>{const s=e.get(t.courseStartDate);if(s)s.participants.push(t);else{const s=D.get(t.courseStartDate)||{id:"virt-active-"+t.courseStartDate,courseStartDate:t.courseStartDate,courseEndDate:t.courseEndDate,status:"active",groupNumber:null,isLocked:!1,createdAt:"",updatedAt:""};e.set(t.courseStartDate,{group:s,participants:[t]})}}),Array.from(e.values()).sort((e,t)=>e.group.courseStartDate.localeCompare(t.group.courseStartDate)).map(e=>({...e,participants:e.participants.sort((e,t)=>t.uniqueNumber.localeCompare(e.uniqueNumber))}))},[C.active,k,D]),L=s.useMemo(()=>{const e=new Set,t=new Set,s=new Set;return C.active.forEach(t=>e.add(t.courseStartDate)),!d&&k&&k.forEach(e=>{"planned"===e.status&&t.add(e.courseStartDate)}),C.planned.forEach(e=>t.add(e.courseStartDate)),C.completed.forEach(e=>s.add(e.courseStartDate)),{active:{count:e.size,periods:Array.from(e).sort()},planned:{count:d?t.size:Math.min(t.size,2),periods:Array.from(t).sort()},completed:{count:s.size,periods:Array.from(s).sort()}}},[C,k,d]);s.useEffect(()=>()=>{S.current.forEach(e=>clearTimeout(e)),S.current.clear()},[]),s.useEffect(()=>{x.size>0&&j.size>0&&(y(new Set),S.current.forEach(e=>clearTimeout(e)),S.current.clear())},[x.size,j.size]);const M=(e,t)=>{if(x.size>0)return;const s=t.currentTarget,a=document.createElement("span");a.style.cssText="position: absolute; visibility: hidden; white-space: nowrap; display: inline-block;",a.className=s.className.replace("marquee-active","").replace("truncate",""),a.textContent=s.textContent,document.body.appendChild(a);const r=a.offsetWidth;document.body.removeChild(a);const n=r-s.offsetWidth;if(n<=5)return;const i=S.current.get(e);i&&clearTimeout(i),y(t=>new Set(t).add(e)),s.style.setProperty("--marquee-distance",`-${n}px`);const l=Math.max(2e3,n/40*1e3);s.style.setProperty("--marquee-duration",`${l}ms`);const o=setTimeout(()=>{y(t=>{const s=new Set(t);return s.delete(e),s}),S.current.delete(e)},l+1e3);S.current.set(e,o)},I=s.useRef(e);s.useEffect(()=>{I.current!==e&&d&&(C.active.length>0&&i.active&&c("active"),C.planned.length>0&&i.planned&&c("planned"),C.completed.length>0&&i.completed&&c("completed"),I.current=e)},[e,C,i,c,d]),s.useEffect(()=>{null==n||n(x.size>0)},[x.size,n]);const $=async(e,t)=>{const s=D.get(e.courseStartDate);if(s&&"completed"===s.status&&s.isLocked)alert(m("lock.lockedInfo"));else try{await p(e.id,{[t]:!e[t]})}catch(a){}},W=e=>null!==e.completedOverride?e.completedOverride:e.completedComputed,G=e=>null!==e.completedOverride,R=e=>{const t=D.get(e.courseStartDate);return!!t&&("completed"===t.status&&t.isLocked)},F=(e,t)=>{if(R(t))return;const s=setTimeout(()=>{h(new Set([e]))},500);g(s)},B=()=>{b&&(clearTimeout(b),g(null))},[z,_]=s.useState({isOpen:!1,title:"",message:"",variant:"info"}),U=(e,s)=>{var r;const n=x.has(e.id),i=R(e);return a.jsxs("div",{onClick:()=>((e,t)=>{const s=R(t);if(x.size>0){if(s)return;const t=new Set(x);t.has(e)?t.delete(e):t.add(e),h(t)}})(e.id,e),onTouchStart:()=>F(e.id,e),onTouchEnd:B,onMouseDown:()=>F(e.id,e),onMouseUp:B,onMouseLeave:B,className:`bg-white rounded-lg shadow-sm p-3 md:p-4 border transition-all duration-150 ${n?"border-blue-500 ring-2 ring-blue-200":"border-slate-200"} ${i?"opacity-75":"cursor-pointer hover:shadow-md"}`,children:[a.jsxs("div",{className:"flex justify-between items-start mb-3",children:[a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("div",{className:"mb-1",children:a.jsx(Ie,{companyName:e.companyName})}),a.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1 overflow-hidden",children:[n&&a.jsx("div",{className:"w-5 h-5 bg-blue-600 rounded flex items-center justify-center shrink-0",children:a.jsx("svg",{className:"w-3 h-3 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}),a.jsx("h3",{className:"font-bold text-lg text-slate-900 leading-tight cursor-pointer select-none "+(j.has(e.id)?"marquee-active":"truncate"),onClick:t=>M(e.id,t),title:j.has(e.id)?void 0:e.personName,children:e.personName}),i&&a.jsx("span",{className:"text-xs text-slate-500 shrink-0",title:m("lock.lockedInfo"),children:"🔒"})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("div",{className:"flex flex-col gap-1 items-end",children:[e.uniqueNumber&&a.jsx("span",{className:"text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-700",children:e.uniqueNumber}),a.jsxs("div",{className:"flex gap-1",children:[W(e)?a.jsx(Re,{label:m("participant.completedBadge"),variant:"success",icon:"check"}):a.jsx("span",{className:"text-[10px] text-slate-400 italic font-medium",children:m("completed.pending")}),G(e)&&a.jsx(Re,{label:m("participant.manual"),variant:"info",icon:"manual"})]})]}),!i&&a.jsx(ze,{onEdit:()=>t(e),onDetails:()=>w({isOpen:!0,participant:e}),onGenerate:"active"===(null==(r=D.get(e.courseStartDate))?void 0:r.status)?()=>(async e=>{try{let t=D.get(e.courseStartDate);t||(t={id:"virtual",groupNumber:null,courseStartDate:e.courseStartDate,courseEndDate:e.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""});const{generateCertificate:s}=await Oe(async()=>{const{generateCertificate:e}=await import("./certificateGenerator-DmGm2V6u.js");return{generateCertificate:e}},__vite__mapDeps([0,1,2,3,4,5,6,7]));await s(e,t),_({isOpen:!0,title:m("common.success"),message:m("certificate.generated"),variant:"success"})}catch(t){_({isOpen:!0,title:m("common.error"),message:m("certificate.error")+": "+t.message,variant:"error"})}})(e):void 0,onDelete:()=>(e=>{v({isOpen:!0,participant:e})})(e)})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-x-2 gap-y-2 mb-3",children:[a.jsxs("div",{className:"flex flex-col min-w-0",children:[a.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:m("participant.medical")}),a.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:ue(e.medicalDate)})]}),a.jsxs("div",{className:"flex flex-col min-w-0 text-right",children:[a.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:m("participant.period")}),a.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:ue(e.courseStartDate)})]}),a.jsxs("div",{className:"flex flex-col min-w-0",children:[a.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:m("participant.courseStart")}),a.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:ue(e.courseStartDate)})]}),a.jsxs("div",{className:"flex flex-col min-w-0 text-right",children:[a.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:m("participant.courseEnd")}),a.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:ue(e.courseEndDate)})]})]}),a.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-1.5 sm:gap-1",children:[a.jsx("button",{onClick:t=>{t.stopPropagation(),$(e,"sent")},disabled:i,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:a.jsx(Ue,{label:m("participant.sent"),isActive:e.sent})}),a.jsx("button",{onClick:t=>{t.stopPropagation(),$(e,"documents")},disabled:i,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:a.jsx(Ue,{label:m("participant.documents"),isActive:e.documents})}),a.jsx("button",{onClick:t=>{t.stopPropagation(),$(e,"handedOver")},disabled:i,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:a.jsx(Ue,{label:m("participant.handed"),isActive:e.handedOver})}),a.jsx("button",{onClick:t=>{t.stopPropagation(),$(e,"paid")},disabled:i,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:a.jsx(Ue,{label:m("participant.paid"),isActive:e.paid})})]})]},e.id)},V=e=>a.jsxs("div",{className:"bg-white rounded-lg p-3 border border-slate-200",children:[a.jsxs("div",{className:"flex justify-between items-start mb-2",children:[a.jsxs("div",{className:"flex-1 min-w-0 pr-2 overflow-hidden",children:[a.jsx("div",{className:"mb-1",children:a.jsx(Ie,{companyName:e.companyName})}),a.jsx("h4",{className:"font-semibold text-slate-900 cursor-pointer select-none "+(j.has(e.id)?"marquee-active":"truncate"),onClick:t=>M(e.id,t),title:j.has(e.id)?void 0:e.personName,children:e.personName})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("div",{className:"flex flex-col gap-1 items-end shrink-0",children:[e.uniqueNumber&&a.jsx("span",{className:"text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-700",children:e.uniqueNumber}),a.jsxs("div",{className:"flex gap-1",children:[W(e)?a.jsx(Re,{label:m("participant.completedBadge"),variant:"success",icon:"check"}):a.jsx("span",{className:"text-[10px] text-slate-400 italic font-medium",children:m("completed.pending")}),G(e)&&a.jsx(Re,{label:m("participant.manual"),variant:"info",icon:"manual"})]})]}),a.jsx(ze,{onDetails:()=>w({isOpen:!0,participant:e})})]})]}),a.jsx("div",{className:"text-sm text-slate-600 mb-2",children:a.jsxs("div",{className:"text-[10px] text-slate-500 uppercase tracking-wider font-semibold mb-1",children:[m("participant.medical"),": ",ue(e.medicalDate)]})}),a.jsxs("div",{className:"flex flex-nowrap justify-between items-center gap-0.5 mt-auto pt-2 border-t border-slate-50 overflow-hidden",children:[a.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[a.jsx("input",{type:"checkbox",checked:e.sent,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),m("participant.sent")]}),a.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[a.jsx("input",{type:"checkbox",checked:e.documents,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),m("participant.documents")]}),a.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[a.jsx("input",{type:"checkbox",checked:e.handedOver,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),m("participant.handed")]}),a.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[a.jsx("input",{type:"checkbox",checked:e.paid,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),m("participant.paid")]})]})]},e.id);return 0===e.length?a.jsx("div",{className:"text-center py-12 text-slate-500",children:m("participants.noResults")}):a.jsxs(a.Fragment,{children:[a.jsx("style",{children:"\n          @keyframes marquee-scroll {\n            0%, 10% {\n              transform: translateX(0);\n            }\n            90%, 100% {\n              transform: translateX(var(--marquee-distance, 0));\n            }\n          }\n\n          .marquee-active {\n            display: inline-block;\n            white-space: nowrap;\n            animation: marquee-scroll var(--marquee-duration, 3s) ease-in-out;\n            animation-iteration-count: 1;\n            animation-fill-mode: forwards;\n          }\n        "}),a.jsx($e,{selectedCount:x.size,selectedIds:Array.from(x),onClearSelection:()=>{h(new Set)},onActionComplete:()=>{h(new Set)}}),a.jsx(_e,{isOpen:N.isOpen,onClose:()=>w({isOpen:!1,participant:void 0}),participant:N.participant}),a.jsx(Fe,{isOpen:z.isOpen,onClose:()=>_(e=>({...e,isOpen:!1})),title:z.title,message:z.message,variant:"error"===z.variant?"danger":z.variant}),a.jsxs("div",{className:"space-y-4 pb-32",children:[(C.active.length>0||!d)&&a.jsx(We,{title:m("groups.activeSection"),count:L.active.count,groupNumbers:T.length<=1&&q.length>0?q:[],dateRange:T.length<=1?P:void 0,participantCount:C.active.length,isCollapsed:i.active,onToggle:()=>l("active"),showCount:!(T.length<=1)||Math.max(q.length,0)>0,variant:"active",children:0===T.length?a.jsx("div",{className:"text-center py-8 text-slate-500 bg-slate-50/50 rounded-lg border border-dashed border-slate-200",children:a.jsx("p",{children:m("participants.noActive")})}):a.jsx("div",{className:"space-y-8",children:T.map(e=>a.jsxs("div",{className:"space-y-4",children:[T.length>1&&a.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-blue-100",children:[a.jsxs("span",{className:"font-semibold text-blue-900",children:[ue(e.group.courseStartDate)," - ",ue(e.group.courseEndDate)]}),e.group.groupNumber&&a.jsxs("span",{className:"px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-bold",children:["№ ",e.group.groupNumber]})]}),e.participants.length>0?a.jsx("div",{className:"space-y-4",children:e.participants.map((e,t)=>U(e))}):a.jsx("div",{className:"text-center py-4 italic text-slate-400 bg-white/50 rounded border border-dashed border-slate-100",children:m("participants.noParticipantsInGroup")})]},e.group.courseStartDate))})}),(C.planned.length>0||!d)&&a.jsx(We,{title:m("groups.plannedSection"),count:L.planned.count,groupNumbers:E.map(e=>e.group.groupNumber).filter(e=>null!==e),participantCount:C.planned.length,isCollapsed:i.planned,onToggle:()=>l("planned"),variant:"planned",children:E.length>0?a.jsx("div",{className:"space-y-3",children:E.map(({courseStartDate:e,group:t,participants:s})=>a.jsxs("div",{className:"bg-white border-2 border-amber-200 rounded-lg overflow-hidden",children:[a.jsx("div",{className:"bg-amber-50 px-3 py-2 border-b border-amber-200",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[t.groupNumber&&a.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-900 rounded text-xs font-semibold",children:["№ ",t.groupNumber]}),a.jsxs("span",{className:"font-semibold text-amber-900",children:[ue(t.courseStartDate)," - ",ue(t.courseEndDate)]})]}),a.jsxs("span",{className:"text-xs text-amber-700 font-medium",children:[s.length," ",1===s.length?m("group.participant_one"):m("group.participant_other")]})]})}),a.jsx("div",{className:"p-2 space-y-2",children:s.map((e,t)=>U(e))})]},e))}):a.jsx("div",{className:"text-center py-8 text-slate-500",children:m("participants.noParticipantsInGroup")})}),(C.completed.length>0||!d)&&a.jsx(We,{title:m("groups.completedSection"),count:L.completed.count,participantCount:C.completed.length,isCollapsed:i.completed,onToggle:()=>l("completed"),variant:"completed",children:A.length>0?a.jsx("div",{className:"space-y-2",children:A.map(({courseStartDate:e,group:t,participants:s})=>a.jsx(Ge,{groupNumber:t.groupNumber||0,courseStartDate:t.courseStartDate,courseEndDate:t.courseEndDate,participants:s,renderParticipantRow:V,mode:"cards",defaultExpanded:d},e))}):a.jsx("div",{className:"text-center py-8 text-slate-500",children:"Няма приключени групи"})})]}),d&&0===e.length&&a.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 text-center",children:[a.jsx("div",{className:"text-6xl mb-4",children:"🔍"}),a.jsx("h3",{className:"text-lg font-semibold text-slate-700 mb-2",children:"Няма намерени резултати"}),a.jsx("p",{className:"text-sm text-slate-500 mb-6",children:"Опитай да промениш филтрите"})]}),a.jsx(Le,{isOpen:f.isOpen,onClose:()=>v({isOpen:!1,participant:void 0}),onConfirm:()=>{f.participant&&r(f.participant.id),v({isOpen:!1,participant:void 0})},title:m("modal.deleteTitle"),message:m("modal.deleteMessage",{name:(null==(u=f.participant)?void 0:u.personName)||""}),confirmText:m("common.delete"),cancelText:m("common.cancel"),variant:"danger"})]})},Ye=({isOpen:e,onClose:t,participant:r})=>{const{addParticipant:n,updateParticipant:i}=Se(),{t:l}=Te(),[c,d]=s.useState({companyName:"",personName:"",egn:"",birthPlace:"",citizenship:"българско",medicalDate:"",groupAssignmentMode:"auto",selectedGroupId:"",uniqueNumber:""}),[u,m]=s.useState({courseStartDate:"",courseEndDate:""}),[p,x]=s.useState({}),[h,b]=s.useState(!1),[g,f]=s.useState(""),[v,N]=s.useState(null),[w,j]=s.useState({isOpen:!1,message:"",onConfirm:()=>{}}),y=o(()=>pe(),[]),S=o(()=>ee.groups.orderBy("groupNumber").toArray(),[]),[k,D]=s.useState(null);s.useEffect(()=>{c.medicalDate?he(c.medicalDate).then(e=>{if(e.group)D(e.group);else if(e.createsForDate){const t=new Date(e.createsForDate),s=new Date(t);s.setDate(t.getDate()+7),D({groupNumber:null,courseStartDate:e.createsForDate,courseEndDate:s.toISOString().split("T")[0],status:"planned"})}else D(null)}):D(null)},[c.medicalDate]),s.useEffect(()=>{r?(d({companyName:r.companyName,personName:r.personName,egn:r.egn||"",birthPlace:r.birthPlace||"",citizenship:r.citizenship||"българско",medicalDate:r.medicalDate,groupAssignmentMode:"auto",selectedGroupId:"",uniqueNumber:r.uniqueNumber}),m({courseStartDate:r.courseStartDate,courseEndDate:r.courseEndDate}),f("")):(d({companyName:"",personName:"",egn:"",birthPlace:"",citizenship:"българско",medicalDate:"",groupAssignmentMode:"auto",selectedGroupId:"",uniqueNumber:""}),m({courseStartDate:"",courseEndDate:""}),e&&Promise.all([re(),oe()]).then(([e,t])=>{f(e),N(t)}).catch(e=>{f(""),N(null)})),x({})},[r,e]),s.useEffect(()=>{if(k)m({courseStartDate:k.courseStartDate,courseEndDate:k.courseEndDate}),"active"===k.status?Promise.all([re(),oe()]).then(([e,t])=>{f(t||e),N(t),r&&d(e=>({...e,uniqueNumber:""}))}).catch(e=>{}):(f(""),N(null));else if(c.medicalDate)try{const e=X(c.medicalDate);m(e)}catch(e){}},[c.medicalDate,k,r]);const C=async()=>{b(!0);try{const e=e=>e.trim().replace(/\s+/g," ").normalize("NFC"),s={companyName:c.companyName.trim(),personName:e(c.personName),egn:c.egn.trim(),birthPlace:c.birthPlace.trim(),citizenship:c.citizenship.trim()||"българско",medicalDate:c.medicalDate,uniqueNumber:c.uniqueNumber.trim()||v||void 0};r?await i(r.id,s):await n(s),t()}catch(e){alert(`${l("error.saveFailed")}: ${e.message}`)}finally{b(!1)}};return e?a.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",onClick:t,children:[a.jsxs("div",{className:"w-full max-w-2xl p-16 cursor-default",onClick:e=>e.stopPropagation(),children:[a.jsx("div",{className:"bg-white rounded-lg w-full max-h-[85vh] overflow-y-auto shadow-xl",children:a.jsxs("div",{className:"p-6",children:[a.jsx("h2",{className:"text-2xl font-bold mb-4",children:l(r?"modal.editParticipant":"modal.addParticipant")}),r&&a.jsx("div",{className:"mb-4 p-3 bg-slate-50 rounded-lg border border-slate-200",children:a.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[r.createdAt&&a.jsxs("div",{children:[a.jsxs("span",{className:"text-slate-600",children:[l("timestamp.createdAt"),":"]}),a.jsxs("span",{className:"ml-2 font-medium text-slate-900",children:[ue(r.createdAt.split("T")[0])," ",new Date(r.createdAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})]})]}),r.updatedAt&&a.jsxs("div",{children:[a.jsxs("span",{className:"text-slate-600",children:[l("timestamp.updatedAt"),":"]}),a.jsxs("span",{className:"ml-2 font-medium text-slate-900",children:[ue(r.updatedAt.split("T")[0])," ",new Date(r.updatedAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})]})]}),r.completedAt&&a.jsxs("div",{className:"col-span-2",children:[a.jsxs("span",{className:"text-emerald-600",children:[l("timestamp.completedAt"),":"]}),a.jsxs("span",{className:"ml-2 font-medium text-emerald-800",children:[ue(r.completedAt.split("T")[0])," ",new Date(r.completedAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})]})]})]})}),a.jsxs("form",{onSubmit:async e=>{e.preventDefault();if(await(async()=>{const e={};if(c.companyName.trim()||(e.companyName=l("modal.companyNameRequired")),c.personName.trim()||(e.personName=l("modal.personNameRequired")),c.egn.trim()?/^\d{10}$/.test(c.egn)||(e.egn=l("modal.egnInvalid")):e.egn=l("modal.egnRequired"),c.birthPlace.trim()||(e.birthPlace=l("modal.birthPlaceRequired")),c.medicalDate||(e.medicalDate=l("modal.medicalDateRequired")),c.uniqueNumber)if(t=c.uniqueNumber,/^\d{4}-\d+$/.test(t))if(await le(c.uniqueNumber,null==r?void 0:r.id)){if(v&&!r){const t=se(c.uniqueNumber),s=se(v);t&&s&&(t.prefix>s.prefix||t.prefix===s.prefix&&t.seq>s.seq)&&(e.uniqueNumber=l("modal.cannotSkipGap",{number:v}))}}else e.uniqueNumber=l("modal.uniqueNumberExists");else e.uniqueNumber=l("modal.uniqueNumberInvalid");var t;return x(e),0===Object.keys(e).length})()){if("manual"===c.groupAssignmentMode&&c.selectedGroupId){const e=parseInt(c.selectedGroupId,10),t=null==S?void 0:S.find(t=>t.groupNumber===e);if("completed"===(null==t?void 0:t.status))return void x(e=>({...e,selectedGroupId:l("modal.completedGroupError")}));if(!de(c.medicalDate,t.courseStartDate))return void x(e=>({...e,medicalDate:l("modal.medicalDateCourseValidation")}))}else if(!de(c.medicalDate,u.courseStartDate))return void x(e=>({...e,medicalDate:l("modal.medicalDateCourseValidation")}));if("manual"===c.groupAssignmentMode&&c.selectedGroupId){const e=parseInt(c.selectedGroupId,10),t=await he(u.courseStartDate);if(t.group&&t.group.groupNumber!==e){const s=null==S?void 0:S.find(t=>t.groupNumber===e);return void j({isOpen:!0,message:l("modal.groupWarningMessage",{selected:String(e),selectedDate:ue(s.courseStartDate),suggested:String(t.group.groupNumber??""),suggestedDate:ue(t.group.courseStartDate)}),onConfirm:()=>{j({isOpen:!1,message:"",onConfirm:()=>{}}),C()}})}}await C()}},children:[a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:[l("modal.companyName")," *"]}),a.jsxs("select",{value:c.companyName,onChange:e=>d({...c,companyName:e.target.value}),className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[a.jsx("option",{value:"",children:l("modal.selectCompany")}),a.jsx("option",{value:"Egida",children:"Egida"}),a.jsx("option",{value:"D-Max",children:"D-Max"}),a.jsx("option",{value:"Multiforce",children:"Multiforce"})]}),p.companyName&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:p.companyName})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:[l("modal.personName")," *"]}),a.jsx("input",{type:"text",value:c.personName,onChange:e=>d({...c,personName:e.target.value}),className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),p.personName&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:p.personName})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"ЕГН *"}),a.jsx("input",{type:"text",value:c.egn,onChange:e=>d({...c,egn:e.target.value}),placeholder:"XXXXXXXXXX",maxLength:10,className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),p.egn&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:p.egn})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Месторождение *"}),a.jsx("input",{type:"text",value:c.birthPlace,onChange:e=>d({...c,birthPlace:e.target.value}),placeholder:"гр./с. ...",className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),p.birthPlace&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:p.birthPlace})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Гражданство"}),a.jsx("input",{type:"text",value:c.citizenship,onChange:e=>d({...c,citizenship:e.target.value}),placeholder:"българско",className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:[l("modal.medicalDate")," *"]}),a.jsx("input",{type:"date",value:c.medicalDate,onChange:e=>d({...c,medicalDate:e.target.value}),onClick:e=>{var t,s;return null==(s=(t=e.target).showPicker)?void 0:s.call(t)},className:"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer "+(p.medicalDate?"border-red-500":"border-slate-300")}),p.medicalDate&&a.jsx("p",{className:"text-red-600 text-sm mt-1 font-medium",children:p.medicalDate}),c.medicalDate&&!p.medicalDate&&a.jsxs("p",{className:"text-emerald-600 text-sm mt-1",children:["✓ ",l("modal.medicalValid"),": ",ue(c.medicalDate)]})]}),u.courseStartDate&&a.jsxs("div",{className:"bg-blue-50 border border-blue-200 p-4 rounded-md",children:[a.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:l("modal.courseDates")}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-blue-700 mb-1",children:l("modal.courseStart")}),a.jsx("div",{className:"text-lg font-semibold text-blue-900",children:ue(u.courseStartDate)})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-blue-700 mb-1",children:l("modal.courseEnd")}),a.jsx("div",{className:"text-lg font-semibold text-blue-900",children:ue(u.courseEndDate)})]})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:l("modal.groupAssignment")}),a.jsxs("div",{className:"flex gap-2 mb-3",children:[a.jsx("button",{type:"button",onClick:()=>d({...c,groupAssignmentMode:"auto",selectedGroupId:""}),className:"flex-1 px-3 py-2 rounded-md border "+("auto"===c.groupAssignmentMode?"bg-blue-700 text-white border-blue-700":"bg-white text-slate-700 border-slate-300 hover:bg-slate-50"),children:l("modal.auto")}),a.jsx("button",{type:"button",onClick:()=>d({...c,groupAssignmentMode:"manual"}),className:"flex-1 px-3 py-2 rounded-md border "+("manual"===c.groupAssignmentMode?"bg-blue-700 text-white border-blue-700":"bg-white text-slate-700 border-slate-300 hover:bg-slate-50"),children:l("modal.manual")})]}),"auto"===c.groupAssignmentMode&&k&&a.jsx(a.Fragment,{children:"completed"===k.status?a.jsx("div",{className:"bg-red-50 border border-red-200 p-3 rounded-md",children:a.jsxs("p",{className:"text-sm text-red-800 font-medium",children:["⛔ ",l("modal.periodClosed"),a.jsx("br",{}),a.jsxs("span",{className:"text-xs font-normal mt-1 block",children:[l("modal.cannotAddComp",{date:ue(k.courseStartDate)}),a.jsx("br",{}),l("modal.selectOtherDate")]})]})}):a.jsx("div",{className:"bg-emerald-50 border border-emerald-200 p-3 rounded-md",children:a.jsxs("p",{className:"text-sm text-emerald-800",children:["✓ ",l("modal.willBeAssigned")," ",a.jsxs("span",{className:"font-semibold",children:[l("group.number")," ",k.groupNumber||"-"]})," ","(",ue(k.courseStartDate)," - ",ue(k.courseEndDate),")"," ",a.jsx("span",{className:"inline-block px-2 py-0.5 rounded text-xs font-semibold "+("active"===k.status?"bg-blue-100 text-blue-700":"bg-slate-100 text-slate-700"),children:"active"===k.status?l("modal.active"):l("modal.planned")})]})})}),"manual"===c.groupAssignmentMode&&a.jsxs("select",{value:c.selectedGroupId,onChange:e=>d({...c,selectedGroupId:e.target.value}),className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[a.jsx("option",{value:"",children:l("modal.selectGroup")}),y&&a.jsxs("option",{value:(y.groupNumber||"").toString(),children:[l("group.number")," ",y.groupNumber||"-"," - ",ue(y.courseStartDate)," (",l("modal.active"),")"]}),null==S?void 0:S.filter(e=>"planned"===e.status).map(e=>a.jsxs("option",{value:(e.groupNumber||"").toString(),children:[l("group.number")," ",e.groupNumber||"-"," - ",ue(e.courseStartDate)," (",l("modal.planned"),")"]},e.id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:l("modal.uniqueNumberAuto")}),v&&r&&a.jsx("div",{className:"mb-2 p-2 bg-amber-50 border border-amber-300 rounded-md",children:a.jsxs("p",{className:"text-amber-800 text-sm font-medium",children:["⚠️ Участникът ще получи попълващ номер: ",v]})}),r&&"active"===(null==k?void 0:k.status)&&g&&!v&&a.jsx("div",{className:"mb-2 p-2 bg-blue-50 border border-blue-300 rounded-md",children:a.jsxs("p",{className:"text-blue-800 text-sm font-medium",children:["ℹ️ Преместване в активна група → Уникален номер: ",a.jsx("span",{className:"font-bold",children:g})]})}),a.jsx("input",{type:"text",value:c.uniqueNumber,onChange:e=>d({...c,uniqueNumber:e.target.value}),placeholder:g?`${l("modal.uniqueNumberNext")}: ${g}`:"e.g., 3534-001",className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono"}),p.uniqueNumber&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:p.uniqueNumber})]})]}),a.jsxs("div",{className:"mt-6 flex gap-3 justify-end pb-2 md:pb-0",children:[a.jsx("button",{type:"button",onClick:t,className:"px-4 py-2 border border-slate-200 rounded-md text-slate-700 hover:bg-slate-50",disabled:h,children:l("common.cancel")}),a.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-700 text-white rounded-md hover:bg-blue-800 disabled:opacity-50 disabled:cursor-not-allowed",disabled:h||"auto"===c.groupAssignmentMode&&"completed"===(null==k?void 0:k.status),children:l(h?"common.saving":r?"modal.update":"common.add")})]})]})]})})," "]})," ",a.jsx(Le,{isOpen:w.isOpen,onClose:()=>j({isOpen:!1,message:"",onConfirm:()=>{}}),onConfirm:w.onConfirm,title:"Предупреждение за група",message:w.message,confirmText:"Продължи",cancelText:"Отказ",variant:"warning"})]}):null},He=({isOpen:e,onClose:t,searchText:r,onSearchTextChange:n,selectedGroup:i,onSelectedGroupChange:l,statusFilters:o,onStatusFilterChange:c,dateRange:d,onDateRangeChange:u,groups:m,onResetToDefaults:p,visibleCount:x,totalCount:h})=>{const{t:b}=Te(),g=s.useRef(null),f=s.useRef(null);s.useEffect(()=>{if(e)return f.current=window.setInterval(()=>{if(g.current){const e=g.current.value;e!==r&&n(e)}},100),()=>{f.current&&(clearInterval(f.current),f.current=null)};f.current&&(clearInterval(f.current),f.current=null)},[e,r,n]);s.useEffect(()=>{const s=e=>{"Escape"===e.key&&t()};if(e)return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[e,t]);const v=({label:e,value:t,onChange:s})=>a.jsxs("div",{className:"mb-3",children:[a.jsx("span",{className:"text-sm font-medium text-slate-700 mb-1.5 block",children:e}),a.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[a.jsx("button",{onClick:()=>s(null),className:"px-2 py-1.5 text-sm rounded-lg min-h-[36px] font-medium transition-colors duration-150 "+(null===t?"bg-slate-500 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"),children:b("filters.all")}),a.jsx("button",{onClick:()=>s(!0),className:"px-2 py-1.5 text-sm rounded-lg min-h-[36px] font-medium transition-colors duration-150 "+(!0===t?"bg-emerald-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"),children:b("filters.yes")}),a.jsx("button",{onClick:()=>s(!1),className:"px-2 py-1.5 text-sm rounded-lg min-h-[36px] font-medium transition-colors duration-150 "+(!1===t?"bg-red-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"),children:b("filters.no")})]})]});return e?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 bg-black/30 z-40 transition-opacity",onClick:t}),a.jsxs("div",{className:`fixed z-50 bg-white shadow-2xl transition-transform\n          md:top-0 md:left-0 md:bottom-auto md:right-auto md:h-auto md:max-h-[calc(100vh-16px)] md:w-[360px] lg:w-[420px] md:max-w-[480px] md:translate-x-0\n          bottom-0 left-0 right-0 max-h-[90vh] rounded-t-3xl md:rounded-none flex flex-col\n          ${e?"translate-y-0":"translate-y-full md:translate-y-0 md:-translate-x-full"}\n        `,children:[a.jsx("div",{className:"md:hidden flex justify-center pt-3 pb-2",children:a.jsx("div",{className:"w-12 h-1.5 bg-slate-300 rounded-full"})}),a.jsxs("div",{className:"sticky top-0 bg-white flex items-center justify-between p-4 border-b border-slate-200 z-10",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("h3",{className:"text-lg font-bold text-slate-900",children:b("filters.title")}),void 0!==x&&void 0!==h&&a.jsxs("span",{className:"text-sm font-medium text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full",children:[x," / ",h]})]}),a.jsx("button",{onClick:t,className:"p-2 hover:bg-slate-100 rounded-lg min-w-[44px] min-h-[44px] transition-colors duration-150",children:a.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),a.jsxs("div",{className:"p-4 pb-4 flex-1 md:flex-none overflow-y-auto overscroll-contain",children:[a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:b("filters.search")}),a.jsx("input",{ref:g,type:"search",inputMode:"search",autoComplete:"off",value:r,onChange:e=>n(e.target.value),onKeyDown:e=>{"Enter"===e.key&&t()},placeholder:b("filters.searchPlaceholder"),className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150"})]}),a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:b("filters.group")}),a.jsxs("select",{value:i,onChange:e=>l(e.target.value),className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150",children:[a.jsx("option",{value:"",children:b("filters.allGroups")}),m.map(e=>a.jsx("option",{value:e.groupNumber.toString(),children:b("filters.groupOption",{number:e.groupNumber.toString(),date:e.courseStartDate})},e.groupNumber))]})]}),a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:b("filters.dateRange")}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("input",{type:"date",value:d.start,onChange:e=>u({...d,start:e.target.value}),onClick:e=>{var t,s;return null==(s=(t=e.target).showPicker)?void 0:s.call(t)},className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150 cursor-pointer"}),a.jsx("input",{type:"date",value:d.end,onChange:e=>u({...d,end:e.target.value}),onClick:e=>{var t,s;return null==(s=(t=e.target).showPicker)?void 0:s.call(t)},className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150 cursor-pointer"})]})]}),a.jsxs("div",{className:"border-t border-slate-200 pt-4 mt-4",children:[a.jsx("h4",{className:"font-medium text-slate-900 mb-4",children:b("filters.statusFilters")}),a.jsx(v,{label:b("participant.sent"),value:o.sent,onChange:e=>c("sent",e)}),a.jsx(v,{label:b("participant.documents"),value:o.documents,onChange:e=>c("documents",e)}),a.jsx(v,{label:b("participant.handed"),value:o.handedOver,onChange:e=>c("handedOver",e)}),a.jsx(v,{label:b("participant.paid"),value:o.paid,onChange:e=>c("paid",e)}),a.jsx(v,{label:b("participant.completed"),value:o.completed,onChange:e=>c("completed",e)})]}),a.jsxs("div",{className:"mt-6 mb-6 pb-8 flex gap-3",children:[a.jsx("button",{onClick:()=>{n(""),l(""),u({start:"",end:""}),c("sent",null),c("documents",null),c("handedOver",null),c("paid",null),c("completed",null),p()},className:"flex-1 px-4 py-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 font-medium min-h-[48px] transition-colors duration-150",children:b("filters.clearAll")}),a.jsx("button",{onClick:t,className:"flex-1 px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium min-h-[48px] transition-colors duration-150",children:b("filters.apply")})]})]})]})]}):null},Ke=({activeFilters:e,onRemoveFilter:t})=>{var s,r;const{t:n}=Te(),i=[];return e.searchText&&i.push({label:`${n("filters.search")}: "${e.searchText}"`,type:"search"}),e.selectedGroup&&i.push({label:`${n("filters.group")}: ${e.selectedGroup}`,type:"group"}),(null==(s=e.dateRange)?void 0:s.start)&&i.push({label:`${n("filters.from")}: ${ue(e.dateRange.start)}`,type:"dateStart"}),(null==(r=e.dateRange)?void 0:r.end)&&i.push({label:`${n("filters.to")}: ${ue(e.dateRange.end)}`,type:"dateEnd"}),e.statusFilters&&Object.entries(e.statusFilters).forEach(([e,t])=>{if(null!==t){const s=`participant.${e}`;i.push({label:`${n(s)}: ${n(t?"filters.yes":"filters.no")}`,type:"status",value:e})}}),0===i.length?null:a.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[i.map((e,s)=>a.jsxs("button",{onClick:()=>t(e.type,e.value),className:"inline-flex items-center gap-2 px-3 py-1.5 bg-blue-100 text-blue-800 rounded-full text-sm hover:bg-blue-200 transition-colors duration-150",children:[a.jsx("span",{children:e.label}),a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]},s)),a.jsx("button",{onClick:()=>t("all"),className:"px-3 py-1.5 bg-slate-200 text-slate-700 rounded-full text-sm hover:bg-slate-300 transition-colors duration-150",children:"Clear All"})]})},Xe="app_pin_config";function Je(e){const t=new Uint8Array(e);let s="";const a=t.byteLength;for(let r=0;r<a;r+=8192)s+=String.fromCharCode.apply(null,t.subarray(r,r+8192));return window.btoa(s)}async function Ze(e,t){let s;s=t?function(e){try{const t=window.atob(e),s=t.length,a=new Uint8Array(s);for(let e=0;e<s;e++)a[e]=t.charCodeAt(e);return a}catch(t){throw new Error("Invalid Base64 string")}}(t):window.crypto.getRandomValues(new Uint8Array(16));const a=new TextEncoder,r=await window.crypto.subtle.importKey("raw",a.encode(e),{name:"PBKDF2"},!1,["deriveBits","deriveKey"]);return{hash:Je(await window.crypto.subtle.deriveBits({name:"PBKDF2",salt:s,iterations:3e5,hash:"SHA-256"},r,256)),salt:Je(s.buffer)}}async function Qe(e,t){try{const{hash:s}=await Ze(e,t.salt);return s===t.hash}catch(s){return!1}}function et(){const e=localStorage.getItem(Xe);if(!e)return null;try{return JSON.parse(e)}catch(t){return null}}function tt(){localStorage.removeItem(Xe)}function st(){return!!localStorage.getItem(Xe)}const at=({mode:e,onSuccess:t,onCancel:r,onResetData:n})=>{const{t:i}=Te(),[l,o]=s.useState(""),[c,d]=s.useState(""),[u,m]=s.useState("enter"),[p,x]=s.useState(null),[h,b]=s.useState(!1),[g,f]=s.useState(!1);s.useEffect(()=>{o(""),d(""),m("enter"),x(null)},[e]);const v=e=>{if(h)return;x(null);const t="enter"===u?l:c;if(t.length<4){const s=t+e.toString();"enter"===u?o(s):d(s),4===s.length&&w(s)}},N=()=>{h||(x(null),"enter"===u?o(e=>e.slice(0,-1)):d(e=>e.slice(0,-1)))},w=async s=>{b(!0),await new Promise(e=>setTimeout(e,100));try{if("unlock"===e){const e=et();if(!e)return void t();await Qe(s,e)?t():(x(i("security.incorrectPin")),o(""))}else if("setup"===e){if("enter"===u)return m("confirm"),void b(!1);if(s===l){const{hash:e,salt:r}=await Ze(s);a={version:1,hash:e,salt:r,algo:"PBKDF2-SHA-256",createdAt:(new Date).toISOString()},localStorage.setItem(Xe,JSON.stringify(a)),t()}else x(i("security.pinMismatch")),o(""),d(""),m("enter")}else if("disable"===e){const e=et();e&&await Qe(s,e)?(tt(),t()):(x(i("security.incorrectPin")),o(""))}}catch(r){x(i("security.error"))}finally{b(!1)}var a};return a.jsxs("div",{className:"fixed inset-0 bg-slate-50 z-[100] flex flex-col items-center justify-center p-4 animate-in fade-in duration-300",children:[a.jsxs("div",{className:"w-full max-w-sm text-center",children:[a.jsx("div",{className:"mb-6 flex justify-center",children:a.jsx("div",{className:"p-4 rounded-full "+(p?"bg-red-100":"bg-blue-100"),children:"unlock"===e?a.jsx(E,{className:"w-8 h-8 "+(p?"text-red-600":"text-blue-600")}):a.jsx(A,{className:"w-8 h-8 text-blue-600"})})}),a.jsx("h2",{className:"text-2xl font-bold mb-2 "+(p?"text-red-600":"text-slate-800"),children:i("setup"===e?"enter"===u?"security.setPinTitle":"security.confirmPinTitle":"disable"===e?"security.enterPinToDisable":"security.appLocked")}),a.jsx("p",{className:"text-sm mb-8 font-medium "+(p?"text-red-500":"text-slate-500"),children:p||i("setup"===e?"enter"===u?"security.enter4DigitPin":"security.reEnterToConfirm":"security.enterYourPin")}),(j="enter"===u?l:c,a.jsx("div",{className:"flex gap-4 justify-center mb-6",children:[0,1,2,3].map(e=>a.jsx("div",{className:`w-4 h-4 rounded-full border-2 transition-all duration-200 ${e<j.length?"bg-blue-600 border-blue-600":"bg-transparent border-slate-300"} ${p?"border-red-400 bg-red-50":""}`},e))})),a.jsxs("div",{className:"grid grid-cols-3 gap-4 max-w-[280px] mx-auto mt-8",children:[[1,2,3,4,5,6,7,8,9].map(e=>a.jsx("button",{onClick:()=>v(e),className:"w-16 h-16 rounded-full bg-slate-100 text-slate-700 text-2xl font-bold hover:bg-slate-200 active:bg-slate-300 transition-colors flex items-center justify-center shadow-sm",children:e},e)),a.jsx("div",{className:"w-16 h-16 flex items-center justify-center",children:"unlock"===e&&a.jsx("button",{onClick:()=>f(!0),className:"text-xs text-slate-400 font-medium hover:text-red-500 transition-colors",children:i("security.forgot")})}),a.jsx("button",{onClick:()=>v(0),className:"w-16 h-16 rounded-full bg-slate-100 text-slate-700 text-2xl font-bold hover:bg-slate-200 active:bg-slate-300 transition-colors flex items-center justify-center shadow-sm",children:"0"}),a.jsx("button",{onClick:N,className:"w-16 h-16 rounded-full text-slate-500 hover:text-slate-700 hover:bg-slate-100 active:bg-slate-200 transition-colors flex items-center justify-center",children:a.jsx(O,{className:"w-6 h-6"})})]}),r&&a.jsx("button",{onClick:r,className:"mt-8 text-slate-500 hover:text-slate-700 font-medium text-sm",children:i("common.cancel")})]}),g&&a.jsx(Le,{isOpen:g,onClose:()=>f(!1),onConfirm:()=>{n&&(tt(),n()),f(!1)},title:i("security.resetDataTitle"),message:i("security.resetDataMessage"),confirmText:i("security.resetDataConfirm"),variant:"danger"})]});var j},rt=6e5,nt=({children:e})=>{const[t,r]=s.useState(!1),[n,i]=s.useState(!1),l=s.useRef(Date.now()),o=s.useRef(null);s.useEffect(()=>{st()&&r(!0),i(!0)},[]);const c=s.useCallback(()=>{st()&&r(!0)},[]),d=s.useCallback(()=>{r(!1),l.current=Date.now()},[]);s.useEffect(()=>{if(t)return;const e=["mousedown","keydown","touchstart","scroll","mousemove"];let s=null;const a=()=>{s||(l.current=Date.now(),s=setTimeout(()=>{s=null},1e3))};e.forEach(e=>window.addEventListener(e,a));const n=()=>{if(!document.hidden&&st()){Date.now()-l.current>rt&&r(!0)}};return document.addEventListener("visibilitychange",n),o.current=setInterval(()=>{if(document.hidden)return;Date.now()-l.current>rt&&st()&&r(!0)},5e3),()=>{e.forEach(e=>window.removeEventListener(e,a)),document.removeEventListener("visibilitychange",n),o.current&&clearInterval(o.current),s&&clearTimeout(s)}},[t]),s.useEffect(()=>{const e=()=>c();return window.addEventListener("app-lock-manual",e),()=>window.removeEventListener("app-lock-manual",e)},[c]);const u=async()=>{try{await ee.delete(),await ee.open(),tt(),window.location.reload()}catch(e){alert("Failed to reset data. Please clear browser storage manually.")}};return n?t?a.jsx(at,{mode:"unlock",onSuccess:d,onResetData:u}):a.jsx(a.Fragment,{children:e}):null},it=()=>{window.dispatchEvent(new Event("app-lock-manual"))},lt=({activeTab:e,onTabChange:t,onBack:s})=>{const{t:r}=Te();return a.jsx("header",{className:"bg-blue-700 text-white shadow-sm sticky top-0 z-40",children:a.jsx("div",{className:"container mx-auto px-4 py-4",children:a.jsxs("div",{className:"flex items-center gap-3",children:[s&&a.jsx("button",{onClick:s,className:"md:hidden p-2 hover:bg-blue-700 rounded-lg",children:a.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),a.jsx("div",{className:"flex-shrink-0 w-14 h-14 md:w-16 md:h-16 bg-white rounded-md flex items-center justify-center overflow-hidden",children:a.jsx("img",{src:"./Logo.svg",alt:"Logo",className:"w-full h-full object-cover scale-[2.4]"})}),a.jsxs("div",{className:"flex-1",children:[a.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"CERTIFY"}),a.jsx("p",{className:"text-sm md:text-base text-blue-100",children:r("nav.subtitle")})]}),a.jsxs("div",{className:"hidden md:flex gap-2",children:[a.jsxs("button",{onClick:()=>t("participants"),className:"px-6 py-2 rounded-lg font-medium transition-colors duration-150 flex items-center gap-2 "+("participants"===e?"bg-white text-blue-800":"bg-blue-700/30 text-white hover:bg-blue-700/50"),children:[a.jsx(q,{className:"w-5 h-5",strokeWidth:2}),r("nav.participants")]}),a.jsxs("button",{onClick:()=>t("tools"),className:"px-6 py-2 rounded-lg font-medium transition-colors duration-150 flex items-center gap-2 "+("tools"===e?"bg-white text-blue-800":"bg-blue-700/30 text-white hover:bg-blue-700/50"),children:[a.jsx(P,{className:"w-5 h-5",strokeWidth:2}),r("nav.tools")]}),st()&&a.jsxs("button",{onClick:()=>it(),className:"px-4 py-2 ml-2 rounded-lg font-medium bg-indigo-600 text-white hover:bg-indigo-500 border border-indigo-400/50 shadow-sm transition-all duration-150 flex items-center gap-2",title:r("nav.lock"),children:[a.jsx(E,{className:"w-5 h-5",strokeWidth:2}),a.jsx("span",{className:"hidden lg:inline",children:r("nav.lock")})]})]})]})})})},ot=({totalParticipants:e,visibleParticipants:t,totalCourses:r,visibleCourses:n,completedCount:i})=>{const{t:l}=Te(),[o,c]=s.useState(!1);return a.jsxs("div",{className:"mb-4",children:[a.jsxs("div",{className:"md:hidden",children:[a.jsxs("button",{onClick:()=>c(!o),className:"w-full bg-white rounded-lg px-2 py-2 shadow-sm border border-slate-200 flex items-center justify-between mb-1",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("div",{className:"text-left",children:[a.jsx("div",{className:"text-[11px] font-medium text-slate-500",children:l("participants.showing")}),a.jsxs("div",{className:"text-lg font-bold text-blue-600",children:[t,"/",e]})]}),a.jsxs("div",{className:"text-left",children:[a.jsx("div",{className:"text-[11px] font-medium text-slate-500",children:l("participant.completed")}),a.jsx("div",{className:"text-lg font-bold text-emerald-700",children:i})]})]}),a.jsx("svg",{className:"w-4 h-4 text-slate-500 transition-transform duration-200 "+(o?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),o&&a.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-1",children:[a.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-slate-400",children:[a.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-xs uppercase tracking-wide text-slate-900 font-semibold whitespace-nowrap",children:l("participants.total")}),a.jsx("div",{className:"text-[9px] text-transparent font-medium mt-0.5 select-none",children:" "})]}),a.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:a.jsx(q,{className:"w-3.5 h-3.5 text-slate-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-2xl font-semibold tracking-tight text-slate-900",children:e})]}),a.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-blue-500",children:[a.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-xs uppercase tracking-wide text-blue-600 font-semibold whitespace-nowrap",children:l("participants.showing")}),a.jsx("div",{className:"text-[9px] text-slate-500 font-medium mt-0.5",children:l("participants.showingSubtext")})]}),a.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:a.jsx(T,{className:"w-3.5 h-3.5 text-blue-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-2xl font-semibold tracking-tight text-blue-600",children:t})]}),a.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-indigo-500",children:[a.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-xs uppercase tracking-wide text-indigo-600 font-semibold whitespace-nowrap",children:l("participants.totalCourses")}),a.jsx("div",{className:"text-[9px] text-slate-500 font-medium mt-0.5",children:l("participants.totalCoursesSubtext")})]}),a.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:a.jsx(L,{className:"w-3.5 h-3.5 text-indigo-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-2xl font-semibold tracking-tight text-indigo-600",children:r})]}),a.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-cyan-500",children:[a.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-xs uppercase tracking-wide text-cyan-600 font-semibold whitespace-nowrap",children:l("participants.visibleCourses")}),a.jsx("div",{className:"text-[9px] text-slate-500 font-medium mt-0.5",children:l("participants.visibleCoursesSubtext")})]}),a.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:a.jsx(b,{className:"w-3.5 h-3.5 text-cyan-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-2xl font-semibold tracking-tight text-cyan-600",children:n})]}),a.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-amber-500 col-span-2",children:[a.jsxs("div",{className:"flex items-center justify-between mb-1",children:[a.jsx("div",{className:"text-xs uppercase tracking-wide text-amber-600 font-semibold whitespace-nowrap",children:l("participants.completed")}),a.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:a.jsx(M,{className:"w-3.5 h-3.5 text-amber-600",strokeWidth:2})})]}),a.jsxs("div",{className:"flex items-baseline gap-1",children:[a.jsx("div",{className:"text-xl font-semibold tracking-tight text-amber-600",children:i}),a.jsxs("div",{className:"text-xs text-slate-500",children:["/ ",t," (",t>0?Math.round(i/t*100):0,"%)"]})]})]})]})]}),a.jsxs("div",{className:"hidden md:grid grid-cols-5 gap-4 mb-2",children:[a.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-slate-400 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[a.jsxs("div",{className:"flex items-center justify-between mb-3",children:[a.jsx("div",{className:"text-sm uppercase tracking-wide text-slate-900 font-semibold whitespace-nowrap",children:l("participants.total")}),a.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:a.jsx(q,{className:"w-[18px] h-[18px] text-slate-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-3xl font-semibold tracking-tight text-slate-900 mt-auto",children:e})]}),a.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-blue-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[a.jsxs("div",{className:"flex items-center justify-between mb-2",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-base uppercase tracking-wide text-blue-600 font-semibold whitespace-nowrap",children:l("participants.showing")}),a.jsx("div",{className:"text-[10px] text-slate-500 font-medium mt-0.5",children:l("participants.showingSubtext")})]}),a.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:a.jsx(T,{className:"w-[18px] h-[18px] text-blue-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-4xl font-semibold tracking-tight text-blue-600 mt-auto",children:t})]}),a.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-indigo-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[a.jsxs("div",{className:"flex items-center justify-between mb-2",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-base uppercase tracking-wide text-indigo-600 font-semibold whitespace-nowrap",children:l("participants.totalCourses")}),a.jsx("div",{className:"text-[10px] text-slate-500 font-medium mt-0.5",children:l("participants.totalCoursesSubtext")})]}),a.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:a.jsx(L,{className:"w-[18px] h-[18px] text-indigo-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-3xl font-semibold tracking-tight text-indigo-600 mt-auto",children:r})]}),a.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-cyan-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[a.jsxs("div",{className:"flex items-center justify-between mb-2",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-base uppercase tracking-wide text-cyan-600 font-semibold whitespace-nowrap",children:l("participants.visibleCourses")}),a.jsx("div",{className:"text-[10px] text-slate-500 font-medium mt-0.5",children:l("participants.visibleCoursesSubtext")})]}),a.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:a.jsx(b,{className:"w-[18px] h-[18px] text-cyan-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-4xl font-semibold tracking-tight text-cyan-600 mt-auto",children:n})]}),a.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-amber-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[a.jsxs("div",{className:"flex items-center justify-between mb-3",children:[a.jsx("div",{className:"text-sm uppercase tracking-wide text-amber-600 font-semibold whitespace-nowrap",children:l("participants.completed")}),a.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:a.jsx(M,{className:"w-[18px] h-[18px] text-amber-600",strokeWidth:2})})]}),a.jsxs("div",{className:"flex items-baseline gap-2 mt-auto",children:[a.jsx("div",{className:"text-3xl font-semibold tracking-tight text-amber-600",children:i}),a.jsxs("div",{className:"text-sm text-slate-500",children:["/ ",t," (",t>0?Math.round(i/t*100):0,"%)"]})]})]})]})]})},ct=({activeTab:e,onTabChange:t})=>{const{t:s}=Te();return a.jsx("nav",{className:"md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-sm z-50",children:a.jsxs("div",{className:"flex",children:[a.jsxs("button",{onClick:()=>t("participants"),className:"flex-1 flex flex-col items-center justify-center py-3 transition-colors duration-150 "+("participants"===e?"text-blue-700":"text-slate-400"),children:[a.jsx(q,{className:"w-6 h-6 mb-1",strokeWidth:2}),a.jsx("span",{className:"text-xs "+("participants"===e?"font-semibold":"font-medium"),children:s("nav.participants")})]}),a.jsxs("button",{onClick:()=>t("tools"),className:"flex-1 flex flex-col items-center justify-center py-3 transition-colors duration-150 "+("tools"===e?"text-blue-700":"text-slate-400"),children:[a.jsx(P,{className:"w-6 h-6 mb-1",strokeWidth:2}),a.jsx("span",{className:"text-xs "+("tools"===e?"font-semibold":"font-medium"),children:s("nav.tools")})]})]})})},dt=({onClick:e})=>{const{t:t}=Te();return a.jsx("button",{onClick:e,className:"md:hidden fixed bottom-24 right-6 w-14 h-14 bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white rounded-full shadow-lg flex items-center justify-center z-40 active:scale-95 transition-all duration-150",style:{minWidth:"56px",minHeight:"56px"},"aria-label":t("participants.add"),children:a.jsx("svg",{className:"w-7 h-7",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M12 4v16m8-8H4"})})})};let ut;const mt=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,pt=/[<>'"`;\\]/;function xt(e){return e.trim().toLowerCase()}function ht(e){return[/(\bOR\b|\bAND\b)\s*['"]?\d+['"]?\s*=\s*['"]?\d+/i,/UNION\s+SELECT/i,/DROP\s+TABLE/i,/INSERT\s+INTO/i,/DELETE\s+FROM/i,/UPDATE\s+\w+\s+SET/i,/--\s*$/m,/\/\*.*\*\//s,/;\s*DROP/i,/'\s*OR\s*'/i,/admin'\s*--/i].some(t=>t.test(e))}function bt(e,t){const s=function(e){if(!e||0===e.trim().length)return{isValid:!1,error:"Email is required"};const t=xt(e);return t.length>254?{isValid:!1,error:"Email is too long"}:mt.test(t)?pt.test(t)?{isValid:!1,error:"Email contains invalid characters"}:{isValid:!0}:{isValid:!1,error:"Invalid email format"}}(e),a=function(e,t="Password"){return e&&0!==e.length?e.length<8?{isValid:!1,error:`${t} must be at least 8 characters`}:e.length>128?{isValid:!1,error:`${t} is too long`}:{isValid:!0}:{isValid:!1,error:`${t} is required`}}(t);return ht(e)||ht(t)?{isValid:!1,emailError:"Invalid characters detected",passwordError:"Invalid characters detected"}:{isValid:s.isValid&&a.isValid,emailError:s.error,passwordError:a.error}}const gt="spi.entitlement.cache.v1",ft={configured:!1,authenticated:!1,status:"unknown",readOnly:!1,planCode:null,daysUntilReadOnly:null,currentPeriodEnd:null,graceUntil:null,error:null,lastCheckedAt:null},vt=s.createContext(void 0);function Nt(e){localStorage.setItem(gt,JSON.stringify(e))}const wt=({children:e})=>{const t=s.useMemo(()=>(void 0!==ut||(ut=K("https://xxkqorvdmksyeyoftlgu.supabase.co","sb_publishable_F6tEV-grkbpwT4Ndhg5r8A__mNzR53l",{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}})),ut),[]),[r,n]=s.useState(()=>function(){try{const e=localStorage.getItem(gt);if(!e)return ft;const t=JSON.parse(e);return{...ft,...t,error:null}}catch{return ft}}()),[i,l]=s.useState(!1),[o,c]=s.useState(!1),[d,u]=s.useState(null);s.useEffect(()=>{const e=window.location.hash;if(!e||e.length<2)return;const t=new URLSearchParams(e.slice(1)),s=t.get("error_description");s&&u(s.replace(/\+/g," "));const a=t.get("type"),r=Boolean(t.get("access_token")||t.get("code"));"recovery"===a&&r&&(c(!0),u(null))},[]),s.useEffect(()=>{Z(r.readOnly)},[r.readOnly]);const m=s.useCallback(async(e=!1)=>{if(!t){const e={...ft,configured:!1,readOnly:!1,lastCheckedAt:(new Date).toISOString()};return n(e),Nt(e),void Z(!1)}e||l(!0);try{const{data:e,error:s}=await t.auth.getSession();if(s)throw s;if(!e.session){const e={...ft,configured:!0,authenticated:!1,readOnly:!1,lastCheckedAt:(new Date).toISOString()};return n(e),Nt(e),void Z(!1)}const{data:a,error:r}=await t.rpc("entitlement_me",{p_tenant_id:null});if(r)throw r;const i=Array.isArray(a)?a[0]:a;if(!i)throw new Error("Entitlement data is missing.");const l={configured:!0,authenticated:!0,status:i.status||"unknown",readOnly:Boolean(i.read_only),planCode:i.plan_code||null,daysUntilReadOnly:"number"==typeof i.days_until_read_only?i.days_until_read_only:null,currentPeriodEnd:i.current_period_end||null,graceUntil:i.grace_until||null,error:null,lastCheckedAt:(new Date).toISOString()};n(l),Nt(l),Z(l.readOnly)}catch(s){const a=function(e){if(!e)return"Entitlement check failed.";if(e instanceof Error)return e.message;if("object"==typeof e&&null!==e){const t=e.message;if("string"==typeof t&&t.trim().length>0)return t}return"Entitlement check failed."}(s),r=a.toLowerCase();if(r.includes("jwt")||r.includes("refresh token")||r.includes("session")||r.includes("invalid token")){await t.auth.signOut();const e={...ft,configured:!0,authenticated:!1,readOnly:!1,error:null,lastCheckedAt:(new Date).toISOString()};return n(e),Nt(e),void Z(!1)}e||n(e=>({...e,configured:!0,error:a,lastCheckedAt:(new Date).toISOString()}))}finally{e||l(!1)}},[t]),p=s.useCallback(async(e,s)=>{if(!t)throw new Error("Supabase is not configured.");const a=bt(e,s);if(!a.isValid){const e=a.emailError||a.passwordError||"Invalid credentials";throw new Error(e)}const{error:r}=await t.auth.signInWithPassword({email:xt(e),password:s});if(r)throw r;await m()},[m,t]),x=s.useCallback(async()=>{if(!t)return;const{error:e}=await t.auth.signOut();if(e)throw e;await m()},[m,t]),h=s.useCallback(async e=>{if(!t)throw new Error("Supabase is not configured.");const s=bt(e,"dummy-password-for-email-only");if(s.emailError)throw new Error(s.emailError);const a=window.location.pathname.endsWith("/")?window.location.pathname:`${window.location.pathname}/`,{error:r}=await t.auth.resetPasswordForEmail(xt(e),{redirectTo:`${window.location.origin}${a}`});if(r)throw r},[t]),b=s.useCallback(async e=>{if(!t)throw new Error("Supabase is not configured.");const s=bt("dummy@email.com",e);if(s.passwordError)throw new Error(s.passwordError);const{error:a}=await t.auth.updateUser({password:e});if(a)throw a;c(!1),window.history.replaceState({},document.title,window.location.pathname+window.location.search),await m()},[m,t]),g=s.useCallback(()=>{u(null),window.location.hash&&window.history.replaceState({},document.title,window.location.pathname+window.location.search)},[]);return s.useEffect(()=>{let e=!0,s=0;const a=async(t=!1)=>{e&&(await m(t),s=Date.now())};a(!1);const r=window.setInterval(()=>{a(!0)},12e4),n=()=>{Date.now()-s>1e4&&a(!0)};window.addEventListener("focus",n);const{data:{subscription:i}}=t?t.auth.onAuthStateChange(e=>{"PASSWORD_RECOVERY"===e&&(c(!0),u(null)),"SIGNED_OUT"===e&&c(!1),a(!1)}):{data:{subscription:{unsubscribe:()=>{}}}};return()=>{e=!1,window.clearInterval(r),window.removeEventListener("focus",n),i.unsubscribe()}},[m,t]),a.jsx(vt.Provider,{value:{entitlement:r,loading:i,recoveryMode:o,authLinkError:d,refresh:m,signInWithPassword:p,signOut:x,requestPasswordReset:h,updatePassword:b,clearAuthLinkError:g},children:e})};function jt(){return{settings:o(()=>async function(){return ee.settings.get(1)}()),updateSettings:async e=>{await async function(e){await ee.settings.update(1,e)}(e)},resetYearlySequence:async()=>{await async function(){const e=await ee.settings.get(1);if(!e)return;const t=e.lastUniquePrefix+1;await ee.settings.update(1,{lastUniquePrefix:t,lastUniqueSeq:0,lastResetYear:(new Date).getFullYear()})}()}}}const yt=1e5,St=2e6;function kt(e){const t=e instanceof Uint8Array?e:new Uint8Array(e);let s="";const a=t.byteLength;for(let r=0;r<a;r+=8192)s+=String.fromCharCode.apply(null,t.subarray(r,r+8192));return window.btoa(s)}function Dt(e){const t=window.atob(e),s=t.length,a=new Uint8Array(s);for(let r=0;r<s;r++)a[r]=t.charCodeAt(r);return a}async function Ct(e,t,s=1e5){const a=new TextEncoder,r=await window.crypto.subtle.importKey("raw",a.encode(e),{name:"PBKDF2"},!1,["deriveKey"]);return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:s,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function Et(e,t){const s=JSON.stringify(e),a=(r=s,(new TextEncoder).encode(r));var r;const n=window.crypto.getRandomValues(new Uint8Array(16)),i=window.crypto.getRandomValues(new Uint8Array(12)),l=await Ct(t,n,yt),o=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:i},l,a);return{version:1,kdf:"PBKDF2-SHA256",salt:kt(n),iv:kt(i),ciphertext:kt(o),iterations:yt}}async function At(e,t){try{const a=Dt(e.salt),r=Dt(e.iv),n=Dt(e.ciphertext),i=function(e){if(null==e)return yt;if("number"!=typeof e||!Number.isFinite(e)||!Number.isInteger(e))throw new Error("Invalid backup format: iterations must be a valid integer.");if(e<5e4||e>St)throw new Error("Invalid backup format: iterations must be between 50000 and 2000000.");return e}(e.iterations),l=await Ct(t,a,i),o=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:r},l,n),c=(s=o,(new TextDecoder).decode(s));return JSON.parse(c)}catch(a){throw new Error("Decryption failed. Wrong password or corrupted file.")}var s}function Ot(e){const t=e.participants.map(e=>{const t={...e};return delete t.groupNumber,delete t.autoGroup,delete t.manualGroup,t}),s=e.groups.map(e=>{const t={...e};return"planned"===t.status&&(t.groupNumber=null),t});return{...e,version:2,participants:t,groups:s}}async function qt(e,t){if("showSaveFilePicker"in window)try{const s=t.split(".").pop()||"",a={suggestedName:t,types:[]};"json"===s?a.types=[{description:"JSON файл",accept:{"application/json":[".json"]}}]:"xlsx"===s?a.types=[{description:"Excel файл",accept:{"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":[".xlsx"]}}]:"csv"===s?a.types=[{description:"CSV файл",accept:{"text/csv":[".csv"]}}]:"docx"===s&&(a.types=[{description:"Word документ",accept:{"application/vnd.openxmlformats-officedocument.wordprocessingml.document":[".docx"]}}]);const r=await window.showSaveFilePicker(a),n=await r.createWritable();return await n.write(e),void(await n.close())}catch(r){if("AbortError"===r.name)return}const s=URL.createObjectURL(e),a=document.createElement("a");a.href=s,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s)}const Pt=({isOpen:e,mode:t,onConfirm:r,onCancel:n,error:i,isProcessing:l=!1})=>{const{t:o}=Te(),[c,d]=s.useState(""),[u,m]=s.useState(!1);return e?a.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",children:a.jsx("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full overflow-hidden animate-in fade-in zoom-in duration-200",children:a.jsxs("div",{className:"p-6",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-4 text-slate-800",children:[a.jsx("div",{className:"p-3 bg-blue-100 rounded-full",children:a.jsx(E,{className:"w-6 h-6 text-blue-600"})}),a.jsx("h3",{className:"text-xl font-bold",children:o("export"===t?"crypto.exportTitle":"crypto.importTitle")})]}),a.jsx("p",{className:"text-slate-600 mb-6",children:o("export"===t?"crypto.exportDescription":"crypto.importDescription")}),a.jsxs("form",{onSubmit:e=>{e.preventDefault(),c&&r(c)},className:"space-y-4",children:[a.jsxs("div",{className:"relative",children:[a.jsx("input",{type:u?"text":"password",value:c,onChange:e=>d(e.target.value),placeholder:o("crypto.passwordPlaceholder"),className:"w-full px-4 py-3 pr-12 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",autoFocus:!0,disabled:l}),a.jsx("button",{type:"button",onClick:()=>m(!u),className:"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600",tabIndex:-1,children:u?a.jsx(I,{size:20}):a.jsx(T,{size:20})})]}),i&&a.jsxs("div",{className:"p-3 bg-red-50 text-red-600 text-sm rounded-lg flex items-center gap-2 animate-pulse",children:[a.jsx("span",{children:"⚠️"})," ",i]}),a.jsxs("div",{className:"flex gap-3 pt-2",children:[a.jsx("button",{type:"button",onClick:n,disabled:l,className:"flex-1 px-4 py-2 text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg font-medium transition-colors",children:o("common.cancel")}),a.jsxs("button",{type:"submit",disabled:!c||l,className:"flex-1 px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg font-bold shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2",children:[l&&a.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),o("export"===t?"crypto.encryptAndExport":"crypto.decryptAndImport")]})]})]})]})})}):null},Tt=({isOpen:e,onClose:t,entitlement:s,entitlementLoading:r=!1,onSignOut:n})=>{const{t:i,language:l}=Te();if(!e)return null;const o=e=>function(e,t,s,a){if(!e)return a;const r=e instanceof Date?e:new Date(e);return Number.isNaN(r.getTime())?a:new Intl.DateTimeFormat(t,{timeZone:s,day:"2-digit",month:"2-digit",year:"numeric"}).format(r)}(e,"bg"===l?"bg-BG":"en-GB","Europe/Sofia",i("tools.notAvailable")),c=(()=>{const e=(null==s?void 0:s.status)??"unknown";return i("active"===e?"tools.subscriptionStatusActive":"grace"===e?"tools.subscriptionStatusGrace":"expired"===e?"tools.subscriptionStatusExpired":"tools.subscriptionStatusUnknown")})(),d=(()=>{const e=(null==s?void 0:s.status)??"unknown";return"active"===e?"text-emerald-700 bg-emerald-50 border-emerald-200":"grace"===e?"text-amber-800 bg-amber-50 border-amber-200":"expired"===e?"text-red-700 bg-red-50 border-red-200":"text-slate-700 bg-slate-50 border-slate-200"})(),u=(()=>{const e=(null==s?void 0:s.status)??"unknown";return"active"===e?$:"grace"===e?g:"expired"===e?w:W})(),m=(()=>{var e;const t=null==(e=null==s?void 0:s.planCode)?void 0:e.trim().toLowerCase();return t?"montly"===t||"monthy"===t||t.startsWith("mon")?"monthly":t.startsWith("year")?"yearly":t:null})(),p=m?"monthly"===m?i("tools.planMonthly"):"yearly"===m?i("tools.planYearly"):m:i("tools.notAvailable"),x="expired"===(null==s?void 0:s.status)?"text-red-700":"grace"===(null==s?void 0:s.status)?"text-amber-800":"text-slate-900";return a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:a.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full",children:[a.jsxs("div",{className:"flex justify-between items-center mb-4",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(h,{className:"w-6 h-6 text-blue-600",strokeWidth:2}),a.jsx("h3",{className:"text-xl font-bold text-slate-900",children:i("about.title")})]}),a.jsx("button",{onClick:t,className:"p-2 hover:bg-slate-100 rounded-lg transition-colors",children:a.jsx(y,{className:"w-6 h-6",strokeWidth:2})})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"text-center py-4",children:[a.jsx("h2",{className:"text-2xl font-bold text-blue-600",children:"CERTIFY"}),a.jsx("p",{className:"text-sm text-slate-600 mt-1",children:i("about.subtitle")})]}),a.jsxs("div",{className:"bg-slate-50 rounded-lg p-4 space-y-3",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(G,{className:"w-5 h-5 text-slate-600",strokeWidth:2}),a.jsxs("div",{children:[a.jsx("div",{className:"text-sm font-medium text-slate-700",children:i("about.version")}),a.jsx("div",{className:"text-lg font-bold text-slate-900",children:"2.2.0"})]})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(C,{className:"w-5 h-5 text-slate-600",strokeWidth:2}),a.jsxs("div",{children:[a.jsx("div",{className:"text-sm font-medium text-slate-700",children:i("about.buildDate")}),a.jsx("div",{className:"text-sm text-slate-900",children:o("2026-02-20")})]})]}),(null==s?void 0:s.configured)&&s.authenticated&&a.jsx(a.Fragment,{children:a.jsxs("div",{className:"border-t border-slate-200 pt-3",children:[a.jsx("div",{className:"text-sm font-semibold text-slate-700 mb-2",children:i("tools.subscriptionAccount")}),a.jsxs("div",{className:"space-y-1.5 text-sm text-slate-700",children:[a.jsxs("p",{className:"flex items-center gap-1.5",children:[a.jsxs("strong",{children:[i("tools.subscriptionStatus"),":"]})," ",a.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded-md border font-semibold ${d}`,children:[a.jsx(u,{className:"w-3.5 h-3.5",strokeWidth:2.5}),c]})]}),a.jsxs("p",{className:`flex items-center gap-1.5 ${x}`,children:[a.jsx(v,{className:"w-4 h-4",strokeWidth:2}),a.jsxs("span",{children:[a.jsxs("strong",{children:[i("tools.subscriptionEndsAt"),":"]})," ",o(s.currentPeriodEnd)]})]}),"grace"===s.status&&a.jsxs("p",{className:"text-amber-800 flex items-center gap-1.5",children:[a.jsx(g,{className:"w-4 h-4",strokeWidth:2}),a.jsxs("span",{children:[a.jsxs("strong",{children:[i("tools.graceUntil"),":"]})," ",o(s.graceUntil)]})]}),a.jsxs("p",{className:"flex items-center gap-1.5",children:[a.jsx(R,{className:"w-4 h-4 text-slate-500",strokeWidth:2}),a.jsxs("span",{children:[a.jsxs("strong",{children:[i("tools.subscriptionPlan"),":"]})," ",p]})]}),r&&a.jsx("p",{className:"text-slate-500",children:i("common.loading")})]})]})})]}),a.jsxs("div",{className:"border-t border-slate-200 pt-4",children:[a.jsx("h4",{className:"text-sm font-semibold text-slate-700 mb-3",children:i("about.features")}),a.jsxs("div",{className:"space-y-2 text-sm text-slate-600",children:[a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsx(q,{className:"w-4 h-4 mt-0.5 text-blue-600",strokeWidth:2}),a.jsx("span",{children:i("about.feature1")})]}),a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsx(N,{className:"w-4 h-4 mt-0.5 text-blue-600",strokeWidth:2}),a.jsx("span",{children:i("about.feature2")})]}),a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsx(G,{className:"w-4 h-4 mt-0.5 text-blue-600",strokeWidth:2}),a.jsx("span",{children:i("about.feature3")})]})]})]}),a.jsx("div",{className:"border-t border-slate-200 pt-4",children:a.jsx("p",{className:"text-xs text-center text-slate-500",children:i("about.footer")})})]}),a.jsxs("div",{className:"mt-6 flex gap-3",children:[(null==s?void 0:s.configured)&&s.authenticated&&a.jsx("button",{onClick:()=>{null==n||n()},className:"px-4 py-3 rounded-lg border border-slate-300 bg-white text-slate-700 hover:bg-slate-50 font-medium transition-colors",children:i("auth.signOut")}),a.jsx("button",{onClick:t,className:"flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors",children:i("common.close")})]})]})})},Lt=({filteredParticipants:e,entitlement:t,entitlementLoading:r=!1,onSignOut:i})=>{var l;const{settings:c}=jt(),{language:d,setLanguage:u,t:m}=Te(),[p,x]=s.useState(!1),[w,j]=s.useState(!1),[k,A]=s.useState(null),[O,T]=s.useState(null),L=(e,t,s="info")=>{A({isOpen:!0,title:e,message:t,variant:s})},M=(e,t,s,a="info",r)=>{T({isOpen:!0,title:e,message:t,onConfirm:s,variant:a,confirmText:m("common.confirm")})},[I,$]=s.useState(!1),[W,R]=s.useState(""),[H,K]=s.useState(0),[X,J]=s.useState(null),[Z,Q]=s.useState(!1),[te,se]=s.useState(!1),[ae,re]=s.useState(""),[ne,ie]=s.useState(!1),[le,oe]=s.useState(null),[de,me]=s.useState(!1),[xe,he]=s.useState({isOpen:!1,mode:"export",isProcessing:!1}),[ge,fe]=s.useState(null),[Ne,we]=s.useState(st()),[je,ye]=s.useState(!1),[Se,ke]=s.useState({date:"",status:"planned"}),De=o(()=>pe(),[]),Ce=o(()=>async function(){return ee.groups.where("status").equals("planned").sortBy("courseStartDate")}(),[H]),Ee=o(()=>async function(){return ee.groups.where("status").equals("completed").reverse().sortBy("groupNumber")}(),[H]),Ae=o(()=>ee.participants.toArray(),[]),qe=o(()=>ee.yearlyArchives.toArray(),[]),Pe=e=>m(1===e?"group.participant_one":"group.participant_other"),Me=async(e,t)=>{try{const s=function(e){let t=e.version||1,s=e;if(!s||"object"!=typeof s)throw new Error("Invalid backup file: data is not an object.");if(t>2)throw new Error(`Backup version ${t} is newer than this app version (2). Please update the app to import this file.`);for(;t<2;)try{if(1!==t)throw new Error(`No migration strategy found for version ${t}`);s=Ot(s),t=2}catch(a){throw new Error(`Migration failed: Could not upgrade backup from v${t} to v${t+1}`)}if(!Array.isArray(s.participants)||!Array.isArray(s.groups))throw new Error("Migration finished but result is malformed (missing arrays).");return s}(e);if(!(s.groups&&s.participants&&Array.isArray(s.groups)&&Array.isArray(s.participants)))throw new Error("Invalid backup format after migration: missing groups or participants arrays");if("replace"===t)await ee.transaction("rw",[ee.participants,ee.groups,ee.settings],async()=>{await ee.participants.clear(),await ee.groups.clear(),s.groups.length>0&&await ee.groups.bulkAdd(s.groups),s.participants.length>0&&await ee.participants.bulkAdd(s.participants),s.settings&&await ee.settings.update(1,s.settings)});else{const e=await ee.participants.toArray(),t=new Set(e.map(e=>e.uniqueNumber));await ee.transaction("rw",[ee.participants,ee.groups,ee.settings],async()=>{s.groups.length>0&&await ee.groups.bulkPut(s.groups);for(const e of s.participants){if(await ee.participants.get(e.id))await ee.participants.update(e.id,e);else{let s=e.uniqueNumber,a=0;for(;t.has(s)&&a<1e3;){const e=await ee.settings.get(1);if(e){const t=e.lastUniquePrefix+1,a=e.lastUniqueSeq+1;s=`${t.toString().padStart(4,"0")}-${a.toString().padStart(3,"0")}`,await ee.settings.update(1,{lastUniquePrefix:t,lastUniqueSeq:a})}a++}t.add(s),await ee.participants.add({...e,uniqueNumber:s})}}})}L(m("common.success"),m("import.success",{participants:String(s.participants.length),groups:String(s.groups.length)}),"success")}catch(s){L(m("common.error"),`${m("import.failed")}: ${s.message}`,"error")}finally{x(!1),he(e=>({...e,isOpen:!1,isProcessing:!1,pendingEncryptedData:null,pendingFile:null}))}},Ie=async(e,t)=>{const s=async()=>{x(!0);try{const a=await e.text(),r=JSON.parse(a);"object"==typeof(s=r)&&null!==s&&"ciphertext"in s&&"salt"in s&&"iv"in s&&"version"in s||r&&"object"==typeof r&&"ciphertext"in r&&"salt"in r?(he({isOpen:!0,mode:"import",isProcessing:!1,pendingEncryptedData:r,importMode:t,pendingFile:e}),x(!1)):await Me(r,t)}catch(a){L(m("common.error"),m("tools.invalidBackupFormat"),"error"),x(!1)}var s};"replace"===t?M(m("common.warning"),m("tools.importReplaceWarning"),s,"danger"):s()},$e=async e=>{try{const t=await async function(e){const t=await ee.groups.get(e);if(!t)throw new Error("Group not found");if("active"===t.status)return{success:!0};const s=await pe();return s&&s.id!==e?{success:!1,needsConfirm:!0,currentActive:s}:await ve(e)}(e);if(t.needsConfirm&&t.currentActive){const s=await ee.groups.get(e);s&&J({type:"makeActive",groupId:e,groupNumber:s.groupNumber,currentActive:t.currentActive})}else if(t.success){K(e=>e+1);const t=await ee.groups.get(e);t&&L(m("common.success"),m("tools.makeActiveSuccess",{number:t.groupNumber?t.groupNumber.toString():"Active"}),"success")}}catch(t){L(m("common.error"),`${m("common.error")}: ${t.message}`,"error")}},We=async e=>{try{const t=await async function(e){const t=await ee.groups.get(e);if(!t)throw new Error("Group not found");if("completed"!==t.status)throw new Error("Only archived groups can be reopened");const s=await pe();return s?{success:!1,needsConfirm:!0,currentActive:s}:await ve(e)}(e);if(t.needsConfirm&&t.currentActive){const s=await ee.groups.get(e);s&&J({type:"reopen",groupId:e,groupNumber:s.groupNumber,currentActive:t.currentActive})}else t.success&&(K(e=>e+1),L(m("common.success"),m("tools.reopenSuccess"),"success"))}catch(t){L(m("common.error"),`${m("common.error")}: ${t.message}`,"error")}};return a.jsxs("div",{className:"space-y-6 pb-24 md:pb-6",children:[a.jsx(Pt,{isOpen:xe.isOpen,mode:xe.mode,isProcessing:xe.isProcessing,error:xe.error,onCancel:()=>he(e=>({...e,isOpen:!1})),onConfirm:e=>{"export"===xe.mode?(async e=>{he(e=>({...e,isProcessing:!0,error:void 0}));try{const t=await ee.participants.toArray(),s=await ee.groups.toArray(),a=await ee.settings.get(1),r={version:2..toString(),timestamp:(new Date).toISOString(),participants:t,groups:s,settings:a},n=await Et(r,e),i=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),l=`course-backup-secure-${(new Date).toISOString().split("T")[0]}.json`;await qt(i,l),he(e=>({...e,isOpen:!1}))}catch(t){he(e=>({...e,error:m("crypto.encryptionFailed")}))}finally{he(e=>({...e,isProcessing:!1}))}})(e):(async e=>{if(xe.pendingEncryptedData&&xe.importMode){he(e=>({...e,isProcessing:!0,error:void 0})),x(!0);try{const t=await At(xe.pendingEncryptedData,e);await Me(t,xe.importMode)}catch(t){he(e=>({...e,isProcessing:!1,error:m("crypto.invalidPassword")})),x(!1)}}})(e)}}),a.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200",children:[a.jsx("h3",{className:"text-lg font-bold text-slate-900 mb-4",children:m("tools.language")}),a.jsxs("div",{className:"flex gap-3",children:[a.jsxs("button",{onClick:()=>u("en"),className:"flex-1 px-6 py-3 rounded-lg font-medium min-h-[48px] transition-colors duration-150 flex items-center justify-center gap-3 "+("en"===d?"bg-blue-600 text-white":"bg-slate-100 text-slate-700 hover:bg-slate-200"),children:[a.jsx(n,{countryCode:"GB",svg:!0,style:{width:"2em",height:"1.5em",borderRadius:"4px"}}),"English"]}),a.jsxs("button",{onClick:()=>u("bg"),className:"flex-1 px-6 py-3 rounded-lg font-medium min-h-[48px] transition-colors duration-150 flex items-center justify-center gap-3 "+("bg"===d?"bg-blue-600 text-white":"bg-slate-100 text-slate-700 hover:bg-slate-200"),children:[a.jsx(n,{countryCode:"BG",svg:!0,style:{width:"2em",height:"1.5em",borderRadius:"4px"}}),"Български"]})]})]}),De&&a.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border-2 border-blue-400",children:[a.jsxs("div",{className:"mb-4",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(N,{className:"w-5 h-5 text-blue-600",strokeWidth:2}),a.jsx("h3",{className:"text-lg font-bold text-blue-700",children:m("tools.activeGroup")})]}),a.jsx("p",{className:"text-sm text-blue-600 mt-0.5",children:m("tools.activeGroupSubtitle")})]}),a.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-4 mb-4",children:a.jsxs("div",{className:"space-y-2 text-sm text-slate-700",children:[a.jsxs("p",{children:[a.jsxs("strong",{children:[m("tools.groupNumber"),":"]})," ",De.groupNumber||a.jsx("span",{className:"italic text-slate-500",children:m("tools.pendingAssignedOnClose")})]}),a.jsxs("p",{children:[a.jsxs("strong",{children:[m("tools.courseStart"),":"]})," ",ue(De.courseStartDate)]}),a.jsxs("p",{children:[a.jsxs("strong",{children:[m("tools.courseEnd"),":"]})," ",ue(De.courseEndDate)]})]})}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("label",{className:"flex items-start gap-3 cursor-pointer min-h-[44px]",children:[a.jsx("input",{type:"checkbox",checked:I,onChange:e=>$(e.target.checked),className:"mt-1 w-5 h-5 text-blue-600 rounded border-slate-300 focus:ring-blue-500"}),a.jsx("span",{className:"text-sm text-slate-700 flex-1",children:m("tools.closeGroupDescription")})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:[m("tools.typeToConfirm",{text:De.groupNumber?`CLOSE-${De.groupNumber}`:"CLOSE"}),": ",a.jsx("code",{className:"bg-slate-200 px-2 py-1 rounded",children:De.groupNumber?`CLOSE-${De.groupNumber}`:"CLOSE"})]}),a.jsx("input",{type:"text",value:W,onChange:e=>R(e.target.value),placeholder:De.groupNumber?`CLOSE-${De.groupNumber}`:"CLOSE",className:"w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 min-h-[44px]",disabled:!I})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsxs("button",{onClick:async()=>{M(m("tools.returnToPlanned"),m("tools.returnToPlannedConfirm"),async()=>{try{await async function(){const e=await pe();if(!e)throw new Error("No active group to set as planned");const t=(new Date).toISOString();await ee.groups.update(e.id,{status:"planned",updatedAt:t,activatedAt:void 0}),await ce(e.courseStartDate)}(),K(e=>e+1),L(m("common.success"),m("tools.returnToPlannedSuccess"),"success")}catch(e){L(m("common.error"),`${m("common.error")}: ${e.message}`,"error")}},"warning")},className:"px-6 py-4 bg-slate-600 text-white rounded-lg hover:bg-slate-700 font-bold min-h-[48px] transition-colors duration-150",children:["← ",m("tools.returnToPlanned")]}),a.jsxs("button",{onClick:async()=>{try{await async function(){const e=await pe();if(!e)throw new Error("No active group to close");const t=(new Date).toISOString();let s=e.groupNumber;if(null==s){const e=await ee.groups.where("status").equals("completed").toArray(),t=new Set(e.map(e=>e.groupNumber).filter(e=>null!=e&&e>0));let a=1;for(;t.has(a);)a++;s=a}await ee.groups.update(e.id,{status:"completed",groupNumber:s,updatedAt:t,closedAt:t,isLocked:!0})}(),$(!1),R(""),K(e=>e+1),L(m("common.success"),m("tools.closeActiveSuccess"),"success")}catch(e){L(m("common.error"),`${m("common.error")}: ${e.message}`,"error")}},disabled:!I||W!==(De.groupNumber?`CLOSE-${De.groupNumber}`:"CLOSE"),className:"px-6 py-4 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed font-bold min-h-[48px] transition-colors duration-150",children:["✓ ",m("tools.archiveGroup")]})]})]})]}),X&&a.jsx(Le,{isOpen:!0,title:m("tools.changeActiveGroup"),message:m("tools.changeActiveGroupMessage",{current:(X.currentActive.groupNumber||"Active").toString(),new:(X.groupNumber||"Active").toString()}),confirmText:m("tools.changeActiveGroupConfirm"),cancelText:m("common.cancel"),onConfirm:async()=>{if(X)try{const e=X.currentActive.groupNumber,t=X.groupNumber;await ve(X.groupId,!0),J(null),K(e=>e+1),L(m("common.success"),m("tools.makeActiveWithSwapSuccess",{new:(null==t?void 0:t.toString())||"Active",old:(null==e?void 0:e.toString())||"Active"}),"success")}catch(e){L(m("common.error"),`${m("common.error")}: ${e.message}`,"error")}},onClose:()=>J(null)}),je&&a.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:a.jsxs("div",{className:"bg-white rounded-lg shadow-2xl max-w-md w-full p-6 space-y-4",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("h3",{className:"text-xl font-bold text-slate-900",children:m("tools.createNewGroup")}),a.jsx("button",{onClick:()=>{ye(!1),ke({date:"",status:"planned"})},className:"text-slate-400 hover:text-slate-600 transition-colors",children:a.jsx(y,{className:"w-6 h-6"})})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:m("tools.courseStartDateMonday")}),a.jsx("input",{type:"date",value:Se.date,onChange:e=>ke(t=>({...t,date:e.target.value})),className:"w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:m("tools.groupStatus")}),a.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[a.jsxs("button",{onClick:()=>ke(e=>({...e,status:"planned"})),className:"px-4 py-3 rounded-lg font-medium transition-all flex items-center justify-center gap-2 "+("planned"===Se.status?"bg-amber-600 text-white ring-2 ring-amber-300":"bg-slate-100 text-slate-700 hover:bg-slate-200"),children:[a.jsx(v,{className:"w-5 h-5",strokeWidth:2}),m("tools.groupPlanned")]}),a.jsxs("button",{onClick:()=>ke(e=>({...e,status:"active"})),className:"px-4 py-3 rounded-lg font-medium transition-all flex items-center justify-center gap-2 "+("active"===Se.status?"bg-green-600 text-white ring-2 ring-green-300":"bg-slate-100 text-slate-700 hover:bg-slate-200"),children:[a.jsx(N,{className:"w-5 h-5",strokeWidth:2}),m("tools.groupActive")]})]})]}),"active"===Se.status&&De&&a.jsxs("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800",children:[a.jsx(g,{className:"w-4 h-4 inline mr-1"}),m("tools.createGroupActiveWarning")]})]}),a.jsxs("div",{className:"flex gap-3 pt-2",children:[a.jsx("button",{onClick:()=>{ye(!1),ke({date:"",status:"planned"})},className:"flex-1 px-4 py-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 font-medium transition-colors",children:m("common.cancel")}),a.jsx("button",{onClick:async()=>{try{if(!Se.date)return void L(m("common.error"),m("tools.createGroupSelectDate"),"error");if(1!==new Date(Se.date).getDay())return void L(m("common.error"),m("tools.createGroupMustBeMonday"),"error");const e=await ee.groups.where("courseStartDate").equals(Se.date).first();if(e){const t="active"===e.status?m("tools.createGroupExistsActive"):"planned"===e.status?m("tools.createGroupExistsPlanned"):m("tools.createGroupExistsCompleted");return void L(m("common.error"),t.replace("{date}",ue(Se.date)),"error")}if("active"===Se.status){if(await pe())return void L(m("common.warning"),m("tools.createGroupActiveExists"),"warning")}if("planned"===Se.status){const e=await pe();if(e&&Se.date<e.courseStartDate)return void L(m("common.warning"),m("tools.createGroupBeforeActive"),"warning")}await be(Se.date,Se.status),ye(!1),ke({date:"",status:"planned"}),K(e=>e+1);const t="active"===Se.status?m("tools.groupActive"):m("tools.groupPlanned");L(m("common.success"),m("tools.createGroupSuccess",{status:t,date:ue(Se.date)}),"success")}catch(e){L(m("common.error"),m("tools.createGroupFailed",{error:e.message}),"error")}},disabled:!Se.date,className:"flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium transition-colors",children:m("tools.createGroup")})]})]})}),a.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg shadow-sm border-2 border-blue-200",children:a.jsxs("div",{className:"flex flex-col md:flex-row items-start justify-between gap-4",children:[a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx(C,{className:"w-5 h-5 text-blue-600",strokeWidth:2}),a.jsx("h3",{className:"text-lg font-bold text-blue-700",children:m("tools.manualGroupCreation")})]}),a.jsx("p",{className:"text-sm text-blue-600",children:m("tools.manualGroupCreationSubtitle")})]}),a.jsxs("button",{onClick:()=>ye(!0),className:"w-full md:w-auto px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 hover:shadow-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 md:whitespace-nowrap",children:[a.jsx(C,{className:"w-5 h-5",strokeWidth:2}),m("tools.newGroup")]})]})}),Ce&&Ce.length>0&&a.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border-2 border-amber-300",children:[a.jsxs("div",{className:"mb-4",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(v,{className:"w-5 h-5 text-amber-600",strokeWidth:2}),a.jsx("h3",{className:"text-lg font-bold text-amber-700",children:m("tools.plannedGroups")})]}),a.jsx("p",{className:"text-sm text-amber-600 mt-0.5 ml-7",children:m("tools.plannedGroupsSubtitle")})]}),a.jsx("div",{className:"space-y-3",children:Ce.map(e=>{const t=(null==Ae?void 0:Ae.filter(t=>t.courseStartDate===e.courseStartDate).length)||0;return a.jsx("div",{className:"border border-amber-200 rounded-lg p-4 bg-amber-50 hover:shadow-md hover:border-amber-300 transition-all duration-200",children:a.jsxs("div",{className:"flex items-start justify-between gap-2 sm:gap-4",children:[a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[a.jsxs("h4",{className:"font-semibold text-amber-900",children:[m("group.number")," ",e.groupNumber]}),a.jsx("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-800 text-xs font-medium rounded-full",children:m("group.planned")})]}),a.jsxs("div",{className:"text-sm text-amber-800 space-y-1",children:[a.jsxs("p",{className:"flex items-center gap-1",children:[a.jsx(C,{className:"w-4 h-4",strokeWidth:2}),ue(e.courseStartDate)," - ",ue(e.courseEndDate)]}),a.jsxs("p",{className:"flex items-center gap-1",children:[a.jsx(q,{className:"w-4 h-4",strokeWidth:2}),t," ",Pe(t)]})]})]}),a.jsx("div",{className:"flex flex-col gap-2",children:a.jsxs("button",{onClick:()=>$e(e.id),className:"px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 hover:shadow-lg text-sm font-medium transition-all duration-200 flex items-center gap-2",children:[a.jsx(b,{className:"w-4 h-4 shrink-0",strokeWidth:2}),a.jsx("span",{children:m("tools.makeActive")})]})})]})},e.id)})})]}),Ee&&Ee.length>0&&a.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border-2 border-slate-300",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(f,{className:"w-5 h-5 text-slate-600",strokeWidth:2}),a.jsx("h3",{className:"text-lg font-bold text-slate-700",children:m("tools.archiveCompleted")}),a.jsxs("span",{className:"text-sm text-slate-500",children:["(",Ee.length,")"]})]}),a.jsx("p",{className:"text-sm text-slate-600 mt-0.5 ml-7",children:m("tools.completedCourses")})]}),Ee.length>2&&a.jsxs("button",{onClick:()=>Q(!Z),className:"flex items-center gap-2 px-3 py-1.5 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors",children:[m(Z?"tools.hide":"tools.showAll"),a.jsx(F,{className:"w-4 h-4 transition-transform "+(Z?"rotate-180":""),strokeWidth:2})]})]}),a.jsx("div",{className:"space-y-3",children:(Z?Ee:Ee.slice(0,2)).map(e=>{const t=(null==Ae?void 0:Ae.filter(t=>t.courseStartDate===e.courseStartDate).length)||0;return a.jsx("div",{className:"border border-slate-300 rounded-lg p-4 bg-slate-50 hover:shadow-md hover:border-slate-400 transition-all duration-200",children:a.jsxs("div",{className:"flex items-start justify-between gap-2 sm:gap-4",children:[a.jsxs("div",{className:"flex-1",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[a.jsxs("h4",{className:"font-semibold text-slate-800",children:[m("group.number")," ",e.groupNumber]}),a.jsx("span",{className:"px-2 py-0.5 bg-slate-200 text-slate-700 text-xs font-medium rounded-full",children:m("group.completed")})]}),a.jsxs("div",{className:"text-sm text-slate-600 space-y-1",children:[a.jsxs("p",{className:"flex items-center gap-1",children:[a.jsx(C,{className:"w-4 h-4",strokeWidth:2}),ue(e.courseStartDate)," - ",ue(e.courseEndDate)]}),a.jsxs("p",{className:"flex items-center gap-1",children:[a.jsx(q,{className:"w-4 h-4",strokeWidth:2}),t," ",Pe(t)]}),e.closedAt&&a.jsxs("p",{className:"flex items-center gap-1 text-xs text-slate-500",children:[a.jsx(D,{className:"w-3.5 h-3.5",strokeWidth:2}),m("tools.completedOn"),": ",ue(e.closedAt.split("T")[0])," ",new Date(e.closedAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})]})]})]}),a.jsx("div",{className:"flex flex-col gap-2",children:a.jsxs("button",{onClick:()=>We(e.id),className:"px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 hover:shadow-lg text-sm font-medium transition-all duration-200 flex items-center gap-2",children:[a.jsx(B,{className:"w-4 h-4 shrink-0",strokeWidth:2}),a.jsx("span",{children:m("tools.reopenForEdits")})]})})]})},e.id)})})]}),c&&a.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[a.jsx(S,{className:"w-5 h-5 text-blue-600",strokeWidth:2}),a.jsx("h3",{className:"text-lg font-bold text-blue-600",children:m("tools.currentSequence")})]}),a.jsxs("div",{className:"text-sm text-slate-700 space-y-1",children:[a.jsxs("p",{children:[a.jsxs("strong",{children:[m("tools.prefix"),":"]})," ",c.lastUniquePrefix]}),a.jsxs("p",{children:[a.jsxs("strong",{children:[m("tools.sequence"),":"]})," ",c.lastUniqueSeq]}),c.lastResetYear&&a.jsxs("p",{children:[a.jsxs("strong",{children:[m("tools.lastReset"),":"]})," ",c.lastResetYear]})]})]}),a.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[a.jsx(z,{className:"w-5 h-5 text-emerald-600",strokeWidth:2}),a.jsx("h3",{className:"text-lg font-bold text-emerald-600",children:m("tools.exportData")})]}),a.jsxs("div",{className:"space-y-3",children:[a.jsxs("button",{onClick:()=>{he({isOpen:!0,mode:"export",isProcessing:!1})},className:"w-full px-6 py-4 bg-blue-100 text-blue-800 border border-blue-300 rounded-lg hover:bg-blue-200 hover:border-blue-400 font-medium min-h-[48px] transition-all duration-150 flex items-center justify-center gap-2",children:[a.jsx(G,{className:"w-5 h-5",strokeWidth:2}),m("tools.exportFullBackup")]}),a.jsxs("button",{onClick:async()=>{try{const t=await Oe(()=>import("./vendor-xlsx-ByDo_lG2.js"),[]),s=await ee.groups.toArray(),a=e.length>0?e:await ee.participants.toArray(),r=new Map,n=new Map;s.forEach(e=>{r.set(e.courseStartDate,e.status),n.set(e.courseStartDate,e.groupNumber)});const i=[],l=[],o=[],c=[],d=e=>({"Company Name":e.companyName,"Person Name":e.personName,"Medical Date":ue(e.medicalDate),"Course Start":ue(e.courseStartDate),"Course End":ue(e.courseEndDate),"Group No":n.get(e.courseStartDate)||"","Unique Number":e.uniqueNumber,Sent:e.sent?"Yes":"No",Documents:e.documents?"Yes":"No","Handed Over":e.handedOver?"Yes":"No",Paid:e.paid?"Yes":"No",Completed:(null!==e.completedOverride?e.completedOverride:e.completedComputed)?"Yes":"No"});a.forEach(e=>{const t=r.get(e.courseStartDate),s=d(e);"active"===t?i.push(s):"planned"===t?l.push(s):"completed"===t?o.push(s):c.push(s)});const u=t.utils.book_new(),m=(e,s,a)=>{if(0===e.length)return;a&&e.sort(a);const r=t.utils.json_to_sheet(e),n=Object.keys(e[0]||{}).map(e=>({wch:Math.max(e.length,15)}));r["!cols"]=n,t.utils.book_append_sheet(u,r,s)};if(m(i,"Active Groups",(e,t)=>(e["Unique Number"]||"").localeCompare(t["Unique Number"]||"")),m(l,"Planned Groups",(e,t)=>e["Course Start"].localeCompare(t["Course Start"])),m(o,"Archived Groups",(e,t)=>(t["Group No"]||0)-(e["Group No"]||0)),m(c,"Other"),0===u.SheetNames.length){const e=t.utils.json_to_sheet([{Info:"No data found to export"}]);t.utils.book_append_sheet(u,e,"Empty")}const p=t.write(u,{bookType:"xlsx",type:"array"}),x=new Blob([p],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),h=`course-export-${(new Date).toISOString().split("T")[0]}.xlsx`;await qt(x,h)}catch(t){L(m("common.error"),m("export.failedExcel"),"error")}},className:"w-full px-6 py-4 bg-emerald-100 text-emerald-800 border border-emerald-300 rounded-lg hover:bg-emerald-200 hover:border-emerald-400 font-medium min-h-[48px] transition-all duration-150 flex items-center justify-center gap-2",children:[a.jsx(_,{className:"w-5 h-5",strokeWidth:2}),m("tools.exportExcel")]}),a.jsxs("button",{onClick:async()=>{try{const t=["Company Name","Person Name","Medical Date","Course Start Date","Course End Date","Group Number","Unique Number","Sent","Documents","Handed Over","Paid","Completed"],s=e.length>0?await ee.groups.toArray():[],a=new Map(s.map(e=>[e.courseStartDate,e.groupNumber])),r=e.map(e=>[e.companyName,e.personName,ue(e.medicalDate),ue(e.courseStartDate),ue(e.courseEndDate),a.get(e.courseStartDate)||"",e.uniqueNumber,e.sent?"Yes":"No",e.documents?"Yes":"No",e.handedOver?"Yes":"No",e.paid?"Yes":"No",(null!==e.completedOverride?e.completedOverride:e.completedComputed)?"Yes":"No"]),n=[t.join(","),...r.map(e=>e.map(e=>`"${e}"`).join(","))].join("\n"),i=new Blob([n],{type:"text/csv"}),l=`course-export-${(new Date).toISOString().split("T")[0]}.csv`;await qt(i,l)}catch(t){L(m("common.error"),m("export.failedCSV"),"error")}},className:"w-full px-6 py-4 bg-slate-100 text-slate-800 border border-slate-300 rounded-lg hover:bg-slate-200 hover:border-slate-400 font-medium min-h-[48px] transition-all duration-150 flex items-center justify-center gap-2",children:[a.jsx(U,{className:"w-5 h-5",strokeWidth:2}),m("tools.exportCSV")]})]}),a.jsx("p",{className:"text-xs text-slate-500 mt-3",children:m("tools.exportNote")})]}),a.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[a.jsx(V,{className:"w-5 h-5 text-blue-600",strokeWidth:2}),a.jsx("h3",{className:"text-lg font-bold text-blue-600",children:m("tools.importData")})]}),a.jsxs("div",{className:"space-y-3",children:[a.jsxs("label",{className:"w-full px-6 py-4 bg-blue-100 text-blue-800 border border-blue-300 rounded-lg hover:bg-blue-200 hover:border-blue-400 cursor-pointer text-center font-medium min-h-[48px] transition-all duration-150 flex items-center justify-center gap-2",children:[a.jsx(z,{className:"w-5 h-5",strokeWidth:2}),m("tools.importMerge"),a.jsx("input",{type:"file",accept:".json",onChange:e=>{var t;(null==(t=e.target.files)?void 0:t[0])&&(Ie(e.target.files[0],"merge"),e.target.value="")},className:"hidden",disabled:p})]}),a.jsxs("label",{className:"w-full px-6 py-4 bg-amber-100 text-amber-800 border border-amber-300 rounded-lg hover:bg-amber-200 hover:border-amber-400 cursor-pointer text-center font-medium min-h-[48px] transition-all duration-150 flex items-center justify-center gap-2",children:[a.jsx(g,{className:"w-5 h-5",strokeWidth:2}),m("tools.importReplace"),a.jsx("input",{type:"file",accept:".json",onChange:e=>{var t;(null==(t=e.target.files)?void 0:t[0])&&(Ie(e.target.files[0],"replace"),e.target.value="")},className:"hidden",disabled:p})]})]}),a.jsxs("p",{className:"text-xs text-slate-500 mt-3",children:[m("tools.importMergeNote")," ",a.jsx("br",{}),a.jsx("span",{className:"text-amber-600 font-semibold",children:m("tools.importReplaceWarning")})]}),p&&!xe.isOpen&&a.jsx("div",{className:"text-center mt-4 text-blue-600 font-medium animate-pulse",children:"Processing..."})]}),a.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200 mb-6",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[a.jsx(E,{className:"w-5 h-5 text-amber-600",strokeWidth:2}),a.jsx("h3",{className:"text-lg font-bold text-amber-600",children:m("security.title")})]}),a.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[a.jsxs("div",{children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[a.jsx("h4",{className:"font-semibold text-slate-700",children:m(Ne?"security.enabled":"security.disabled")}),Ne&&a.jsx("span",{className:"text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded font-medium",children:m("security.active")})]}),a.jsx("p",{className:"text-sm text-slate-500 max-w-md",children:m(Ne?"security.descriptionEnabled":"security.descriptionDisabled")})]}),a.jsx("div",{className:"flex flex-col gap-2",children:Ne?a.jsxs(a.Fragment,{children:[a.jsx("button",{onClick:()=>it(),className:"px-4 py-2 bg-slate-800 text-white hover:bg-slate-900 rounded-lg text-sm font-medium transition-colors shadow-sm",children:m("security.lockNow")}),a.jsx("button",{onClick:()=>fe("disable"),className:"px-4 py-2 text-red-600 hover:bg-red-50 border border-red-200 rounded-lg text-sm font-medium transition-colors",children:m("security.disable")})]}):a.jsx("button",{onClick:()=>fe("setup"),className:"px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg text-sm font-medium transition-colors shadow-sm",children:m("security.setPin")})})]})]}),a.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md border-2 border-orange-200",children:[a.jsxs("button",{onClick:()=>j(!w),className:"w-full flex items-center justify-between py-2 min-h-[44px]",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(P,{className:"w-5 h-5 text-orange-600",strokeWidth:2}),a.jsx("h3",{className:"text-lg font-bold text-orange-600",children:m("tools.advancedSettings")})]}),a.jsx(F,{className:"w-6 h-6 transition-transform "+(w?"rotate-180":""),strokeWidth:2})]}),w&&a.jsxs("div",{className:"mt-4 pt-4 border-t border-orange-200 space-y-6",children:[a.jsx(Mt,{onArchive:()=>se(!0),onViewArchives:()=>ie(!0)}),a.jsx(Wt,{showAlert:L})]})]}),a.jsx("div",{className:"bg-white p-6 rounded-lg shadow-md border-2 border-blue-200",children:a.jsxs("button",{onClick:()=>me(!0),className:"w-full flex items-center justify-between py-2 min-h-[44px]",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(h,{className:"w-5 h-5 text-blue-600",strokeWidth:2}),a.jsx("h3",{className:"text-lg font-bold text-blue-600",children:m("about.title")})]}),a.jsx(Y,{className:"w-6 h-6 text-blue-600",strokeWidth:2})]})}),a.jsx(Tt,{isOpen:de,onClose:()=>me(!1),entitlement:t,entitlementLoading:r,onSignOut:i}),te&&a.jsx(It,{isOpen:te,onClose:()=>{se(!1),re("")},onConfirm:async()=>{try{const e=(new Date).getFullYear(),t=await ee.groups.toArray(),s=await ee.participants.toArray(),a=t.some(e=>"active"===e.status),r=new Set(s.map(e=>e.courseStartDate)),n=t.filter(e=>"planned"===e.status).some(e=>r.has(e.courseStartDate));if(a||n)return L(m("common.warning"),m("tools.archiveGuardFail"),"warning"),se(!1),void re("");const i=t.filter(t=>{if("completed"!==t.status)return!1;return new Date(t.courseStartDate).getFullYear()===e});if(0===i.length)return L(m("common.info"),m("archive.noGroupsToArchive"),"info"),se(!1),void re("");const l=new Set(i.map(e=>e.courseStartDate)),o=s.filter(e=>l.has(e.courseStartDate)),c=`archive-${e}`;await ee.yearlyArchives.put({id:c,year:e,groups:i,participants:o,archivedAt:(new Date).toISOString()}),await ee.groups.bulkDelete(i.map(e=>e.id)),await ee.participants.bulkDelete(o.map(e=>e.id));const d=await ee.settings.get(1);d&&await ee.settings.update(1,{lastUniquePrefix:d.lastUniquePrefix+1,lastUniqueSeq:0,lastResetYear:e}),L(m("common.success"),m("tools.archiveYearSuccess",{count:i.length.toString()}),"success"),se(!1),re("")}catch(e){L(m("common.error"),m("archive.error"),"error")}},confirmText:ae,onConfirmTextChange:re}),ne&&a.jsx($t,{isOpen:ne,onClose:()=>ie(!1),archives:qe||[],onRestoreGroup:(e,t)=>oe({year:e,groupNumber:t})}),a.jsx(Le,{isOpen:null!==le,onClose:()=>oe(null),onConfirm:()=>{le&&(async(e,t)=>{try{const s=`archive-${e}`,a=await ee.yearlyArchives.get(s);if(!a)return void L(m("common.error"),m("tools.restoreGroupNotFound"),"error");const r=a.groups.find(e=>e.groupNumber===t);if(!r)return void L(m("common.error"),m("tools.restoreGroupGroupNotFound"),"error");const n=a.participants.filter(e=>e.courseStartDate===r.courseStartDate);if(await ee.groups.where("groupNumber").equals(t).first())return void L(m("common.error"),m("tools.restoreGroupExists",{number:t.toString()}),"error");await ee.groups.add({...r,updatedAt:(new Date).toISOString()});for(const e of n)await ee.participants.add(e);const i=a.groups.filter(e=>e.groupNumber!==t),l=a.participants.filter(e=>e.courseStartDate!==r.courseStartDate);0===i.length?await ee.yearlyArchives.delete(s):await ee.yearlyArchives.update(s,{groups:i,participants:l}),L(m("common.success"),m("tools.restoreGroupSuccess",{number:t.toString()}),"success"),oe(null)}catch(s){L(m("common.error"),m("tools.restoreGroupError",{error:s.message}),"error")}})(le.year,le.groupNumber)},title:m("tools.restoreGroupTitle"),message:m("tools.restoreGroupMessage",{number:(null==(l=null==le?void 0:le.groupNumber)?void 0:l.toString())||""}),confirmText:m("tools.restoreGroupConfirm"),cancelText:m("common.cancel"),variant:"warning"}),k&&a.jsx(Fe,{isOpen:k.isOpen,onClose:()=>A(null),title:k.title,message:k.message,variant:k.variant}),O&&a.jsx(Le,{isOpen:O.isOpen,onClose:()=>T(null),onConfirm:O.onConfirm,title:O.title,message:O.message,confirmText:O.confirmText,cancelText:m("common.cancel"),variant:O.variant}),ge&&a.jsx(at,{mode:ge,onSuccess:()=>{fe(null),we(st()),"setup"===ge?L(m("common.success"),m("security.setupSuccess"),"success"):"disable"===ge&&L(m("common.success"),m("security.disableSuccess"),"info")},onCancel:()=>fe(null)})]})},Mt=({onArchive:e,onViewArchives:t})=>{const{t:s}=Te(),r=(new Date).getFullYear(),n=o(()=>ee.groups.toArray(),[]),i=o(()=>ee.participants.toArray(),[]),l=(null==n?void 0:n.filter(e=>"active"===e.status).length)||0,c=new Set((i||[]).map(e=>e.courseStartDate)),d=(null==n?void 0:n.filter(e=>"planned"===e.status&&c.has(e.courseStartDate)).length)||0,u=l>0||d>0,m=!u,p=(null==n?void 0:n.filter(e=>{if("completed"!==e.status)return!1;return new Date(e.courseStartDate).getFullYear()===r}))||[],x=(null==i?void 0:i.filter(e=>p.some(t=>t.courseStartDate===e.courseStartDate)).length)||0;return a.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg border-2 border-purple-300",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx(f,{className:"w-5 h-5 text-purple-600",strokeWidth:2}),a.jsx("h4",{className:"text-lg font-bold text-purple-600",children:s("archive.title")})]}),a.jsx("p",{className:"text-sm text-slate-700 mb-4",children:s("archive.description")}),a.jsxs("div",{className:"bg-white border border-slate-300 rounded-lg p-3 mb-4",children:[a.jsx("h5",{className:"text-sm font-semibold text-slate-800 mb-2",children:s("tools.archiveReadinessTitle")}),a.jsxs("div",{className:"space-y-1.5",children:[a.jsxs("div",{className:"flex items-center justify-between text-sm",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[0===l?a.jsx(b,{className:"w-5 h-5 text-emerald-600",strokeWidth:2}):a.jsx(H,{className:"w-5 h-5 text-amber-600",strokeWidth:2}),a.jsx("span",{className:"text-slate-700",children:s("tools.archiveActiveGroups")})]}),a.jsx("span",{className:"font-semibold "+(0===l?"text-emerald-700":"text-amber-700"),children:l})]}),a.jsxs("div",{className:"flex items-center justify-between text-sm",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[0===d?a.jsx(b,{className:"w-5 h-5 text-emerald-600",strokeWidth:2}):a.jsx(H,{className:"w-5 h-5 text-amber-600",strokeWidth:2}),a.jsx("span",{className:"text-slate-700",children:s("tools.archivePlannedGroups")})]}),a.jsx("span",{className:"font-semibold "+(0===d?"text-emerald-700":"text-amber-700"),children:d})]})]}),a.jsxs("div",{className:"mt-3 pt-3 border-t border-slate-200",children:[m?a.jsxs("p",{className:"text-xs text-emerald-700 flex items-start gap-1.5",children:[a.jsx("span",{className:"text-emerald-600 mt-0.5",children:"✓"}),a.jsx("span",{children:s("tools.archiveReady")})]}):a.jsxs("p",{className:"text-xs text-amber-800 flex items-start gap-1.5",children:[a.jsx(h,{className:"w-4 h-4 text-amber-600 mt-0.5 flex-shrink-0",strokeWidth:2}),a.jsx("span",{children:s("tools.archiveNotReady")})]}),a.jsx("p",{className:"text-[11px] text-slate-500 mt-2",children:s("tools.archiveAutoPlannedNote")})]})]}),p.length>0?a.jsxs("div",{className:"bg-white p-3 rounded mb-4 text-sm space-y-1",children:[a.jsxs("p",{children:[a.jsxs("strong",{children:[s("archive.currentYear"),":"]})," ",r]}),a.jsxs("p",{children:[a.jsxs("strong",{children:[s("archive.groupsToArchive"),":"]})," ",p.length]}),a.jsxs("p",{children:[a.jsxs("strong",{children:[s("archive.participantsToArchive"),":"]})," ",x]})]}):a.jsx("div",{className:"bg-white p-3 rounded mb-4 text-sm text-slate-600",children:s("archive.noGroupsToArchive")}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("button",{onClick:e,disabled:0===p.length||u,className:"w-full px-6 py-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-slate-400 disabled:cursor-not-allowed font-bold min-h-[48px] transition-colors",title:u?"Приключете всички активни и планирани групи":"Архивирай и нулирай годишния номер",children:s("archive.button")}),a.jsxs("button",{onClick:t,className:"w-full px-6 py-4 bg-slate-600 text-white rounded-lg hover:bg-slate-700 font-medium min-h-[48px] transition-colors",children:["📚 ",s("archive.viewArchives")]})]})]})},It=({isOpen:e,onClose:t,onConfirm:s,confirmText:r,onConfirmTextChange:n})=>{const{t:i}=Te(),l=(new Date).getFullYear(),c=o(()=>ee.groups.toArray(),[]),d=o(()=>ee.participants.toArray(),[]),u=(null==c?void 0:c.some(e=>"active"===e.status))||!1,m=new Set((d||[]).map(e=>e.courseStartDate)),p=(null==c?void 0:c.some(e=>"planned"===e.status&&m.has(e.courseStartDate)))||!1,x=u||p,h=(null==c?void 0:c.filter(e=>{if("completed"!==e.status)return!1;return new Date(e.courseStartDate).getFullYear()===l}))||[],b=(null==d?void 0:d.filter(e=>h.some(t=>t.courseStartDate===e.courseStartDate)).length)||0,g=`ARCHIVE-${l}`,f=r===g&&!x;return e?a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:a.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full",children:[a.jsx("h3",{className:"text-xl font-bold text-purple-600 mb-4",children:i("archive.confirmTitle")}),x?a.jsxs("div",{className:"bg-red-50 border-2 border-red-400 p-4 rounded mb-4",children:[a.jsx("p",{className:"text-sm text-red-900 font-semibold mb-2",children:i("tools.archiveCannotArchive")}),a.jsx("p",{className:"text-sm text-red-800 mb-3",children:i("tools.archiveCannotArchiveMessage")}),u&&a.jsx("p",{className:"text-xs text-red-700",children:i("tools.archiveHasActiveGroups")}),p&&a.jsx("p",{className:"text-xs text-red-700",children:i("tools.archiveHasPlannedGroups")})]}):a.jsx("p",{className:"text-slate-700 mb-4",children:i("tools.archiveConfirmMessage",{groups:h.length.toString(),participants:b.toString(),year:l.toString()})}),!x&&a.jsxs("div",{className:"mb-6",children:[a.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:[i("archive.typeToConfirm")," ",a.jsx("code",{className:"bg-slate-200 px-2 py-1 rounded",children:g})," ",i("archive.toConfirm"),":"]}),a.jsx("input",{type:"text",value:r,onChange:e=>n(e.target.value),placeholder:g,className:"w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"})]}),a.jsxs("div",{className:"flex gap-3",children:[a.jsx("button",{onClick:t,className:"flex-1 px-4 py-3 border border-slate-200 rounded-lg hover:bg-slate-50",children:i(x?"tools.archiveCloseButton":"common.cancel")}),!x&&a.jsx("button",{onClick:s,disabled:!f,className:"flex-1 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed font-bold",children:i("archive.button")})]})]})}):null},$t=({isOpen:e,onClose:t,archives:r,onRestoreGroup:n})=>{const{t:i}=Te(),[l,o]=s.useState(null),[c,d]=s.useState(null);return e?a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:a.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[a.jsxs("div",{className:"flex justify-between items-center mb-4",children:[a.jsx("h3",{className:"text-xl font-bold text-slate-900",children:i("archive.yearlyArchives")}),a.jsx("button",{onClick:t,className:"p-2 hover:bg-slate-100 rounded-lg transition-colors",children:a.jsx(y,{className:"w-6 h-6",strokeWidth:2})})]}),0===r.length?a.jsx("p",{className:"text-slate-600 text-center py-8",children:i("archive.noArchives")}):a.jsx("div",{className:"space-y-4",children:r.sort((e,t)=>t.year-e.year).map(e=>a.jsxs("div",{className:"border border-slate-300 rounded-lg",children:[a.jsxs("button",{onClick:()=>o(l===e.year?null:e.year),className:"w-full px-4 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors rounded-lg",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(Y,{className:"w-5 h-5 text-slate-600 transition-transform "+(l===e.year?"rotate-90":""),strokeWidth:2}),a.jsxs("div",{className:"text-left",children:[a.jsxs("div",{className:"font-bold text-slate-900",children:[i("archive.year")," ",e.year]}),a.jsxs("div",{className:"text-sm text-slate-600",children:[e.groups.length," ",i("archive.groups"),", ",e.participants.length," ",i("archive.participants")]})]})]}),a.jsxs("div",{className:"text-xs text-slate-500",children:[i("archive.archived"),": ",ue(e.archivedAt.split("T")[0])]})]}),l===e.year&&a.jsx("div",{className:"border-t border-slate-200 p-4 space-y-2",children:e.groups.sort((e,t)=>t.groupNumber-e.groupNumber).map(t=>{const s=e.participants.filter(e=>e.groupNumber===t.groupNumber);return a.jsxs("div",{className:"border border-slate-200 rounded-lg",children:[a.jsxs("button",{onClick:()=>d(c===t.groupNumber?null:t.groupNumber),className:"w-full px-3 py-2 flex items-center justify-between hover:bg-slate-50 transition-colors rounded-lg",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Y,{className:"w-4 h-4 text-slate-600 transition-transform "+(c===t.groupNumber?"rotate-90":""),strokeWidth:2}),a.jsxs("div",{className:"text-left",children:[a.jsxs("div",{className:"font-semibold text-slate-900",children:[i("group.number")," ",t.groupNumber]}),a.jsxs("div",{className:"text-xs text-slate-600",children:[ue(t.courseStartDate)," - ",ue(t.courseEndDate)]})]})]}),a.jsxs("div",{className:"text-xs text-slate-600",children:[s.length," ",i("archive.participants")]})]}),c===t.groupNumber&&a.jsxs("div",{className:"border-t border-slate-200 p-3",children:[a.jsxs("div",{className:"mb-3",children:[a.jsxs("button",{onClick:()=>n(e.year,t.groupNumber),className:"w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition-colors flex items-center justify-center gap-2",children:[a.jsx(V,{className:"w-5 h-5",strokeWidth:2}),i("tools.restoreGroupConfirm")]}),a.jsx("p",{className:"text-xs text-slate-600 mt-2 text-center",children:i("tools.restoreGroupWillRestore")})]}),a.jsx("div",{className:"space-y-2",children:s.map(e=>a.jsxs("div",{className:"bg-slate-50 p-2 rounded text-sm",children:[a.jsx("div",{className:"font-semibold text-slate-900",children:e.personName}),a.jsx("div",{className:"text-slate-600",children:e.companyName}),a.jsxs("div",{className:"text-xs text-slate-500 mt-1",children:[i("participant.uniqueNumber"),": ",e.uniqueNumber]})]},e.id))})]})]},t.id)})})]},e.id))}),a.jsx("div",{className:"mt-6",children:a.jsx("button",{onClick:t,className:"w-full px-6 py-3 bg-slate-600 text-white rounded-lg hover:bg-slate-700 font-medium",children:i("common.close")})})]})}):null},Wt=({showAlert:e})=>{const{settings:t,resetYearlySequence:r}=jt(),{t:n}=Te(),[i,l]=s.useState(!1),[c,d]=s.useState(""),[u,m]=s.useState(!1),p=o(()=>ee.participants.toArray(),[]),x=(null==p?void 0:p.reduce((e,t)=>{const s=parseInt(t.uniqueNumber.split("-")[0],10);return s>e?s:e},0))||0,h=`RESET-${(new Date).getFullYear()}`,b=i&&c===h;return a.jsxs("div",{className:"bg-red-50 p-4 rounded-lg border-2 border-red-300",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a.jsx(g,{className:"w-5 h-5 text-red-600",strokeWidth:2}),a.jsx("h4",{className:"text-lg font-bold text-red-600",children:n("tools.dangerZone")})]}),a.jsx("p",{className:"text-sm text-slate-700 mb-4",children:n("tools.resetSequenceDescription2")}),t&&a.jsxs("div",{className:"bg-white p-3 rounded mb-4 text-sm",children:[a.jsxs("p",{children:[a.jsxs("strong",{children:[n("tools.current"),":"]})," ",t.lastUniquePrefix.toString().padStart(4,"0"),"-",t.lastUniqueSeq.toString().padStart(3,"0")]}),a.jsxs("p",{children:[a.jsxs("strong",{children:[n("tools.nextAfterReset"),":"]})," ",(x+1).toString().padStart(4,"0"),"-001"]})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("label",{className:"flex items-start gap-3 cursor-pointer min-h-[44px]",children:[a.jsx("input",{type:"checkbox",checked:i,onChange:e=>l(e.target.checked),className:"mt-1 w-5 h-5 text-red-600 rounded border-slate-300 focus:ring-red-500"}),a.jsx("span",{className:"text-sm text-slate-700 flex-1",children:n("tools.resetSequenceCheckbox")})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:[n("tools.typeToConfirm",{text:h}),": ",a.jsx("code",{className:"bg-slate-200 px-2 py-1 rounded",children:h})]}),a.jsx("input",{type:"text",value:c,onChange:e=>d(e.target.value),placeholder:h,className:"w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 min-h-[44px]",disabled:!i})]}),a.jsx("button",{onClick:()=>{m(!0)},disabled:!b,className:"w-full px-6 py-4 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed font-bold min-h-[48px]",children:n("tools.resetButton")})]}),u&&a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:a.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full",children:[a.jsx("h3",{className:"text-xl font-bold text-red-600 mb-4",children:n("modal.finalConfirmation")}),a.jsx("p",{className:"text-slate-700 mb-6",children:n("tools.resetSequenceFinalConfirm")}),a.jsxs("div",{className:"flex gap-3",children:[a.jsx("button",{onClick:()=>m(!1),className:"flex-1 px-4 py-3 border border-slate-200 rounded-lg hover:bg-slate-50 min-h-[48px]",children:n("tools.resetSequenceCancel")}),a.jsx("button",{onClick:async()=>{try{await r(),e(n("common.success"),n("tools.resetSequenceSuccess"),"success"),l(!1),d(""),m(!1)}catch(t){e(n("common.error"),n("tools.resetSequenceFailed"),"error")}},className:"flex-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold min-h-[48px]",children:n("tools.resetSequenceConfirmButton")})]})]})})]})};function Gt(e,t){const s=e.toLowerCase();return s.includes("invalid login credentials")?t("auth.invalidCredentials"):s.includes("email not confirmed")?t("auth.emailNotConfirmed"):s.includes("too many requests")?t("auth.rateLimited"):t("auth.failed")}function Rt(){const{t:e,language:t,setLanguage:r}=Te(),{entitlement:n,loading:i,signInWithPassword:l,signOut:o,requestPasswordReset:c,updatePassword:d,recoveryMode:u,authLinkError:m,clearAuthLinkError:p}=(()=>{const e=s.useContext(vt);if(!e)throw new Error("useEntitlement must be used within EntitlementProvider");return e})(),{participants:x,deleteParticipant:h}=Se(),{groups:b}=ke(),{collapsedSections:g,toggleSection:f,expandSection:v,resetToDefaults:N,setCollapsedState:w}=function(){const[e,t]=s.useState(()=>{const e=localStorage.getItem(De),t=localStorage.getItem(Ce),s=localStorage.getItem(Ee);return"true"===t||"true"===e?(localStorage.setItem(De,"false"),localStorage.setItem(Ce,"false"),localStorage.setItem(Ee,"true"),{active:!1,planned:!1,completed:!0}):{active:"true"===e,planned:"true"===t,completed:null===s||"true"===s}});return s.useEffect(()=>{localStorage.setItem(De,String(e.active)),localStorage.setItem(Ce,String(e.planned)),localStorage.setItem(Ee,String(e.completed))},[e]),{collapsedSections:e,toggleSection:e=>{t(t=>({...t,[e]:!t[e]}))},expandSection:e=>{t(t=>({...t,[e]:!1}))},expandAll:()=>{t({active:!1,planned:!1,completed:!1})},resetToDefaults:()=>{t({active:!1,planned:!1,completed:!0}),localStorage.setItem(De,"false"),localStorage.setItem(Ce,"false"),localStorage.setItem(Ee,"true")},setCollapsedState:e=>{t(e)}}}(),j=n.readOnly,[y,S]=s.useState("participants"),[k,D]=s.useState(!1),[C,E]=s.useState(),[A,O]=s.useState(!1),[q,P]=s.useState(!1),[T]=s.useState(0),[L,M]=s.useState(""),[I,$]=s.useState(""),[W,G]=s.useState(!1),[R,F]=s.useState(null),[B,z]=s.useState(!1),[_,U]=s.useState(null),[V,Y]=s.useState(""),[H,K]=s.useState(""),[X,J]=s.useState(!1),[Z,Q]=s.useState(null);s.useEffect(()=>{setTimeout(async()=>{try{await async function(){const e=await ee.groups.where("status").equals("active").toArray();if(e.length<=1)return;const t=e.sort((e,t)=>new Date(t.updatedAt).getTime()-new Date(e.updatedAt).getTime()),s=(t[0],t.slice(1)),a=(new Date).toISOString();for(const r of s)await ee.groups.update(r.id,{status:"planned",updatedAt:a,activatedAt:void 0})}(),await ge()}catch(e){}},100)},[]);const[te,se]=s.useState(""),[ae,re]=s.useState(""),[ne,ie]=s.useState({sent:null,documents:null,handedOver:null,paid:null,completed:null}),[le,oe]=s.useState({start:"",end:""}),[ce,de]=s.useState(null),ue=s.useMemo(()=>""!==te||""!==ae||null!==ne.sent||null!==ne.documents||null!==ne.handedOver||null!==ne.paid||null!==ne.completed||""!==le.start||""!==le.end,[te,ae,ne,le]);s.useEffect(()=>{ue?(ce||de({...g}),g.active&&v("active"),g.planned&&v("planned"),g.completed&&v("completed")):ce&&(w(ce),de(null))},[ue]);const me=s.useMemo(()=>new Map((b??[]).map(e=>[e.courseStartDate,e])),[b]),pe=s.useMemo(()=>(b??[]).filter(e=>null!==e.groupNumber&&void 0!==e.groupNumber).map(e=>({...e,groupNumber:e.groupNumber})),[b]),xe=s.useMemo(()=>{if(!x)return[];const e=(new Date).getFullYear();return x.filter(t=>{const s=me.get(t.courseStartDate);if((null!==t.completedOverride?t.completedOverride:t.completedComputed)&&"completed"===(null==s?void 0:s.status)){if(new Date(t.courseStartDate).getFullYear()!==e)return!1}if(te){const e=te.trim().replace(/\s+/g," ").toLowerCase().normalize("NFC"),s=e=>e.replace(/\s+/g," ").toLowerCase().normalize("NFC");if(!(t.companyName.toLowerCase().normalize("NFC").includes(e)||s(t.personName).includes(e)||t.uniqueNumber.toLowerCase().normalize("NFC").includes(e)))return!1}if(ae){const e=parseInt(ae,10);if(s&&s.groupNumber!==e)return!1;if(!s)return!1}if(le.start&&t.courseStartDate<le.start)return!1;if(le.end&&t.courseStartDate>=le.end)return!1;if(null!==ne.sent&&t.sent!==ne.sent)return!1;if(null!==ne.documents&&t.documents!==ne.documents)return!1;if(null!==ne.handedOver&&t.handedOver!==ne.handedOver)return!1;if(null!==ne.paid&&t.paid!==ne.paid)return!1;if(null!==ne.completed){if((null!==t.completedOverride?t.completedOverride:t.completedComputed)!==ne.completed)return!1}return!0})},[x,me,te,ae,ne,le]),he=(null==x?void 0:x.length)||0,be=xe.length,fe=(null==b?void 0:b.length)||0,ve=s.useMemo(()=>{if(!b||0===b.length)return 0;const e=new Set,t=new Map(b.map(e=>[e.courseStartDate,e]));if(xe.forEach(s=>{const a=t.get(s.courseStartDate);a&&e.add(a.courseStartDate)}),!ue){b.forEach(t=>{"active"===t.status&&e.add(t.courseStartDate)});b.filter(e=>"planned"===e.status).map(e=>e.courseStartDate).sort((e,t)=>e.localeCompare(t)).slice(0,2).forEach(t=>e.add(t))}return e.size},[b,xe,ue]),Ne=s.useMemo(()=>xe.filter(e=>null!==e.completedOverride?e.completedOverride:e.completedComputed).length,[xe]),we=()=>{j?alert(e("entitlement.readOnlyAction")):(E(void 0),D(!0))},je=t=>{j?alert(e("entitlement.readOnlyAction")):(E(t),D(!0))},ye=async t=>{j?alert(e("entitlement.readOnlyAction")):await h(t)},Ae=async t=>{if(t.preventDefault(),F(null),L.trim()&&I.trim()){U(null),G(!0);try{await l(L.trim(),I),$("")}catch(s){s instanceof Error?F(Gt(s.message,e)):F(e("auth.failed"))}finally{G(!1)}}else F(e("auth.required"))},Oe=async t=>{if(t.preventDefault(),F(null),U(null),L.trim()){G(!0);try{await c(L.trim()),U(e("auth.resetSent"))}catch(s){s instanceof Error?F(Gt(s.message,e)):F(e("auth.failed"))}finally{G(!1)}}else F(e("auth.emailRequired"))},qe=async t=>{if(t.preventDefault(),Q(null),V&&H)if(V.length<6)Q(e("auth.resetPasswordTooShort"));else if(V===H){J(!0);try{await d(V),Y(""),K("")}catch(s){s instanceof Error?Q(Gt(s.message,e)):Q(e("auth.failed"))}finally{J(!1)}}else Q(e("auth.resetPasswordsMismatch"));else Q(e("auth.resetPasswordRequired"))};return u?a.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center px-4",children:a.jsxs("div",{className:"w-full max-w-md bg-white rounded-xl shadow p-6 space-y-4 relative",children:[a.jsxs("div",{className:"absolute top-4 right-4 flex gap-1",children:[a.jsx("button",{type:"button",onClick:()=>r("bg"),className:"px-2.5 py-1 text-xs font-medium rounded "+("bg"===t?"bg-blue-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"),children:"BG"}),a.jsx("button",{type:"button",onClick:()=>r("en"),className:"px-2.5 py-1 text-xs font-medium rounded "+("en"===t?"bg-blue-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"),children:"EN"})]}),a.jsx("h1",{className:"text-2xl font-bold text-slate-900",children:e("auth.resetTitle")}),a.jsx("p",{className:"text-sm text-slate-600",children:e("auth.resetSubtitle")}),a.jsxs("form",{onSubmit:qe,className:"space-y-3",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:e("auth.newPassword")}),a.jsx("input",{type:"password",value:V,onChange:e=>Y(e.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:e("auth.passwordPlaceholder"),autoComplete:"new-password"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:e("auth.confirmPassword")}),a.jsx("input",{type:"password",value:H,onChange:e=>K(e.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:e("auth.passwordPlaceholder"),autoComplete:"new-password"})]}),Z&&a.jsx("p",{className:"text-sm text-red-600",children:Z}),a.jsx("button",{type:"submit",disabled:X,className:"w-full py-2.5 rounded-lg font-medium "+(X?"bg-slate-300 text-slate-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"),children:e(X?"common.loading":"auth.updatePassword")})]})]})}):n.configured&&!n.authenticated?a.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center px-4",children:a.jsxs("div",{className:"w-full max-w-md bg-white rounded-xl shadow p-6 space-y-4 relative",children:[a.jsxs("div",{className:"absolute top-4 right-4 flex gap-1",children:[a.jsx("button",{type:"button",onClick:()=>r("bg"),className:"px-2.5 py-1 text-xs font-medium rounded "+("bg"===t?"bg-blue-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"),children:"BG"}),a.jsx("button",{type:"button",onClick:()=>r("en"),className:"px-2.5 py-1 text-xs font-medium rounded "+("en"===t?"bg-blue-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"),children:"EN"})]}),a.jsx("h1",{className:"text-2xl font-bold text-slate-900",children:e("auth.title")}),a.jsx("p",{className:"text-sm text-slate-600",children:e("auth.subtitle")}),a.jsxs("form",{onSubmit:B?Oe:Ae,className:"space-y-3",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:e("auth.email")}),a.jsx("input",{type:"email",value:L,onChange:e=>M(e.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:e("auth.emailPlaceholder"),autoComplete:"email"})]}),!B&&a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:e("auth.password")}),a.jsx("input",{type:"password",value:I,onChange:e=>$(e.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:e("auth.passwordPlaceholder"),autoComplete:"current-password"})]}),R&&a.jsx("p",{className:"text-sm text-red-600",children:R}),_&&a.jsx("p",{className:"text-sm text-emerald-700",children:_}),m&&a.jsx("p",{className:"text-sm text-red-600",children:m}),n.error&&a.jsx("p",{className:"text-sm text-red-600",children:n.error}),a.jsx("button",{type:"submit",disabled:W||i,className:"w-full py-2.5 rounded-lg font-medium "+(W||i?"bg-slate-300 text-slate-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"),children:e(W?"common.loading":B?"auth.sendReset":"auth.signIn")}),a.jsx("button",{type:"button",onClick:()=>{z(e=>!e),F(null),U(null),p()},className:"w-full py-2 text-sm text-blue-700 hover:text-blue-800",children:e(B?"auth.backToLogin":"auth.forgotPassword")})]})]})}):a.jsx("div",{className:"min-h-screen bg-slate-50",children:a.jsxs(nt,{children:[a.jsx(lt,{activeTab:y,onTabChange:S}),n.configured&&n.authenticated&&("grace"===n.status||j)&&a.jsx("div",{className:"border-b "+(j?"bg-red-50 border-red-200":"bg-amber-50 border-amber-200"),children:a.jsx("div",{className:"container mx-auto px-4 py-2 text-sm",children:a.jsxs("div",{children:[a.jsx("p",{className:"font-medium "+(j?"text-red-700":"text-amber-800"),children:e(j?"entitlement.readOnlyBannerTitle":"entitlement.graceBannerTitle")}),!j&&null!==n.daysUntilReadOnly&&a.jsx("p",{className:"text-amber-700",children:e("entitlement.graceBannerMessage",{days:String(n.daysUntilReadOnly)})}),j&&a.jsx("p",{className:"text-red-700",children:e("entitlement.readOnlyBannerMessage")}),i&&a.jsx("p",{className:"text-slate-500",children:e("common.loading")})]})})}),"participants"===y?a.jsxs("main",{className:"container mx-auto px-4 py-6 pb-24 md:pb-6",children:[a.jsx(ot,{totalParticipants:he,visibleParticipants:be,totalCourses:fe,visibleCourses:ve,completedCount:Ne}),a.jsx(Ke,{activeFilters:{searchText:te,selectedGroup:ae,dateRange:le,statusFilters:ne},onRemoveFilter:(e,t)=>{switch(e){case"search":se("");break;case"group":re("");break;case"dateStart":oe(e=>({...e,start:""}));break;case"dateEnd":oe(e=>({...e,end:""}));break;case"status":t&&ie(e=>({...e,[t]:null}));break;case"all":se(""),re(""),ie({sent:null,documents:null,handedOver:null,paid:null,completed:null}),oe({start:"",end:""})}},groups:pe}),a.jsxs("div",{className:"hidden md:flex flex-wrap gap-3 mb-6",children:[a.jsxs("button",{onClick:we,disabled:j,className:"px-6 py-3 rounded-lg shadow font-medium "+(j?"bg-slate-300 text-slate-600 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700"),children:["+ ",e("participants.add")]}),a.jsx("button",{onClick:()=>O(!0),className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow font-medium",children:e("filters.title")})]}),a.jsx("div",{className:"md:hidden mb-4",children:a.jsxs("button",{onClick:()=>O(!0),className:"w-full px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow font-medium min-h-[48px]",children:["🔍 ",e("filters.title")]})}),a.jsxs("div",{className:"md:bg-white md:rounded-lg md:shadow",children:[a.jsxs("div",{className:"hidden md:block",children:[a.jsx("div",{className:"p-4 border-b",children:a.jsxs("h2",{className:"text-xl font-semibold text-slate-900",children:[e("participants.title")," ",be<he&&`(${be} ${e("participants.of")} ${he})`]})}),a.jsx("div",{className:"p-4",children:a.jsx(Be,{participants:xe,onEdit:je,onDelete:ye,collapsedSections:g,toggleSection:f,expandSection:v,hasActiveFilters:ue,onFilterChange:e=>{se(e.searchTerm),re(e.courseStartDate||""),ie({sent:null,documents:null,handedOver:null,paid:null,completed:null}),oe({start:"",end:""})},groupRefreshKey:T})})]}),a.jsx("div",{className:"md:hidden",children:a.jsx(Ve,{participants:xe,onEdit:je,onDelete:ye,onSelectionChange:P,collapsedSections:g,toggleSection:f,expandSection:v,hasActiveFilters:ue})})]})]}):a.jsx("main",{className:"container mx-auto px-4 py-6",children:a.jsx(Lt,{filteredParticipants:xe,entitlement:n,entitlementLoading:i,onSignOut:async()=>{try{await o()}catch(t){alert(t instanceof Error?t.message:e("auth.signOutFailed"))}}})}),a.jsx(He,{isOpen:A,onClose:()=>O(!1),searchText:te,onSearchTextChange:se,selectedGroup:ae,onSelectedGroupChange:re,statusFilters:ne,onStatusFilterChange:(e,t)=>{ie(s=>({...s,[e]:t}))},dateRange:le,onDateRangeChange:oe,groups:pe,onResetToDefaults:N,visibleCount:be,totalCount:he}),a.jsx(Ye,{isOpen:k,onClose:()=>{D(!1),E(void 0)},participant:C}),"participants"===y&&!q&&!j&&a.jsx(dt,{onClick:we}),a.jsx(ct,{activeTab:y,onTabChange:S})]})})}function Ft(){return a.jsx(wt,{children:a.jsx(Pe,{children:a.jsx(Rt,{})})})}class Bt extends s.Component{constructor(){super(...arguments),t(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){}render(){var e;return this.state.hasError?a.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 p-4",children:a.jsxs("div",{className:"max-w-md w-full bg-white shadow-lg rounded-lg p-6",children:[a.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"Something went wrong"}),a.jsx("p",{className:"text-gray-600 mb-4",children:"The application encountered an unexpected error. This might be due to a data consistency issue."}),a.jsx("div",{className:"bg-gray-100 p-3 rounded mb-4 overflow-auto max-h-32 text-xs font-mono text-red-800",children:null==(e=this.state.error)?void 0:e.message}),a.jsxs("div",{className:"flex gap-3",children:[a.jsx("button",{onClick:()=>window.location.reload(),className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition",children:"Reload Application"}),a.jsx("button",{onClick:()=>{window.confirm("Delete all local data and reset? This cannot be undone.")&&(indexedDB.deleteDatabase("CourseManagementDB"),localStorage.clear(),window.location.reload())},className:"flex-1 px-4 py-2 bg-red-100 text-red-700 border border-red-200 rounded hover:bg-red-200 transition",children:"Reset Data"})]})]})}):this.props.children}}const zt="2.2.0",_t="spi.app.version";if(localStorage.getItem(_t)!==zt){(async function(){if("serviceWorker"in navigator){const e=await navigator.serviceWorker.getRegistrations();for(const t of e)await t.unregister();if("caches"in window){const e=await caches.keys();await Promise.all(e.map(e=>caches.delete(e)))}}})().then(()=>{window.location.reload()});const e={};["spi.db.initialized","spi.language"].forEach(t=>{const s=localStorage.getItem(t);null!==s&&(e[t]=s)}),localStorage.clear(),Object.entries(e).forEach(([e,t])=>{localStorage.setItem(e,t)}),localStorage.setItem(_t,zt)}i.createRoot(document.getElementById("root")).render(a.jsx(r.StrictMode,{children:a.jsx(Bt,{children:a.jsx(Ft,{})})}));export{ue as f,qt as s};
