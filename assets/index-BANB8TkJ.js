const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./certificateGenerator-BmX9tfMH.js","./vendor-misc-VdyTtt_u.js","./fileDownload-0ohKhoX7.js","./vendor-react-3uLv-P3n.js","./vendor-dexie-mu9yNVYX.js","./vendor-dates-Dk0ftcM6.js","./vendor-uuid-CtRu48qb.js","./vendor-icons-QXWXkYnp.js","./vendor-supabase-CXFbbOpx.js","./ToolsPage-BTeG2ydO.js"])))=>i.map(i=>d[i]);
var ss=Object.defineProperty;var as=(t,s,a)=>s in t?ss(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a;var ve=(t,s,a)=>as(t,typeof s!="symbol"?s+"":s,a);import{r as x,j as e,R as Dt,c as rs}from"./vendor-react-3uLv-P3n.js";import{X as ns,u as Se}from"./vendor-dexie-mu9yNVYX.js";import{p as ze,f as os,i as ls,a as is,s as Ct}from"./vendor-dates-Dk0ftcM6.js";import{v as Et}from"./vendor-uuid-CtRu48qb.js";import{I as At,C as Ue,T as at,A as cs,a as ds,b as us,c as ms,U as ps,X as xs,H as hs,M as fs,d as bs,e as gs,L as Pt,S as ws,D as vs,f as We,g as Ot,E as xt,h as ht,G as ft}from"./vendor-icons-QXWXkYnp.js";import{c as Ns}from"./vendor-supabase-CXFbbOpx.js";import"./vendor-misc-VdyTtt_u.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const n of l.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&r(n)}).observe(document,{childList:!0,subtree:!0});function a(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function r(o){if(o.ep)return;o.ep=!0;const l=a(o);fetch(o.href,l)}})();const js="modulepreload",ys=function(t,s){return new URL(t,s).href},bt={},Le=function(s,a,r){let o=Promise.resolve();if(a&&a.length>0){const n=document.getElementsByTagName("link"),i=document.querySelector("meta[property=csp-nonce]"),u=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));o=Promise.allSettled(a.map(d=>{if(d=ys(d,r),d in bt)return;bt[d]=!0;const m=d.endsWith(".css"),E=m?'[rel="stylesheet"]':"";if(!!r)for(let v=n.length-1;v>=0;v--){const P=n[v];if(P.href===d&&(!m||P.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${E}`))return;const G=document.createElement("link");if(G.rel=m?"stylesheet":js,m||(G.as="script"),G.crossOrigin="",G.href=d,u&&G.setAttribute("nonce",u),document.head.appendChild(G),m)return new Promise((v,P)=>{G.addEventListener("load",v),G.addEventListener("error",()=>P(new Error(`Unable to preload CSS for ${d}`)))})}))}function l(n){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=n,window.dispatchEvent(i),!i.defaultPrevented)throw n}return o.then(n=>{for(const i of n||[])i.status==="rejected"&&l(i.reason);return s().catch(l)})};function Ss(t){const s=new Date(t),a=s.getDay();if(a===1)return s;const r=a===0?1:8-a;return s.setDate(s.getDate()+r),s}function Fe(t){const s=new Date(t),a=Ss(s),r=new Date(a);return r.setDate(r.getDate()+7),{courseStartDate:a.toISOString().split("T")[0],courseEndDate:r.toISOString().split("T")[0]}}function Ea(t,s,a,r){if(!t)return r;const o=t instanceof Date?t:new Date(t);return Number.isNaN(o.getTime())?r:new Intl.DateTimeFormat(s,{timeZone:a,day:"2-digit",month:"2-digit",year:"numeric"}).format(o)}const ks="APP_READ_ONLY_ERROR";let qt=!1;function Ce(t){qt=t}function et(){if(qt){const t=new Error("Read-only mode is enabled. Subscription access has expired.");throw t.name=ks,t}}class Ds extends ns{constructor(){super("CourseManagementDB");ve(this,"groups");ve(this,"participants");ve(this,"settings");ve(this,"yearlyArchives");this.version(1).stores({groups:"id, groupNumber, courseStartDate",participants:"id, groupNumber, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}),this.version(2).stores({groups:"id, groupNumber, courseStartDate",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}).upgrade(a=>a.table("participants").toCollection().modify(r=>{r.autoGroup=r.groupNumber,r.manualGroup=null})),this.version(3).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}).upgrade(a=>{const r=new Date().toISOString();return a.table("groups").toCollection().modify(o=>{o.status=o.groupNumber===1?"active":"planned",o.createdAt=r,o.updatedAt=r})}),this.version(4).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}).upgrade(a=>{const r=new Date().toISOString();a.table("participants").toCollection().modify(o=>{o.createdAt=o.createdAt||r,o.updatedAt=o.updatedAt||r,(o.completedComputed||o.completedOverride===!0)&&(o.completedAt=o.completedAt||r)}),a.table("groups").toCollection().modify(o=>{o.isLocked=o.status==="completed"})}),this.version(5).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id",yearlyArchives:"id, year"}),this.version(6).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate, egn",settings:"id",yearlyArchives:"id, year"}).upgrade(a=>a.table("participants").toCollection().modify(r=>{r.egn=r.egn||"",r.birthPlace=r.birthPlace||"",r.citizenship=r.citizenship||"българско"})),this.version(7).stores({groups:"id, courseStartDate, status, groupNumber",participants:"id, courseStartDate, uniqueNumber, companyName, personName, egn",settings:"id",yearlyArchives:"id, year"}).upgrade(async a=>{await a.table("participants").toCollection().modify(r=>{delete r.groupNumber,delete r.autoGroup,delete r.manualGroup}),await a.table("groups").toCollection().modify(r=>{r.status==="planned"&&(r.groupNumber=null)})}),[this.groups,this.participants,this.settings,this.yearlyArchives].forEach(a=>{a.hook("creating",()=>{et()}),a.hook("updating",()=>{et()}),a.hook("deleting",()=>{et()})})}}const D=new Ds;async function Cs(){try{if(await D.settings.count()===0)await D.settings.add({id:1,lastUniquePrefix:3533,lastUniqueSeq:0,lastResetYear:null});else{const s=await D.settings.get(1);s&&s.lastUniquePrefix<=3531&&(await D.settings.update(1,{lastUniquePrefix:3533,lastUniqueSeq:0}),console.log("✅ Updated unique number prefix to 3533 for 2026"))}}catch(t){console.error("Failed to initialize settings:",t)}}Cs().catch(t=>{console.error("CRITICAL DB INIT FAILURE:",t)});function xe(t,s){return`${t.toString().padStart(4,"0")}-${s}`}function ke(t){const s=t.match(/^(\d{4})-(\d+)$/);return s?{prefix:parseInt(s[1],10),seq:parseInt(s[2],10)}:null}async function Xe(t=!1){const s=await D.participants.toArray();let a=null;for(const r of s){if(!r.uniqueNumber)continue;const o=ke(r.uniqueNumber);o&&(a?(o.prefix>a.prefix||o.prefix===a.prefix&&o.seq>a.seq)&&(a=o):a=o)}if(!t){const r=await D.settings.get(1);if(r){const o={prefix:r.lastUniquePrefix,seq:r.lastUniqueSeq};a?(o.prefix>a.prefix||o.prefix===a.prefix&&o.seq>a.seq)&&(a=o):a=o}}return a}async function He(){const t=await D.settings.get(1);if(!t)throw new Error("Settings not initialized");let s=t.lastUniquePrefix,a=t.lastUniqueSeq;const r=await Xe();r&&(r.prefix>s?(s=r.prefix,a=r.seq):r.prefix===s&&r.seq>a&&(a=r.seq));const o=s+1,l=a+1;return xe(o,l)}async function Lt(t){const s=await D.groups.get(t);if(!s)return;if(s.status!=="active"){console.warn(`Attempted to assign numbers to non-active group ${t}`);return}const r=(await D.participants.where("courseStartDate").equals(s.courseStartDate).toArray()).filter(d=>!d.uniqueNumber);if(r.length===0)return;r.sort((d,m)=>{const E=new Date(d.createdAt||0).getTime(),N=new Date(m.createdAt||0).getTime();return E!==N?E-N:(d.id||"").localeCompare(m.id||"")});const o=await D.settings.get(1);if(!o)throw new Error("Settings not initialized");let l=o.lastUniquePrefix,n=o.lastUniqueSeq;const i=await Xe();i&&(i.prefix>l?(l=i.prefix,n=i.seq):i.prefix===l&&i.seq>n&&(n=i.seq));const u=[];for(const d of r){l++,n++;const m=xe(l,n);u.push({id:d.id,uniqueNumber:m})}for(const d of u)await D.participants.update(d.id,{uniqueNumber:d.uniqueNumber});await D.settings.update(1,{lastUniquePrefix:l,lastUniqueSeq:n})}async function Aa(){const t=await D.settings.get(1);if(!t)return;const s=t.lastUniquePrefix+1;await D.settings.update(1,{lastUniquePrefix:s,lastUniqueSeq:0,lastResetYear:new Date().getFullYear()})}async function gt(t){const s=ke(t);if(!s)return;const{prefix:a}=s,r=await D.participants.filter(n=>!!n.uniqueNumber).toArray(),o=[];for(const n of r){const i=ke(n.uniqueNumber);if(i&&i.prefix>a){const u=i.prefix-1,d=i.seq-1,m=xe(u,d);o.push({id:n.id,newNum:m,newPrefix:u,newSeq:d})}}for(const n of o)await D.participants.update(n.id,{uniqueNumber:n.newNum});const l=await Xe();l&&await D.settings.update(1,{lastUniquePrefix:l.prefix,lastUniqueSeq:l.seq})}async function rt(t,s){const r=await D.participants.where("uniqueNumber").equals(t).toArray();return s?r.length===0||r.length===1&&r[0].id===s:r.length===0}async function nt(){const s=(await D.participants.toArray()).filter(r=>r.uniqueNumber).map(r=>ke(r.uniqueNumber)).filter(r=>r!==null).sort((r,o)=>r.prefix!==o.prefix?r.prefix-o.prefix:r.seq-o.seq);if(console.log("[checkForGaps] Numbers in DB:",s.map(r=>xe(r.prefix,r.seq))),s.length===0)return null;for(let r=0;r<s.length-1;r++){const o=s[r];if(s[r+1].prefix!==o.prefix+1){const n=xe(o.prefix+1,o.seq+1);return console.log("[checkForGaps] Gap found between numbers:",n),n}}const a=await D.settings.get(1);if(console.log("[checkForGaps] Settings:",a?`${a.lastUniquePrefix}-${a.lastUniqueSeq}`:"none"),a&&s.length>0){const r=s[s.length-1];if(console.log("[checkForGaps] Last in DB:",xe(r.prefix,r.seq)),a.lastUniquePrefix>r.prefix){const o=xe(r.prefix+1,r.seq+1);return console.log("[checkForGaps] Gap found after last number:",o),o}}return console.log("[checkForGaps] No gaps found"),null}function Es(t){return/^\d{4}-\d+$/.test(t)}async function Mt(t){const s=await D.participants.where("courseStartDate").equals(t).toArray();for(const r of s)r.uniqueNumber&&await D.participants.update(r.id,{uniqueNumber:""});const a=await Xe(!0);a&&await D.settings.update(1,{lastUniquePrefix:a.prefix,lastUniqueSeq:a.seq})}function As(t){const a=Ct(new Date);return ze(t)>=a}function he(t,s){const a=ze(t),r=ze(s);if(!ls(a,r)&&!is(a,r))return!1;const o=Ct(r);return a>=o}function T(t){try{const s=ze(t);return os(s,"dd.MM.yyyy")}catch{return t}}const _e="Медицинското трябва да е в рамките на 6 месеца преди началото на курса.";async function de(){return D.groups.where("status").equals("active").first()}async function Ps(t){const s=await D.groups.where("courseStartDate").equals(t).first();s&&await Lt(s.id)}async function Pa(){return D.groups.where("status").equals("planned").sortBy("courseStartDate")}async function Ve(t){const{courseStartDate:s}=Fe(t),a=await D.groups.toArray(),r=a.find(n=>n.status==="active"),o=a.filter(n=>n.status==="planned").sort((n,i)=>n.courseStartDate.localeCompare(i.courseStartDate));if(r&&s<=r.courseStartDate&&he(t,r.courseStartDate))return{group:r,shouldCreate:!1};const l=a.find(n=>n.courseStartDate===s);if(l&&l.status==="completed"){const n=[];r&&n.push(r),n.push(...o),n.sort((u,d)=>u.courseStartDate.localeCompare(d.courseStartDate));const i=n.find(u=>u.courseStartDate<s?!1:he(t,u.courseStartDate));return i?{group:i,shouldCreate:!1}:{group:l,shouldCreate:!1}}return l?{group:l,shouldCreate:!1}:r&&s<r.courseStartDate?{group:{id:"stub_past",status:"completed",courseStartDate:s,courseEndDate:"",groupNumber:-1,createdAt:"",updatedAt:"",isLocked:!0},shouldCreate:!1}:{group:null,shouldCreate:!0,createsForDate:s}}async function ot(t,s="planned"){const a=await D.groups.where("courseStartDate").equals(t).first();if(a)return a.status!==s&&s==="active"&&console.warn(`Group for ${t} already exists with status ${a.status}. Returning existing.`),a;let r=null;s==="active"&&(r=null);const o=new Date(t);o.setDate(o.getDate()+7);const l=new Date().toISOString(),n={id:Et(),groupNumber:r,courseStartDate:t,courseEndDate:o.toISOString().split("T")[0],status:s,createdAt:l,updatedAt:l,isLocked:!1};return await D.groups.add(n),n}async function Oa(){const t=await de();if(!t)throw new Error("No active group to close");const s=new Date().toISOString();let a=t.groupNumber;if(a==null){const r=await D.groups.where("status").equals("completed").toArray(),o=new Set(r.map(n=>n.groupNumber).filter(n=>n!=null&&n>0));let l=1;for(;o.has(l);)l++;a=l,console.log(`Assigning Group Number ${a} to closed group (Gap filling/Next sequential)`)}await D.groups.update(t.id,{status:"completed",groupNumber:a,updatedAt:s,closedAt:s,isLocked:!0})}async function Pe(){const t=await D.participants.toArray(),s=await D.groups.toArray(),a=s.find(f=>f.status==="active");if(a&&(a.groupNumber===null||a.groupNumber===void 0)){const f=new Set(s.map(g=>g.groupNumber).filter(g=>g!=null&&g>0));let h=1;for(;f.has(h);)h++;await D.groups.update(a.id,{groupNumber:h,updatedAt:new Date().toISOString()}),console.log(`✅ Assigned Group Number ${h} to active group`)}const r=s.filter(f=>f.status==="active");for(const f of r)await Ps(f.courseStartDate);for(const f of s){const h=new Date(f.courseStartDate);if(h.getDay()!==1){console.warn(`Found invalid group start date ${f.courseStartDate} (Day: ${h.getDay()}). Fixing to Monday.`);const g=h.getDay(),C=g===0?1:8-g,k=new Date(h);k.setDate(h.getDate()+C);const O=k.toISOString().split("T")[0];await D.groups.update(f.id,{courseStartDate:O,courseEndDate:new Date(k.getTime()+7*24*60*60*1e3).toISOString().split("T")[0]});const M=t.filter(_=>_.courseStartDate===f.courseStartDate);for(const _ of M)await D.participants.update(_.id,{courseStartDate:O,courseEndDate:new Date(k.getTime()+7*24*60*60*1e3).toISOString().split("T")[0]})}}const o=new Set;t.forEach(f=>o.add(f.courseStartDate));let l;if(a)l=new Date(a.courseStartDate);else{const f=new Date,h=f.getDay(),g=h===0?1:h===1?0:8-h;l=new Date(f),l.setHours(12,0,0,0),l.setDate(f.getDate()+g)}const n=new Date(l);n.setDate(n.getDate()+7);const i=new Date(l);i.setDate(i.getDate()+14),o.add(n.toISOString().split("T")[0]),o.add(i.toISOString().split("T")[0]);const u=new Set(s.map(f=>f.courseStartDate));for(const f of o)u.has(f)||(console.log(`Creating missing planned group for ${f}`),await ot(f,"planned"));const d=await D.groups.toArray(),m=new Map;t.forEach(f=>{m.set(f.courseStartDate,(m.get(f.courseStartDate)||0)+1)});const E=new Map;d.forEach(f=>{const h=E.get(f.courseStartDate)||[];h.push(f),E.set(f.courseStartDate,h)});for(const[f,h]of E)if(h.length>1){console.warn(`Found ${h.length} duplicate groups for ${f}. Merging and cleaning up...`);const g=h.sort((O,M)=>{const _=z=>z.status==="completed"?3:z.status==="active"?2:1,L=_(O),I=_(M);return L!==I?I-L:0}),C=g[0],k=g.slice(1);for(const O of k)console.warn(`Merging participants from duplicate group ${O.id} to ${C.id}`),await D.groups.delete(O.id)}const N=await D.groups.toArray(),G=N.find(f=>f.status==="active");if(G){const f=N.filter(h=>h.status==="planned"&&h.courseStartDate<G.courseStartDate&&(m.get(h.courseStartDate)||0)===0);for(const h of f)console.log(`Removing old empty planned group before active: ${h.courseStartDate}`),await D.groups.delete(h.id)}const P=(await D.groups.toArray()).filter(f=>f.status==="planned");if(P.length>2){const f=P.filter(g=>(m.get(g.courseStartDate)||0)===0);let h=P.length;f.sort((g,C)=>C.courseStartDate.localeCompare(g.courseStartDate));for(const g of f){if(h<=2)break;console.log(`Pruning excess empty planned group: ${g.courseStartDate}`),await D.groups.delete(g.id),h--}}}function Ee(t){return t?t.status==="completed"&&t.isLocked:!1}async function qa(){return D.groups.where("status").equals("completed").reverse().sortBy("groupNumber")}async function La(t){const s=await D.groups.get(t);if(!s)throw new Error("Group not found");if(s.status==="active")return{success:!0};const a=await de();return a&&a.id!==t?{success:!1,needsConfirm:!0,currentActive:a}:await It(t)}async function It(t,s=!1){const a=await D.groups.get(t);if(!a)throw new Error("Group not found");const r=new Date().toISOString();if(s){const l=await de();l&&(await D.groups.update(l.id,{status:"planned",updatedAt:r,activatedAt:void 0,groupNumber:null}),await Mt(l.courseStartDate))}let o=a.groupNumber;if(a.status==="planned"&&o===null){const l=await D.groups.toArray(),n=new Set(l.map(u=>u.groupNumber).filter(u=>u!=null&&u>0));let i=1;for(;n.has(i);)i++;o=i,console.log(`Assigning Group Number ${o} to newly activated group`)}return await D.groups.update(t,{groupNumber:o,status:"active",activatedAt:r,updatedAt:r,isLocked:!1}),await Lt(t),{success:!0}}async function Ma(){const t=await de();if(!t)throw new Error("No active group to set as planned");const s=new Date().toISOString();await D.groups.update(t.id,{status:"planned",updatedAt:s,activatedAt:void 0}),await Mt(t.courseStartDate)}async function Ia(t){const s=await D.groups.get(t);if(!s)throw new Error("Group not found");if(s.status!=="completed")throw new Error("Only archived groups can be reopened");const a=await de();return a?{success:!1,needsConfirm:!0,currentActive:a}:await It(t)}async function Os(){const t=await D.groups.where("status").equals("active").toArray();if(t.length<=1)return;console.warn(`⚠️ Found ${t.length} active groups! Fixing...`);const s=t.sort((l,n)=>new Date(n.updatedAt).getTime()-new Date(l.updatedAt).getTime()),a=s[0],r=s.slice(1),o=new Date().toISOString();for(const l of r)await D.groups.update(l.id,{status:"planned",updatedAt:o,activatedAt:void 0}),console.warn(`⚠️ Moved Group ${l.groupNumber} from active to planned`);console.log(`✅ Kept Group ${a.groupNumber} as active`)}async function qs(){return D.participants.orderBy("courseStartDate").toArray()}async function Oe(t){return D.participants.get(t)}async function Ls(t){await D.participants.add(t)}async function Ye(t,s){await D.participants.update(t,s)}async function Ms(t){await D.participants.delete(t)}async function Is(t){return D.participants.where("courseStartDate").equals(t).count()}async function wt(){return(await D.groups.toArray()).sort((s,a)=>s.courseStartDate.localeCompare(a.courseStartDate))}async function $s(t){return D.groups.where("groupNumber").equals(t).first()}async function Ts(t){return D.groups.where("courseStartDate").equals(t).toArray()}async function Ke(t){return D.groups.where("courseStartDate").equals(t).first()}function Je(){return{participants:Se(()=>qs()),addParticipant:async n=>{const{courseStartDate:i}=Fe(n.medicalDate);if(!he(n.medicalDate,i))throw new Error(_e);const{group:u,shouldCreate:d,createsForDate:m}=await Ve(n.medicalDate),E=u?u.courseStartDate:m||i,N=(()=>{const g=new Date(E);return g.setDate(g.getDate()+7),g.toISOString().split("T")[0]})();if(!he(n.medicalDate,E))throw new Error(_e);if((await Ts(E)).some(g=>g.status==="completed"))throw new Error("Не може да добавяте нови участници към приключила група (периодът е архивиран).");if((u==null?void 0:u.status)==="completed")throw new Error("Не може да добавяте нови участници към приключила група.");if(d){const C=await de()?"planned":"active";await ot(E,C)}let v;if(n.uniqueNumber){if(!await rt(n.uniqueNumber))throw new Error("Unique number already exists");v=n.uniqueNumber}else(u==null?void 0:u.status)==="active"?v=await He():v="";const P=!1,f=new Date().toISOString(),h={id:Et(),companyName:n.companyName,personName:n.personName,egn:n.egn||"",birthPlace:n.birthPlace||"",citizenship:n.citizenship||"българско",medicalDate:n.medicalDate,courseStartDate:E,courseEndDate:N,uniqueNumber:v,sent:!1,documents:!1,handedOver:!1,paid:!1,completedOverride:null,completedComputed:P,createdAt:f,updatedAt:f};return await Ls(h),await Pe(),h},updateParticipant:async(n,i)=>{const u=await Oe(n);if(!u)throw new Error("Participant not found");const d=await Ke(u.courseStartDate);if(Ee(d))throw new Error("Не може да редактирате участник от заключена група. Моля отключете групата първо от Tools.");const m={};let E=null;if(i.companyName!==void 0&&(m.companyName=i.companyName),i.personName!==void 0&&(m.personName=i.personName),i.egn!==void 0&&(m.egn=i.egn),i.birthPlace!==void 0&&(m.birthPlace=i.birthPlace),i.citizenship!==void 0&&(m.citizenship=i.citizenship),i.medicalDate&&i.medicalDate!==u.medicalDate){const{group:C,shouldCreate:k,createsForDate:O}=await Ve(i.medicalDate),{courseStartDate:M}=Fe(i.medicalDate),_=C?C.courseStartDate:O||M,L=(()=>{const B=new Date(_);return B.setDate(B.getDate()+7),B.toISOString().split("T")[0]})();if(!he(i.medicalDate,_))throw new Error(_e);if((C==null?void 0:C.status)==="completed")throw new Error("Медицинският преглед отговаря на приключила група (периодът е архивиран).");if(k){const U=await de()?"planned":"active";await ot(_,U)}m.medicalDate=i.medicalDate,m.courseStartDate=_,m.courseEndDate=L;const I=await Ke(u.courseStartDate),z=(I==null?void 0:I.status)||"planned",w=(C==null?void 0:C.status)||"planned";if(w==="active"&&z!=="active"){const B=await nt();B?m.uniqueNumber=B:m.uniqueNumber=await He()}else if(z==="active"&&w==="planned"){const B=u.uniqueNumber;m.uniqueNumber="",B&&(E=B)}}if(i.uniqueNumber&&i.uniqueNumber!==u.uniqueNumber){if(!await rt(i.uniqueNumber,n))throw new Error("Unique number already exists");m.uniqueNumber=i.uniqueNumber}i.sent!==void 0&&(m.sent=i.sent),i.documents!==void 0&&(m.documents=i.documents),i.handedOver!==void 0&&(m.handedOver=i.handedOver),i.paid!==void 0&&(m.paid=i.paid);const N=m.sent!==void 0?m.sent:u.sent,G=m.documents!==void 0?m.documents:u.documents,v=m.handedOver!==void 0?m.handedOver:u.handedOver,P=m.paid!==void 0?m.paid:u.paid,f=N&&G&&v&&P;m.completedComputed=f,m.updatedAt=new Date().toISOString();const h=u.completedOverride!==null?u.completedOverride:u.completedComputed,g=m.completedOverride!==void 0&&m.completedOverride!==null?m.completedOverride:m.completedOverride===null?f:u.completedOverride!==null?u.completedOverride:f;!h&&g&&(m.completedAt=new Date().toISOString()),await Ye(n,m),E&&await gt(E),await Pe()},deleteParticipant:async n=>{const i=await Oe(n);await Ms(n),i&&i.uniqueNumber&&await gt(i.uniqueNumber),await Pe()},resetCompletedOverride:async n=>{await Ye(n,{completedOverride:null})},getParticipant:async n=>Oe(n)}}function Gs(){return{groups:Se(async()=>wt()),getGroup:async r=>$s(r),getGroupsWithCounts:async()=>{const r=await wt();return await Promise.all(r.map(async l=>{const n=await Is(l.courseStartDate);return{...l,participantCount:n}}))}}}const ae={active:"groups-collapsed-active",planned:"groups-collapsed-planned",completed:"groups-collapsed-completed"};function Bs(){const[t,s]=x.useState(()=>{const i=localStorage.getItem(ae.active),u=localStorage.getItem(ae.planned),d=localStorage.getItem(ae.completed);return u==="true"||i==="true"?(localStorage.setItem(ae.active,"false"),localStorage.setItem(ae.planned,"false"),localStorage.setItem(ae.completed,"true"),{active:!1,planned:!1,completed:!0}):{active:i==="true",planned:u==="true",completed:d===null?!0:d==="true"}});return x.useEffect(()=>{localStorage.setItem(ae.active,String(t.active)),localStorage.setItem(ae.planned,String(t.planned)),localStorage.setItem(ae.completed,String(t.completed))},[t]),{collapsedSections:t,toggleSection:i=>{s(u=>({...u,[i]:!u[i]}))},expandSection:i=>{s(u=>({...u,[i]:!1}))},expandAll:()=>{s({active:!1,planned:!1,completed:!1})},resetToDefaults:()=>{s({active:!1,planned:!1,completed:!0}),localStorage.setItem(ae.active,"false"),localStorage.setItem(ae.planned,"false"),localStorage.setItem(ae.completed,"true")},setCollapsedState:i=>{s(i)}}}const Rs=(t,s,a)=>{const r=t[s];return r?typeof r=="function"?r():Promise.resolve(r):new Promise((o,l)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(l.bind(null,new Error("Unknown variable dynamic import: "+s+(s.split("/").length!==a?". Note that variables only represent file names one level deep.":""))))})},$t=x.createContext(void 0),_s=({children:t})=>{const[s,a]=x.useState(()=>{var m;const i=localStorage.getItem("spi.language");return i==="bg"||i==="en"?i:(navigator.language||((m=navigator.languages)==null?void 0:m[0])||"en").toLowerCase().startsWith("bg")?"bg":"en"}),[r,o]=x.useState({});x.useEffect(()=>{(async()=>{const u=await Rs(Object.assign({"../locales/bg.ts":()=>Le(()=>import("./bg-2-bdpX8K.js"),[],import.meta.url),"../locales/en.ts":()=>Le(()=>import("./en-BmU_mF-p.js"),[],import.meta.url)}),`../locales/${s}.ts`,3);o(u.default)})()},[s]);const l=i=>{a(i),localStorage.setItem("spi.language",i)},n=(i,u)=>{let d=r[i]||i;return u&&Object.entries(u).forEach(([m,E])=>{d=d.replace(`{${m}}`,E)}),d};return e.jsx($t.Provider,{value:{language:s,setLanguage:l,t:n},children:t})},Q=()=>{const t=x.useContext($t);if(!t)throw new Error("useLanguage must be used within LanguageProvider");return t},Me=({isOpen:t,onClose:s,onConfirm:a,title:r,message:o,confirmText:l="Confirm",cancelText:n="Cancel",variant:i="info"})=>{if(x.useEffect(()=>{const E=N=>{N.key==="Escape"&&s()};if(t)return document.addEventListener("keydown",E),()=>document.removeEventListener("keydown",E)},[t,s]),!t)return null;const u=()=>{switch(i){case"danger":return e.jsx(at,{className:"w-6 h-6 text-red-600"});case"warning":return e.jsx(at,{className:"w-6 h-6 text-amber-600"});case"success":return e.jsx(Ue,{className:"w-6 h-6 text-emerald-600"});default:return e.jsx(At,{className:"w-6 h-6 text-blue-600"})}},d=()=>{switch(i){case"danger":return"bg-red-50 text-red-900 border-red-100";case"warning":return"bg-amber-50 text-amber-900 border-amber-100";case"success":return"bg-emerald-50 text-emerald-900 border-emerald-100";default:return"bg-blue-50 text-blue-900 border-blue-100"}},m=()=>{switch(i){case"danger":return"bg-red-600 hover:bg-red-700 focus:ring-red-500";case"warning":return"bg-amber-600 hover:bg-amber-700 focus:ring-amber-500";case"success":return"bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500";default:return"bg-blue-600 hover:bg-blue-700 focus:ring-blue-500"}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 transition-opacity",onClick:s}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden animate-scale-up transform transition-all",children:[e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:`p-3 rounded-full flex-shrink-0 ${d()} bg-opacity-50`,children:u()}),e.jsxs("div",{className:"flex-1 pt-1",children:[e.jsx("h3",{className:"text-xl font-bold text-slate-900 mb-2 leading-none",children:r}),e.jsx("p",{className:"text-slate-600 leading-relaxed text-sm",children:o})]})]})}),e.jsxs("div",{className:"p-4 bg-slate-50 flex gap-3 justify-end border-t border-slate-100",children:[e.jsx("button",{onClick:s,className:"px-5 py-2.5 bg-white text-slate-700 border border-slate-200 rounded-lg hover:bg-slate-50 hover:text-slate-900 font-medium transition-all duration-200 shadow-sm",children:n}),e.jsx("button",{onClick:()=>{a(),s()},className:`px-5 py-2.5 text-white rounded-lg font-medium shadow-md transition-all duration-200 transform hover:-translate-y-0.5 ${m()}`,children:l})]})]})})]})},zs={Egida:"bg-violet-50 text-violet-700 ring-1 ring-violet-200/50","D-Max":"bg-orange-50 text-orange-700 ring-1 ring-orange-200/50",Multiforce:"bg-cyan-50 text-cyan-700 ring-1 ring-cyan-200/50"},Us="bg-slate-50 text-slate-600 ring-1 ring-slate-200/50",qe=({companyName:t,className:s=""})=>{const a=zs[t]||Us;return e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 text-xs rounded-full 
        font-medium tracking-normal transition-all duration-150 
        hover:ring-2 hover:shadow-sm ${a} ${s}`,"aria-label":`Company: ${t||"Unknown"}`,children:t||"Няма компания"})};function Ws(){return{bulkSetFlag:async(a,r,o)=>{const l={success:0,failed:0,errors:[]},n=new Date().toISOString();for(const i of a)try{const u=await Oe(i);if(!u){l.failed++,l.errors.push(`Participant ${i} not found`);continue}const d=await Ke(u.courseStartDate);if(d&&d.status==="completed"&&d.isLocked){l.failed++,l.errors.push(`Participant ${u.personName} belongs to locked group (${d.courseStartDate})`);continue}const m={[r]:o,updatedAt:n},E=r==="sent"?o:u.sent,N=r==="documents"?o:u.documents,G=r==="handedOver"?o:u.handedOver,v=r==="paid"?o:u.paid,P=E&&N&&G&&v;m.completedComputed=P;const f=u.completedOverride!==null?u.completedOverride:u.completedComputed,h=u.completedOverride!==null?u.completedOverride:P;!f&&h&&(m.completedAt=n),await Ye(i,m),l.success++}catch(u){l.failed++,l.errors.push(`Failed to update ${i}: ${u.message}`)}return l},bulkSetCompleted:async a=>{const r={success:0,failed:0,errors:[]},o=new Date().toISOString();for(const l of a)try{const n=await Oe(l);if(!n){r.failed++,r.errors.push(`Participant ${l} not found`);continue}const i=await Ke(n.courseStartDate);if(i&&i.status==="completed"&&i.isLocked){r.failed++,r.errors.push(`Participant ${n.personName} belongs to locked group (${i.courseStartDate})`);continue}if(!n.sent||!n.documents||!n.handedOver||!n.paid){r.failed++,r.errors.push(`Participant ${n.personName} does not have all 4 flags set`);continue}await Ye(l,{completedOverride:!0,updatedAt:o,completedAt:o}),r.success++}catch(n){r.failed++,r.errors.push(`Failed to update ${l}: ${n.message}`)}return r}}}const Tt=({selectedCount:t,selectedIds:s,onClearSelection:a,onActionComplete:r})=>{const{t:o}=Q(),{bulkSetFlag:l}=Ws(),[n,i]=x.useState(!1),[u,d]=x.useState(!1),[m,E]=x.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}}),N=async(v,P)=>{i(!0);try{const f=await l(s,v,P);f.failed>0?alert(`${o("bulk.completed")}: ${f.success}
${o("bulk.failed")}: ${f.failed}
${f.errors.join(`
`)}`):alert(`${o("bulk.success")}: ${f.success} ${o("bulk.updated")}`),r()}catch(f){alert(`${o("bulk.error")}: ${f.message}`)}finally{i(!1)}},G=()=>{E({isOpen:!0,title:o("bulk.confirmPaidTitle"),message:o("bulk.confirmPaidMessage"),onConfirm:async()=>{E({...m,isOpen:!1}),await N("paid",!0)}})};return t===0?null:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block sticky top-0 bg-blue-600 text-white shadow-lg z-20 mb-4 rounded-lg",children:e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:a,className:"p-1 hover:bg-blue-700 rounded transition-colors","aria-label":"Clear selection",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsxs("span",{className:"font-semibold",children:[t," ",o("bulk.selected")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>N("sent",!0),disabled:n,className:"px-3 py-1.5 bg-white text-blue-600 rounded text-sm font-medium hover:bg-blue-50 disabled:opacity-50 whitespace-nowrap",children:o("bulk.setSent")}),e.jsx("button",{onClick:()=>N("documents",!0),disabled:n,className:"px-3 py-1.5 bg-white text-blue-600 rounded text-sm font-medium hover:bg-blue-50 disabled:opacity-50 whitespace-nowrap",children:o("bulk.setDocuments")}),e.jsx("button",{onClick:()=>N("handedOver",!0),disabled:n,className:"px-3 py-1.5 bg-white text-blue-600 rounded text-sm font-medium hover:bg-blue-50 disabled:opacity-50 whitespace-nowrap",children:o("bulk.setHanded")}),e.jsx("button",{onClick:G,disabled:n,className:"px-3 py-1.5 bg-amber-100 text-amber-800 rounded text-sm font-medium hover:bg-amber-200 disabled:opacity-50 whitespace-nowrap",children:o("bulk.setPaid")}),e.jsx("div",{className:"w-px h-6 bg-blue-400"}),e.jsx("button",{onClick:()=>N("sent",!1),disabled:n,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:o("bulk.clearSent")}),e.jsx("button",{onClick:()=>N("documents",!1),disabled:n,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:o("bulk.clearDocuments")}),e.jsx("button",{onClick:()=>N("handedOver",!1),disabled:n,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:o("bulk.clearHanded")}),e.jsx("button",{onClick:()=>N("paid",!1),disabled:n,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:o("bulk.clearPaid")})]})]})}),e.jsxs("div",{className:"md:hidden fixed bottom-16 left-0 right-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-2xl z-20 rounded-t-2xl",style:{boxShadow:"0 -10px 25px -5px rgba(0, 0, 0, 0.3), 0 -8px 10px -6px rgba(0, 0, 0, 0.1)"},children:[e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:a,className:"p-1.5 hover:bg-white/20 rounded-full transition-all active:scale-95","aria-label":"Clear selection",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M6 18L18 6M6 6l12 12"})})}),e.jsxs("div",{className:"flex items-baseline gap-1.5",children:[e.jsx("span",{className:"text-xl font-bold",children:t}),e.jsx("span",{className:"text-sm font-medium opacity-90",children:o("bulk.selected")})]})]}),e.jsxs("button",{onClick:()=>d(!u),className:"px-4 py-2.5 bg-white text-blue-700 rounded-full font-semibold text-sm hover:bg-blue-50 active:scale-95 transition-all shadow-md flex items-center gap-1.5",disabled:n,children:[o("bulk.actions"),e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M19 9l-7 7-7-7"})})]})]}),u&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-end pointer-events-auto",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40 pointer-events-auto",onClick:()=>d(!1)}),e.jsxs("div",{className:"relative w-full bg-white rounded-t-3xl shadow-2xl max-h-[80vh] overflow-hidden animate-slide-up pointer-events-auto z-10",children:[e.jsxs("div",{className:"sticky top-0 bg-white border-b border-slate-200 px-6 py-3 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-bold text-slate-900",children:o("bulk.actionTitle")}),e.jsxs("p",{className:"text-xs text-slate-600 mt-0",children:[o("bulk.forSelected"),": ",e.jsx("span",{className:"font-semibold",children:t})]})]}),e.jsx("button",{onClick:()=>d(!1),className:"p-2 hover:bg-slate-100 rounded-full transition-colors active:scale-95","aria-label":"Close",children:e.jsx("svg",{className:"w-6 h-6 text-slate-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"overflow-y-auto",children:[e.jsxs("div",{className:"px-6 pt-3 pb-1",children:[e.jsx("div",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider mb-2",children:o("bulk.set")}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("button",{onClick:()=>{N("sent",!0),d(!1)},disabled:n,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-blue-600 text-lg",children:"✓"}),e.jsx("span",{className:"flex-1 font-medium",children:o("bulk.setSent")})]}),e.jsxs("button",{onClick:()=>{N("documents",!0),d(!1)},disabled:n,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-blue-600 text-lg",children:"✓"}),e.jsx("span",{className:"flex-1 font-medium",children:o("bulk.setDocuments")})]}),e.jsxs("button",{onClick:()=>{N("handedOver",!0),d(!1)},disabled:n,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-blue-600 text-lg",children:"✓"}),e.jsx("span",{className:"flex-1 font-medium",children:o("bulk.setHanded")})]}),e.jsxs("button",{onClick:()=>{G(),d(!1)},disabled:n,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-amber-50 active:bg-amber-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-amber-600 text-lg",children:"✓"}),e.jsx("span",{className:"flex-1 font-medium",children:o("bulk.setPaid")})]})]})]}),e.jsx("div",{className:"my-2 mx-6 border-t border-slate-200"}),e.jsxs("div",{className:"px-6 pb-20",children:[e.jsx("div",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider mb-2",children:o("bulk.clear")}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("button",{onClick:()=>{N("sent",!1),d(!1)},disabled:n,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),e.jsx("span",{className:"flex-1",children:o("bulk.clearSent")})]}),e.jsxs("button",{onClick:()=>{N("documents",!1),d(!1)},disabled:n,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),e.jsx("span",{className:"flex-1",children:o("bulk.clearDocuments")})]}),e.jsxs("button",{onClick:()=>{N("handedOver",!1),d(!1)},disabled:n,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),e.jsx("span",{className:"flex-1",children:o("bulk.clearHanded")})]}),e.jsxs("button",{onClick:()=>{N("paid",!1),d(!1)},disabled:n,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),e.jsx("span",{className:"flex-1",children:o("bulk.clearPaid")})]})]})]})]})]})]})]}),e.jsx(Me,{isOpen:m.isOpen,onClose:()=>E({...m,isOpen:!1}),onConfirm:m.onConfirm,title:m.title,message:m.message,confirmText:o("common.confirm"),cancelText:o("common.cancel")})]})};function je({title:t,count:s,groupNumbers:a,dateRange:r,participantCount:o,isCollapsed:l,onToggle:n,children:i,variant:u="active",showCount:d=!0}){const{t:m}=Q(),N={active:{bg:"bg-blue-50",border:"border-blue-200",accent:"border-l-blue-400",text:"text-blue-900",countBg:"bg-blue-100",countText:"text-blue-700",icon:e.jsx(us,{className:"w-5 h-5 text-blue-600",strokeWidth:2})},planned:{bg:"bg-amber-50",border:"border-amber-200",accent:"border-l-amber-400",text:"text-amber-900",countBg:"bg-amber-100",countText:"text-amber-700",icon:e.jsx(ds,{className:"w-5 h-5 text-amber-600",strokeWidth:2})},completed:{bg:"bg-slate-50",border:"border-slate-200",accent:"border-l-slate-400",text:"text-slate-700",countBg:"bg-slate-100",countText:"text-slate-600",icon:e.jsx(cs,{className:"w-5 h-5 text-slate-600",strokeWidth:2})}}[u];return e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:`rounded-lg border ${N.border} ${N.bg} border-l-4 ${N.accent} overflow-hidden shadow-sm transition-shadow duration-150`,children:[e.jsxs("button",{onClick:n,className:`w-full flex items-center justify-between px-4 py-3.5 transition-all duration-150 hover:brightness-95 active:scale-[0.99] ${N.text}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex-shrink-0",children:N.icon}),e.jsx("span",{className:"font-bold text-base",children:t}),d&&a&&a.length>0&&e.jsx("span",{className:`px-2.5 py-0.5 ${N.countBg} ${N.countText} rounded-full text-xs font-semibold`,children:a.length===1?`№ ${a[0]}`:`№ ${a.join(", ")}`}),r&&e.jsx("span",{className:"text-sm font-medium opacity-75",children:r}),d&&!a&&u==="planned"&&e.jsx("span",{className:`px-2.5 py-0.5 ${N.countBg} ${N.countText} rounded-full text-xs font-semibold`,children:s})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[o!==void 0&&e.jsxs("span",{className:`px-2.5 py-1 ${N.countBg} ${N.countText} rounded-full text-xs font-bold`,children:[o," ",m(o===1?"group.participant_one":"group.participant_other")]}),e.jsx("svg",{className:`w-5 h-5 transition-transform duration-200 ease-out ${l?"":"rotate-180"}`,style:{transformOrigin:"center"},fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M19 9l-7 7-7-7"})})]})]}),e.jsx("div",{className:`grid transition-all duration-150 ease-in-out ${l?"grid-rows-[0fr] opacity-0":"grid-rows-[1fr] opacity-100"}`,style:{transitionProperty:"grid-template-rows, opacity",willChange:l?"auto":"grid-template-rows, opacity"},children:e.jsx("div",{className:"overflow-hidden",children:e.jsx("div",{className:`px-1.5 sm:px-2 pb-2 transition-transform duration-150 ease-out ${l?"translate-y-[-8px]":"translate-y-0"}`,style:{willChange:l?"auto":"transform"},children:i})})})]}),e.jsx("style",{children:`
        @media (prefers-reduced-motion: reduce) {
          .grid, button, svg {
            transition: none !important;
          }
        }
        
        @media (max-width: 768px) {
          .grid {
            transition-duration: 120ms !important;
          }
        }
      `})]})}const Gt=({groupNumber:t,courseStartDate:s,courseEndDate:a,participants:r,renderParticipantRow:o,mode:l="table",defaultExpanded:n=!1})=>{const{t:i}=Q(),[u,d]=x.useState(n),[m,E]=x.useState({key:"uniqueNumber",direction:"desc"}),N=v=>{let P="asc";m.key===v&&m.direction==="asc"&&(P="desc"),E({key:v,direction:P})},G=Dt.useMemo(()=>m.key?[...r].sort((v,P)=>{if(m.key==="uniqueNumber"){const f=v.uniqueNumber||"",h=P.uniqueNumber||"";return m.direction==="asc"?f.localeCompare(h):h.localeCompare(f)}return 0}):r,[r,m]);return e.jsxs("div",{className:"border border-slate-300 rounded-lg mb-2 bg-white shadow-sm transition-shadow duration-150",children:[e.jsxs("button",{onClick:()=>d(!u),className:"w-full px-4 py-3 flex items-center justify-between hover:bg-slate-50 transition-all duration-150 rounded-lg active:scale-[0.99]",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("svg",{className:`w-5 h-5 text-slate-600 transition-transform duration-200 ease-out ${u?"rotate-90":""}`,style:{transformOrigin:"center"},fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),e.jsxs("div",{className:"text-left",children:[e.jsxs("div",{className:"font-semibold text-slate-900",children:[i("group.group")," ",t]}),e.jsxs("div",{className:"text-sm text-slate-600",children:[T(s)," - ",T(a)]})]})]}),e.jsxs("div",{className:"text-sm text-slate-600 font-medium",children:[r.length," ",r.length===1?i("group.participant_one"):i("group.participant_other")]})]}),e.jsx("div",{className:`grid transition-all ease-in-out border-t border-slate-200 ${u?"grid-rows-[1fr] opacity-100":"grid-rows-[0fr] opacity-0"}`,style:{transitionDuration:"180ms",transitionProperty:"grid-template-rows, opacity",willChange:u?"grid-template-rows, opacity":"auto"},children:e.jsx("div",{className:"overflow-hidden",children:e.jsx("div",{className:`transition-transform duration-180 ease-out ${u?"translate-y-0":"translate-y-[-8px]"}`,style:{willChange:u?"transform":"auto"},children:l==="table"?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("participant.companyName")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("participant.personName")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors select-none",onClick:()=>N("uniqueNumber"),title:"Sort by Number",children:e.jsxs("div",{className:"flex items-center gap-1",children:[i("participant.uniqueNumber"),m.key==="uniqueNumber"&&e.jsx("span",{className:"text-slate-500",children:m.direction==="asc"?"↑":"↓"})]})}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("participant.medicalDate")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("participant.sent")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("participant.documents")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("participant.handedOver")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("participant.paid")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("filters.status")})]})}),e.jsx("tbody",{className:"divide-y divide-slate-200",children:G.map(o)})]})}):e.jsx("div",{className:"p-3 space-y-2",children:G.map(o)})})})}),e.jsx("style",{children:`
        @media (prefers-reduced-motion: reduce) {
          .grid, button, svg {
            transition: none !important;
          }
        }
      `})]})},Ne=({label:t,variant:s,icon:a})=>{const r={success:"bg-emerald-50 text-emerald-800 ring-1 ring-emerald-200 border-0",neutral:"bg-slate-100 text-slate-700 ring-1 ring-slate-200 border-0",info:"bg-blue-50 text-blue-800 ring-1 ring-blue-200 border-0"};return e.jsxs("span",{className:`
        inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium border
        ${r[s]}
      `,children:[a==="check"&&e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}),a==="manual"&&e.jsxs("svg",{className:"w-3 h-3",fill:"currentColor",viewBox:"0 0 16 16",children:[e.jsx("path",{d:"M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"}),e.jsx("path",{d:"M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"})]}),t]})},Bt=({isOpen:t,onClose:s,title:a,message:r,buttonText:o="OK",variant:l="info"})=>{if(x.useEffect(()=>{const d=m=>{m.key==="Escape"&&s()};if(t)return document.addEventListener("keydown",d),()=>document.removeEventListener("keydown",d)},[t,s]),x.useEffect(()=>{if(t){const d=setTimeout(()=>{s()},5e3);return()=>clearTimeout(d)}},[t,s]),!t)return null;const n=()=>{switch(l){case"danger":case"error":return e.jsx(ms,{className:"w-6 h-6 text-red-600"});case"warning":return e.jsx(at,{className:"w-6 h-6 text-amber-600"});case"success":return e.jsx(Ue,{className:"w-6 h-6 text-emerald-600"});default:return e.jsx(At,{className:"w-6 h-6 text-blue-600"})}},i=()=>{switch(l){case"danger":case"error":return"bg-red-50 text-red-900 border-red-100";case"warning":return"bg-amber-50 text-amber-900 border-amber-100";case"success":return"bg-emerald-50 text-emerald-900 border-emerald-100";default:return"bg-blue-50 text-blue-900 border-blue-100"}},u=()=>{switch(l){case"danger":case"error":return"bg-red-600 hover:bg-red-700 focus:ring-red-500";case"warning":return"bg-amber-600 hover:bg-amber-700 focus:ring-amber-500";case"success":return"bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500";default:return"bg-blue-600 hover:bg-blue-700 focus:ring-blue-500"}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 transition-opacity",onClick:s}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-sm w-full md:max-w-md lg:max-w-lg overflow-hidden animate-scale-up transform transition-all",children:[e.jsxs("div",{className:"p-6 md:p-8 text-center",children:[e.jsx("div",{className:`mx-auto mb-4 w-12 h-12 rounded-full flex items-center justify-center ${i()}`,children:n()}),e.jsx("h3",{className:"text-xl font-bold text-slate-900 mb-2",children:a}),e.jsx("p",{className:"text-slate-600 text-sm leading-relaxed",children:r})]}),e.jsx("div",{className:"p-4 bg-slate-50 border-t border-slate-100",children:e.jsx("button",{onClick:s,className:`w-full px-5 py-2.5 text-white rounded-lg font-medium shadow-md transition-all duration-200 transform hover:-translate-y-0.5 ${u()}`,children:o})})]})})]})},Fs=({participants:t,onEdit:s,onDelete:a,collapsedSections:r,toggleSection:o,hasActiveFilters:l,onFilterChange:n,groupRefreshKey:i=0})=>{var V;const{updateParticipant:u}=Je(),{t:d}=Q(),[m,E]=x.useState("uniqueNumber"),[N,G]=x.useState("asc"),[v,P]=x.useState(new Set),[f,h]=x.useState({isOpen:!1,participant:void 0}),[g,C]=x.useState(null),[k,O]=x.useState({isOpen:!1,title:"",message:"",variant:"info"}),M=(c,b)=>{const y=c.currentTarget.getBoundingClientRect();C({participant:b,x:y.left,y:y.top-8})},_=()=>{C(null)},L=Se(()=>D.groups.toArray(),[i]),I=x.useMemo(()=>L?new Map(L.map(c=>[c.courseStartDate,c])):new Map,[L]),z=x.useMemo(()=>[...t].sort((b,y)=>{let j=0;return m==="courseStartDate"||m==="groupNumber"?j=b.courseStartDate.localeCompare(y.courseStartDate):m==="uniqueNumber"&&(j=b.uniqueNumber.localeCompare(y.uniqueNumber)),N==="asc"?j:-j}),[t,m,N]),w=x.useMemo(()=>{const c=[],b=[],y=[];return z.forEach(j=>{const H=I.get(j.courseStartDate);if(!H){b.push(j);return}H.status==="active"?c.push(j):H.status==="planned"?b.push(j):H.status==="completed"&&y.push(j)}),{active:c,planned:b,completed:y}},[z,I]),B=x.useMemo(()=>L==null?void 0:L.find(c=>c.status==="active"),[L]),U=B!=null&&B.groupNumber?[B.groupNumber]:[],F=B?`${T(B.courseStartDate)} - ${T(B.courseEndDate)}`:void 0,Y=x.useMemo(()=>{const c=new Map;return L==null||L.forEach(b=>{b.status==="active"&&c.set(b.courseStartDate,{group:b,participants:[]})}),w.active.forEach(b=>{const y=c.get(b.courseStartDate);if(y)y.participants.push(b);else{const j=I.get(b.courseStartDate)||{id:"virt-active-"+b.courseStartDate,courseStartDate:b.courseStartDate,courseEndDate:b.courseEndDate,status:"active",groupNumber:null,isLocked:!1,createdAt:"",updatedAt:""};c.set(b.courseStartDate,{group:j,participants:[b]})}}),Array.from(c.values()).sort((b,y)=>b.group.courseStartDate.localeCompare(y.group.courseStartDate))},[w.active,L,I]),X=x.useMemo(()=>{const c=new Map;!l&&L&&L.forEach(j=>{j.status==="planned"&&c.set(j.courseStartDate,{group:j,participants:[]})}),w.planned.forEach(j=>{let H=I.get(j.courseStartDate);if(H&&!c.has(j.courseStartDate)&&c.set(j.courseStartDate,{group:H,participants:[]}),!H&&!c.has(j.courseStartDate)){const W={id:"virtual-planned-"+j.courseStartDate,groupNumber:null,courseStartDate:j.courseStartDate,courseEndDate:j.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""};c.set(j.courseStartDate,{group:W,participants:[]})}c.has(j.courseStartDate)&&c.get(j.courseStartDate).participants.push(j)});const b=Array.from(c.entries()).sort(([j],[H])=>j.localeCompare(H));return(l?b:b.slice(0,2)).map(([j,H])=>({courseStartDate:j,...H}))},[w.planned,I,L,l]),ue=x.useMemo(()=>{const c=new Map;return w.completed.forEach(b=>{const y=I.get(b.courseStartDate);y&&(c.has(b.courseStartDate)||c.set(b.courseStartDate,{group:y,participants:[]}),c.get(b.courseStartDate).participants.push(b))}),Array.from(c.entries()).sort(([b],[y])=>y.localeCompare(b)).map(([b,y])=>({courseStartDate:b,...y}))},[w.completed,I]),te=x.useMemo(()=>{const c=new Set,b=new Set,y=new Set;return Y.forEach(j=>c.add(j.group.courseStartDate)),!l&&L&&L.forEach(j=>{j.status==="active"&&c.add(j.courseStartDate),j.status==="planned"&&b.add(j.courseStartDate),j.status==="completed"&&y.add(j.courseStartDate)}),w.active.forEach(j=>c.add(j.courseStartDate)),w.planned.forEach(j=>b.add(j.courseStartDate)),w.completed.forEach(j=>y.add(j.courseStartDate)),{active:{count:c.size,numbers:[]},planned:{count:b.size,numbers:[]},completed:{count:y.size,numbers:[]}}},[w,L,Y,l]);x.useEffect(()=>{(async()=>{await Pe()})()},[]);const fe=c=>{m===c?G(b=>b==="asc"?"desc":"asc"):(E(c),G("asc"))},se=async(c,b)=>{const y=I.get(c.courseStartDate);if(Ee(y)){O({isOpen:!0,title:d("common.info"),message:d("lock.lockedInfo"),variant:"info"});return}try{await u(c.id,{[b]:!c[b]})}catch(j){console.error("Error updating participant:",j),O({isOpen:!0,title:d("common.error"),message:d("error.updateParticipantFailed"),variant:"error"})}},ie=async c=>{const b=I.get(c.courseStartDate);if(Ee(b)){O({isOpen:!0,title:d("common.info"),message:d("lock.lockedInfo"),variant:"info"});return}const y=c.completedOverride!==null?c.completedOverride:c.completedComputed;try{await u(c.id,{completedOverride:!y})}catch(j){console.error("Error updating completed status:",j),O({isOpen:!0,title:d("common.error"),message:d("error.updateCompletedFailed"),variant:"error"})}},be=async c=>{const b=I.get(c.courseStartDate);if(Ee(b)){O({isOpen:!0,title:d("common.info"),message:d("lock.lockedInfo"),variant:"info"});return}try{await u(c.id,{completedOverride:null})}catch(y){console.error("Error resetting completed status:",y),O({isOpen:!0,title:d("common.error"),message:d("error.resetCompletedFailed"),variant:"error"})}},J=c=>c.completedOverride!==null?c.completedOverride:c.completedComputed,Z=c=>c.completedOverride!==null,me=async c=>{try{let b=I.get(c.courseStartDate);b||(b={id:"virtual-cert",groupNumber:null,courseStartDate:c.courseStartDate,courseEndDate:c.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""});const{generateCertificate:y}=await Le(async()=>{const{generateCertificate:j}=await import("./certificateGenerator-BmX9tfMH.js");return{generateCertificate:j}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]),import.meta.url);await y(c,b),O({isOpen:!0,title:d("common.success"),message:d("certificate.generated"),variant:"success"})}catch(b){O({isOpen:!0,title:d("common.error"),message:d("certificate.error")+": "+b.message,variant:"error"})}},ge=()=>{f.participant&&a(f.participant.id),h({isOpen:!1,participant:void 0})},ne=c=>{const b=I.get(c.courseStartDate),y=A(c),j=["hover:bg-slate-100 transition-colors duration-150",(b==null?void 0:b.status)==="active"?"bg-slate-50":"",(b==null?void 0:b.status)==="completed"?"opacity-90":""].filter(Boolean).join(" ");return e.jsxs("tr",{className:j,children:[e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:v.has(c.id),onChange:()=>p(c.id),disabled:y,className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed","aria-label":`Select ${c.personName}`})}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qe,{companyName:c.companyName}),y&&e.jsx("span",{className:"text-xs text-slate-500",title:d("lock.lockedInfo"),children:"🔒"})]})}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:e.jsx("div",{className:"max-w-xs truncate cursor-help",onMouseEnter:H=>M(H,c),onMouseLeave:_,children:c.personName})}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:T(c.medicalDate)}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:T(c.courseStartDate)}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:T(c.courseEndDate)}),e.jsx("td",{className:"px-3 py-3 text-sm",children:e.jsx("span",{className:"font-mono text-xs bg-slate-100 px-2 py-0.5 rounded inline-block text-slate-700 cursor-help",title:`Уникален номер на удостоверение
Протокол: ${b!=null&&b.groupNumber?b.groupNumber*5:"---"}`,children:c.uniqueNumber||"---"})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:c.sent,onChange:()=>se(c,"sent"),disabled:y,title:"Данните са изпратени към фирмата",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:c.documents,onChange:()=>se(c,"documents"),disabled:y,title:"Получени са всички документи",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:c.handedOver,onChange:()=>se(c,"handedOver"),disabled:y,title:"Удостоверението е предадено",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:c.paid,onChange:()=>se(c,"paid"),disabled:y,title:"Таксата е платена",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("button",{onClick:()=>ie(c),disabled:y,className:`px-3 py-1 rounded-md text-xs font-medium transition-colors duration-150 ring-1 disabled:opacity-50 disabled:cursor-not-allowed ${J(c)?"bg-emerald-50 text-emerald-800 ring-emerald-200 hover:bg-emerald-100":"bg-slate-100 text-slate-700 ring-slate-200 hover:bg-slate-200"}`,title:y?d("lock.lockedInfo"):"Click to toggle",children:J(c)?d("completed.done"):d("completed.pending")}),Z(c)&&!y&&e.jsx("button",{onClick:()=>be(c),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-50 transition-colors duration-150",title:"Reset to auto","aria-label":"Reset completed to automatic",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})})]})}),e.jsx("td",{className:"px-3 py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("button",{onClick:()=>s(c),disabled:y,className:"p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-100 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:d(y?"lock.lockedInfo":"common.edit"),"aria-label":`Edit ${c.personName}`,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),e.jsx("button",{onClick:()=>me(c),className:"p-2 text-green-600 hover:text-green-800 hover:bg-green-50 rounded-lg transition-colors duration-150",title:"Генерирай сертификат","aria-label":`Generate certificate for ${c.personName}`,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),e.jsx("button",{onClick:()=>h({isOpen:!0,participant:c}),disabled:y,className:"p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:d(y?"lock.lockedInfo":"common.delete"),"aria-label":`Delete ${c.personName}`,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})})]},c.id)},oe=c=>{const b=A(c);return e.jsxs("tr",{className:"hover:bg-slate-100 transition-colors duration-150",children:[e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:v.has(c.id),onChange:()=>p(c.id),disabled:b,className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed","aria-label":`Select ${c.personName}`})}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:e.jsx(qe,{companyName:c.companyName})}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:e.jsx("div",{className:"max-w-xs truncate cursor-help",onMouseEnter:j=>M(j,c),onMouseLeave:_,children:c.personName})}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:T(c.medicalDate)}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:T(c.courseStartDate)}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:T(c.courseEndDate)}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:c.documents,onChange:()=>se(c,"documents"),disabled:b,title:"Получени са всички документи",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:c.paid,onChange:()=>se(c,"paid"),disabled:b,title:"Таксата е платена",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),e.jsx("td",{className:"px-3 py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("button",{onClick:()=>s(c),disabled:b,className:"p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-100 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:d(b?"lock.lockedInfo":"common.edit"),"aria-label":`Edit ${c.personName}`,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),e.jsx("button",{onClick:()=>h({isOpen:!0,participant:c}),disabled:b,className:"p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:d(b?"lock.lockedInfo":"common.delete"),"aria-label":`Delete ${c.personName}`,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})})]},c.id)},pe=c=>{const b=I.get(c.courseStartDate),y=J(c);return e.jsxs("tr",{className:"hover:bg-slate-50 transition-colors",children:[e.jsx("td",{className:"px-3 py-2 text-sm text-slate-900",children:e.jsx(qe,{companyName:c.companyName})}),e.jsx("td",{className:"px-3 py-2 text-sm text-slate-900",children:e.jsx("div",{className:"cursor-help",onMouseEnter:j=>M(j,c),onMouseLeave:_,children:c.personName})}),e.jsx("td",{className:"px-3 py-2 text-sm",children:e.jsx("span",{className:"font-mono text-xs bg-slate-100 px-2 py-0.5 rounded inline-block text-slate-700 cursor-help",title:`Уникален номер на удостоверение
Протокол: ${b!=null&&b.groupNumber?b.groupNumber*5:"---"}`,children:c.uniqueNumber})}),e.jsx("td",{className:"px-3 py-2 text-sm text-slate-600",children:T(c.medicalDate)}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:c.sent,disabled:!0,title:"Данните са изпратени към фирмата",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:c.documents,disabled:!0,title:"Получени са всички документи",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:c.handedOver,disabled:!0,title:"Удостоверението е предадено",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:c.paid,disabled:!0,title:"Таксата е платена",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[y&&e.jsx(Ne,{label:d("participant.completedBadge"),variant:"success",icon:"check"}),Z(c)&&e.jsx(Ne,{label:d("participant.manual"),variant:"info",icon:"manual"}),!y&&!Z(c)&&e.jsx("span",{className:"text-xs text-slate-400 italic",children:d("completed.pending")})]})})]},c.id)},p=c=>{const b=new Set(v);b.has(c)?b.delete(c):b.add(c),P(b)},S=()=>{P(new Set)},$=()=>{P(new Set)},A=c=>{const b=I.get(c.courseStartDate);return Ee(b)};return z.length===0?e.jsx("div",{className:"text-center py-12 text-slate-500",children:d("participants.noResults")}):e.jsxs(e.Fragment,{children:[e.jsx(Tt,{selectedCount:v.size,selectedIds:Array.from(v),onClearSelection:S,onActionComplete:$}),e.jsx(Bt,{isOpen:k.isOpen,onClose:()=>O(c=>({...c,isOpen:!1})),title:k.title,message:k.message,variant:k.variant}),e.jsxs("div",{className:"space-y-4",children:[(w.active.length>0||!l)&&e.jsx(je,{title:d("groups.activeSection"),count:te.active.count,groupNumbers:Y.length<=1?U:[],dateRange:Y.length<=1?F:void 0,participantCount:w.active.length,isCollapsed:r.active,onToggle:()=>o("active"),variant:"active",children:Y.length===0?e.jsx("div",{className:"text-center py-8 text-slate-500 bg-slate-50 border border-dashed border-slate-200 rounded-lg",children:d("participants.noActive")}):e.jsx("div",{className:"space-y-8",children:Y.map(c=>e.jsxs("div",{className:"space-y-3",children:[Y.length>1&&e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-blue-100",children:[e.jsxs("span",{className:"font-bold text-blue-900",children:[T(c.group.courseStartDate)," - ",T(c.group.courseEndDate)]}),c.group.groupNumber&&e.jsxs("span",{className:"px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs font-bold",children:["№ ",c.group.groupNumber]})]}),e.jsx("div",{className:"overflow-x-auto max-h-[400px] overflow-y-auto relative rounded-lg border border-slate-200",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-slate-100 sticky top-0 z-10 shadow-sm",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 border-b border-slate-200 w-12",children:e.jsx("input",{type:"checkbox",checked:c.participants.length>0&&c.participants.every(b=>v.has(b.id)),onChange:b=>{const y=new Set(v);b.target.checked?c.participants.filter(j=>!A(j)).forEach(j=>y.add(j.id)):c.participants.forEach(j=>y.delete(j.id)),P(y)},className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer"})}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.companyName")}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.personName")}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.medicalDate")}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.courseStart")}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.courseEnd")}),e.jsxs("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200 cursor-pointer hover:bg-slate-200 transition-colors duration-150",onClick:()=>fe("uniqueNumber"),children:[d("participant.uniqueNumber")," ",m==="uniqueNumber"&&(N==="asc"?"↑":"↓")]}),e.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.sent")}),e.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.documents")}),e.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.handedOver")}),e.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.paid")}),e.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("filters.status")}),e.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("common.delete")})]})}),e.jsx("tbody",{className:"divide-y divide-slate-200",children:c.participants.length>0?c.participants.map(ne):e.jsx("tr",{children:e.jsx("td",{colSpan:13,className:"text-center py-8 text-slate-400 italic",children:d("participants.noParticipantsInGroup")})})})]})})]},c.group.courseStartDate))})}),(w.planned.length>0||!l)&&X.length>0&&e.jsx(je,{title:d("groups.plannedSection"),count:te.planned.count,groupNumbers:X.map(c=>c.group.groupNumber).filter(c=>c!==null),isCollapsed:r.planned,onToggle:()=>o("planned"),variant:"planned",children:e.jsx("div",{className:"space-y-6",children:X.map(({courseStartDate:c,group:b,participants:y})=>e.jsxs("div",{className:"bg-white border border-amber-200 rounded-lg overflow-hidden",children:[e.jsx("div",{className:"bg-amber-50 px-4 py-2 border-b border-amber-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[b.groupNumber&&e.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-900 rounded text-xs font-semibold",children:["№ ",b.groupNumber]}),e.jsxs("span",{className:"font-semibold text-amber-900",children:[T(b.courseStartDate)," - ",T(b.courseEndDate)]})]}),e.jsxs("span",{className:"text-sm text-amber-700 font-medium",children:[y.length," ",y.length===1?d("group.participant_one"):d("group.participant_other")]})]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 border-b border-slate-200 w-12",children:e.jsx("input",{type:"checkbox",checked:y.length>0&&y.every(j=>v.has(j.id)),onChange:j=>{const H=new Set(v);j.target.checked?y.forEach(W=>H.add(W.id)):y.forEach(W=>H.delete(W.id)),P(H)},className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer"})}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.companyName")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.personName")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.medicalDate")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.courseStart")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.courseEnd")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.documents")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.paid")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("common.delete")})]})}),e.jsx("tbody",{className:"divide-y divide-slate-200",children:y.length>0?y.map(oe):e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"text-center py-4 text-slate-400 italic",children:d("participants.noParticipantsInGroup")})})})]})})]},c))})}),(w.completed.length>0||!l)&&ue.length>0&&e.jsx(je,{title:d("groups.completedSection"),count:te.completed.count,groupNumbers:te.completed.numbers,isCollapsed:r.completed,onToggle:()=>o("completed"),variant:"completed",children:e.jsx("div",{className:"space-y-4",children:ue.map(({courseStartDate:c,group:b,participants:y})=>e.jsx("div",{children:e.jsx(Gt,{groupNumber:b.groupNumber||0,courseStartDate:b.courseStartDate,courseEndDate:b.courseEndDate,participants:y,renderParticipantRow:pe,defaultExpanded:l})},c))})})]}),l&&t.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 text-center",children:[e.jsx("div",{className:"text-6xl mb-4",children:"🔍"}),e.jsx("h3",{className:"text-lg font-semibold text-slate-700 mb-2",children:"Няма намерени резултати"}),e.jsx("p",{className:"text-sm text-slate-500 mb-6",children:"Опитай да промениш филтрите или ги изчисти"}),e.jsx("button",{onClick:()=>{n({searchTerm:"",courseStartDate:null,category:null,status:"all"})},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium",children:"Изчисти филтрите"})]}),e.jsx(Me,{isOpen:f.isOpen,onClose:()=>h({isOpen:!1,participant:void 0}),onConfirm:ge,title:d("modal.deleteTitle"),message:e.jsxs(e.Fragment,{children:[d("modal.deleteMessage").split("{name}")[0],e.jsx("strong",{className:"font-bold text-slate-900",children:((V=f.participant)==null?void 0:V.personName)||""}),d("modal.deleteMessage").split("{name}")[1]]}),confirmText:d("common.delete"),cancelText:d("common.cancel"),variant:"danger"}),g&&e.jsxs("div",{className:"fixed z-50 bg-slate-800 text-white text-xs p-3 rounded shadow-lg pointer-events-none transform -translate-y-full filter drop-shadow-md",style:{left:g.x,top:g.y,minWidth:"220px"},children:[e.jsx("div",{className:"font-bold mb-2 border-b border-slate-600 pb-1 text-slate-100",children:g.participant.personName}),e.jsxs("div",{className:"grid grid-cols-[auto_1fr] gap-x-3 gap-y-1.5",children:[e.jsxs("span",{className:"text-slate-400 text-right",children:[d("participant.egn"),":"]}),e.jsx("span",{className:"font-mono",children:g.participant.egn||"-"}),e.jsxs("span",{className:"text-slate-400 text-right",children:[d("participant.birthPlace"),":"]}),e.jsx("span",{children:g.participant.birthPlace||"-"}),e.jsxs("span",{className:"text-slate-400 text-right",children:[d("participant.added"),":"]}),e.jsx("span",{children:g.participant.createdAt?T(g.participant.createdAt):"-"}),e.jsxs("span",{className:"text-slate-400 text-right",children:[d("participant.modified"),":"]}),e.jsx("span",{children:g.participant.updatedAt?T(g.participant.updatedAt):"-"})]})]})]})},vt=({onEdit:t,onDetails:s,onGenerate:a,onDelete:r})=>{const[o,l]=x.useState(!1),n=x.useRef(null);return x.useEffect(()=>{const i=d=>{n.current&&!n.current.contains(d.target)&&l(!1)},u=d=>{d.key==="Escape"&&l(!1)};if(o)return document.addEventListener("mousedown",i),document.addEventListener("keydown",u),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("keydown",u)}},[o]),e.jsxs("div",{className:"relative",ref:n,children:[e.jsx("button",{onClick:()=>l(!o),className:"p-2 hover:bg-slate-100 rounded-lg transition-colors duration-150 min-h-[44px] min-w-[44px] flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-blue-500","aria-label":"More options","aria-expanded":o,children:e.jsxs("svg",{className:"w-5 h-5 text-slate-600",fill:"currentColor",viewBox:"0 0 16 16",children:[e.jsx("circle",{cx:"8",cy:"2",r:"1.5"}),e.jsx("circle",{cx:"8",cy:"8",r:"1.5"}),e.jsx("circle",{cx:"8",cy:"14",r:"1.5"})]})}),o&&e.jsxs("div",{className:"absolute right-0 top-12 bg-white rounded-lg shadow-lg border border-slate-200 py-1 min-w-[140px] z-10 animate-scale-up",children:[t&&e.jsxs("button",{onClick:()=>{t(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-100 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),"Редактирай"]}),s&&e.jsxs("button",{onClick:()=>{s(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-blue-700 hover:bg-blue-50 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),"Детайли"]}),a&&e.jsxs("button",{onClick:()=>{a(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-green-700 hover:bg-green-50 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Генерирай"]}),r&&e.jsxs("button",{onClick:()=>{r(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),"Изтрий"]})]})]})},Hs=({isOpen:t,onClose:s,participant:a})=>{const{t:r}=Q();return x.useEffect(()=>{const o=l=>{l.key==="Escape"&&s()};if(t)return document.addEventListener("keydown",o),()=>document.removeEventListener("keydown",o)},[t,s]),!t||!a?null:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 transition-opacity",onClick:s}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden animate-scale-up pointer-events-auto",children:[e.jsxs("div",{className:"relative bg-slate-50 px-6 py-4 border-b border-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center shrink-0",children:e.jsx(ps,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 truncate pr-6",children:a.personName}),e.jsx("p",{className:"text-xs text-slate-500 truncate",children:a.companyName})]})]}),e.jsx("button",{onClick:s,className:"absolute right-4 top-4 p-1 rounded-full hover:bg-slate-200 transition-colors text-slate-400 hover:text-slate-600",children:e.jsx(xs,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[e.jsx(hs,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:r("participant.egn")})]}),e.jsx("div",{className:"text-sm font-mono text-slate-900 bg-slate-50 px-2 py-1 rounded",children:a.egn||"---"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[e.jsx(fs,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:r("participant.birthPlace")})]}),e.jsx("div",{className:"text-sm font-medium text-slate-900 truncate",children:a.birthPlace||"---"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[e.jsx(bs,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:r("participant.added")})]}),e.jsx("div",{className:"text-xs text-slate-900",children:a.createdAt?T(a.createdAt):"---"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[e.jsx(gs,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:r("participant.modified")})]}),e.jsx("div",{className:"text-xs text-slate-900",children:a.updatedAt?T(a.updatedAt):"---"})]})]})]}),e.jsx("div",{className:"px-6 py-4 bg-slate-50 flex justify-end",children:e.jsx("button",{onClick:s,className:"px-4 py-2 bg-white text-slate-700 border border-slate-200 rounded-lg hover:bg-slate-100 font-medium text-sm transition-all",children:r("common.close")})})]})})]})},Ge=({label:t,isActive:s})=>e.jsxs("div",{className:`
        flex items-center justify-center gap-1 px-1.5 py-1 rounded text-xs font-medium
        transition-all duration-150 min-h-[32px] w-full
        ${s?"bg-emerald-700 border border-emerald-700 text-white":"bg-white border border-slate-300 text-slate-700"}
      `,children:[s&&e.jsx("svg",{className:"w-3 h-3 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}),e.jsx("span",{className:"text-[10px] whitespace-nowrap",children:t})]}),Vs=({participants:t,onEdit:s,onDelete:a,onSelectionChange:r,collapsedSections:o,toggleSection:l,expandSection:n,hasActiveFilters:i})=>{var pe;const{t:u}=Q(),{updateParticipant:d}=Je(),[m,E]=x.useState(new Set),[N,G]=x.useState(null),[v,P]=x.useState({isOpen:!1,participant:void 0}),[f,h]=x.useState({isOpen:!1,participant:void 0}),g=Se(()=>D.groups.toArray(),[]),C=x.useMemo(()=>g?new Map(g.map(p=>[p.courseStartDate,p])):new Map,[g]),k=x.useMemo(()=>{const p=[],S=[],$=[];return t.forEach(A=>{const V=C.get(A.courseStartDate);if(!V){S.push(A);return}V.status==="active"?p.push(A):V.status==="planned"?S.push(A):V.status==="completed"&&$.push(A)}),{active:p,planned:S,completed:$}},[t,C]),O=x.useMemo(()=>{const p=new Map;!i&&g&&g.forEach(A=>{A.status==="planned"&&p.set(A.courseStartDate,{group:A,participants:[]})}),k.planned.forEach(A=>{let V=C.get(A.courseStartDate);if(V&&!p.has(A.courseStartDate)&&p.set(A.courseStartDate,{group:V,participants:[]}),!V&&!p.has(A.courseStartDate)){const c={id:"virtual-"+A.courseStartDate,groupNumber:null,courseStartDate:A.courseStartDate,courseEndDate:A.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""};p.set(A.courseStartDate,{group:c,participants:[]})}p.has(A.courseStartDate)&&p.get(A.courseStartDate).participants.push(A)});const S=Array.from(p.entries()).sort(([A],[V])=>A.localeCompare(V));return(i?S:S.slice(0,2)).map(([A,V])=>({courseStartDate:A,...V}))},[k.planned,C,g,i]),M=x.useMemo(()=>{const p=new Map;return k.completed.forEach(S=>{const $=C.get(S.courseStartDate);$&&(p.has(S.courseStartDate)||p.set(S.courseStartDate,{group:$,participants:[]}),p.get(S.courseStartDate).participants.push(S))}),Array.from(p.entries()).sort(([S],[$])=>$.localeCompare(S)).map(([S,$])=>({courseStartDate:S,...$}))},[k.completed,C]),_=x.useMemo(()=>g==null?void 0:g.find(p=>p.status==="active"),[g]),L=_!=null&&_.groupNumber?[_.groupNumber]:[],I=_?`${T(_.courseStartDate)} - ${T(_.courseEndDate)}`:void 0,z=x.useMemo(()=>{const p=new Map;return g==null||g.forEach(S=>{S.status==="active"&&p.set(S.courseStartDate,{group:S,participants:[]})}),k.active.forEach(S=>{const $=p.get(S.courseStartDate);if($)$.participants.push(S);else{const A=C.get(S.courseStartDate)||{id:"virt-active-"+S.courseStartDate,courseStartDate:S.courseStartDate,courseEndDate:S.courseEndDate,status:"active",groupNumber:null,isLocked:!1,createdAt:"",updatedAt:""};p.set(S.courseStartDate,{group:A,participants:[S]})}}),Array.from(p.values()).sort((S,$)=>S.group.courseStartDate.localeCompare($.group.courseStartDate))},[k.active,g,C]),w=x.useMemo(()=>{const p=new Set,S=new Set,$=new Set;return k.active.forEach(A=>p.add(A.courseStartDate)),!i&&g&&g.forEach(A=>{A.status==="planned"&&S.add(A.courseStartDate)}),k.planned.forEach(A=>S.add(A.courseStartDate)),k.completed.forEach(A=>$.add(A.courseStartDate)),{active:{count:p.size,periods:Array.from(p).sort()},planned:{count:i?S.size:Math.min(S.size,2),periods:Array.from(S).sort()},completed:{count:$.size,periods:Array.from($).sort()}}},[k,g,i]),B=x.useRef(t);x.useEffect(()=>{B.current!==t&&i&&(k.active.length>0&&o.active&&n("active"),k.planned.length>0&&o.planned&&n("planned"),k.completed.length>0&&o.completed&&n("completed"),B.current=t)},[t,k,o,n,i]),x.useEffect(()=>{r==null||r(m.size>0)},[m.size,r]);const U=async(p,S)=>{const $=C.get(p.courseStartDate);if($&&$.status==="completed"&&$.isLocked){alert(u("lock.lockedInfo"));return}try{await d(p.id,{[S]:!p[S]})}catch(A){console.error("Error updating participant:",A)}},F=p=>p.completedOverride!==null?p.completedOverride:p.completedComputed,Y=p=>p.completedOverride!==null,X=p=>{const S=C.get(p.courseStartDate);return S?S.status==="completed"&&S.isLocked:!1},ue=(p,S)=>{if(X(S))return;const $=setTimeout(()=>{E(new Set([p]))},500);G($)},te=()=>{N&&(clearTimeout(N),G(null))},fe=(p,S)=>{const $=X(S);if(m.size>0){if($)return;const A=new Set(m);A.has(p)?A.delete(p):A.add(p),E(A)}},se=()=>{E(new Set)},ie=()=>{E(new Set)},be=p=>{P({isOpen:!0,participant:p})},J=()=>{v.participant&&a(v.participant.id),P({isOpen:!1,participant:void 0})},[Z,me]=x.useState({isOpen:!1,title:"",message:"",variant:"info"}),ge=async p=>{try{let S=C.get(p.courseStartDate);S||(S={id:"virtual",groupNumber:null,courseStartDate:p.courseStartDate,courseEndDate:p.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""});const{generateCertificate:$}=await Le(async()=>{const{generateCertificate:A}=await import("./certificateGenerator-BmX9tfMH.js");return{generateCertificate:A}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]),import.meta.url);await $(p,S),me({isOpen:!0,title:u("common.success"),message:u("certificate.generated"),variant:"success"})}catch(S){me({isOpen:!0,title:u("common.error"),message:u("certificate.error")+": "+S.message,variant:"error"})}},ne=(p,S)=>{var V;const $=m.has(p.id),A=X(p);return e.jsxs("div",{onClick:()=>fe(p.id,p),onTouchStart:()=>ue(p.id,p),onTouchEnd:te,onMouseDown:()=>ue(p.id,p),onMouseUp:te,onMouseLeave:te,className:`bg-white rounded-lg shadow-sm p-3 md:p-4 border transition-all duration-150 ${$?"border-blue-500 ring-2 ring-blue-200":"border-slate-200"} ${A?"opacity-75":"cursor-pointer hover:shadow-md"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"mb-1",children:e.jsx(qe,{companyName:p.companyName})}),e.jsxs("div",{className:"flex items-center gap-2",children:[$&&e.jsx("div",{className:"w-5 h-5 bg-blue-600 rounded flex items-center justify-center shrink-0",children:e.jsx("svg",{className:"w-3 h-3 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}),e.jsx("h3",{className:"font-bold text-lg text-slate-900 leading-tight truncate",children:p.personName}),A&&e.jsx("span",{className:"text-xs text-slate-500 shrink-0",title:u("lock.lockedInfo"),children:"🔒"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col gap-1 items-end",children:[p.uniqueNumber&&e.jsx("span",{className:"text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-700",children:p.uniqueNumber}),e.jsxs("div",{className:"flex gap-1",children:[F(p)?e.jsx(Ne,{label:u("participant.completedBadge"),variant:"success",icon:"check"}):e.jsx("span",{className:"text-[10px] text-slate-400 italic font-medium",children:u("completed.pending")}),Y(p)&&e.jsx(Ne,{label:u("participant.manual"),variant:"info",icon:"manual"})]})]}),!A&&e.jsx(vt,{onEdit:()=>s(p),onDetails:()=>h({isOpen:!0,participant:p}),onGenerate:((V=C.get(p.courseStartDate))==null?void 0:V.status)==="active"?()=>ge(p):void 0,onDelete:()=>be(p)})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-2 gap-y-2 mb-3",children:[e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:u("participant.medical")}),e.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:T(p.medicalDate)})]}),e.jsxs("div",{className:"flex flex-col min-w-0 text-right",children:[e.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:u("participant.period")}),e.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:T(p.courseStartDate)})]}),e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:u("participant.courseStart")}),e.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:T(p.courseStartDate)})]}),e.jsxs("div",{className:"flex flex-col min-w-0 text-right",children:[e.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:u("participant.courseEnd")}),e.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:T(p.courseEndDate)})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-1.5 sm:gap-1",children:[e.jsx("button",{onClick:c=>{c.stopPropagation(),U(p,"sent")},disabled:A,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(Ge,{label:u("participant.sent"),isActive:p.sent})}),e.jsx("button",{onClick:c=>{c.stopPropagation(),U(p,"documents")},disabled:A,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(Ge,{label:u("participant.documents"),isActive:p.documents})}),e.jsx("button",{onClick:c=>{c.stopPropagation(),U(p,"handedOver")},disabled:A,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(Ge,{label:u("participant.handed"),isActive:p.handedOver})}),e.jsx("button",{onClick:c=>{c.stopPropagation(),U(p,"paid")},disabled:A,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(Ge,{label:u("participant.paid"),isActive:p.paid})})]})]},p.id)},oe=p=>e.jsxs("div",{className:"bg-white rounded-lg p-3 border border-slate-200",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex-1 min-w-0 pr-2",children:[e.jsx("div",{className:"mb-1",children:e.jsx(qe,{companyName:p.companyName})}),e.jsx("h4",{className:"font-semibold text-slate-900 truncate",children:p.personName})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col gap-1 items-end shrink-0",children:[p.uniqueNumber&&e.jsx("span",{className:"text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-700",children:p.uniqueNumber}),e.jsxs("div",{className:"flex gap-1",children:[F(p)?e.jsx(Ne,{label:u("participant.completedBadge"),variant:"success",icon:"check"}):e.jsx("span",{className:"text-[10px] text-slate-400 italic font-medium",children:u("completed.pending")}),Y(p)&&e.jsx(Ne,{label:u("participant.manual"),variant:"info",icon:"manual"})]})]}),e.jsx(vt,{onDetails:()=>h({isOpen:!0,participant:p})})]})]}),e.jsx("div",{className:"text-sm text-slate-600 mb-2",children:e.jsxs("div",{className:"text-[10px] text-slate-500 uppercase tracking-wider font-semibold mb-1",children:[u("participant.medical"),": ",T(p.medicalDate)]})}),e.jsxs("div",{className:"flex flex-nowrap justify-between items-center gap-0.5 mt-auto pt-2 border-t border-slate-50 overflow-hidden",children:[e.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[e.jsx("input",{type:"checkbox",checked:p.sent,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),u("participant.sent")]}),e.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[e.jsx("input",{type:"checkbox",checked:p.documents,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),u("participant.documents")]}),e.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[e.jsx("input",{type:"checkbox",checked:p.handedOver,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),u("participant.handed")]}),e.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[e.jsx("input",{type:"checkbox",checked:p.paid,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),u("participant.paid")]})]})]},p.id);return t.length===0?e.jsx("div",{className:"text-center py-12 text-slate-500",children:u("participants.noResults")}):e.jsxs(e.Fragment,{children:[e.jsx(Tt,{selectedCount:m.size,selectedIds:Array.from(m),onClearSelection:se,onActionComplete:ie}),e.jsx(Hs,{isOpen:f.isOpen,onClose:()=>h({isOpen:!1,participant:void 0}),participant:f.participant}),e.jsx(Bt,{isOpen:Z.isOpen,onClose:()=>me(p=>({...p,isOpen:!1})),title:Z.title,message:Z.message,variant:Z.variant==="error"?"danger":Z.variant}),e.jsxs("div",{className:"space-y-4 pb-32",children:[(k.active.length>0||!i)&&e.jsx(je,{title:u("groups.activeSection"),count:w.active.count,groupNumbers:z.length<=1&&L.length>0?L:[],dateRange:z.length<=1?I:void 0,participantCount:k.active.length,isCollapsed:o.active,onToggle:()=>l("active"),showCount:z.length<=1?Math.max(L.length,0)>0:!0,variant:"active",children:z.length===0?e.jsx("div",{className:"text-center py-8 text-slate-500 bg-slate-50/50 rounded-lg border border-dashed border-slate-200",children:e.jsx("p",{children:u("participants.noActive")})}):e.jsx("div",{className:"space-y-8",children:z.map(p=>e.jsxs("div",{className:"space-y-4",children:[z.length>1&&e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-blue-100",children:[e.jsxs("span",{className:"font-semibold text-blue-900",children:[T(p.group.courseStartDate)," - ",T(p.group.courseEndDate)]}),p.group.groupNumber&&e.jsxs("span",{className:"px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-bold",children:["№ ",p.group.groupNumber]})]}),p.participants.length>0?e.jsx("div",{className:"space-y-4",children:p.participants.map((S,$)=>ne(S))}):e.jsx("div",{className:"text-center py-4 italic text-slate-400 bg-white/50 rounded border border-dashed border-slate-100",children:u("participants.noParticipantsInGroup")})]},p.group.courseStartDate))})}),(k.planned.length>0||!i)&&e.jsx(je,{title:u("groups.plannedSection"),count:w.planned.count,groupNumbers:O.map(p=>p.group.groupNumber).filter(p=>p!==null),participantCount:k.planned.length,isCollapsed:o.planned,onToggle:()=>l("planned"),variant:"planned",children:O.length>0?e.jsx("div",{className:"space-y-3",children:O.map(({courseStartDate:p,group:S,participants:$})=>e.jsxs("div",{className:"bg-white border-2 border-amber-200 rounded-lg overflow-hidden",children:[e.jsx("div",{className:"bg-amber-50 px-3 py-2 border-b border-amber-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[S.groupNumber&&e.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-900 rounded text-xs font-semibold",children:["№ ",S.groupNumber]}),e.jsxs("span",{className:"font-semibold text-amber-900",children:[T(S.courseStartDate)," - ",T(S.courseEndDate)]})]}),e.jsxs("span",{className:"text-xs text-amber-700 font-medium",children:[$.length," ",$.length===1?u("group.participant_one"):u("group.participant_other")]})]})}),e.jsx("div",{className:"p-2 space-y-2",children:$.map((A,V)=>ne(A))})]},p))}):e.jsx("div",{className:"text-center py-8 text-slate-500",children:u("participants.noParticipantsInGroup")})}),(k.completed.length>0||!i)&&e.jsx(je,{title:u("groups.completedSection"),count:w.completed.count,participantCount:k.completed.length,isCollapsed:o.completed,onToggle:()=>l("completed"),variant:"completed",children:M.length>0?e.jsx("div",{className:"space-y-2",children:M.map(({courseStartDate:p,group:S,participants:$})=>e.jsx(Gt,{groupNumber:S.groupNumber||0,courseStartDate:S.courseStartDate,courseEndDate:S.courseEndDate,participants:$,renderParticipantRow:oe,mode:"cards",defaultExpanded:i},p))}):e.jsx("div",{className:"text-center py-8 text-slate-500",children:"Няма приключени групи"})})]}),i&&t.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 text-center",children:[e.jsx("div",{className:"text-6xl mb-4",children:"🔍"}),e.jsx("h3",{className:"text-lg font-semibold text-slate-700 mb-2",children:"Няма намерени резултати"}),e.jsx("p",{className:"text-sm text-slate-500 mb-6",children:"Опитай да промениш филтрите"})]}),e.jsx(Me,{isOpen:v.isOpen,onClose:()=>P({isOpen:!1,participant:void 0}),onConfirm:J,title:u("modal.deleteTitle"),message:u("modal.deleteMessage",{name:((pe=v.participant)==null?void 0:pe.personName)||""}),confirmText:u("common.delete"),cancelText:u("common.cancel"),variant:"danger"})]})},Ys=({isOpen:t,onClose:s,participant:a})=>{const{addParticipant:r,updateParticipant:o}=Je(),{t:l}=Q(),[n,i]=x.useState({companyName:"",personName:"",egn:"",birthPlace:"",citizenship:"българско",medicalDate:"",groupAssignmentMode:"auto",selectedGroupId:"",uniqueNumber:""}),[u,d]=x.useState({courseStartDate:"",courseEndDate:""}),[m,E]=x.useState({}),[N,G]=x.useState(!1),[v,P]=x.useState(""),[f,h]=x.useState(null),[g,C]=x.useState({isOpen:!1,message:"",onConfirm:()=>{}}),k=Se(()=>de(),[]),O=Se(()=>D.groups.orderBy("groupNumber").toArray(),[]),[M,_]=x.useState(null);x.useEffect(()=>{if(!n.medicalDate){_(null);return}Ve(n.medicalDate).then(w=>{if(w.group)_(w.group);else if(w.createsForDate){const B=new Date(w.createsForDate),U=new Date(B);U.setDate(B.getDate()+7),_({groupNumber:null,courseStartDate:w.createsForDate,courseEndDate:U.toISOString().split("T")[0],status:"planned"})}else _(null)})},[n.medicalDate]),x.useEffect(()=>{a?(i({companyName:a.companyName,personName:a.personName,egn:a.egn||"",birthPlace:a.birthPlace||"",citizenship:a.citizenship||"българско",medicalDate:a.medicalDate,groupAssignmentMode:"auto",selectedGroupId:"",uniqueNumber:a.uniqueNumber}),d({courseStartDate:a.courseStartDate,courseEndDate:a.courseEndDate}),P("")):(i({companyName:"",personName:"",egn:"",birthPlace:"",citizenship:"българско",medicalDate:"",groupAssignmentMode:"auto",selectedGroupId:"",uniqueNumber:""}),d({courseStartDate:"",courseEndDate:""}),t&&Promise.all([He(),nt()]).then(([w,B])=>{P(w),h(B)}).catch(w=>{console.error("Failed to generate next unique number:",w),P(""),h(null)})),E({})},[a,t]),x.useEffect(()=>{if(M)d({courseStartDate:M.courseStartDate,courseEndDate:M.courseEndDate}),M.status==="active"?Promise.all([He(),nt()]).then(([w,B])=>{P(B||w),h(B),a&&i(F=>({...F,uniqueNumber:""}))}).catch(w=>{console.error("Failed to get unique number:",w)}):(P(""),h(null));else if(n.medicalDate)try{const w=Fe(n.medicalDate);d(w)}catch(w){console.error("Error computing dates:",w)}},[n.medicalDate,M,a]);const L=async()=>{const w={};if(n.companyName.trim()||(w.companyName=l("modal.companyNameRequired")),n.personName.trim()||(w.personName=l("modal.personNameRequired")),n.egn.trim()?/^\d{10}$/.test(n.egn)||(w.egn=l("modal.egnInvalid")):w.egn=l("modal.egnRequired"),n.birthPlace.trim()||(w.birthPlace=l("modal.birthPlaceRequired")),n.medicalDate?As(n.medicalDate)||(w.medicalDate=_e):w.medicalDate=l("modal.medicalDateRequired"),n.uniqueNumber){if(!Es(n.uniqueNumber))w.uniqueNumber=l("modal.uniqueNumberInvalid");else if(!await rt(n.uniqueNumber,a==null?void 0:a.id))w.uniqueNumber=l("modal.uniqueNumberExists");else if(f&&!a){const U=ke(n.uniqueNumber),F=ke(f);U&&F&&(U.prefix>F.prefix||U.prefix===F.prefix&&U.seq>F.seq)&&(w.uniqueNumber=l("modal.cannotSkipGap",{number:f}))}}return E(w),Object.keys(w).length===0},I=async w=>{if(w.preventDefault(),!!await L()){if(n.groupAssignmentMode==="manual"&&n.selectedGroupId){const U=parseInt(n.selectedGroupId,10),F=O==null?void 0:O.find(Y=>Y.groupNumber===U);if((F==null?void 0:F.status)==="completed"){E(Y=>({...Y,selectedGroupId:l("modal.completedGroupError")}));return}if(!he(n.medicalDate,F.courseStartDate)){E(Y=>({...Y,medicalDate:l("modal.medicalDateCourseValidation")}));return}}else if(!he(n.medicalDate,u.courseStartDate)){E(U=>({...U,medicalDate:l("modal.medicalDateCourseValidation")}));return}if(n.groupAssignmentMode==="manual"&&n.selectedGroupId){const U=parseInt(n.selectedGroupId,10),F=await Ve(u.courseStartDate);if(F.group&&F.group.groupNumber!==U){const Y=O==null?void 0:O.find(X=>X.groupNumber===U);C({isOpen:!0,message:l("modal.groupWarningMessage",{selected:String(U),selectedDate:T(Y.courseStartDate),suggested:String(F.group.groupNumber??""),suggestedDate:T(F.group.courseStartDate)}),onConfirm:()=>{C({isOpen:!1,message:"",onConfirm:()=>{}}),z()}});return}}await z()}},z=async()=>{G(!0);try{const w={companyName:n.companyName.trim(),personName:n.personName.trim(),egn:n.egn.trim(),birthPlace:n.birthPlace.trim(),citizenship:n.citizenship.trim()||"българско",medicalDate:n.medicalDate,uniqueNumber:n.uniqueNumber.trim()||f||void 0};a?await o(a.id,w):await r(w),s()}catch(w){console.error("Error saving participant:",w),alert(`${l("error.saveFailed")}: ${w.message}`)}finally{G(!1)}};return t?e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",onClick:s,children:[e.jsxs("div",{className:"w-full max-w-2xl p-16 cursor-default",onClick:w=>w.stopPropagation(),children:[e.jsx("div",{className:"bg-white rounded-lg w-full max-h-[85vh] overflow-y-auto shadow-xl",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:l(a?"modal.editParticipant":"modal.addParticipant")}),a&&e.jsx("div",{className:"mb-4 p-3 bg-slate-50 rounded-lg border border-slate-200",children:e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[a.createdAt&&e.jsxs("div",{children:[e.jsxs("span",{className:"text-slate-600",children:[l("timestamp.createdAt"),":"]}),e.jsxs("span",{className:"ml-2 font-medium text-slate-900",children:[T(a.createdAt.split("T")[0])," ",new Date(a.createdAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})]})]}),a.updatedAt&&e.jsxs("div",{children:[e.jsxs("span",{className:"text-slate-600",children:[l("timestamp.updatedAt"),":"]}),e.jsxs("span",{className:"ml-2 font-medium text-slate-900",children:[T(a.updatedAt.split("T")[0])," ",new Date(a.updatedAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})]})]}),a.completedAt&&e.jsxs("div",{className:"col-span-2",children:[e.jsxs("span",{className:"text-emerald-600",children:[l("timestamp.completedAt"),":"]}),e.jsxs("span",{className:"ml-2 font-medium text-emerald-800",children:[T(a.completedAt.split("T")[0])," ",new Date(a.completedAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})]})]})]})}),e.jsxs("form",{onSubmit:I,children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:[l("modal.companyName")," *"]}),e.jsxs("select",{value:n.companyName,onChange:w=>i({...n,companyName:w.target.value}),className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:l("modal.selectCompany")}),e.jsx("option",{value:"Egida",children:"Egida"}),e.jsx("option",{value:"D-Max",children:"D-Max"}),e.jsx("option",{value:"Multiforce",children:"Multiforce"})]}),m.companyName&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.companyName})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:[l("modal.personName")," *"]}),e.jsx("input",{type:"text",value:n.personName,onChange:w=>i({...n,personName:w.target.value}),className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),m.personName&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.personName})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"ЕГН *"}),e.jsx("input",{type:"text",value:n.egn,onChange:w=>i({...n,egn:w.target.value}),placeholder:"XXXXXXXXXX",maxLength:10,className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),m.egn&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.egn})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Месторождение *"}),e.jsx("input",{type:"text",value:n.birthPlace,onChange:w=>i({...n,birthPlace:w.target.value}),placeholder:"гр./с. ...",className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),m.birthPlace&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.birthPlace})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Гражданство"}),e.jsx("input",{type:"text",value:n.citizenship,onChange:w=>i({...n,citizenship:w.target.value}),placeholder:"българско",className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:[l("modal.medicalDate")," *"]}),e.jsx("input",{type:"date",value:n.medicalDate,onChange:w=>i({...n,medicalDate:w.target.value}),onClick:w=>{var B,U;return(U=(B=w.target).showPicker)==null?void 0:U.call(B)},className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer ${m.medicalDate?"border-red-500":"border-slate-300"}`}),m.medicalDate&&e.jsx("p",{className:"text-red-600 text-sm mt-1 font-medium",children:m.medicalDate}),n.medicalDate&&!m.medicalDate&&e.jsxs("p",{className:"text-emerald-600 text-sm mt-1",children:["✓ ",l("modal.medicalValid"),": ",T(n.medicalDate)]})]}),u.courseStartDate&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 p-4 rounded-md",children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:l("modal.courseDates")}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-blue-700 mb-1",children:l("modal.courseStart")}),e.jsx("div",{className:"text-lg font-semibold text-blue-900",children:T(u.courseStartDate)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-blue-700 mb-1",children:l("modal.courseEnd")}),e.jsx("div",{className:"text-lg font-semibold text-blue-900",children:T(u.courseEndDate)})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:l("modal.groupAssignment")}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("button",{type:"button",onClick:()=>i({...n,groupAssignmentMode:"auto",selectedGroupId:""}),className:`flex-1 px-3 py-2 rounded-md border ${n.groupAssignmentMode==="auto"?"bg-blue-700 text-white border-blue-700":"bg-white text-slate-700 border-slate-300 hover:bg-slate-50"}`,children:l("modal.auto")}),e.jsx("button",{type:"button",onClick:()=>i({...n,groupAssignmentMode:"manual"}),className:`flex-1 px-3 py-2 rounded-md border ${n.groupAssignmentMode==="manual"?"bg-blue-700 text-white border-blue-700":"bg-white text-slate-700 border-slate-300 hover:bg-slate-50"}`,children:l("modal.manual")})]}),n.groupAssignmentMode==="auto"&&M&&e.jsx(e.Fragment,{children:M.status==="completed"?e.jsx("div",{className:"bg-red-50 border border-red-200 p-3 rounded-md",children:e.jsxs("p",{className:"text-sm text-red-800 font-medium",children:["⛔ ",l("modal.periodClosed"),e.jsx("br",{}),e.jsxs("span",{className:"text-xs font-normal mt-1 block",children:[l("modal.cannotAddComp",{date:T(M.courseStartDate)}),e.jsx("br",{}),l("modal.selectOtherDate")]})]})}):e.jsx("div",{className:"bg-emerald-50 border border-emerald-200 p-3 rounded-md",children:e.jsxs("p",{className:"text-sm text-emerald-800",children:["✓ ",l("modal.willBeAssigned")," ",e.jsxs("span",{className:"font-semibold",children:[l("group.number")," ",M.groupNumber||"-"]})," ","(",T(M.courseStartDate)," - ",T(M.courseEndDate),")"," ",e.jsx("span",{className:`inline-block px-2 py-0.5 rounded text-xs font-semibold ${M.status==="active"?"bg-blue-100 text-blue-700":"bg-slate-100 text-slate-700"}`,children:M.status==="active"?l("modal.active"):l("modal.planned")})]})})}),n.groupAssignmentMode==="manual"&&e.jsxs("select",{value:n.selectedGroupId,onChange:w=>i({...n,selectedGroupId:w.target.value}),className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:l("modal.selectGroup")}),k&&e.jsxs("option",{value:(k.groupNumber||"").toString(),children:[l("group.number")," ",k.groupNumber||"-"," - ",T(k.courseStartDate)," (",l("modal.active"),")"]}),O==null?void 0:O.filter(w=>w.status==="planned").map(w=>e.jsxs("option",{value:(w.groupNumber||"").toString(),children:[l("group.number")," ",w.groupNumber||"-"," - ",T(w.courseStartDate)," (",l("modal.planned"),")"]},w.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:l("modal.uniqueNumberAuto")}),f&&a&&e.jsx("div",{className:"mb-2 p-2 bg-amber-50 border border-amber-300 rounded-md",children:e.jsxs("p",{className:"text-amber-800 text-sm font-medium",children:["⚠️ Участникът ще получи попълващ номер: ",f]})}),a&&(M==null?void 0:M.status)==="active"&&v&&!f&&e.jsx("div",{className:"mb-2 p-2 bg-blue-50 border border-blue-300 rounded-md",children:e.jsxs("p",{className:"text-blue-800 text-sm font-medium",children:["ℹ️ Преместване в активна група → Уникален номер: ",e.jsx("span",{className:"font-bold",children:v})]})}),e.jsx("input",{type:"text",value:n.uniqueNumber,onChange:w=>i({...n,uniqueNumber:w.target.value}),placeholder:v?`${l("modal.uniqueNumberNext")}: ${v}`:"e.g., 3534-001",className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono"}),m.uniqueNumber&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.uniqueNumber})]})]}),e.jsxs("div",{className:"mt-6 flex gap-3 justify-end pb-2 md:pb-0",children:[e.jsx("button",{type:"button",onClick:s,className:"px-4 py-2 border border-slate-200 rounded-md text-slate-700 hover:bg-slate-50",disabled:N,children:l("common.cancel")}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-700 text-white rounded-md hover:bg-blue-800 disabled:opacity-50 disabled:cursor-not-allowed",disabled:N||n.groupAssignmentMode==="auto"&&(M==null?void 0:M.status)==="completed",children:l(N?"common.saving":a?"modal.update":"common.add")})]})]})]})})," "]})," ",e.jsx(Me,{isOpen:g.isOpen,onClose:()=>C({isOpen:!1,message:"",onConfirm:()=>{}}),onConfirm:g.onConfirm,title:"Предупреждение за група",message:g.message,confirmText:"Продължи",cancelText:"Отказ",variant:"warning"})]}):null},Ks=({isOpen:t,onClose:s,searchText:a,onSearchTextChange:r,selectedGroup:o,onSelectedGroupChange:l,statusFilters:n,onStatusFilterChange:i,dateRange:u,onDateRangeChange:d,groups:m,onResetToDefaults:E,visibleCount:N,totalCount:G})=>{const{t:v}=Q(),P=h=>{h.key==="Enter"&&s()};x.useEffect(()=>{const h=g=>{g.key==="Escape"&&s()};if(t)return document.addEventListener("keydown",h),()=>document.removeEventListener("keydown",h)},[t,s]);const f=({label:h,value:g,onChange:C})=>e.jsxs("div",{className:"mb-3",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700 mb-1.5 block",children:h}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("button",{onClick:()=>C(null),className:`px-2 py-1.5 text-sm rounded-lg min-h-[36px] font-medium transition-colors duration-150 ${g===null?"bg-slate-500 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:v("filters.all")}),e.jsx("button",{onClick:()=>C(!0),className:`px-2 py-1.5 text-sm rounded-lg min-h-[36px] font-medium transition-colors duration-150 ${g===!0?"bg-emerald-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:v("filters.yes")}),e.jsx("button",{onClick:()=>C(!1),className:`px-2 py-1.5 text-sm rounded-lg min-h-[36px] font-medium transition-colors duration-150 ${g===!1?"bg-red-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:v("filters.no")})]})]});return t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/30 z-40 transition-opacity",onClick:s}),e.jsxs("div",{className:`fixed z-50 bg-white shadow-2xl transition-transform
          md:top-0 md:left-0 md:bottom-auto md:right-auto md:h-auto md:max-h-[calc(100vh-16px)] md:w-[360px] lg:w-[420px] md:max-w-[480px] md:translate-x-0
          bottom-0 left-0 right-0 max-h-[90vh] rounded-t-3xl md:rounded-none flex flex-col
          ${t?"translate-y-0":"translate-y-full md:translate-y-0 md:-translate-x-full"}
        `,children:[e.jsx("div",{className:"md:hidden flex justify-center pt-3 pb-2",children:e.jsx("div",{className:"w-12 h-1.5 bg-slate-300 rounded-full"})}),e.jsxs("div",{className:"sticky top-0 bg-white flex items-center justify-between p-4 border-b border-slate-200 z-10",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900",children:v("filters.title")}),N!==void 0&&G!==void 0&&e.jsxs("span",{className:"text-sm font-medium text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full",children:[N," / ",G]})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-slate-100 rounded-lg min-w-[44px] min-h-[44px] transition-colors duration-150",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"p-4 pb-4 flex-1 md:flex-none overflow-y-auto overscroll-contain",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:v("filters.search")}),e.jsx("input",{type:"text",value:a,onChange:h=>r(h.target.value),onKeyDown:P,placeholder:v("filters.searchPlaceholder"),className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:v("filters.group")}),e.jsxs("select",{value:o,onChange:h=>l(h.target.value),className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150",children:[e.jsx("option",{value:"",children:v("filters.allGroups")}),m.map(h=>e.jsx("option",{value:h.groupNumber.toString(),children:v("filters.groupOption",{number:h.groupNumber.toString(),date:h.courseStartDate})},h.groupNumber))]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:v("filters.dateRange")}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"date",value:u.start,onChange:h=>d({...u,start:h.target.value}),onClick:h=>{var g,C;return(C=(g=h.target).showPicker)==null?void 0:C.call(g)},className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150 cursor-pointer"}),e.jsx("input",{type:"date",value:u.end,onChange:h=>d({...u,end:h.target.value}),onClick:h=>{var g,C;return(C=(g=h.target).showPicker)==null?void 0:C.call(g)},className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150 cursor-pointer"})]})]}),e.jsxs("div",{className:"border-t border-slate-200 pt-4 mt-4",children:[e.jsx("h4",{className:"font-medium text-slate-900 mb-4",children:v("filters.statusFilters")}),e.jsx(f,{label:v("participant.sent"),value:n.sent,onChange:h=>i("sent",h)}),e.jsx(f,{label:v("participant.documents"),value:n.documents,onChange:h=>i("documents",h)}),e.jsx(f,{label:v("participant.handed"),value:n.handedOver,onChange:h=>i("handedOver",h)}),e.jsx(f,{label:v("participant.paid"),value:n.paid,onChange:h=>i("paid",h)}),e.jsx(f,{label:v("participant.completed"),value:n.completed,onChange:h=>i("completed",h)})]}),e.jsxs("div",{className:"mt-6 mb-6 pb-8 flex gap-3",children:[e.jsx("button",{onClick:()=>{r(""),l(""),d({start:"",end:""}),i("sent",null),i("documents",null),i("handedOver",null),i("paid",null),i("completed",null),E()},className:"flex-1 px-4 py-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 font-medium min-h-[48px] transition-colors duration-150",children:v("filters.clearAll")}),e.jsx("button",{onClick:s,className:"flex-1 px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium min-h-[48px] transition-colors duration-150",children:v("filters.apply")})]})]})]})]}):null},Xs=({activeFilters:t,onRemoveFilter:s})=>{var o,l;const{t:a}=Q(),r=[];return t.searchText&&r.push({label:`${a("filters.search")}: "${t.searchText}"`,type:"search"}),t.selectedGroup&&r.push({label:`${a("filters.group")}: ${t.selectedGroup}`,type:"group"}),(o=t.dateRange)!=null&&o.start&&r.push({label:`${a("filters.from")}: ${T(t.dateRange.start)}`,type:"dateStart"}),(l=t.dateRange)!=null&&l.end&&r.push({label:`${a("filters.to")}: ${T(t.dateRange.end)}`,type:"dateEnd"}),t.statusFilters&&Object.entries(t.statusFilters).forEach(([n,i])=>{if(i!==null){const u=`participant.${n}`;r.push({label:`${a(u)}: ${a(i?"filters.yes":"filters.no")}`,type:"status",value:n})}}),r.length===0?null:e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[r.map((n,i)=>e.jsxs("button",{onClick:()=>s(n.type,n.value),className:"inline-flex items-center gap-2 px-3 py-1.5 bg-blue-100 text-blue-800 rounded-full text-sm hover:bg-blue-200 transition-colors duration-150",children:[e.jsx("span",{children:n.label}),e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]},i)),e.jsx("button",{onClick:()=>s("all"),className:"px-3 py-1.5 bg-slate-200 text-slate-700 rounded-full text-sm hover:bg-slate-300 transition-colors duration-150",children:"Clear All"})]})},Js=3e5,Qs=16,Zs="SHA-256",ea=256,Qe="app_pin_config";function Nt(t){const s=new Uint8Array(t);let a="";const r=s.byteLength,o=8192;for(let l=0;l<r;l+=o)a+=String.fromCharCode.apply(null,s.subarray(l,l+o));return window.btoa(a)}function ta(t){try{const s=window.atob(t),a=s.length,r=new Uint8Array(a);for(let o=0;o<a;o++)r[o]=s.charCodeAt(o);return r}catch{throw new Error("Invalid Base64 string")}}async function Rt(t,s){let a;s?a=ta(s):a=window.crypto.getRandomValues(new Uint8Array(Qs));const r=new TextEncoder,o=await window.crypto.subtle.importKey("raw",r.encode(t),{name:"PBKDF2"},!1,["deriveBits","deriveKey"]),l=await window.crypto.subtle.deriveBits({name:"PBKDF2",salt:a,iterations:Js,hash:Zs},o,ea);return{hash:Nt(l),salt:Nt(a.buffer)}}async function jt(t,s){try{const{hash:a}=await Rt(t,s.salt);return a===s.hash}catch(a){return console.error("PIN verification failed:",a),!1}}function sa(t){localStorage.setItem(Qe,JSON.stringify(t))}function yt(){const t=localStorage.getItem(Qe);if(!t)return null;try{return JSON.parse(t)}catch{return null}}function lt(){localStorage.removeItem(Qe)}function Ae(){return!!localStorage.getItem(Qe)}const aa=({mode:t,onSuccess:s,onCancel:a,onResetData:r})=>{const{t:o}=Q(),[l,n]=x.useState(""),[i,u]=x.useState(""),[d,m]=x.useState("enter"),[E,N]=x.useState(null),[G,v]=x.useState(!1),[P,f]=x.useState(!1);x.useEffect(()=>{n(""),u(""),m("enter"),N(null)},[t]);const h=L=>{if(G)return;N(null);const I=d==="enter"?l:i;if(I.length<4){const z=I+L.toString();d==="enter"?n(z):u(z),z.length===4&&C(z)}},g=()=>{G||(N(null),d==="enter"?n(L=>L.slice(0,-1)):u(L=>L.slice(0,-1)))},C=async L=>{v(!0),await new Promise(I=>setTimeout(I,100));try{if(t==="unlock"){const I=yt();if(!I){s();return}await jt(L,I)?s():(N(o("security.incorrectPin")),n(""))}else if(t==="setup")if(d==="enter"){m("confirm"),v(!1);return}else if(L===l){const{hash:I,salt:z}=await Rt(L);sa({version:1,hash:I,salt:z,algo:"PBKDF2-SHA-256",createdAt:new Date().toISOString()}),s()}else N(o("security.pinMismatch")),n(""),u(""),m("enter");else if(t==="disable"){const I=yt();I&&await jt(L,I)?(lt(),s()):(N(o("security.incorrectPin")),n(""))}}catch(I){console.error(I),N(o("security.error"))}finally{v(!1)}},k=()=>e.jsxs("div",{className:"grid grid-cols-3 gap-4 max-w-[280px] mx-auto mt-8",children:[[1,2,3,4,5,6,7,8,9].map(L=>e.jsx("button",{onClick:()=>h(L),className:"w-16 h-16 rounded-full bg-slate-100 text-slate-700 text-2xl font-bold hover:bg-slate-200 active:bg-slate-300 transition-colors flex items-center justify-center shadow-sm",children:L},L)),e.jsx("div",{className:"w-16 h-16 flex items-center justify-center",children:t==="unlock"&&e.jsx("button",{onClick:()=>f(!0),className:"text-xs text-slate-400 font-medium hover:text-red-500 transition-colors",children:o("security.forgot")})}),e.jsx("button",{onClick:()=>h(0),className:"w-16 h-16 rounded-full bg-slate-100 text-slate-700 text-2xl font-bold hover:bg-slate-200 active:bg-slate-300 transition-colors flex items-center justify-center shadow-sm",children:"0"}),e.jsx("button",{onClick:g,className:"w-16 h-16 rounded-full text-slate-500 hover:text-slate-700 hover:bg-slate-100 active:bg-slate-200 transition-colors flex items-center justify-center",children:e.jsx(vs,{className:"w-6 h-6"})})]}),O=L=>e.jsx("div",{className:"flex gap-4 justify-center mb-6",children:[0,1,2,3].map(I=>e.jsx("div",{className:`w-4 h-4 rounded-full border-2 transition-all duration-200 ${I<L.length?"bg-blue-600 border-blue-600":"bg-transparent border-slate-300"} ${E?"border-red-400 bg-red-50":""}`},I))}),M=()=>o(t==="setup"?d==="enter"?"security.setPinTitle":"security.confirmPinTitle":t==="disable"?"security.enterPinToDisable":"security.appLocked"),_=()=>E||o(t==="setup"?d==="enter"?"security.enter4DigitPin":"security.reEnterToConfirm":"security.enterYourPin");return e.jsxs("div",{className:"fixed inset-0 bg-slate-50 z-[100] flex flex-col items-center justify-center p-4 animate-in fade-in duration-300",children:[e.jsxs("div",{className:"w-full max-w-sm text-center",children:[e.jsx("div",{className:"mb-6 flex justify-center",children:e.jsx("div",{className:`p-4 rounded-full ${E?"bg-red-100":"bg-blue-100"}`,children:t==="unlock"?e.jsx(Pt,{className:`w-8 h-8 ${E?"text-red-600":"text-blue-600"}`}):e.jsx(ws,{className:"w-8 h-8 text-blue-600"})})}),e.jsx("h2",{className:`text-2xl font-bold mb-2 ${E?"text-red-600":"text-slate-800"}`,children:M()}),e.jsx("p",{className:`text-sm mb-8 font-medium ${E?"text-red-500":"text-slate-500"}`,children:_()}),O(d==="enter"?l:i),k(),a&&e.jsx("button",{onClick:a,className:"mt-8 text-slate-500 hover:text-slate-700 font-medium text-sm",children:o("common.cancel")})]}),P&&e.jsx(Me,{isOpen:P,onClose:()=>f(!1),onConfirm:()=>{r&&(lt(),r()),f(!1)},title:o("security.resetDataTitle"),message:o("security.resetDataMessage"),confirmText:o("security.resetDataConfirm"),variant:"danger"})]})},St=10*60*1e3,ra=({children:t})=>{const[s,a]=x.useState(!1),[r,o]=x.useState(!1),l=x.useRef(Date.now()),n=x.useRef(null);x.useEffect(()=>{Ae()&&a(!0),o(!0)},[]);const i=x.useCallback(()=>{Ae()&&a(!0)},[]),u=x.useCallback(()=>{a(!1),l.current=Date.now()},[]);x.useEffect(()=>{if(s)return;const m=()=>{l.current=Date.now()},E=["mousedown","keydown","touchstart","scroll","mousemove"];let N=null;const G=()=>{N||(m(),N=setTimeout(()=>{N=null},1e3))};E.forEach(P=>window.addEventListener(P,G));const v=()=>{!document.hidden&&Ae()&&Date.now()-l.current>St&&a(!0)};return document.addEventListener("visibilitychange",v),n.current=setInterval(()=>{if(document.hidden)return;Date.now()-l.current>St&&Ae()&&a(!0)},5e3),()=>{E.forEach(P=>window.removeEventListener(P,G)),document.removeEventListener("visibilitychange",v),n.current&&clearInterval(n.current),N&&clearTimeout(N)}},[s]),x.useEffect(()=>{const m=()=>i();return window.addEventListener("app-lock-manual",m),()=>window.removeEventListener("app-lock-manual",m)},[i]);const d=async()=>{try{await D.delete(),await D.open(),lt(),window.location.reload()}catch(m){console.error("Failed to reset data",m),alert("Failed to reset data. Please clear browser storage manually.")}};return r?s?e.jsx(aa,{mode:"unlock",onSuccess:u,onResetData:d}):e.jsx(e.Fragment,{children:t}):null},na=()=>{window.dispatchEvent(new Event("app-lock-manual"))},oa=({activeTab:t,onTabChange:s,onBack:a})=>{const{t:r}=Q();return e.jsx("header",{className:"bg-blue-700 text-white shadow-sm sticky top-0 z-40",children:e.jsx("div",{className:"container mx-auto px-4 py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[a&&e.jsx("button",{onClick:a,className:"md:hidden p-2 hover:bg-blue-700 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("div",{className:"flex-shrink-0 w-14 h-14 md:w-16 md:h-16 bg-white rounded-md flex items-center justify-center overflow-hidden",children:e.jsx("img",{src:"./Logo.svg",alt:"Logo",className:"w-full h-full object-cover scale-[2.4]"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"CERTIFY"}),e.jsx("p",{className:"text-sm md:text-base text-blue-100",children:r("nav.subtitle")})]}),e.jsxs("div",{className:"hidden md:flex gap-2",children:[e.jsxs("button",{onClick:()=>s("participants"),className:`px-6 py-2 rounded-lg font-medium transition-colors duration-150 flex items-center gap-2 ${t==="participants"?"bg-white text-blue-800":"bg-blue-700/30 text-white hover:bg-blue-700/50"}`,children:[e.jsx(We,{className:"w-5 h-5",strokeWidth:2}),r("nav.participants")]}),e.jsxs("button",{onClick:()=>s("tools"),className:`px-6 py-2 rounded-lg font-medium transition-colors duration-150 flex items-center gap-2 ${t==="tools"?"bg-white text-blue-800":"bg-blue-700/30 text-white hover:bg-blue-700/50"}`,children:[e.jsx(Ot,{className:"w-5 h-5",strokeWidth:2}),r("nav.tools")]}),Ae()&&e.jsxs("button",{onClick:()=>na(),className:"px-4 py-2 ml-2 rounded-lg font-medium bg-indigo-600 text-white hover:bg-indigo-500 border border-indigo-400/50 shadow-sm transition-all duration-150 flex items-center gap-2",title:r("nav.lock"),children:[e.jsx(Pt,{className:"w-5 h-5",strokeWidth:2}),e.jsx("span",{className:"hidden lg:inline",children:r("nav.lock")})]})]})]})})})},la=({totalParticipants:t,visibleParticipants:s,totalCourses:a,visibleCourses:r,completedCount:o})=>{const{t:l}=Q(),[n,i]=x.useState(!1);return e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"md:hidden",children:[e.jsxs("button",{onClick:()=>i(!n),className:"w-full bg-white rounded-lg px-2 py-2 shadow-sm border border-slate-200 flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"text-[11px] font-medium text-slate-500",children:l("participants.showing")}),e.jsxs("div",{className:"text-lg font-bold text-blue-600",children:[s,"/",t]})]}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"text-[11px] font-medium text-slate-500",children:l("participant.completed")}),e.jsx("div",{className:"text-lg font-bold text-emerald-700",children:o})]})]}),e.jsx("svg",{className:`w-4 h-4 text-slate-500 transition-transform duration-200 ${n?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),n&&e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-1",children:[e.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-slate-400",children:[e.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-slate-900 font-semibold whitespace-nowrap",children:l("participants.total")}),e.jsx("div",{className:"text-[9px] text-transparent font-medium mt-0.5 select-none",children:" "})]}),e.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:e.jsx(We,{className:"w-3.5 h-3.5 text-slate-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-2xl font-semibold tracking-tight text-slate-900",children:t})]}),e.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-blue-500",children:[e.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-blue-600 font-semibold whitespace-nowrap",children:l("participants.showing")}),e.jsx("div",{className:"text-[9px] text-slate-500 font-medium mt-0.5",children:l("participants.showingSubtext")})]}),e.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:e.jsx(xt,{className:"w-3.5 h-3.5 text-blue-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-2xl font-semibold tracking-tight text-blue-600",children:s})]}),e.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-indigo-500",children:[e.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-indigo-600 font-semibold whitespace-nowrap",children:l("participants.totalCourses")}),e.jsx("div",{className:"text-[9px] text-slate-500 font-medium mt-0.5",children:l("participants.totalCoursesSubtext")})]}),e.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:e.jsx(ht,{className:"w-3.5 h-3.5 text-indigo-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-2xl font-semibold tracking-tight text-indigo-600",children:a})]}),e.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-cyan-500",children:[e.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-cyan-600 font-semibold whitespace-nowrap",children:l("participants.visibleCourses")}),e.jsx("div",{className:"text-[9px] text-slate-500 font-medium mt-0.5",children:l("participants.visibleCoursesSubtext")})]}),e.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:e.jsx(Ue,{className:"w-3.5 h-3.5 text-cyan-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-2xl font-semibold tracking-tight text-cyan-600",children:r})]}),e.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-amber-500 col-span-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-amber-600 font-semibold whitespace-nowrap",children:l("participants.completed")}),e.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:e.jsx(ft,{className:"w-3.5 h-3.5 text-amber-600",strokeWidth:2})})]}),e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsx("div",{className:"text-xl font-semibold tracking-tight text-amber-600",children:o}),e.jsxs("div",{className:"text-xs text-slate-500",children:["/ ",s," (",s>0?Math.round(o/s*100):0,"%)"]})]})]})]})]}),e.jsxs("div",{className:"hidden md:grid grid-cols-5 gap-4 mb-2",children:[e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-slate-400 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"text-sm uppercase tracking-wide text-slate-900 font-semibold whitespace-nowrap",children:l("participants.total")}),e.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:e.jsx(We,{className:"w-[18px] h-[18px] text-slate-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-3xl font-semibold tracking-tight text-slate-900 mt-auto",children:t})]}),e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-blue-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base uppercase tracking-wide text-blue-600 font-semibold whitespace-nowrap",children:l("participants.showing")}),e.jsx("div",{className:"text-[10px] text-slate-500 font-medium mt-0.5",children:l("participants.showingSubtext")})]}),e.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:e.jsx(xt,{className:"w-[18px] h-[18px] text-blue-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-4xl font-semibold tracking-tight text-blue-600 mt-auto",children:s})]}),e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-indigo-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base uppercase tracking-wide text-indigo-600 font-semibold whitespace-nowrap",children:l("participants.totalCourses")}),e.jsx("div",{className:"text-[10px] text-slate-500 font-medium mt-0.5",children:l("participants.totalCoursesSubtext")})]}),e.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:e.jsx(ht,{className:"w-[18px] h-[18px] text-indigo-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-3xl font-semibold tracking-tight text-indigo-600 mt-auto",children:a})]}),e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-cyan-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base uppercase tracking-wide text-cyan-600 font-semibold whitespace-nowrap",children:l("participants.visibleCourses")}),e.jsx("div",{className:"text-[10px] text-slate-500 font-medium mt-0.5",children:l("participants.visibleCoursesSubtext")})]}),e.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:e.jsx(Ue,{className:"w-[18px] h-[18px] text-cyan-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-4xl font-semibold tracking-tight text-cyan-600 mt-auto",children:r})]}),e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-amber-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"text-sm uppercase tracking-wide text-amber-600 font-semibold whitespace-nowrap",children:l("participants.completed")}),e.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:e.jsx(ft,{className:"w-[18px] h-[18px] text-amber-600",strokeWidth:2})})]}),e.jsxs("div",{className:"flex items-baseline gap-2 mt-auto",children:[e.jsx("div",{className:"text-3xl font-semibold tracking-tight text-amber-600",children:o}),e.jsxs("div",{className:"text-sm text-slate-500",children:["/ ",s," (",s>0?Math.round(o/s*100):0,"%)"]})]})]})]})]})},ia=({activeTab:t,onTabChange:s})=>{const{t:a}=Q();return e.jsx("nav",{className:"md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-sm z-50",children:e.jsxs("div",{className:"flex",children:[e.jsxs("button",{onClick:()=>s("participants"),className:`flex-1 flex flex-col items-center justify-center py-3 transition-colors duration-150 ${t==="participants"?"text-blue-700":"text-slate-400"}`,children:[e.jsx(We,{className:"w-6 h-6 mb-1",strokeWidth:2}),e.jsx("span",{className:`text-xs ${t==="participants"?"font-semibold":"font-medium"}`,children:a("nav.participants")})]}),e.jsxs("button",{onClick:()=>s("tools"),className:`flex-1 flex flex-col items-center justify-center py-3 transition-colors duration-150 ${t==="tools"?"text-blue-700":"text-slate-400"}`,children:[e.jsx(Ot,{className:"w-6 h-6 mb-1",strokeWidth:2}),e.jsx("span",{className:`text-xs ${t==="tools"?"font-semibold":"font-medium"}`,children:a("nav.tools")})]})]})})},ca=({onClick:t})=>{const{t:s}=Q();return e.jsx("button",{onClick:t,className:"md:hidden fixed bottom-24 right-6 w-14 h-14 bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white rounded-full shadow-lg flex items-center justify-center z-40 active:scale-95 transition-all duration-150",style:{minWidth:"56px",minHeight:"56px"},"aria-label":s("participants.add"),children:e.jsx("svg",{className:"w-7 h-7",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M12 4v16m8-8H4"})})})};let Be;function da(){return Be!==void 0||(Be=Ns("https://xxkqorvdmksyeyoftlgu.supabase.co","sb_publishable_F6tEV-grkbpwT4Ndhg5r8A__mNzR53l",{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}})),Be}const _t="spi.entitlement.cache.v1",ye={configured:!1,authenticated:!1,status:"unknown",readOnly:!1,planCode:null,daysUntilReadOnly:null,currentPeriodEnd:null,graceUntil:null,error:null,lastCheckedAt:null},zt=x.createContext(void 0);function ua(t){if(!t)return"Entitlement check failed.";if(t instanceof Error)return t.message;if(typeof t=="object"&&t!==null){const s=t.message;if(typeof s=="string"&&s.trim().length>0)return s}return"Entitlement check failed."}function ma(){try{const t=localStorage.getItem(_t);if(!t)return ye;const s=JSON.parse(t);return{...ye,...s,error:null}}catch{return ye}}function Re(t){localStorage.setItem(_t,JSON.stringify(t))}const pa=({children:t})=>{const s=x.useMemo(()=>da(),[]),[a,r]=x.useState(()=>ma()),[o,l]=x.useState(!1),[n,i]=x.useState(!1),[u,d]=x.useState(null);x.useEffect(()=>{const f=window.location.hash;if(!f||f.length<2)return;const h=new URLSearchParams(f.slice(1)),g=h.get("error_description");g&&d(g.replace(/\+/g," "));const C=h.get("type"),k=!!(h.get("access_token")||h.get("code"));C==="recovery"&&k&&(i(!0),d(null))},[]),x.useEffect(()=>{Ce(a.readOnly)},[a.readOnly]);const m=x.useCallback(async(f=!1)=>{if(!s){const h={...ye,configured:!1,readOnly:!1,lastCheckedAt:new Date().toISOString()};r(h),Re(h),Ce(!1);return}f||l(!0);try{const{data:h,error:g}=await s.auth.getSession();if(g)throw g;if(!h.session){const _={...ye,configured:!0,authenticated:!1,readOnly:!1,lastCheckedAt:new Date().toISOString()};r(_),Re(_),Ce(!1);return}const{data:C,error:k}=await s.rpc("entitlement_me",{p_tenant_id:null});if(k)throw k;const O=Array.isArray(C)?C[0]:C;if(!O)throw new Error("Entitlement data is missing.");const M={configured:!0,authenticated:!0,status:O.status||"unknown",readOnly:!!O.read_only,planCode:O.plan_code||null,daysUntilReadOnly:typeof O.days_until_read_only=="number"?O.days_until_read_only:null,currentPeriodEnd:O.current_period_end||null,graceUntil:O.grace_until||null,error:null,lastCheckedAt:new Date().toISOString()};r(M),Re(M),Ce(M.readOnly)}catch(h){const g=ua(h),C=g.toLowerCase();if(C.includes("jwt")||C.includes("refresh token")||C.includes("session")||C.includes("invalid token")){await s.auth.signOut();const k={...ye,configured:!0,authenticated:!1,readOnly:!1,error:null,lastCheckedAt:new Date().toISOString()};r(k),Re(k),Ce(!1);return}f||r(k=>({...k,configured:!0,error:g,lastCheckedAt:new Date().toISOString()}))}finally{f||l(!1)}},[s]),E=x.useCallback(async(f,h)=>{if(!s)throw new Error("Supabase is not configured.");const{error:g}=await s.auth.signInWithPassword({email:f,password:h});if(g)throw g;await m()},[m,s]),N=x.useCallback(async()=>{if(!s)return;const{error:f}=await s.auth.signOut();if(f)throw f;await m()},[m,s]),G=x.useCallback(async f=>{if(!s)throw new Error("Supabase is not configured.");const h=window.location.pathname.endsWith("/")?window.location.pathname:`${window.location.pathname}/`,{error:g}=await s.auth.resetPasswordForEmail(f,{redirectTo:`${window.location.origin}${h}`});if(g)throw g},[s]),v=x.useCallback(async f=>{if(!s)throw new Error("Supabase is not configured.");const{error:h}=await s.auth.updateUser({password:f});if(h)throw h;i(!1),window.history.replaceState({},document.title,window.location.pathname+window.location.search),await m()},[m,s]),P=x.useCallback(()=>{d(null),window.location.hash&&window.history.replaceState({},document.title,window.location.pathname+window.location.search)},[]);return x.useEffect(()=>{let f=!0,h=0;const g=async(M=!1)=>{f&&(await m(M),h=Date.now())};g(!1);const C=window.setInterval(()=>{g(!0)},2*60*1e3),k=()=>{Date.now()-h>1e4&&g(!0)};window.addEventListener("focus",k);const{data:{subscription:O}}=s?s.auth.onAuthStateChange(M=>{M==="PASSWORD_RECOVERY"&&(i(!0),d(null)),M==="SIGNED_OUT"&&i(!1),g(!1)}):{data:{subscription:{unsubscribe:()=>{}}}};return()=>{f=!1,window.clearInterval(C),window.removeEventListener("focus",k),O.unsubscribe()}},[m,s]),e.jsx(zt.Provider,{value:{entitlement:a,loading:o,recoveryMode:n,authLinkError:u,refresh:m,signInWithPassword:E,signOut:N,requestPasswordReset:G,updatePassword:v,clearAuthLinkError:P},children:t})},xa=()=>{const t=x.useContext(zt);if(!t)throw new Error("useEntitlement must be used within EntitlementProvider");return t},ha=x.lazy(()=>Le(()=>import("./ToolsPage-BTeG2ydO.js"),__vite__mapDeps([9,3,1,4,2,7,5,6,8]),import.meta.url).then(t=>({default:t.ToolsPage})));function tt(t,s){const a=t.toLowerCase();return a.includes("invalid login credentials")?s("auth.invalidCredentials"):a.includes("email not confirmed")?s("auth.emailNotConfirmed"):a.includes("too many requests")?s("auth.rateLimited"):s("auth.failed")}function fa(){const{t,language:s,setLanguage:a}=Q(),{entitlement:r,loading:o,signInWithPassword:l,signOut:n,requestPasswordReset:i,updatePassword:u,recoveryMode:d,authLinkError:m,clearAuthLinkError:E}=xa(),{participants:N,deleteParticipant:G}=Je(),{groups:v}=Gs(),{collapsedSections:P,toggleSection:f,expandSection:h,resetToDefaults:g,setCollapsedState:C}=Bs(),k=r.readOnly,[O,M]=x.useState("participants"),[_,L]=x.useState(!1),[I,z]=x.useState(),[w,B]=x.useState(!1),[U,F]=x.useState(!1),[Y]=x.useState(0),[X,ue]=x.useState(""),[te,fe]=x.useState(""),[se,ie]=x.useState(!1),[be,J]=x.useState(null),[Z,me]=x.useState(!1),[ge,ne]=x.useState(null),[oe,pe]=x.useState(""),[p,S]=x.useState(""),[$,A]=x.useState(!1),[V,c]=x.useState(null);x.useEffect(()=>{setTimeout(async()=>{try{console.log("App initializing..."),await Os(),await Pe(),console.log("App initialization complete.")}catch(R){console.error("CRITICAL: Failed to initialize groups:",R)}},100)},[]);const[b,y]=x.useState(""),[j,H]=x.useState(""),[W,Ie]=x.useState({sent:null,documents:null,handedOver:null,paid:null,completed:null}),[re,De]=x.useState({start:"",end:""}),[Ze,it]=x.useState(null),we=x.useMemo(()=>b!==""||j!==""||W.sent!==null||W.documents!==null||W.handedOver!==null||W.paid!==null||W.completed!==null||re.start!==""||re.end!=="",[b,j,W,re]);x.useEffect(()=>{we?(Ze||it({...P}),P.active&&h("active"),P.planned&&h("planned"),P.completed&&h("completed")):Ze&&(C(Ze),it(null))},[we]);const ct=x.useMemo(()=>new Map((v??[]).map(q=>[q.courseStartDate,q])),[v]),dt=x.useMemo(()=>(v??[]).filter(q=>q.groupNumber!==null&&q.groupNumber!==void 0).map(q=>({...q,groupNumber:q.groupNumber})),[v]),ce=x.useMemo(()=>{if(!N)return[];const q=new Date().getFullYear();return N.filter(R=>{const K=ct.get(R.courseStartDate);if((R.completedOverride!==null?R.completedOverride:R.completedComputed)&&(K==null?void 0:K.status)==="completed"&&new Date(R.courseStartDate).getFullYear()!==q)return!1;if(b){const le=b.toLowerCase();if(!(R.companyName.toLowerCase().includes(le)||R.personName.toLowerCase().includes(le)||R.uniqueNumber.toLowerCase().includes(le)))return!1}if(j){const le=parseInt(j,10);if(K&&K.groupNumber!==le||!K)return!1}return!(re.start&&R.courseStartDate<re.start||re.end&&R.courseStartDate>=re.end||W.sent!==null&&R.sent!==W.sent||W.documents!==null&&R.documents!==W.documents||W.handedOver!==null&&R.handedOver!==W.handedOver||W.paid!==null&&R.paid!==W.paid||W.completed!==null&&(R.completedOverride!==null?R.completedOverride:R.completedComputed)!==W.completed)})},[N,ct,b,j,W,re]),$e=(N==null?void 0:N.length)||0,Te=ce.length,Wt=(v==null?void 0:v.length)||0,Ft=x.useMemo(()=>{if(!v||v.length===0)return 0;const q=new Set,R=new Map(v.map(K=>[K.courseStartDate,K]));return ce.forEach(K=>{const ee=R.get(K.courseStartDate);ee&&q.add(ee.courseStartDate)}),we||(v.forEach(ee=>{ee.status==="active"&&q.add(ee.courseStartDate)}),v.filter(ee=>ee.status==="planned").map(ee=>ee.courseStartDate).sort((ee,le)=>ee.localeCompare(le)).slice(0,2).forEach(ee=>q.add(ee))),q.size},[v,ce,we]),Ht=x.useMemo(()=>ce.filter(q=>q.completedOverride!==null?q.completedOverride:q.completedComputed).length,[ce]),ut=()=>{if(k){alert(t("entitlement.readOnlyAction"));return}z(void 0),L(!0)},mt=q=>{if(k){alert(t("entitlement.readOnlyAction"));return}z(q),L(!0)},pt=async q=>{if(k){alert(t("entitlement.readOnlyAction"));return}await G(q)},Vt=()=>{L(!1),z(void 0)},Yt=(q,R)=>{Ie(K=>({...K,[q]:R}))},Kt=()=>{y(""),H(""),Ie({sent:null,documents:null,handedOver:null,paid:null,completed:null}),De({start:"",end:""})},Xt=q=>{y(q.searchTerm),H(q.courseStartDate||""),Ie({sent:null,documents:null,handedOver:null,paid:null,completed:null}),De({start:"",end:""})},Jt=(q,R)=>{switch(q){case"search":y("");break;case"group":H("");break;case"dateStart":De(K=>({...K,start:""}));break;case"dateEnd":De(K=>({...K,end:""}));break;case"status":R&&Ie(K=>({...K,[R]:null}));break;case"all":Kt();break}},Qt=async q=>{if(q.preventDefault(),J(null),!X.trim()||!te.trim()){J(t("auth.required"));return}ne(null),ie(!0);try{await l(X.trim(),te),fe("")}catch(R){R instanceof Error?J(tt(R.message,t)):J(t("auth.failed"))}finally{ie(!1)}},Zt=async()=>{try{await n()}catch(q){alert(q instanceof Error?q.message:t("auth.signOutFailed"))}},es=async q=>{if(q.preventDefault(),J(null),ne(null),!X.trim()){J(t("auth.emailRequired"));return}ie(!0);try{await i(X.trim()),ne(t("auth.resetSent"))}catch(R){R instanceof Error?J(tt(R.message,t)):J(t("auth.failed"))}finally{ie(!1)}},ts=async q=>{if(q.preventDefault(),c(null),!oe||!p){c(t("auth.resetPasswordRequired"));return}if(oe.length<6){c(t("auth.resetPasswordTooShort"));return}if(oe!==p){c(t("auth.resetPasswordsMismatch"));return}A(!0);try{await u(oe),pe(""),S("")}catch(R){R instanceof Error?c(tt(R.message,t)):c(t("auth.failed"))}finally{A(!1)}};return d?e.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center px-4",children:e.jsxs("div",{className:"w-full max-w-md bg-white rounded-xl shadow p-6 space-y-4 relative",children:[e.jsxs("div",{className:"absolute top-4 right-4 flex gap-1",children:[e.jsx("button",{type:"button",onClick:()=>a("bg"),className:`px-2.5 py-1 text-xs font-medium rounded ${s==="bg"?"bg-blue-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:"BG"}),e.jsx("button",{type:"button",onClick:()=>a("en"),className:`px-2.5 py-1 text-xs font-medium rounded ${s==="en"?"bg-blue-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:"EN"})]}),e.jsx("h1",{className:"text-2xl font-bold text-slate-900",children:t("auth.resetTitle")}),e.jsx("p",{className:"text-sm text-slate-600",children:t("auth.resetSubtitle")}),e.jsxs("form",{onSubmit:ts,className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:t("auth.newPassword")}),e.jsx("input",{type:"password",value:oe,onChange:q=>pe(q.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:t("auth.passwordPlaceholder"),autoComplete:"new-password"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:t("auth.confirmPassword")}),e.jsx("input",{type:"password",value:p,onChange:q=>S(q.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:t("auth.passwordPlaceholder"),autoComplete:"new-password"})]}),V&&e.jsx("p",{className:"text-sm text-red-600",children:V}),e.jsx("button",{type:"submit",disabled:$,className:`w-full py-2.5 rounded-lg font-medium ${$?"bg-slate-300 text-slate-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:t($?"common.loading":"auth.updatePassword")})]})]})}):r.configured&&!r.authenticated?e.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center px-4",children:e.jsxs("div",{className:"w-full max-w-md bg-white rounded-xl shadow p-6 space-y-4 relative",children:[e.jsxs("div",{className:"absolute top-4 right-4 flex gap-1",children:[e.jsx("button",{type:"button",onClick:()=>a("bg"),className:`px-2.5 py-1 text-xs font-medium rounded ${s==="bg"?"bg-blue-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:"BG"}),e.jsx("button",{type:"button",onClick:()=>a("en"),className:`px-2.5 py-1 text-xs font-medium rounded ${s==="en"?"bg-blue-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:"EN"})]}),e.jsx("h1",{className:"text-2xl font-bold text-slate-900",children:t("auth.title")}),e.jsx("p",{className:"text-sm text-slate-600",children:t("auth.subtitle")}),e.jsxs("form",{onSubmit:Z?es:Qt,className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:t("auth.email")}),e.jsx("input",{type:"email",value:X,onChange:q=>ue(q.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:t("auth.emailPlaceholder"),autoComplete:"email"})]}),!Z&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:t("auth.password")}),e.jsx("input",{type:"password",value:te,onChange:q=>fe(q.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:t("auth.passwordPlaceholder"),autoComplete:"current-password"})]}),be&&e.jsx("p",{className:"text-sm text-red-600",children:be}),ge&&e.jsx("p",{className:"text-sm text-emerald-700",children:ge}),m&&e.jsx("p",{className:"text-sm text-red-600",children:m}),r.error&&e.jsx("p",{className:"text-sm text-red-600",children:r.error}),e.jsx("button",{type:"submit",disabled:se||o,className:`w-full py-2.5 rounded-lg font-medium ${se||o?"bg-slate-300 text-slate-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:t(se?"common.loading":Z?"auth.sendReset":"auth.signIn")}),e.jsx("button",{type:"button",onClick:()=>{me(q=>!q),J(null),ne(null),E()},className:"w-full py-2 text-sm text-blue-700 hover:text-blue-800",children:t(Z?"auth.backToLogin":"auth.forgotPassword")})]})]})}):e.jsx("div",{className:"min-h-screen bg-slate-50",children:e.jsxs(ra,{children:[e.jsx(oa,{activeTab:O,onTabChange:M}),r.configured&&r.authenticated&&(r.status==="grace"||k)&&e.jsx("div",{className:`border-b ${k?"bg-red-50 border-red-200":"bg-amber-50 border-amber-200"}`,children:e.jsx("div",{className:"container mx-auto px-4 py-2 text-sm",children:e.jsxs("div",{children:[e.jsx("p",{className:`font-medium ${k?"text-red-700":"text-amber-800"}`,children:t(k?"entitlement.readOnlyBannerTitle":"entitlement.graceBannerTitle")}),!k&&r.daysUntilReadOnly!==null&&e.jsx("p",{className:"text-amber-700",children:t("entitlement.graceBannerMessage",{days:String(r.daysUntilReadOnly)})}),k&&e.jsx("p",{className:"text-red-700",children:t("entitlement.readOnlyBannerMessage")}),o&&e.jsx("p",{className:"text-slate-500",children:t("common.loading")})]})})}),O==="participants"?e.jsxs("main",{className:"container mx-auto px-4 py-6 pb-24 md:pb-6",children:[e.jsx(la,{totalParticipants:$e,visibleParticipants:Te,totalCourses:Wt,visibleCourses:Ft,completedCount:Ht}),e.jsx(Xs,{activeFilters:{searchText:b,selectedGroup:j,dateRange:re,statusFilters:W},onRemoveFilter:Jt,groups:dt}),e.jsxs("div",{className:"hidden md:flex flex-wrap gap-3 mb-6",children:[e.jsxs("button",{onClick:ut,disabled:k,className:`px-6 py-3 rounded-lg shadow font-medium ${k?"bg-slate-300 text-slate-600 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700"}`,children:["+ ",t("participants.add")]}),e.jsx("button",{onClick:()=>B(!0),className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow font-medium",children:t("filters.title")})]}),e.jsx("div",{className:"md:hidden mb-4",children:e.jsxs("button",{onClick:()=>B(!0),className:"w-full px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow font-medium min-h-[48px]",children:["🔍 ",t("filters.title")]})}),e.jsxs("div",{className:"md:bg-white md:rounded-lg md:shadow",children:[e.jsxs("div",{className:"hidden md:block",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsxs("h2",{className:"text-xl font-semibold text-slate-900",children:[t("participants.title")," ",Te<$e&&`(${Te} ${t("participants.of")} ${$e})`]})}),e.jsx("div",{className:"p-4",children:e.jsx(Fs,{participants:ce,onEdit:mt,onDelete:pt,collapsedSections:P,toggleSection:f,expandSection:h,hasActiveFilters:we,onFilterChange:Xt,groupRefreshKey:Y})})]}),e.jsx("div",{className:"md:hidden",children:e.jsx(Vs,{participants:ce,onEdit:mt,onDelete:pt,onSelectionChange:F,collapsedSections:P,toggleSection:f,expandSection:h,hasActiveFilters:we})})]})]}):e.jsx("main",{className:"container mx-auto px-4 py-6",children:e.jsx(x.Suspense,{fallback:e.jsx("div",{className:"text-sm text-slate-500",children:t("common.loading")}),children:e.jsx(ha,{filteredParticipants:ce,entitlement:r,entitlementLoading:o,onSignOut:Zt})})}),e.jsx(Ks,{isOpen:w,onClose:()=>B(!1),searchText:b,onSearchTextChange:y,selectedGroup:j,onSelectedGroupChange:H,statusFilters:W,onStatusFilterChange:Yt,dateRange:re,onDateRangeChange:De,groups:dt,onResetToDefaults:g,visibleCount:Te,totalCount:$e}),e.jsx(Ys,{isOpen:_,onClose:Vt,participant:I}),O==="participants"&&!U&&!k&&e.jsx(ca,{onClick:ut}),e.jsx(ia,{activeTab:O,onTabChange:M})]})})}function ba(){return e.jsx(pa,{children:e.jsx(_s,{children:e.jsx(fa,{})})})}class ga extends x.Component{constructor(){super(...arguments);ve(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(a){return{hasError:!0,error:a}}componentDidCatch(a,r){console.error("Uncaught error:",a,r)}render(){var a;return this.state.hasError?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white shadow-lg rounded-lg p-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"Something went wrong"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"The application encountered an unexpected error. This might be due to a data consistency issue."}),e.jsx("div",{className:"bg-gray-100 p-3 rounded mb-4 overflow-auto max-h-32 text-xs font-mono text-red-800",children:(a=this.state.error)==null?void 0:a.message}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>window.location.reload(),className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition",children:"Reload Application"}),e.jsx("button",{onClick:()=>{window.confirm("Delete all local data and reset? This cannot be undone.")&&(indexedDB.deleteDatabase("CourseManagementDB"),localStorage.clear(),window.location.reload())},className:"flex-1 px-4 py-2 bg-red-100 text-red-700 border border-red-200 rounded hover:bg-red-200 transition",children:"Reset Data"})]})]})}):this.props.children}}const st="2.0.0",Ut="spi.app.version",kt=localStorage.getItem(Ut);if(kt!==st){console.log(`Version changed from '${kt}' to '${st}', clearing localStorage`);const t=["spi.db.initialized","spi.language"],s={};t.forEach(a=>{const r=localStorage.getItem(a);r!==null&&(s[a]=r)}),localStorage.clear(),Object.entries(s).forEach(([a,r])=>{localStorage.setItem(a,r)}),localStorage.setItem(Ut,st),console.log("localStorage cleared, version updated")}rs.createRoot(document.getElementById("root")).render(e.jsx(Dt.StrictMode,{children:e.jsx(ga,{children:e.jsx(ba,{})})}));export{Bt as A,Me as C,aa as L,Le as _,T as a,It as b,Oa as c,D as d,ot as e,Ea as f,de as g,Ia as h,Ae as i,rt as j,Pa as k,qa as l,La as m,Aa as r,Ma as s,na as t,Q as u};
