import{d,r as ft,u as U,f as jt,i as $e,a as A,c as Nt,C as ue,t as vt,A as wt,L as yt,b as St,g as me,e as Ct,m as kt,h as At,_ as Dt,j as Gt,s as Et,k as Tt,l as Pt}from"./index-a4NbmPE3.js";import{r as v,j as e,a as qe}from"./vendor-react-3uLv-P3n.js";import{u as Y}from"./vendor-dexie-mu9yNVYX.js";import{s as pe}from"./fileDownload-0ohKhoX7.js";import{L as _e,i as Wt,E as Ot,j as Mt,T as te,c as Yt,k as $t,I as we,X as ye,P as ge,e as Q,a as be,B as qt,f as fe,b as je,C as Ne,A as Ue,l as Re,d as Rt,R as Ft,H as It,m as Fe,F as Bt,n as Lt,o as Ve,g as _t,p as ve,q as Ie}from"./vendor-icons-QXWXkYnp.js";import"./vendor-dates-Dk0ftcM6.js";import"./vendor-uuid-CtRu48qb.js";import"./vendor-supabase-CXFbbOpx.js";import"./vendor-misc-VdyTtt_u.js";async function Ut(){return d.settings.get(1)}async function Vt(i){await d.settings.update(1,i)}function ze(){return{settings:Y(()=>Ut()),updateSettings:async u=>{await Vt(u)},resetYearlySequence:async()=>{await ft()}}}const ie=1e5,Be=5e4,Le=2e6,zt=16,Kt=12,Ht=256;function Jt(i){if(i==null)return ie;if(typeof i!="number"||!Number.isFinite(i)||!Number.isInteger(i))throw new Error("Invalid backup format: iterations must be a valid integer.");if(i<Be||i>Le)throw new Error(`Invalid backup format: iterations must be between ${Be} and ${Le}.`);return i}function Xt(i){return new TextEncoder().encode(i)}function Zt(i){return new TextDecoder().decode(i)}function xe(i){const m=i instanceof Uint8Array?i:new Uint8Array(i);let r="";const u=m.byteLength,l=8192;for(let o=0;o<u;o+=l)r+=String.fromCharCode.apply(null,m.subarray(o,o+l));return window.btoa(r)}function he(i){const m=window.atob(i),r=m.length,u=new Uint8Array(r);for(let l=0;l<r;l++)u[l]=m.charCodeAt(l);return u}async function Ke(i,m,r=ie){const u=new TextEncoder,l=await window.crypto.subtle.importKey("raw",u.encode(i),{name:"PBKDF2"},!1,["deriveKey"]);return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:m,iterations:r,hash:"SHA-256"},l,{name:"AES-GCM",length:Ht},!1,["encrypt","decrypt"])}async function Qt(i,m){const r=JSON.stringify(i),u=Xt(r),l=window.crypto.getRandomValues(new Uint8Array(zt)),o=window.crypto.getRandomValues(new Uint8Array(Kt)),b=await Ke(m,l,ie),t=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:o},b,u);return{version:1,kdf:"PBKDF2-SHA256",salt:xe(l),iv:xe(o),ciphertext:xe(t),iterations:ie}}async function es(i,m){try{const r=he(i.salt),u=he(i.iv),l=he(i.ciphertext),o=Jt(i.iterations),b=await Ke(m,r,o),t=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:u},b,l),w=Zt(t);return JSON.parse(w)}catch(r){throw console.error("Decryption failed:",r),new Error("Decryption failed. Wrong password or corrupted file.")}}function ts(i){return typeof i=="object"&&i!==null&&"ciphertext"in i&&"salt"in i&&"iv"in i&&"version"in i}const ee=2;function ss(i){console.log("Migrating Backup: v1 -> v2");const m=i.participants.map(u=>{const l={...u};return delete l.groupNumber,delete l.autoGroup,delete l.manualGroup,l}),r=i.groups.map(u=>{const l={...u};return l.status==="planned"&&(l.groupNumber=null),l});return{...i,version:2,participants:m,groups:r}}function rs(i){let m=i.version||1,r=i;if(console.log(`Starting Import. Backup Version: ${m}. Current App Version: ${ee}`),!r||typeof r!="object")throw new Error("Invalid backup file: data is not an object.");if(m>ee)throw new Error(`Backup version ${m} is newer than this app version (${ee}). Please update the app to import this file.`);for(;m<ee;)try{switch(m){case 1:r=ss(r),m=2;break;default:throw new Error(`No migration strategy found for version ${m}`)}}catch(u){throw console.error(`Migration failed at step v${m}:`,u),new Error(`Migration failed: Could not upgrade backup from v${m} to v${m+1}`)}if(!Array.isArray(r.participants)||!Array.isArray(r.groups))throw new Error("Migration finished but result is malformed (missing arrays).");return r}const as=({isOpen:i,mode:m,onConfirm:r,onCancel:u,error:l,isProcessing:o=!1})=>{const{t:b}=U(),[t,w]=v.useState(""),[p,f]=v.useState(!1);return i?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",children:e.jsx("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full overflow-hidden animate-in fade-in zoom-in duration-200",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4 text-slate-800",children:[e.jsx("div",{className:"p-3 bg-blue-100 rounded-full",children:e.jsx(_e,{className:"w-6 h-6 text-blue-600"})}),e.jsx("h3",{className:"text-xl font-bold",children:b(m==="export"?"crypto.exportTitle":"crypto.importTitle")})]}),e.jsx("p",{className:"text-slate-600 mb-6",children:b(m==="export"?"crypto.exportDescription":"crypto.importDescription")}),e.jsxs("form",{onSubmit:k=>{k.preventDefault(),t&&r(t)},className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:p?"text":"password",value:t,onChange:k=>w(k.target.value),placeholder:b("crypto.passwordPlaceholder"),className:"w-full px-4 py-3 pr-12 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",autoFocus:!0,disabled:o}),e.jsx("button",{type:"button",onClick:()=>f(!p),className:"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600",tabIndex:-1,children:p?e.jsx(Wt,{size:20}):e.jsx(Ot,{size:20})})]}),l&&e.jsxs("div",{className:"p-3 bg-red-50 text-red-600 text-sm rounded-lg flex items-center gap-2 animate-pulse",children:[e.jsx("span",{children:"âš ï¸"})," ",l]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{type:"button",onClick:u,disabled:o,className:"flex-1 px-4 py-2 text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg font-medium transition-colors",children:b("common.cancel")}),e.jsxs("button",{type:"submit",disabled:!t||o,className:"flex-1 px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg font-bold shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2",children:[o&&e.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),b(m==="export"?"crypto.encryptAndExport":"crypto.decryptAndImport")]})]})]})]})})}):null},os=({isOpen:i,onClose:m,entitlement:r,entitlementLoading:u=!1,onSignOut:l})=>{const{t:o,language:b}=U();if(!i)return null;const t="2.0.0",w="2026-02-13",p=c=>jt(c,b==="bg"?"bg-BG":"en-GB","Europe/Sofia",o("tools.notAvailable")),f=(()=>{const c=(r==null?void 0:r.status)??"unknown";return o(c==="active"?"tools.subscriptionStatusActive":c==="grace"?"tools.subscriptionStatusGrace":c==="expired"?"tools.subscriptionStatusExpired":"tools.subscriptionStatusUnknown")})(),k=(()=>{const c=(r==null?void 0:r.status)??"unknown";return c==="active"?"text-emerald-700 bg-emerald-50 border-emerald-200":c==="grace"?"text-amber-800 bg-amber-50 border-amber-200":c==="expired"?"text-red-700 bg-red-50 border-red-200":"text-slate-700 bg-slate-50 border-slate-200"})(),y=(()=>{const c=(r==null?void 0:r.status)??"unknown";return c==="active"?Mt:c==="grace"?te:c==="expired"?Yt:$t})(),N=(()=>{var j;const c=(j=r==null?void 0:r.planCode)==null?void 0:j.trim().toLowerCase();return c?c==="montly"||c==="monthy"||c.startsWith("mon")?"monthly":c.startsWith("year")?"yearly":c:null})(),D=N?N==="monthly"?o("tools.planMonthly"):N==="yearly"?o("tools.planYearly"):N:o("tools.notAvailable"),$=(r==null?void 0:r.status)==="expired"?"text-red-700":(r==null?void 0:r.status)==="grace"?"text-amber-800":"text-slate-900";return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-6 h-6 text-blue-600",strokeWidth:2}),e.jsx("h3",{className:"text-xl font-bold text-slate-900",children:o("about.title")})]}),e.jsx("button",{onClick:m,className:"p-2 hover:bg-slate-100 rounded-lg transition-colors",children:e.jsx(ye,{className:"w-6 h-6",strokeWidth:2})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-center py-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-blue-600",children:"CERTIFY"}),e.jsx("p",{className:"text-sm text-slate-600 mt-1",children:o("about.subtitle")})]}),e.jsxs("div",{className:"bg-slate-50 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ge,{className:"w-5 h-5 text-slate-600",strokeWidth:2}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-slate-700",children:o("about.version")}),e.jsx("div",{className:"text-lg font-bold text-slate-900",children:t})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Q,{className:"w-5 h-5 text-slate-600",strokeWidth:2}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-slate-700",children:o("about.buildDate")}),e.jsx("div",{className:"text-sm text-slate-900",children:p(w)})]})]}),(r==null?void 0:r.configured)&&r.authenticated&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"border-t border-slate-200 pt-3",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-700 mb-2",children:o("tools.subscriptionAccount")}),e.jsxs("div",{className:"space-y-1.5 text-sm text-slate-700",children:[e.jsxs("p",{className:"flex items-center gap-1.5",children:[e.jsxs("strong",{children:[o("tools.subscriptionStatus"),":"]})," ",e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded-md border font-semibold ${k}`,children:[e.jsx(y,{className:"w-3.5 h-3.5",strokeWidth:2.5}),f]})]}),e.jsxs("p",{className:`flex items-center gap-1.5 ${$}`,children:[e.jsx(be,{className:"w-4 h-4",strokeWidth:2}),e.jsxs("span",{children:[e.jsxs("strong",{children:[o("tools.subscriptionEndsAt"),":"]})," ",p(r.currentPeriodEnd)]})]}),r.status==="grace"&&e.jsxs("p",{className:"text-amber-800 flex items-center gap-1.5",children:[e.jsx(te,{className:"w-4 h-4",strokeWidth:2}),e.jsxs("span",{children:[e.jsxs("strong",{children:[o("tools.graceUntil"),":"]})," ",p(r.graceUntil)]})]}),e.jsxs("p",{className:"flex items-center gap-1.5",children:[e.jsx(qt,{className:"w-4 h-4 text-slate-500",strokeWidth:2}),e.jsxs("span",{children:[e.jsxs("strong",{children:[o("tools.subscriptionPlan"),":"]})," ",D]})]}),u&&e.jsx("p",{className:"text-slate-500",children:o("common.loading")})]})]})})]}),e.jsxs("div",{className:"border-t border-slate-200 pt-4",children:[e.jsx("h4",{className:"text-sm font-semibold text-slate-700 mb-3",children:o("about.features")}),e.jsxs("div",{className:"space-y-2 text-sm text-slate-600",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(fe,{className:"w-4 h-4 mt-0.5 text-blue-600",strokeWidth:2}),e.jsx("span",{children:o("about.feature1")})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(je,{className:"w-4 h-4 mt-0.5 text-blue-600",strokeWidth:2}),e.jsx("span",{children:o("about.feature2")})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ge,{className:"w-4 h-4 mt-0.5 text-blue-600",strokeWidth:2}),e.jsx("span",{children:o("about.feature3")})]})]})]}),e.jsx("div",{className:"border-t border-slate-200 pt-4",children:e.jsx("p",{className:"text-xs text-center text-slate-500",children:o("about.footer")})})]}),e.jsxs("div",{className:"mt-6 flex gap-3",children:[(r==null?void 0:r.configured)&&r.authenticated&&e.jsx("button",{onClick:()=>void(l==null?void 0:l()),className:"px-4 py-3 rounded-lg border border-slate-300 bg-white text-slate-700 hover:bg-slate-50 font-medium transition-colors",children:o("auth.signOut")}),e.jsx("button",{onClick:m,className:"flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors",children:o("common.close")})]})]})})},js=({filteredParticipants:i,entitlement:m,entitlementLoading:r=!1,onSignOut:u})=>{var Oe;const{settings:l}=ze(),{language:o,setLanguage:b,t}=U(),[w,p]=v.useState(!1),[f,k]=v.useState(!1),[y,N]=v.useState(null),[D,$]=v.useState(null),c=(s,a,n="info")=>{N({isOpen:!0,title:s,message:a,variant:n})},j=(s,a,n,x="info",S)=>{$({isOpen:!0,title:s,message:a,onConfirm:n,variant:x,confirmText:t("common.confirm")})},[F,J]=v.useState(!1),[Se,Ce]=v.useState(""),[ke,V]=v.useState(0),[I,se]=v.useState(null),[re,He]=v.useState(!1),[Ae,X]=v.useState(!1),[Je,Z]=v.useState(""),[De,Ge]=v.useState(!1),[B,ce]=v.useState(null),[Xe,Ee]=v.useState(!1),[q,R]=v.useState({isOpen:!1,mode:"export",isProcessing:!1}),[ae,oe]=v.useState(null),[ne,Ze]=v.useState($e()),[Qe,le]=v.useState(!1),[G,z]=v.useState({date:"",status:"planned"}),et=()=>{oe(null),Ze($e()),ae==="setup"?c(t("common.success"),t("security.setupSuccess"),"success"):ae==="disable"&&c(t("common.success"),t("security.disableSuccess"),"info")},O=Y(()=>me(),[]),de=Y(()=>Tt(),[ke]),K=Y(()=>Pt(),[ke]),H=Y(()=>d.participants.toArray(),[]),tt=Y(()=>d.yearlyArchives.toArray(),[]),Te=s=>t(s===1?"group.participant_one":"group.participant_other"),Pe=async(s,a)=>{try{console.log("Validating and migrating backup...");const n=rs(s);if(!n.groups||!n.participants||!Array.isArray(n.groups)||!Array.isArray(n.participants))throw new Error("Invalid backup format after migration: missing groups or participants arrays");a==="replace"?await d.transaction("rw",[d.participants,d.groups,d.settings],async()=>{await d.participants.clear(),await d.groups.clear(),n.groups.length>0&&await d.groups.bulkAdd(n.groups),n.participants.length>0&&await d.participants.bulkAdd(n.participants),n.settings&&await d.settings.update(1,n.settings)}):await d.transaction("rw",[d.participants,d.groups,d.settings],async()=>{n.groups.length>0&&await d.groups.bulkPut(n.groups);for(const x of n.participants)if(await d.participants.get(x.id))await d.participants.update(x.id,x);else{let P=x.uniqueNumber,E=0;for(;!await Gt(P)&&E<1e3;){const g=await d.settings.get(1);if(g){const W=g.lastUniquePrefix+1,T=g.lastUniqueSeq+1;P=`${W.toString().padStart(4,"0")}-${T.toString().padStart(3,"0")}`,await d.settings.update(1,{lastUniquePrefix:W,lastUniqueSeq:T})}E++}await d.participants.add({...x,uniqueNumber:P})}}),c(t("common.success"),t("import.success",{participants:String(n.participants.length),groups:String(n.groups.length)}),"success")}catch(n){console.error("Import processing failed:",n),c(t("common.error"),`${t("import.failed")}: ${n.message}`,"error")}finally{p(!1),R(n=>({...n,isOpen:!1,isProcessing:!1,pendingEncryptedData:null,pendingFile:null}))}},st=()=>{R({isOpen:!0,mode:"export",isProcessing:!1})},rt=async s=>{R(a=>({...a,isProcessing:!0,error:void 0}));try{const a=await d.participants.toArray(),n=await d.groups.toArray(),x=await d.settings.get(1),S={version:ee.toString(),timestamp:new Date().toISOString(),participants:a,groups:n,settings:x},P=await Qt(S,s),E=new Blob([JSON.stringify(P,null,2)],{type:"application/json"}),g=`course-backup-secure-${new Date().toISOString().split("T")[0]}.json`;await pe(E,g),R(W=>({...W,isOpen:!1}))}catch(a){console.error("Secure export failed:",a),R(n=>({...n,error:t("crypto.encryptionFailed")}))}finally{R(a=>({...a,isProcessing:!1}))}},We=async(s,a)=>{const n=async()=>{p(!0);try{const x=await s.text(),S=JSON.parse(x);ts(S)||S&&typeof S=="object"&&"ciphertext"in S&&"salt"in S?(R({isOpen:!0,mode:"import",isProcessing:!1,pendingEncryptedData:S,importMode:a,pendingFile:s}),p(!1)):await Pe(S,a)}catch(x){console.error("File parsing failed:",x),c(t("common.error"),t("tools.invalidBackupFormat"),"error"),p(!1)}};a==="replace"?j(t("common.warning"),t("tools.importReplaceWarning"),n,"danger"):n()},at=async s=>{if(!(!q.pendingEncryptedData||!q.importMode)){R(a=>({...a,isProcessing:!0,error:void 0})),p(!0);try{const a=await es(q.pendingEncryptedData,s);await Pe(a,q.importMode)}catch(a){console.error("Decryption failed:",a),R(n=>({...n,isProcessing:!1,error:t("crypto.invalidPassword")})),p(!1)}}},ot=async()=>{try{const s=await Dt(()=>import("./vendor-xlsx-D_0l8YDs.js"),[]),a=await d.groups.toArray(),n=i.length>0?i:await d.participants.toArray(),x=new Map,S=new Map;a.forEach(h=>{x.set(h.courseStartDate,h.status),S.set(h.courseStartDate,h.groupNumber)});const P=[],E=[],g=[],W=[],T=h=>({"Company Name":h.companyName,"Person Name":h.personName,"Medical Date":A(h.medicalDate),"Course Start":A(h.courseStartDate),"Course End":A(h.courseEndDate),"Group No":S.get(h.courseStartDate)||"","Unique Number":h.uniqueNumber,Sent:h.sent?"Yes":"No",Documents:h.documents?"Yes":"No","Handed Over":h.handedOver?"Yes":"No",Paid:h.paid?"Yes":"No",Completed:(h.completedOverride!==null?h.completedOverride:h.completedComputed)?"Yes":"No"});n.forEach(h=>{const M=x.get(h.courseStartDate),_=T(h);M==="active"?P.push(_):M==="planned"?E.push(_):M==="completed"?g.push(_):W.push(_)});const L=s.utils.book_new(),C=(h,M,_)=>{if(h.length===0)return;_&&h.sort(_);const Ye=s.utils.json_to_sheet(h),gt=Object.keys(h[0]||{}).map(bt=>({wch:Math.max(bt.length,15)}));Ye["!cols"]=gt,s.utils.book_append_sheet(L,Ye,M)};if(C(P,"Active Groups",(h,M)=>(h["Unique Number"]||"").localeCompare(M["Unique Number"]||"")),C(E,"Planned Groups",(h,M)=>h["Course Start"].localeCompare(M["Course Start"])),C(g,"Archived Groups",(h,M)=>(M["Group No"]||0)-(h["Group No"]||0)),C(W,"Other"),L.SheetNames.length===0){const h=s.utils.json_to_sheet([{Info:"No data found to export"}]);s.utils.book_append_sheet(L,h,"Empty")}const Me=s.write(L,{bookType:"xlsx",type:"array"}),xt=new Blob([Me],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),ht=`course-export-${new Date().toISOString().split("T")[0]}.xlsx`;await pe(xt,ht)}catch(s){console.error("Excel export failed:",s),c(t("common.error"),t("export.failedExcel"),"error")}},nt=async()=>{try{const s=["Company Name","Person Name","Medical Date","Course Start Date","Course End Date","Group Number","Unique Number","Sent","Documents","Handed Over","Paid","Completed"],a=i.length>0?await d.groups.toArray():[],n=new Map(a.map(g=>[g.courseStartDate,g.groupNumber])),x=i.map(g=>[g.companyName,g.personName,A(g.medicalDate),A(g.courseStartDate),A(g.courseEndDate),n.get(g.courseStartDate)||"",g.uniqueNumber,g.sent?"Yes":"No",g.documents?"Yes":"No",g.handedOver?"Yes":"No",g.paid?"Yes":"No",(g.completedOverride!==null?g.completedOverride:g.completedComputed)?"Yes":"No"]),S=[s.join(","),...x.map(g=>g.map(W=>`"${W}"`).join(","))].join(`
`),P=new Blob([S],{type:"text/csv"}),E=`course-export-${new Date().toISOString().split("T")[0]}.csv`;await pe(P,E)}catch(s){console.error("CSV export failed:",s),c(t("common.error"),t("export.failedCSV"),"error")}},lt=async(s,a)=>{try{const n=`archive-${s}`,x=await d.yearlyArchives.get(n);if(!x){c(t("common.error"),t("tools.restoreGroupNotFound"),"error");return}const S=x.groups.find(T=>T.groupNumber===a);if(!S){c(t("common.error"),t("tools.restoreGroupGroupNotFound"),"error");return}const P=x.participants.filter(T=>T.courseStartDate===S.courseStartDate);if(await d.groups.where("groupNumber").equals(a).first()){c(t("common.error"),t("tools.restoreGroupExists",{number:a.toString()}),"error");return}await d.groups.add({...S,updatedAt:new Date().toISOString()});for(const T of P)await d.participants.add(T);const g=x.groups.filter(T=>T.groupNumber!==a),W=x.participants.filter(T=>T.courseStartDate!==S.courseStartDate);g.length===0?await d.yearlyArchives.delete(n):await d.yearlyArchives.update(n,{groups:g,participants:W}),c(t("common.success"),t("tools.restoreGroupSuccess",{number:a.toString()}),"success"),ce(null)}catch(n){console.error("Restore failed:",n),c(t("common.error"),t("tools.restoreGroupError",{error:n.message}),"error")}},it=async()=>{try{const s=new Date().getFullYear(),a=await d.groups.toArray(),n=await d.participants.toArray(),x=a.some(C=>C.status==="active"),S=new Set(n.map(C=>C.courseStartDate)),P=a.filter(C=>C.status==="planned").some(C=>S.has(C.courseStartDate));if(x||P){c(t("common.warning"),t("tools.archiveGuardFail"),"warning"),X(!1),Z("");return}const E=a.filter(C=>C.status!=="completed"?!1:new Date(C.courseStartDate).getFullYear()===s);if(E.length===0){c(t("common.info"),t("archive.noGroupsToArchive"),"info"),X(!1),Z("");return}const g=new Set(E.map(C=>C.courseStartDate)),W=n.filter(C=>g.has(C.courseStartDate)),T=`archive-${s}`;await d.yearlyArchives.put({id:T,year:s,groups:E,participants:W,archivedAt:new Date().toISOString()}),await d.groups.bulkDelete(E.map(C=>C.id)),await d.participants.bulkDelete(W.map(C=>C.id));const L=await d.settings.get(1);L&&await d.settings.update(1,{lastUniquePrefix:L.lastUniquePrefix+1,lastUniqueSeq:0,lastResetYear:s}),c(t("common.success"),t("tools.archiveYearSuccess",{count:E.length.toString()}),"success"),X(!1),Z("")}catch(s){console.error("Archive failed:",s),c(t("common.error"),t("archive.error"),"error")}},ct=async s=>{try{const a=await kt(s);if(a.needsConfirm&&a.currentActive){const n=await d.groups.get(s);n&&se({type:"makeActive",groupId:s,groupNumber:n.groupNumber,currentActive:a.currentActive})}else if(a.success){V(x=>x+1);const n=await d.groups.get(s);n&&c(t("common.success"),t("tools.makeActiveSuccess",{number:n.groupNumber?n.groupNumber.toString():"Active"}),"success")}}catch(a){c(t("common.error"),`${t("common.error")}: ${a.message}`,"error")}},dt=async s=>{try{const a=await At(s);if(a.needsConfirm&&a.currentActive){const n=await d.groups.get(s);n&&se({type:"reopen",groupId:s,groupNumber:n.groupNumber,currentActive:a.currentActive})}else a.success&&(V(n=>n+1),c(t("common.success"),t("tools.reopenSuccess"),"success"))}catch(a){c(t("common.error"),`${t("common.error")}: ${a.message}`,"error")}},ut=async()=>{if(I)try{const s=I.currentActive.groupNumber,a=I.groupNumber;await St(I.groupId,!0),se(null),V(n=>n+1),c(t("common.success"),t("tools.makeActiveWithSwapSuccess",{new:(a==null?void 0:a.toString())||"Active",old:(s==null?void 0:s.toString())||"Active"}),"success")}catch(s){c(t("common.error"),`${t("common.error")}: ${s.message}`,"error")}},mt=async()=>{j(t("tools.returnToPlanned"),t("tools.returnToPlannedConfirm"),async()=>{try{await Et(),V(s=>s+1),c(t("common.success"),t("tools.returnToPlannedSuccess"),"success")}catch(s){c(t("common.error"),`${t("common.error")}: ${s.message}`,"error")}},"warning")},pt=async()=>{try{if(!G.date){c(t("common.error"),t("tools.createGroupSelectDate"),"error");return}if(new Date(G.date).getDay()!==1){c(t("common.error"),t("tools.createGroupMustBeMonday"),"error");return}const a=await d.groups.where("courseStartDate").equals(G.date).first();if(a){const x=a.status==="active"?t("tools.createGroupExistsActive"):a.status==="planned"?t("tools.createGroupExistsPlanned"):t("tools.createGroupExistsCompleted");c(t("common.error"),x.replace("{date}",A(G.date)),"error");return}if(G.status==="active"&&await me()){c(t("common.warning"),t("tools.createGroupActiveExists"),"warning");return}if(G.status==="planned"){const x=await me();if(x&&G.date<x.courseStartDate){c(t("common.warning"),t("tools.createGroupBeforeActive"),"warning");return}}await Ct(G.date,G.status),le(!1),z({date:"",status:"planned"}),V(x=>x+1);const n=G.status==="active"?t("tools.groupActive"):t("tools.groupPlanned");c(t("common.success"),t("tools.createGroupSuccess",{status:n,date:A(G.date)}),"success")}catch(s){console.error("Failed to create group:",s),c(t("common.error"),t("tools.createGroupFailed",{error:s.message}),"error")}};return e.jsxs("div",{className:"space-y-6 pb-24 md:pb-6",children:[e.jsx(as,{isOpen:q.isOpen,mode:q.mode,isProcessing:q.isProcessing,error:q.error,onCancel:()=>R(s=>({...s,isOpen:!1})),onConfirm:s=>{q.mode==="export"?rt(s):at(s)}}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 mb-4",children:t("tools.language")}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("button",{onClick:()=>b("en"),className:`flex-1 px-6 py-3 rounded-lg font-medium min-h-[48px] transition-colors duration-150 flex items-center justify-center gap-3 ${o==="en"?"bg-blue-600 text-white":"bg-slate-100 text-slate-700 hover:bg-slate-200"}`,children:[e.jsx(qe,{countryCode:"GB",svg:!0,style:{width:"2em",height:"1.5em",borderRadius:"4px"}}),"English"]}),e.jsxs("button",{onClick:()=>b("bg"),className:`flex-1 px-6 py-3 rounded-lg font-medium min-h-[48px] transition-colors duration-150 flex items-center justify-center gap-3 ${o==="bg"?"bg-blue-600 text-white":"bg-slate-100 text-slate-700 hover:bg-slate-200"}`,children:[e.jsx(qe,{countryCode:"BG",svg:!0,style:{width:"2em",height:"1.5em",borderRadius:"4px"}}),"Ð‘ÑŠÐ»Ð³Ð°Ñ€ÑÐºÐ¸"]})]})]}),O&&e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border-2 border-blue-400",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(je,{className:"w-5 h-5 text-blue-600",strokeWidth:2}),e.jsx("h3",{className:"text-lg font-bold text-blue-700",children:t("tools.activeGroup")})]}),e.jsx("p",{className:"text-sm text-blue-600 mt-0.5",children:t("tools.activeGroupSubtitle")})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-4 mb-4",children:e.jsxs("div",{className:"space-y-2 text-sm text-slate-700",children:[e.jsxs("p",{children:[e.jsxs("strong",{children:[t("tools.groupNumber"),":"]})," ",O.groupNumber||e.jsx("span",{className:"italic text-slate-500",children:t("tools.pendingAssignedOnClose")})]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[t("tools.courseStart"),":"]})," ",A(O.courseStartDate)]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[t("tools.courseEnd"),":"]})," ",A(O.courseEndDate)]})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer min-h-[44px]",children:[e.jsx("input",{type:"checkbox",checked:F,onChange:s=>J(s.target.checked),className:"mt-1 w-5 h-5 text-blue-600 rounded border-slate-300 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-slate-700 flex-1",children:t("tools.closeGroupDescription")})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:[t("tools.typeToConfirm",{text:O.groupNumber?`CLOSE-${O.groupNumber}`:"CLOSE"}),": ",e.jsx("code",{className:"bg-slate-200 px-2 py-1 rounded",children:O.groupNumber?`CLOSE-${O.groupNumber}`:"CLOSE"})]}),e.jsx("input",{type:"text",value:Se,onChange:s=>Ce(s.target.value),placeholder:O.groupNumber?`CLOSE-${O.groupNumber}`:"CLOSE",className:"w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 min-h-[44px]",disabled:!F})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{onClick:mt,className:"px-6 py-4 bg-slate-600 text-white rounded-lg hover:bg-slate-700 font-bold min-h-[48px] transition-colors duration-150",children:["â† ",t("tools.returnToPlanned")]}),e.jsxs("button",{onClick:async()=>{try{await Nt(),J(!1),Ce(""),V(s=>s+1),c(t("common.success"),t("tools.closeActiveSuccess"),"success")}catch(s){console.error("Failed to close active group:",s),c(t("common.error"),`${t("common.error")}: ${s.message}`,"error")}},disabled:!F||Se!==(O.groupNumber?`CLOSE-${O.groupNumber}`:"CLOSE"),className:"px-6 py-4 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed font-bold min-h-[48px] transition-colors duration-150",children:["âœ“ ",t("tools.archiveGroup")]})]})]})]}),I&&e.jsx(ue,{isOpen:!0,title:t("tools.changeActiveGroup"),message:t("tools.changeActiveGroupMessage",{current:(I.currentActive.groupNumber||"Active").toString(),new:(I.groupNumber||"Active").toString()}),confirmText:t("tools.changeActiveGroupConfirm"),cancelText:t("common.cancel"),onConfirm:ut,onClose:()=>se(null)}),Qe&&e.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-2xl max-w-md w-full p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-xl font-bold text-slate-900",children:t("tools.createNewGroup")}),e.jsx("button",{onClick:()=>{le(!1),z({date:"",status:"planned"})},className:"text-slate-400 hover:text-slate-600 transition-colors",children:e.jsx(ye,{className:"w-6 h-6"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:t("tools.courseStartDateMonday")}),e.jsx("input",{type:"date",value:G.date,onChange:s=>z(a=>({...a,date:s.target.value})),className:"w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:t("tools.groupStatus")}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("button",{onClick:()=>z(s=>({...s,status:"planned"})),className:`px-4 py-3 rounded-lg font-medium transition-all flex items-center justify-center gap-2 ${G.status==="planned"?"bg-amber-600 text-white ring-2 ring-amber-300":"bg-slate-100 text-slate-700 hover:bg-slate-200"}`,children:[e.jsx(be,{className:"w-5 h-5",strokeWidth:2}),t("tools.groupPlanned")]}),e.jsxs("button",{onClick:()=>z(s=>({...s,status:"active"})),className:`px-4 py-3 rounded-lg font-medium transition-all flex items-center justify-center gap-2 ${G.status==="active"?"bg-green-600 text-white ring-2 ring-green-300":"bg-slate-100 text-slate-700 hover:bg-slate-200"}`,children:[e.jsx(je,{className:"w-5 h-5",strokeWidth:2}),t("tools.groupActive")]})]})]}),G.status==="active"&&O&&e.jsxs("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800",children:[e.jsx(te,{className:"w-4 h-4 inline mr-1"}),t("tools.createGroupActiveWarning")]})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:()=>{le(!1),z({date:"",status:"planned"})},className:"flex-1 px-4 py-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 font-medium transition-colors",children:t("common.cancel")}),e.jsx("button",{onClick:pt,disabled:!G.date,className:"flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium transition-colors",children:t("tools.createGroup")})]})]})}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg shadow-sm border-2 border-blue-200",children:e.jsxs("div",{className:"flex flex-col md:flex-row items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Q,{className:"w-5 h-5 text-blue-600",strokeWidth:2}),e.jsx("h3",{className:"text-lg font-bold text-blue-700",children:t("tools.manualGroupCreation")})]}),e.jsx("p",{className:"text-sm text-blue-600",children:t("tools.manualGroupCreationSubtitle")})]}),e.jsxs("button",{onClick:()=>le(!0),className:"w-full md:w-auto px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 hover:shadow-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 md:whitespace-nowrap",children:[e.jsx(Q,{className:"w-5 h-5",strokeWidth:2}),t("tools.newGroup")]})]})}),de&&de.length>0&&e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border-2 border-amber-300",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(be,{className:"w-5 h-5 text-amber-600",strokeWidth:2}),e.jsx("h3",{className:"text-lg font-bold text-amber-700",children:t("tools.plannedGroups")})]}),e.jsx("p",{className:"text-sm text-amber-600 mt-0.5 ml-7",children:t("tools.plannedGroupsSubtitle")})]}),e.jsx("div",{className:"space-y-3",children:de.map(s=>{const a=(H==null?void 0:H.filter(n=>n.courseStartDate===s.courseStartDate).length)||0;return e.jsx("div",{className:"border border-amber-200 rounded-lg p-4 bg-amber-50 hover:shadow-md hover:border-amber-300 transition-all duration-200",children:e.jsxs("div",{className:"flex items-start justify-between gap-2 sm:gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("h4",{className:"font-semibold text-amber-900",children:[t("group.number")," ",s.groupNumber]}),e.jsx("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-800 text-xs font-medium rounded-full",children:t("group.planned")})]}),e.jsxs("div",{className:"text-sm text-amber-800 space-y-1",children:[e.jsxs("p",{className:"flex items-center gap-1",children:[e.jsx(Q,{className:"w-4 h-4",strokeWidth:2}),A(s.courseStartDate)," - ",A(s.courseEndDate)]}),e.jsxs("p",{className:"flex items-center gap-1",children:[e.jsx(fe,{className:"w-4 h-4",strokeWidth:2}),a," ",Te(a)]})]})]}),e.jsx("div",{className:"flex flex-col gap-2",children:e.jsxs("button",{onClick:()=>ct(s.id),className:"px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 hover:shadow-lg text-sm font-medium transition-all duration-200 flex items-center gap-2",children:[e.jsx(Ne,{className:"w-4 h-4 shrink-0",strokeWidth:2}),e.jsx("span",{children:t("tools.makeActive")})]})})]})},s.id)})})]}),K&&K.length>0&&e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border-2 border-slate-300",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ue,{className:"w-5 h-5 text-slate-600",strokeWidth:2}),e.jsx("h3",{className:"text-lg font-bold text-slate-700",children:t("tools.archiveCompleted")}),e.jsxs("span",{className:"text-sm text-slate-500",children:["(",K.length,")"]})]}),e.jsx("p",{className:"text-sm text-slate-600 mt-0.5 ml-7",children:t("tools.completedCourses")})]}),K.length>2&&e.jsxs("button",{onClick:()=>He(!re),className:"flex items-center gap-2 px-3 py-1.5 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors",children:[t(re?"tools.hide":"tools.showAll"),e.jsx(Re,{className:`w-4 h-4 transition-transform ${re?"rotate-180":""}`,strokeWidth:2})]})]}),e.jsx("div",{className:"space-y-3",children:(re?K:K.slice(0,2)).map(s=>{const a=(H==null?void 0:H.filter(n=>n.courseStartDate===s.courseStartDate).length)||0;return e.jsx("div",{className:"border border-slate-300 rounded-lg p-4 bg-slate-50 hover:shadow-md hover:border-slate-400 transition-all duration-200",children:e.jsxs("div",{className:"flex items-start justify-between gap-2 sm:gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("h4",{className:"font-semibold text-slate-800",children:[t("group.number")," ",s.groupNumber]}),e.jsx("span",{className:"px-2 py-0.5 bg-slate-200 text-slate-700 text-xs font-medium rounded-full",children:t("group.completed")})]}),e.jsxs("div",{className:"text-sm text-slate-600 space-y-1",children:[e.jsxs("p",{className:"flex items-center gap-1",children:[e.jsx(Q,{className:"w-4 h-4",strokeWidth:2}),A(s.courseStartDate)," - ",A(s.courseEndDate)]}),e.jsxs("p",{className:"flex items-center gap-1",children:[e.jsx(fe,{className:"w-4 h-4",strokeWidth:2}),a," ",Te(a)]}),s.closedAt&&e.jsxs("p",{className:"flex items-center gap-1 text-xs text-slate-500",children:[e.jsx(Rt,{className:"w-3.5 h-3.5",strokeWidth:2}),t("tools.completedOn"),": ",A(s.closedAt.split("T")[0])," ",new Date(s.closedAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})]})]})]}),e.jsx("div",{className:"flex flex-col gap-2",children:e.jsxs("button",{onClick:()=>dt(s.id),className:"px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 hover:shadow-lg text-sm font-medium transition-all duration-200 flex items-center gap-2",children:[e.jsx(Ft,{className:"w-4 h-4 shrink-0",strokeWidth:2}),e.jsx("span",{children:t("tools.reopenForEdits")})]})})]})},s.id)})})]}),l&&e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(It,{className:"w-5 h-5 text-blue-600",strokeWidth:2}),e.jsx("h3",{className:"text-lg font-bold text-blue-600",children:t("tools.currentSequence")})]}),e.jsxs("div",{className:"text-sm text-slate-700 space-y-1",children:[e.jsxs("p",{children:[e.jsxs("strong",{children:[t("tools.prefix"),":"]})," ",l.lastUniquePrefix]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[t("tools.sequence"),":"]})," ",l.lastUniqueSeq]}),l.lastResetYear&&e.jsxs("p",{children:[e.jsxs("strong",{children:[t("tools.lastReset"),":"]})," ",l.lastResetYear]})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Fe,{className:"w-5 h-5 text-emerald-600",strokeWidth:2}),e.jsx("h3",{className:"text-lg font-bold text-emerald-600",children:t("tools.exportData")})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{onClick:st,className:"w-full px-6 py-4 bg-blue-100 text-blue-800 border border-blue-300 rounded-lg hover:bg-blue-200 hover:border-blue-400 font-medium min-h-[48px] transition-all duration-150 flex items-center justify-center gap-2",children:[e.jsx(ge,{className:"w-5 h-5",strokeWidth:2}),t("tools.exportFullBackup")]}),e.jsxs("button",{onClick:ot,className:"w-full px-6 py-4 bg-emerald-100 text-emerald-800 border border-emerald-300 rounded-lg hover:bg-emerald-200 hover:border-emerald-400 font-medium min-h-[48px] transition-all duration-150 flex items-center justify-center gap-2",children:[e.jsx(Bt,{className:"w-5 h-5",strokeWidth:2}),t("tools.exportExcel")]}),e.jsxs("button",{onClick:nt,className:"w-full px-6 py-4 bg-slate-100 text-slate-800 border border-slate-300 rounded-lg hover:bg-slate-200 hover:border-slate-400 font-medium min-h-[48px] transition-all duration-150 flex items-center justify-center gap-2",children:[e.jsx(Lt,{className:"w-5 h-5",strokeWidth:2}),t("tools.exportCSV")]})]}),e.jsx("p",{className:"text-xs text-slate-500 mt-3",children:t("tools.exportNote")})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Ve,{className:"w-5 h-5 text-blue-600",strokeWidth:2}),e.jsx("h3",{className:"text-lg font-bold text-blue-600",children:t("tools.importData")})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"w-full px-6 py-4 bg-blue-100 text-blue-800 border border-blue-300 rounded-lg hover:bg-blue-200 hover:border-blue-400 cursor-pointer text-center font-medium min-h-[48px] transition-all duration-150 flex items-center justify-center gap-2",children:[e.jsx(Fe,{className:"w-5 h-5",strokeWidth:2}),t("tools.importMerge"),e.jsx("input",{type:"file",accept:".json",onChange:s=>{var a;(a=s.target.files)!=null&&a[0]&&(We(s.target.files[0],"merge"),s.target.value="")},className:"hidden",disabled:w})]}),e.jsxs("label",{className:"w-full px-6 py-4 bg-amber-100 text-amber-800 border border-amber-300 rounded-lg hover:bg-amber-200 hover:border-amber-400 cursor-pointer text-center font-medium min-h-[48px] transition-all duration-150 flex items-center justify-center gap-2",children:[e.jsx(te,{className:"w-5 h-5",strokeWidth:2}),t("tools.importReplace"),e.jsx("input",{type:"file",accept:".json",onChange:s=>{var a;(a=s.target.files)!=null&&a[0]&&(We(s.target.files[0],"replace"),s.target.value="")},className:"hidden",disabled:w})]})]}),e.jsxs("p",{className:"text-xs text-slate-500 mt-3",children:[t("tools.importMergeNote")," ",e.jsx("br",{}),e.jsx("span",{className:"text-amber-600 font-semibold",children:t("tools.importReplaceWarning")})]}),w&&!q.isOpen&&e.jsx("div",{className:"text-center mt-4 text-blue-600 font-medium animate-pulse",children:"Processing..."})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200 mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(_e,{className:"w-5 h-5 text-amber-600",strokeWidth:2}),e.jsx("h3",{className:"text-lg font-bold text-amber-600",children:t("security.title")})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("h4",{className:"font-semibold text-slate-700",children:t(ne?"security.enabled":"security.disabled")}),ne&&e.jsx("span",{className:"text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded font-medium",children:t("security.active")})]}),e.jsx("p",{className:"text-sm text-slate-500 max-w-md",children:t(ne?"security.descriptionEnabled":"security.descriptionDisabled")})]}),e.jsx("div",{className:"flex flex-col gap-2",children:ne?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>vt(),className:"px-4 py-2 bg-slate-800 text-white hover:bg-slate-900 rounded-lg text-sm font-medium transition-colors shadow-sm",children:t("security.lockNow")}),e.jsx("button",{onClick:()=>oe("disable"),className:"px-4 py-2 text-red-600 hover:bg-red-50 border border-red-200 rounded-lg text-sm font-medium transition-colors",children:t("security.disable")})]}):e.jsx("button",{onClick:()=>oe("setup"),className:"px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg text-sm font-medium transition-colors shadow-sm",children:t("security.setPin")})})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md border-2 border-orange-200",children:[e.jsxs("button",{onClick:()=>k(!f),className:"w-full flex items-center justify-between py-2 min-h-[44px]",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_t,{className:"w-5 h-5 text-orange-600",strokeWidth:2}),e.jsx("h3",{className:"text-lg font-bold text-orange-600",children:t("tools.advancedSettings")})]}),e.jsx(Re,{className:`w-6 h-6 transition-transform ${f?"rotate-180":""}`,strokeWidth:2})]}),f&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-orange-200 space-y-6",children:[e.jsx(ns,{onArchive:()=>X(!0),onViewArchives:()=>Ge(!0)}),e.jsx(cs,{showAlert:c})]})]}),e.jsx("div",{className:"bg-white p-6 rounded-lg shadow-md border-2 border-blue-200",children:e.jsxs("button",{onClick:()=>Ee(!0),className:"w-full flex items-center justify-between py-2 min-h-[44px]",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-5 h-5 text-blue-600",strokeWidth:2}),e.jsx("h3",{className:"text-lg font-bold text-blue-600",children:t("about.title")})]}),e.jsx(ve,{className:"w-6 h-6 text-blue-600",strokeWidth:2})]})}),e.jsx(os,{isOpen:Xe,onClose:()=>Ee(!1),entitlement:m,entitlementLoading:r,onSignOut:u}),Ae&&e.jsx(ls,{isOpen:Ae,onClose:()=>{X(!1),Z("")},onConfirm:it,confirmText:Je,onConfirmTextChange:Z}),De&&e.jsx(is,{isOpen:De,onClose:()=>Ge(!1),archives:tt||[],onRestoreGroup:(s,a)=>ce({year:s,groupNumber:a})}),e.jsx(ue,{isOpen:B!==null,onClose:()=>ce(null),onConfirm:()=>{B&&lt(B.year,B.groupNumber)},title:t("tools.restoreGroupTitle"),message:t("tools.restoreGroupMessage",{number:((Oe=B==null?void 0:B.groupNumber)==null?void 0:Oe.toString())||""}),confirmText:t("tools.restoreGroupConfirm"),cancelText:t("common.cancel"),variant:"warning"}),y&&e.jsx(wt,{isOpen:y.isOpen,onClose:()=>N(null),title:y.title,message:y.message,variant:y.variant}),D&&e.jsx(ue,{isOpen:D.isOpen,onClose:()=>$(null),onConfirm:D.onConfirm,title:D.title,message:D.message,confirmText:D.confirmText,cancelText:t("common.cancel"),variant:D.variant}),ae&&e.jsx(yt,{mode:ae,onSuccess:et,onCancel:()=>oe(null)})]})},ns=({onArchive:i,onViewArchives:m})=>{const{t:r}=U(),u=new Date().getFullYear(),l=Y(()=>d.groups.toArray(),[]),o=Y(()=>d.participants.toArray(),[]),b=(l==null?void 0:l.filter(N=>N.status==="active").length)||0,t=new Set((o||[]).map(N=>N.courseStartDate)),w=(l==null?void 0:l.filter(N=>N.status==="planned"&&t.has(N.courseStartDate)).length)||0,p=b>0||w>0,f=!p,k=(l==null?void 0:l.filter(N=>N.status!=="completed"?!1:new Date(N.courseStartDate).getFullYear()===u))||[],y=(o==null?void 0:o.filter(N=>k.some(D=>D.courseStartDate===N.courseStartDate)).length)||0;return e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg border-2 border-purple-300",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ue,{className:"w-5 h-5 text-purple-600",strokeWidth:2}),e.jsx("h4",{className:"text-lg font-bold text-purple-600",children:r("archive.title")})]}),e.jsx("p",{className:"text-sm text-slate-700 mb-4",children:r("archive.description")}),e.jsxs("div",{className:"bg-white border border-slate-300 rounded-lg p-3 mb-4",children:[e.jsx("h5",{className:"text-sm font-semibold text-slate-800 mb-2",children:r("tools.archiveReadinessTitle")}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[b===0?e.jsx(Ne,{className:"w-5 h-5 text-emerald-600",strokeWidth:2}):e.jsx(Ie,{className:"w-5 h-5 text-amber-600",strokeWidth:2}),e.jsx("span",{className:"text-slate-700",children:r("tools.archiveActiveGroups")})]}),e.jsx("span",{className:`font-semibold ${b===0?"text-emerald-700":"text-amber-700"}`,children:b})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[w===0?e.jsx(Ne,{className:"w-5 h-5 text-emerald-600",strokeWidth:2}):e.jsx(Ie,{className:"w-5 h-5 text-amber-600",strokeWidth:2}),e.jsx("span",{className:"text-slate-700",children:r("tools.archivePlannedGroups")})]}),e.jsx("span",{className:`font-semibold ${w===0?"text-emerald-700":"text-amber-700"}`,children:w})]})]}),e.jsxs("div",{className:"mt-3 pt-3 border-t border-slate-200",children:[f?e.jsxs("p",{className:"text-xs text-emerald-700 flex items-start gap-1.5",children:[e.jsx("span",{className:"text-emerald-600 mt-0.5",children:"âœ“"}),e.jsx("span",{children:r("tools.archiveReady")})]}):e.jsxs("p",{className:"text-xs text-amber-800 flex items-start gap-1.5",children:[e.jsx(we,{className:"w-4 h-4 text-amber-600 mt-0.5 flex-shrink-0",strokeWidth:2}),e.jsx("span",{children:r("tools.archiveNotReady")})]}),e.jsx("p",{className:"text-[11px] text-slate-500 mt-2",children:r("tools.archiveAutoPlannedNote")})]})]}),k.length>0?e.jsxs("div",{className:"bg-white p-3 rounded mb-4 text-sm space-y-1",children:[e.jsxs("p",{children:[e.jsxs("strong",{children:[r("archive.currentYear"),":"]})," ",u]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[r("archive.groupsToArchive"),":"]})," ",k.length]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[r("archive.participantsToArchive"),":"]})," ",y]})]}):e.jsx("div",{className:"bg-white p-3 rounded mb-4 text-sm text-slate-600",children:r("archive.noGroupsToArchive")}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:i,disabled:k.length===0||p,className:"w-full px-6 py-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-slate-400 disabled:cursor-not-allowed font-bold min-h-[48px] transition-colors",title:p?"ÐŸÑ€Ð¸ÐºÐ»ÑŽÑ‡ÐµÑ‚Ðµ Ð²ÑÐ¸Ñ‡ÐºÐ¸ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¸ Ð¸ Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð°Ð½Ð¸ Ð³Ñ€ÑƒÐ¿Ð¸":"ÐÑ€Ñ…Ð¸Ð²Ð¸Ñ€Ð°Ð¹ Ð¸ Ð½ÑƒÐ»Ð¸Ñ€Ð°Ð¹ Ð³Ð¾Ð´Ð¸ÑˆÐ½Ð¸Ñ Ð½Ð¾Ð¼ÐµÑ€",children:r("archive.button")}),e.jsxs("button",{onClick:m,className:"w-full px-6 py-4 bg-slate-600 text-white rounded-lg hover:bg-slate-700 font-medium min-h-[48px] transition-colors",children:["ðŸ“š ",r("archive.viewArchives")]})]})]})},ls=({isOpen:i,onClose:m,onConfirm:r,confirmText:u,onConfirmTextChange:l})=>{const{t:o}=U(),b=new Date().getFullYear(),t=Y(()=>d.groups.toArray(),[]),w=Y(()=>d.participants.toArray(),[]),p=(t==null?void 0:t.some(j=>j.status==="active"))||!1,f=new Set((w||[]).map(j=>j.courseStartDate)),k=(t==null?void 0:t.some(j=>j.status==="planned"&&f.has(j.courseStartDate)))||!1,y=p||k,N=(t==null?void 0:t.filter(j=>j.status!=="completed"?!1:new Date(j.courseStartDate).getFullYear()===b))||[],D=(w==null?void 0:w.filter(j=>N.some(F=>F.courseStartDate===j.courseStartDate)).length)||0,$=`ARCHIVE-${b}`,c=u===$&&!y;return i?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full",children:[e.jsx("h3",{className:"text-xl font-bold text-purple-600 mb-4",children:o("archive.confirmTitle")}),y?e.jsxs("div",{className:"bg-red-50 border-2 border-red-400 p-4 rounded mb-4",children:[e.jsx("p",{className:"text-sm text-red-900 font-semibold mb-2",children:o("tools.archiveCannotArchive")}),e.jsx("p",{className:"text-sm text-red-800 mb-3",children:o("tools.archiveCannotArchiveMessage")}),p&&e.jsx("p",{className:"text-xs text-red-700",children:o("tools.archiveHasActiveGroups")}),k&&e.jsx("p",{className:"text-xs text-red-700",children:o("tools.archiveHasPlannedGroups")})]}):e.jsx("p",{className:"text-slate-700 mb-4",children:o("tools.archiveConfirmMessage",{groups:N.length.toString(),participants:D.toString(),year:b.toString()})}),!y&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:[o("archive.typeToConfirm")," ",e.jsx("code",{className:"bg-slate-200 px-2 py-1 rounded",children:$})," ",o("archive.toConfirm"),":"]}),e.jsx("input",{type:"text",value:u,onChange:j=>l(j.target.value),placeholder:$,className:"w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:m,className:"flex-1 px-4 py-3 border border-slate-200 rounded-lg hover:bg-slate-50",children:o(y?"tools.archiveCloseButton":"common.cancel")}),!y&&e.jsx("button",{onClick:r,disabled:!c,className:"flex-1 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed font-bold",children:o("archive.button")})]})]})}):null},is=({isOpen:i,onClose:m,archives:r,onRestoreGroup:u})=>{const{t:l}=U(),[o,b]=v.useState(null),[t,w]=v.useState(null);return i?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-bold text-slate-900",children:l("archive.yearlyArchives")}),e.jsx("button",{onClick:m,className:"p-2 hover:bg-slate-100 rounded-lg transition-colors",children:e.jsx(ye,{className:"w-6 h-6",strokeWidth:2})})]}),r.length===0?e.jsx("p",{className:"text-slate-600 text-center py-8",children:l("archive.noArchives")}):e.jsx("div",{className:"space-y-4",children:r.sort((p,f)=>f.year-p.year).map(p=>e.jsxs("div",{className:"border border-slate-300 rounded-lg",children:[e.jsxs("button",{onClick:()=>b(o===p.year?null:p.year),className:"w-full px-4 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ve,{className:`w-5 h-5 text-slate-600 transition-transform ${o===p.year?"rotate-90":""}`,strokeWidth:2}),e.jsxs("div",{className:"text-left",children:[e.jsxs("div",{className:"font-bold text-slate-900",children:[l("archive.year")," ",p.year]}),e.jsxs("div",{className:"text-sm text-slate-600",children:[p.groups.length," ",l("archive.groups"),", ",p.participants.length," ",l("archive.participants")]})]})]}),e.jsxs("div",{className:"text-xs text-slate-500",children:[l("archive.archived"),": ",A(p.archivedAt.split("T")[0])]})]}),o===p.year&&e.jsx("div",{className:"border-t border-slate-200 p-4 space-y-2",children:p.groups.sort((f,k)=>k.groupNumber-f.groupNumber).map(f=>{const k=p.participants.filter(y=>y.groupNumber===f.groupNumber);return e.jsxs("div",{className:"border border-slate-200 rounded-lg",children:[e.jsxs("button",{onClick:()=>w(t===f.groupNumber?null:f.groupNumber),className:"w-full px-3 py-2 flex items-center justify-between hover:bg-slate-50 transition-colors rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ve,{className:`w-4 h-4 text-slate-600 transition-transform ${t===f.groupNumber?"rotate-90":""}`,strokeWidth:2}),e.jsxs("div",{className:"text-left",children:[e.jsxs("div",{className:"font-semibold text-slate-900",children:[l("group.number")," ",f.groupNumber]}),e.jsxs("div",{className:"text-xs text-slate-600",children:[A(f.courseStartDate)," - ",A(f.courseEndDate)]})]})]}),e.jsxs("div",{className:"text-xs text-slate-600",children:[k.length," ",l("archive.participants")]})]}),t===f.groupNumber&&e.jsxs("div",{className:"border-t border-slate-200 p-3",children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("button",{onClick:()=>u(p.year,f.groupNumber),className:"w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition-colors flex items-center justify-center gap-2",children:[e.jsx(Ve,{className:"w-5 h-5",strokeWidth:2}),l("tools.restoreGroupConfirm")]}),e.jsx("p",{className:"text-xs text-slate-600 mt-2 text-center",children:l("tools.restoreGroupWillRestore")})]}),e.jsx("div",{className:"space-y-2",children:k.map(y=>e.jsxs("div",{className:"bg-slate-50 p-2 rounded text-sm",children:[e.jsx("div",{className:"font-semibold text-slate-900",children:y.personName}),e.jsx("div",{className:"text-slate-600",children:y.companyName}),e.jsxs("div",{className:"text-xs text-slate-500 mt-1",children:[l("participant.uniqueNumber"),": ",y.uniqueNumber]})]},y.id))})]})]},f.id)})})]},p.id))}),e.jsx("div",{className:"mt-6",children:e.jsx("button",{onClick:m,className:"w-full px-6 py-3 bg-slate-600 text-white rounded-lg hover:bg-slate-700 font-medium",children:l("common.close")})})]})}):null},cs=({showAlert:i})=>{const{settings:m,resetYearlySequence:r}=ze(),{t:u}=U(),[l,o]=v.useState(!1),[b,t]=v.useState(""),[w,p]=v.useState(!1),f=Y(()=>d.participants.toArray(),[]),k=(f==null?void 0:f.reduce((j,F)=>{const J=parseInt(F.uniqueNumber.split("-")[0],10);return J>j?J:j},0))||0,N=`RESET-${new Date().getFullYear()}`,D=l&&b===N,$=()=>{p(!0)},c=async()=>{try{await r(),i(u("common.success"),u("tools.resetSequenceSuccess"),"success"),o(!1),t(""),p(!1)}catch(j){console.error("Failed to reset sequence:",j),i(u("common.error"),u("tools.resetSequenceFailed"),"error")}};return e.jsxs("div",{className:"bg-red-50 p-4 rounded-lg border-2 border-red-300",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(te,{className:"w-5 h-5 text-red-600",strokeWidth:2}),e.jsx("h4",{className:"text-lg font-bold text-red-600",children:u("tools.dangerZone")})]}),e.jsx("p",{className:"text-sm text-slate-700 mb-4",children:u("tools.resetSequenceDescription2")}),m&&e.jsxs("div",{className:"bg-white p-3 rounded mb-4 text-sm",children:[e.jsxs("p",{children:[e.jsxs("strong",{children:[u("tools.current"),":"]})," ",m.lastUniquePrefix.toString().padStart(4,"0"),"-",m.lastUniqueSeq.toString().padStart(3,"0")]}),e.jsxs("p",{children:[e.jsxs("strong",{children:[u("tools.nextAfterReset"),":"]})," ",(k+1).toString().padStart(4,"0"),"-001"]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("label",{className:"flex items-start gap-3 cursor-pointer min-h-[44px]",children:[e.jsx("input",{type:"checkbox",checked:l,onChange:j=>o(j.target.checked),className:"mt-1 w-5 h-5 text-red-600 rounded border-slate-300 focus:ring-red-500"}),e.jsx("span",{className:"text-sm text-slate-700 flex-1",children:u("tools.resetSequenceCheckbox")})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:[u("tools.typeToConfirm",{text:N}),": ",e.jsx("code",{className:"bg-slate-200 px-2 py-1 rounded",children:N})]}),e.jsx("input",{type:"text",value:b,onChange:j=>t(j.target.value),placeholder:N,className:"w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 min-h-[44px]",disabled:!l})]}),e.jsx("button",{onClick:$,disabled:!D,className:"w-full px-6 py-4 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed font-bold min-h-[48px]",children:u("tools.resetButton")})]}),w&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full",children:[e.jsx("h3",{className:"text-xl font-bold text-red-600 mb-4",children:u("modal.finalConfirmation")}),e.jsx("p",{className:"text-slate-700 mb-6",children:u("tools.resetSequenceFinalConfirm")}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>p(!1),className:"flex-1 px-4 py-3 border border-slate-200 rounded-lg hover:bg-slate-50 min-h-[48px]",children:u("tools.resetSequenceCancel")}),e.jsx("button",{onClick:c,className:"flex-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold min-h-[48px]",children:u("tools.resetSequenceConfirmButton")})]})]})})]})};export{js as ToolsPage};
