import{d as e,r as t,u as s,f as r,i as a,a as o,c as l,C as n,t as i,A as c,L as d,b as m,g as u,e as x,m as p,h,_ as g,j as b,s as f,k as j,l as v}from"./index-CGB6qKWg.js";import{r as N,j as w,a as y}from"./vendor-react-BvoEKvLG.js";import{u as S}from"./vendor-dexie-JKmga9jS.js";import{s as k}from"./fileDownload-D0s8ICu7.js";import{L as C,i as A,E as D,j as G,T as E,c as O,k as W,I as P,X as T,P as q,e as $,a as F,B as Y,f as M,b as R,C as U,A as I,l as B,d as L,R as _,H as z,m as H,F as V,n as K,o as J,g as Z,p as Q,q as X}from"./vendor-icons-BX-4-bzZ.js";import"./vendor-dates-qyqZJmaY.js";import"./vendor-uuid-P-OY1HC2.js";import"./vendor-supabase-BRwdPCI1.js";import"./vendor-misc-DSrITObC.js";function ee(){return{settings:S(()=>async function(){return e.settings.get(1)}()),updateSettings:async t=>{await async function(t){await e.settings.update(1,t)}(t)},resetYearlySequence:async()=>{await t()}}}const te=1e5,se=2e6;function re(e){const t=e instanceof Uint8Array?e:new Uint8Array(e);let s="";const r=t.byteLength;for(let a=0;a<r;a+=8192)s+=String.fromCharCode.apply(null,t.subarray(a,a+8192));return window.btoa(s)}function ae(e){const t=window.atob(e),s=t.length,r=new Uint8Array(s);for(let a=0;a<s;a++)r[a]=t.charCodeAt(a);return r}async function oe(e,t,s=1e5){const r=new TextEncoder,a=await window.crypto.subtle.importKey("raw",r.encode(e),{name:"PBKDF2"},!1,["deriveKey"]);return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:s,hash:"SHA-256"},a,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function le(e,t){const s=JSON.stringify(e),r=(a=s,(new TextEncoder).encode(a));var a;const o=window.crypto.getRandomValues(new Uint8Array(16)),l=window.crypto.getRandomValues(new Uint8Array(12)),n=await oe(t,o,te),i=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:l},n,r);return{version:1,kdf:"PBKDF2-SHA256",salt:re(o),iv:re(l),ciphertext:re(i),iterations:te}}async function ne(e,t){try{const r=ae(e.salt),a=ae(e.iv),o=ae(e.ciphertext),l=function(e){if(null==e)return te;if("number"!=typeof e||!Number.isFinite(e)||!Number.isInteger(e))throw new Error("Invalid backup format: iterations must be a valid integer.");if(e<5e4||e>se)throw new Error("Invalid backup format: iterations must be between 50000 and 2000000.");return e}(e.iterations),n=await oe(t,r,l),i=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:a},n,o),c=(s=i,(new TextDecoder).decode(s));return JSON.parse(c)}catch(r){throw new Error("Decryption failed. Wrong password or corrupted file.")}var s}function ie(e){const t=e.participants.map(e=>{const t={...e};return delete t.groupNumber,delete t.autoGroup,delete t.manualGroup,t}),s=e.groups.map(e=>{const t={...e};return"planned"===t.status&&(t.groupNumber=null),t});return{...e,version:2,participants:t,groups:s}}const ce=({isOpen:e,mode:t,onConfirm:r,onCancel:a,error:o,isProcessing:l=!1})=>{const{t:n}=s(),[i,c]=N.useState(""),[d,m]=N.useState(!1);return e?w.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm",children:w.jsx("div",{className:"bg-white rounded-xl shadow-xl max-w-md w-full overflow-hidden animate-in fade-in zoom-in duration-200",children:w.jsxs("div",{className:"p-6",children:[w.jsxs("div",{className:"flex items-center gap-3 mb-4 text-slate-800",children:[w.jsx("div",{className:"p-3 bg-blue-100 rounded-full",children:w.jsx(C,{className:"w-6 h-6 text-blue-600"})}),w.jsx("h3",{className:"text-xl font-bold",children:n("export"===t?"crypto.exportTitle":"crypto.importTitle")})]}),w.jsx("p",{className:"text-slate-600 mb-6",children:n("export"===t?"crypto.exportDescription":"crypto.importDescription")}),w.jsxs("form",{onSubmit:e=>{e.preventDefault(),i&&r(i)},className:"space-y-4",children:[w.jsxs("div",{className:"relative",children:[w.jsx("input",{type:d?"text":"password",value:i,onChange:e=>c(e.target.value),placeholder:n("crypto.passwordPlaceholder"),className:"w-full px-4 py-3 pr-12 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",autoFocus:!0,disabled:l}),w.jsx("button",{type:"button",onClick:()=>m(!d),className:"absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600",tabIndex:-1,children:d?w.jsx(A,{size:20}):w.jsx(D,{size:20})})]}),o&&w.jsxs("div",{className:"p-3 bg-red-50 text-red-600 text-sm rounded-lg flex items-center gap-2 animate-pulse",children:[w.jsx("span",{children:"âš ï¸"})," ",o]}),w.jsxs("div",{className:"flex gap-3 pt-2",children:[w.jsx("button",{type:"button",onClick:a,disabled:l,className:"flex-1 px-4 py-2 text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg font-medium transition-colors",children:n("common.cancel")}),w.jsxs("button",{type:"submit",disabled:!i||l,className:"flex-1 px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg font-bold shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2",children:[l&&w.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}),n("export"===t?"crypto.encryptAndExport":"crypto.decryptAndImport")]})]})]})]})})}):null},de=({isOpen:e,onClose:t,entitlement:a,entitlementLoading:o=!1,onSignOut:l})=>{const{t:n,language:i}=s();if(!e)return null;const c=e=>r(e,"bg"===i?"bg-BG":"en-GB","Europe/Sofia",n("tools.notAvailable")),d=(()=>{const e=(null==a?void 0:a.status)??"unknown";return n("active"===e?"tools.subscriptionStatusActive":"grace"===e?"tools.subscriptionStatusGrace":"expired"===e?"tools.subscriptionStatusExpired":"tools.subscriptionStatusUnknown")})(),m=(()=>{const e=(null==a?void 0:a.status)??"unknown";return"active"===e?"text-emerald-700 bg-emerald-50 border-emerald-200":"grace"===e?"text-amber-800 bg-amber-50 border-amber-200":"expired"===e?"text-red-700 bg-red-50 border-red-200":"text-slate-700 bg-slate-50 border-slate-200"})(),u=(()=>{const e=(null==a?void 0:a.status)??"unknown";return"active"===e?G:"grace"===e?E:"expired"===e?O:W})(),x=(()=>{var e;const t=null==(e=null==a?void 0:a.planCode)?void 0:e.trim().toLowerCase();return t?"montly"===t||"monthy"===t||t.startsWith("mon")?"monthly":t.startsWith("year")?"yearly":t:null})(),p=x?"monthly"===x?n("tools.planMonthly"):"yearly"===x?n("tools.planYearly"):x:n("tools.notAvailable"),h="expired"===(null==a?void 0:a.status)?"text-red-700":"grace"===(null==a?void 0:a.status)?"text-amber-800":"text-slate-900";return w.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:w.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full",children:[w.jsxs("div",{className:"flex justify-between items-center mb-4",children:[w.jsxs("div",{className:"flex items-center gap-2",children:[w.jsx(P,{className:"w-6 h-6 text-blue-600",strokeWidth:2}),w.jsx("h3",{className:"text-xl font-bold text-slate-900",children:n("about.title")})]}),w.jsx("button",{onClick:t,className:"p-2 hover:bg-slate-100 rounded-lg transition-colors",children:w.jsx(T,{className:"w-6 h-6",strokeWidth:2})})]}),w.jsxs("div",{className:"space-y-4",children:[w.jsxs("div",{className:"text-center py-4",children:[w.jsx("h2",{className:"text-2xl font-bold text-blue-600",children:"CERTIFY"}),w.jsx("p",{className:"text-sm text-slate-600 mt-1",children:n("about.subtitle")})]}),w.jsxs("div",{className:"bg-slate-50 rounded-lg p-4 space-y-3",children:[w.jsxs("div",{className:"flex items-center gap-3",children:[w.jsx(q,{className:"w-5 h-5 text-slate-600",strokeWidth:2}),w.jsxs("div",{children:[w.jsx("div",{className:"text-sm font-medium text-slate-700",children:n("about.version")}),w.jsx("div",{className:"text-lg font-bold text-slate-900",children:"2.1.1"})]})]}),w.jsxs("div",{className:"flex items-center gap-3",children:[w.jsx($,{className:"w-5 h-5 text-slate-600",strokeWidth:2}),w.jsxs("div",{children:[w.jsx("div",{className:"text-sm font-medium text-slate-700",children:n("about.buildDate")}),w.jsx("div",{className:"text-sm text-slate-900",children:c("2026-02-19")})]})]}),(null==a?void 0:a.configured)&&a.authenticated&&w.jsx(w.Fragment,{children:w.jsxs("div",{className:"border-t border-slate-200 pt-3",children:[w.jsx("div",{className:"text-sm font-semibold text-slate-700 mb-2",children:n("tools.subscriptionAccount")}),w.jsxs("div",{className:"space-y-1.5 text-sm text-slate-700",children:[w.jsxs("p",{className:"flex items-center gap-1.5",children:[w.jsxs("strong",{children:[n("tools.subscriptionStatus"),":"]})," ",w.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded-md border font-semibold ${m}`,children:[w.jsx(u,{className:"w-3.5 h-3.5",strokeWidth:2.5}),d]})]}),w.jsxs("p",{className:`flex items-center gap-1.5 ${h}`,children:[w.jsx(F,{className:"w-4 h-4",strokeWidth:2}),w.jsxs("span",{children:[w.jsxs("strong",{children:[n("tools.subscriptionEndsAt"),":"]})," ",c(a.currentPeriodEnd)]})]}),"grace"===a.status&&w.jsxs("p",{className:"text-amber-800 flex items-center gap-1.5",children:[w.jsx(E,{className:"w-4 h-4",strokeWidth:2}),w.jsxs("span",{children:[w.jsxs("strong",{children:[n("tools.graceUntil"),":"]})," ",c(a.graceUntil)]})]}),w.jsxs("p",{className:"flex items-center gap-1.5",children:[w.jsx(Y,{className:"w-4 h-4 text-slate-500",strokeWidth:2}),w.jsxs("span",{children:[w.jsxs("strong",{children:[n("tools.subscriptionPlan"),":"]})," ",p]})]}),o&&w.jsx("p",{className:"text-slate-500",children:n("common.loading")})]})]})})]}),w.jsxs("div",{className:"border-t border-slate-200 pt-4",children:[w.jsx("h4",{className:"text-sm font-semibold text-slate-700 mb-3",children:n("about.features")}),w.jsxs("div",{className:"space-y-2 text-sm text-slate-600",children:[w.jsxs("div",{className:"flex items-start gap-2",children:[w.jsx(M,{className:"w-4 h-4 mt-0.5 text-blue-600",strokeWidth:2}),w.jsx("span",{children:n("about.feature1")})]}),w.jsxs("div",{className:"flex items-start gap-2",children:[w.jsx(R,{className:"w-4 h-4 mt-0.5 text-blue-600",strokeWidth:2}),w.jsx("span",{children:n("about.feature2")})]}),w.jsxs("div",{className:"flex items-start gap-2",children:[w.jsx(q,{className:"w-4 h-4 mt-0.5 text-blue-600",strokeWidth:2}),w.jsx("span",{children:n("about.feature3")})]})]})]}),w.jsx("div",{className:"border-t border-slate-200 pt-4",children:w.jsx("p",{className:"text-xs text-center text-slate-500",children:n("about.footer")})})]}),w.jsxs("div",{className:"mt-6 flex gap-3",children:[(null==a?void 0:a.configured)&&a.authenticated&&w.jsx("button",{onClick:()=>{null==l||l()},className:"px-4 py-3 rounded-lg border border-slate-300 bg-white text-slate-700 hover:bg-slate-50 font-medium transition-colors",children:n("auth.signOut")}),w.jsx("button",{onClick:t,className:"flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition-colors",children:n("common.close")})]})]})})},me=({filteredParticipants:t,entitlement:r,entitlementLoading:A=!1,onSignOut:D})=>{var G;const{settings:O}=ee(),{language:W,setLanguage:Y,t:X}=s(),[te,se]=N.useState(!1),[re,ae]=N.useState(!1),[oe,me]=N.useState(null),[ge,be]=N.useState(null),fe=(e,t,s="info")=>{me({isOpen:!0,title:e,message:t,variant:s})},je=(e,t,s,r="info",a)=>{be({isOpen:!0,title:e,message:t,onConfirm:s,variant:r,confirmText:X("common.confirm")})},[ve,Ne]=N.useState(!1),[we,ye]=N.useState(""),[Se,ke]=N.useState(0),[Ce,Ae]=N.useState(null),[De,Ge]=N.useState(!1),[Ee,Oe]=N.useState(!1),[We,Pe]=N.useState(""),[Te,qe]=N.useState(!1),[$e,Fe]=N.useState(null),[Ye,Me]=N.useState(!1),[Re,Ue]=N.useState({isOpen:!1,mode:"export",isProcessing:!1}),[Ie,Be]=N.useState(null),[Le,_e]=N.useState(a()),[ze,He]=N.useState(!1),[Ve,Ke]=N.useState({date:"",status:"planned"}),Je=S(()=>u(),[]),Ze=S(()=>j(),[Se]),Qe=S(()=>v(),[Se]),Xe=S(()=>e.participants.toArray(),[]),et=S(()=>e.yearlyArchives.toArray(),[]),tt=e=>X(1===e?"group.participant_one":"group.participant_other"),st=async(t,s)=>{try{const r=function(e){let t=e.version||1,s=e;if(!s||"object"!=typeof s)throw new Error("Invalid backup file: data is not an object.");if(t>2)throw new Error(`Backup version ${t} is newer than this app version (2). Please update the app to import this file.`);for(;t<2;)try{if(1!==t)throw new Error(`No migration strategy found for version ${t}`);s=ie(s),t=2}catch(r){throw new Error(`Migration failed: Could not upgrade backup from v${t} to v${t+1}`)}if(!Array.isArray(s.participants)||!Array.isArray(s.groups))throw new Error("Migration finished but result is malformed (missing arrays).");return s}(t);if(!(r.groups&&r.participants&&Array.isArray(r.groups)&&Array.isArray(r.participants)))throw new Error("Invalid backup format after migration: missing groups or participants arrays");"replace"===s?await e.transaction("rw",[e.participants,e.groups,e.settings],async()=>{await e.participants.clear(),await e.groups.clear(),r.groups.length>0&&await e.groups.bulkAdd(r.groups),r.participants.length>0&&await e.participants.bulkAdd(r.participants),r.settings&&await e.settings.update(1,r.settings)}):await e.transaction("rw",[e.participants,e.groups,e.settings],async()=>{r.groups.length>0&&await e.groups.bulkPut(r.groups);for(const t of r.participants){if(await e.participants.get(t.id))await e.participants.update(t.id,t);else{let s=t.uniqueNumber,r=0;for(;!(await b(s))&&r<1e3;){const t=await e.settings.get(1);if(t){const r=t.lastUniquePrefix+1,a=t.lastUniqueSeq+1;s=`${r.toString().padStart(4,"0")}-${a.toString().padStart(3,"0")}`,await e.settings.update(1,{lastUniquePrefix:r,lastUniqueSeq:a})}r++}await e.participants.add({...t,uniqueNumber:s})}}}),fe(X("common.success"),X("import.success",{participants:String(r.participants.length),groups:String(r.groups.length)}),"success")}catch(r){fe(X("common.error"),`${X("import.failed")}: ${r.message}`,"error")}finally{se(!1),Ue(e=>({...e,isOpen:!1,isProcessing:!1,pendingEncryptedData:null,pendingFile:null}))}},rt=async(e,t)=>{const s=async()=>{se(!0);try{const r=await e.text(),a=JSON.parse(r);"object"==typeof(s=a)&&null!==s&&"ciphertext"in s&&"salt"in s&&"iv"in s&&"version"in s||a&&"object"==typeof a&&"ciphertext"in a&&"salt"in a?(Ue({isOpen:!0,mode:"import",isProcessing:!1,pendingEncryptedData:a,importMode:t,pendingFile:e}),se(!1)):await st(a,t)}catch(r){fe(X("common.error"),X("tools.invalidBackupFormat"),"error"),se(!1)}var s};"replace"===t?je(X("common.warning"),X("tools.importReplaceWarning"),s,"danger"):s()};return w.jsxs("div",{className:"space-y-6 pb-24 md:pb-6",children:[w.jsx(ce,{isOpen:Re.isOpen,mode:Re.mode,isProcessing:Re.isProcessing,error:Re.error,onCancel:()=>Ue(e=>({...e,isOpen:!1})),onConfirm:t=>{"export"===Re.mode?(async t=>{Ue(e=>({...e,isProcessing:!0,error:void 0}));try{const s=await e.participants.toArray(),r=await e.groups.toArray(),a=await e.settings.get(1),o={version:2..toString(),timestamp:(new Date).toISOString(),participants:s,groups:r,settings:a},l=await le(o,t),n=new Blob([JSON.stringify(l,null,2)],{type:"application/json"}),i=`course-backup-secure-${(new Date).toISOString().split("T")[0]}.json`;await k(n,i),Ue(e=>({...e,isOpen:!1}))}catch(s){Ue(e=>({...e,error:X("crypto.encryptionFailed")}))}finally{Ue(e=>({...e,isProcessing:!1}))}})(t):(async e=>{if(Re.pendingEncryptedData&&Re.importMode){Ue(e=>({...e,isProcessing:!0,error:void 0})),se(!0);try{const t=await ne(Re.pendingEncryptedData,e);await st(t,Re.importMode)}catch(t){Ue(e=>({...e,isProcessing:!1,error:X("crypto.invalidPassword")})),se(!1)}}})(t)}}),w.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200",children:[w.jsx("h3",{className:"text-lg font-bold text-slate-900 mb-4",children:X("tools.language")}),w.jsxs("div",{className:"flex gap-3",children:[w.jsxs("button",{onClick:()=>Y("en"),className:"flex-1 px-6 py-3 rounded-lg font-medium min-h-[48px] transition-colors duration-150 flex items-center justify-center gap-3 "+("en"===W?"bg-blue-600 text-white":"bg-slate-100 text-slate-700 hover:bg-slate-200"),children:[w.jsx(y,{countryCode:"GB",svg:!0,style:{width:"2em",height:"1.5em",borderRadius:"4px"}}),"English"]}),w.jsxs("button",{onClick:()=>Y("bg"),className:"flex-1 px-6 py-3 rounded-lg font-medium min-h-[48px] transition-colors duration-150 flex items-center justify-center gap-3 "+("bg"===W?"bg-blue-600 text-white":"bg-slate-100 text-slate-700 hover:bg-slate-200"),children:[w.jsx(y,{countryCode:"BG",svg:!0,style:{width:"2em",height:"1.5em",borderRadius:"4px"}}),"Ð‘ÑŠÐ»Ð³Ð°Ñ€ÑÐºÐ¸"]})]})]}),Je&&w.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border-2 border-blue-400",children:[w.jsxs("div",{className:"mb-4",children:[w.jsxs("div",{className:"flex items-center gap-2",children:[w.jsx(R,{className:"w-5 h-5 text-blue-600",strokeWidth:2}),w.jsx("h3",{className:"text-lg font-bold text-blue-700",children:X("tools.activeGroup")})]}),w.jsx("p",{className:"text-sm text-blue-600 mt-0.5",children:X("tools.activeGroupSubtitle")})]}),w.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-4 mb-4",children:w.jsxs("div",{className:"space-y-2 text-sm text-slate-700",children:[w.jsxs("p",{children:[w.jsxs("strong",{children:[X("tools.groupNumber"),":"]})," ",Je.groupNumber||w.jsx("span",{className:"italic text-slate-500",children:X("tools.pendingAssignedOnClose")})]}),w.jsxs("p",{children:[w.jsxs("strong",{children:[X("tools.courseStart"),":"]})," ",o(Je.courseStartDate)]}),w.jsxs("p",{children:[w.jsxs("strong",{children:[X("tools.courseEnd"),":"]})," ",o(Je.courseEndDate)]})]})}),w.jsxs("div",{className:"space-y-4",children:[w.jsxs("label",{className:"flex items-start gap-3 cursor-pointer min-h-[44px]",children:[w.jsx("input",{type:"checkbox",checked:ve,onChange:e=>Ne(e.target.checked),className:"mt-1 w-5 h-5 text-blue-600 rounded border-slate-300 focus:ring-blue-500"}),w.jsx("span",{className:"text-sm text-slate-700 flex-1",children:X("tools.closeGroupDescription")})]}),w.jsxs("div",{children:[w.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:[X("tools.typeToConfirm",{text:Je.groupNumber?`CLOSE-${Je.groupNumber}`:"CLOSE"}),": ",w.jsx("code",{className:"bg-slate-200 px-2 py-1 rounded",children:Je.groupNumber?`CLOSE-${Je.groupNumber}`:"CLOSE"})]}),w.jsx("input",{type:"text",value:we,onChange:e=>ye(e.target.value),placeholder:Je.groupNumber?`CLOSE-${Je.groupNumber}`:"CLOSE",className:"w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 min-h-[44px]",disabled:!ve})]}),w.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[w.jsxs("button",{onClick:async()=>{je(X("tools.returnToPlanned"),X("tools.returnToPlannedConfirm"),async()=>{try{await f(),ke(e=>e+1),fe(X("common.success"),X("tools.returnToPlannedSuccess"),"success")}catch(e){fe(X("common.error"),`${X("common.error")}: ${e.message}`,"error")}},"warning")},className:"px-6 py-4 bg-slate-600 text-white rounded-lg hover:bg-slate-700 font-bold min-h-[48px] transition-colors duration-150",children:["â† ",X("tools.returnToPlanned")]}),w.jsxs("button",{onClick:async()=>{try{await l(),Ne(!1),ye(""),ke(e=>e+1),fe(X("common.success"),X("tools.closeActiveSuccess"),"success")}catch(e){fe(X("common.error"),`${X("common.error")}: ${e.message}`,"error")}},disabled:!ve||we!==(Je.groupNumber?`CLOSE-${Je.groupNumber}`:"CLOSE"),className:"px-6 py-4 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed font-bold min-h-[48px] transition-colors duration-150",children:["âœ“ ",X("tools.archiveGroup")]})]})]})]}),Ce&&w.jsx(n,{isOpen:!0,title:X("tools.changeActiveGroup"),message:X("tools.changeActiveGroupMessage",{current:(Ce.currentActive.groupNumber||"Active").toString(),new:(Ce.groupNumber||"Active").toString()}),confirmText:X("tools.changeActiveGroupConfirm"),cancelText:X("common.cancel"),onConfirm:async()=>{if(Ce)try{const e=Ce.currentActive.groupNumber,t=Ce.groupNumber;await m(Ce.groupId,!0),Ae(null),ke(e=>e+1),fe(X("common.success"),X("tools.makeActiveWithSwapSuccess",{new:(null==t?void 0:t.toString())||"Active",old:(null==e?void 0:e.toString())||"Active"}),"success")}catch(e){fe(X("common.error"),`${X("common.error")}: ${e.message}`,"error")}},onClose:()=>Ae(null)}),ze&&w.jsx("div",{className:"fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4",children:w.jsxs("div",{className:"bg-white rounded-lg shadow-2xl max-w-md w-full p-6 space-y-4",children:[w.jsxs("div",{className:"flex items-center justify-between",children:[w.jsx("h3",{className:"text-xl font-bold text-slate-900",children:X("tools.createNewGroup")}),w.jsx("button",{onClick:()=>{He(!1),Ke({date:"",status:"planned"})},className:"text-slate-400 hover:text-slate-600 transition-colors",children:w.jsx(T,{className:"w-6 h-6"})})]}),w.jsxs("div",{className:"space-y-4",children:[w.jsxs("div",{children:[w.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:X("tools.courseStartDateMonday")}),w.jsx("input",{type:"date",value:Ve.date,onChange:e=>Ke(t=>({...t,date:e.target.value})),className:"w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),w.jsxs("div",{children:[w.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:X("tools.groupStatus")}),w.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[w.jsxs("button",{onClick:()=>Ke(e=>({...e,status:"planned"})),className:"px-4 py-3 rounded-lg font-medium transition-all flex items-center justify-center gap-2 "+("planned"===Ve.status?"bg-amber-600 text-white ring-2 ring-amber-300":"bg-slate-100 text-slate-700 hover:bg-slate-200"),children:[w.jsx(F,{className:"w-5 h-5",strokeWidth:2}),X("tools.groupPlanned")]}),w.jsxs("button",{onClick:()=>Ke(e=>({...e,status:"active"})),className:"px-4 py-3 rounded-lg font-medium transition-all flex items-center justify-center gap-2 "+("active"===Ve.status?"bg-green-600 text-white ring-2 ring-green-300":"bg-slate-100 text-slate-700 hover:bg-slate-200"),children:[w.jsx(R,{className:"w-5 h-5",strokeWidth:2}),X("tools.groupActive")]})]})]}),"active"===Ve.status&&Je&&w.jsxs("div",{className:"p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800",children:[w.jsx(E,{className:"w-4 h-4 inline mr-1"}),X("tools.createGroupActiveWarning")]})]}),w.jsxs("div",{className:"flex gap-3 pt-2",children:[w.jsx("button",{onClick:()=>{He(!1),Ke({date:"",status:"planned"})},className:"flex-1 px-4 py-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 font-medium transition-colors",children:X("common.cancel")}),w.jsx("button",{onClick:async()=>{try{if(!Ve.date)return void fe(X("common.error"),X("tools.createGroupSelectDate"),"error");if(1!==new Date(Ve.date).getDay())return void fe(X("common.error"),X("tools.createGroupMustBeMonday"),"error");const t=await e.groups.where("courseStartDate").equals(Ve.date).first();if(t){const e="active"===t.status?X("tools.createGroupExistsActive"):"planned"===t.status?X("tools.createGroupExistsPlanned"):X("tools.createGroupExistsCompleted");return void fe(X("common.error"),e.replace("{date}",o(Ve.date)),"error")}if("active"===Ve.status){if(await u())return void fe(X("common.warning"),X("tools.createGroupActiveExists"),"warning")}if("planned"===Ve.status){const e=await u();if(e&&Ve.date<e.courseStartDate)return void fe(X("common.warning"),X("tools.createGroupBeforeActive"),"warning")}await x(Ve.date,Ve.status),He(!1),Ke({date:"",status:"planned"}),ke(e=>e+1);const s="active"===Ve.status?X("tools.groupActive"):X("tools.groupPlanned");fe(X("common.success"),X("tools.createGroupSuccess",{status:s,date:o(Ve.date)}),"success")}catch(t){fe(X("common.error"),X("tools.createGroupFailed",{error:t.message}),"error")}},disabled:!Ve.date,className:"flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium transition-colors",children:X("tools.createGroup")})]})]})}),w.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg shadow-sm border-2 border-blue-200",children:w.jsxs("div",{className:"flex flex-col md:flex-row items-start justify-between gap-4",children:[w.jsxs("div",{className:"flex-1",children:[w.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[w.jsx($,{className:"w-5 h-5 text-blue-600",strokeWidth:2}),w.jsx("h3",{className:"text-lg font-bold text-blue-700",children:X("tools.manualGroupCreation")})]}),w.jsx("p",{className:"text-sm text-blue-600",children:X("tools.manualGroupCreationSubtitle")})]}),w.jsxs("button",{onClick:()=>He(!0),className:"w-full md:w-auto px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 hover:shadow-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 md:whitespace-nowrap",children:[w.jsx($,{className:"w-5 h-5",strokeWidth:2}),X("tools.newGroup")]})]})}),Ze&&Ze.length>0&&w.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border-2 border-amber-300",children:[w.jsxs("div",{className:"mb-4",children:[w.jsxs("div",{className:"flex items-center gap-2",children:[w.jsx(F,{className:"w-5 h-5 text-amber-600",strokeWidth:2}),w.jsx("h3",{className:"text-lg font-bold text-amber-700",children:X("tools.plannedGroups")})]}),w.jsx("p",{className:"text-sm text-amber-600 mt-0.5 ml-7",children:X("tools.plannedGroupsSubtitle")})]}),w.jsx("div",{className:"space-y-3",children:Ze.map(t=>{const s=(null==Xe?void 0:Xe.filter(e=>e.courseStartDate===t.courseStartDate).length)||0;return w.jsx("div",{className:"border border-amber-200 rounded-lg p-4 bg-amber-50 hover:shadow-md hover:border-amber-300 transition-all duration-200",children:w.jsxs("div",{className:"flex items-start justify-between gap-2 sm:gap-4",children:[w.jsxs("div",{className:"flex-1",children:[w.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[w.jsxs("h4",{className:"font-semibold text-amber-900",children:[X("group.number")," ",t.groupNumber]}),w.jsx("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-800 text-xs font-medium rounded-full",children:X("group.planned")})]}),w.jsxs("div",{className:"text-sm text-amber-800 space-y-1",children:[w.jsxs("p",{className:"flex items-center gap-1",children:[w.jsx($,{className:"w-4 h-4",strokeWidth:2}),o(t.courseStartDate)," - ",o(t.courseEndDate)]}),w.jsxs("p",{className:"flex items-center gap-1",children:[w.jsx(M,{className:"w-4 h-4",strokeWidth:2}),s," ",tt(s)]})]})]}),w.jsx("div",{className:"flex flex-col gap-2",children:w.jsxs("button",{onClick:()=>(async t=>{try{const s=await p(t);if(s.needsConfirm&&s.currentActive){const r=await e.groups.get(t);r&&Ae({type:"makeActive",groupId:t,groupNumber:r.groupNumber,currentActive:s.currentActive})}else if(s.success){ke(e=>e+1);const s=await e.groups.get(t);s&&fe(X("common.success"),X("tools.makeActiveSuccess",{number:s.groupNumber?s.groupNumber.toString():"Active"}),"success")}}catch(s){fe(X("common.error"),`${X("common.error")}: ${s.message}`,"error")}})(t.id),className:"px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 hover:shadow-lg text-sm font-medium transition-all duration-200 flex items-center gap-2",children:[w.jsx(U,{className:"w-4 h-4 shrink-0",strokeWidth:2}),w.jsx("span",{children:X("tools.makeActive")})]})})]})},t.id)})})]}),Qe&&Qe.length>0&&w.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border-2 border-slate-300",children:[w.jsxs("div",{className:"flex items-center justify-between mb-4",children:[w.jsxs("div",{children:[w.jsxs("div",{className:"flex items-center gap-2",children:[w.jsx(I,{className:"w-5 h-5 text-slate-600",strokeWidth:2}),w.jsx("h3",{className:"text-lg font-bold text-slate-700",children:X("tools.archiveCompleted")}),w.jsxs("span",{className:"text-sm text-slate-500",children:["(",Qe.length,")"]})]}),w.jsx("p",{className:"text-sm text-slate-600 mt-0.5 ml-7",children:X("tools.completedCourses")})]}),Qe.length>2&&w.jsxs("button",{onClick:()=>Ge(!De),className:"flex items-center gap-2 px-3 py-1.5 text-sm text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors",children:[X(De?"tools.hide":"tools.showAll"),w.jsx(B,{className:"w-4 h-4 transition-transform "+(De?"rotate-180":""),strokeWidth:2})]})]}),w.jsx("div",{className:"space-y-3",children:(De?Qe:Qe.slice(0,2)).map(t=>{const s=(null==Xe?void 0:Xe.filter(e=>e.courseStartDate===t.courseStartDate).length)||0;return w.jsx("div",{className:"border border-slate-300 rounded-lg p-4 bg-slate-50 hover:shadow-md hover:border-slate-400 transition-all duration-200",children:w.jsxs("div",{className:"flex items-start justify-between gap-2 sm:gap-4",children:[w.jsxs("div",{className:"flex-1",children:[w.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[w.jsxs("h4",{className:"font-semibold text-slate-800",children:[X("group.number")," ",t.groupNumber]}),w.jsx("span",{className:"px-2 py-0.5 bg-slate-200 text-slate-700 text-xs font-medium rounded-full",children:X("group.completed")})]}),w.jsxs("div",{className:"text-sm text-slate-600 space-y-1",children:[w.jsxs("p",{className:"flex items-center gap-1",children:[w.jsx($,{className:"w-4 h-4",strokeWidth:2}),o(t.courseStartDate)," - ",o(t.courseEndDate)]}),w.jsxs("p",{className:"flex items-center gap-1",children:[w.jsx(M,{className:"w-4 h-4",strokeWidth:2}),s," ",tt(s)]}),t.closedAt&&w.jsxs("p",{className:"flex items-center gap-1 text-xs text-slate-500",children:[w.jsx(L,{className:"w-3.5 h-3.5",strokeWidth:2}),X("tools.completedOn"),": ",o(t.closedAt.split("T")[0])," ",new Date(t.closedAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})]})]})]}),w.jsx("div",{className:"flex flex-col gap-2",children:w.jsxs("button",{onClick:()=>(async t=>{try{const s=await h(t);if(s.needsConfirm&&s.currentActive){const r=await e.groups.get(t);r&&Ae({type:"reopen",groupId:t,groupNumber:r.groupNumber,currentActive:s.currentActive})}else s.success&&(ke(e=>e+1),fe(X("common.success"),X("tools.reopenSuccess"),"success"))}catch(s){fe(X("common.error"),`${X("common.error")}: ${s.message}`,"error")}})(t.id),className:"px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 hover:shadow-lg text-sm font-medium transition-all duration-200 flex items-center gap-2",children:[w.jsx(_,{className:"w-4 h-4 shrink-0",strokeWidth:2}),w.jsx("span",{children:X("tools.reopenForEdits")})]})})]})},t.id)})})]}),O&&w.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[w.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[w.jsx(z,{className:"w-5 h-5 text-blue-600",strokeWidth:2}),w.jsx("h3",{className:"text-lg font-bold text-blue-600",children:X("tools.currentSequence")})]}),w.jsxs("div",{className:"text-sm text-slate-700 space-y-1",children:[w.jsxs("p",{children:[w.jsxs("strong",{children:[X("tools.prefix"),":"]})," ",O.lastUniquePrefix]}),w.jsxs("p",{children:[w.jsxs("strong",{children:[X("tools.sequence"),":"]})," ",O.lastUniqueSeq]}),O.lastResetYear&&w.jsxs("p",{children:[w.jsxs("strong",{children:[X("tools.lastReset"),":"]})," ",O.lastResetYear]})]})]}),w.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200",children:[w.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[w.jsx(H,{className:"w-5 h-5 text-emerald-600",strokeWidth:2}),w.jsx("h3",{className:"text-lg font-bold text-emerald-600",children:X("tools.exportData")})]}),w.jsxs("div",{className:"space-y-3",children:[w.jsxs("button",{onClick:()=>{Ue({isOpen:!0,mode:"export",isProcessing:!1})},className:"w-full px-6 py-4 bg-blue-100 text-blue-800 border border-blue-300 rounded-lg hover:bg-blue-200 hover:border-blue-400 font-medium min-h-[48px] transition-all duration-150 flex items-center justify-center gap-2",children:[w.jsx(q,{className:"w-5 h-5",strokeWidth:2}),X("tools.exportFullBackup")]}),w.jsxs("button",{onClick:async()=>{try{const s=await g(()=>import("./vendor-xlsx-ByDo_lG2.js"),[]),r=await e.groups.toArray(),a=t.length>0?t:await e.participants.toArray(),l=new Map,n=new Map;r.forEach(e=>{l.set(e.courseStartDate,e.status),n.set(e.courseStartDate,e.groupNumber)});const i=[],c=[],d=[],m=[],u=e=>({"Company Name":e.companyName,"Person Name":e.personName,"Medical Date":o(e.medicalDate),"Course Start":o(e.courseStartDate),"Course End":o(e.courseEndDate),"Group No":n.get(e.courseStartDate)||"","Unique Number":e.uniqueNumber,Sent:e.sent?"Yes":"No",Documents:e.documents?"Yes":"No","Handed Over":e.handedOver?"Yes":"No",Paid:e.paid?"Yes":"No",Completed:(null!==e.completedOverride?e.completedOverride:e.completedComputed)?"Yes":"No"});a.forEach(e=>{const t=l.get(e.courseStartDate),s=u(e);"active"===t?i.push(s):"planned"===t?c.push(s):"completed"===t?d.push(s):m.push(s)});const x=s.utils.book_new(),p=(e,t,r)=>{if(0===e.length)return;r&&e.sort(r);const a=s.utils.json_to_sheet(e),o=Object.keys(e[0]||{}).map(e=>({wch:Math.max(e.length,15)}));a["!cols"]=o,s.utils.book_append_sheet(x,a,t)};if(p(i,"Active Groups",(e,t)=>(e["Unique Number"]||"").localeCompare(t["Unique Number"]||"")),p(c,"Planned Groups",(e,t)=>e["Course Start"].localeCompare(t["Course Start"])),p(d,"Archived Groups",(e,t)=>(t["Group No"]||0)-(e["Group No"]||0)),p(m,"Other"),0===x.SheetNames.length){const e=s.utils.json_to_sheet([{Info:"No data found to export"}]);s.utils.book_append_sheet(x,e,"Empty")}const h=s.write(x,{bookType:"xlsx",type:"array"}),b=new Blob([h],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),f=`course-export-${(new Date).toISOString().split("T")[0]}.xlsx`;await k(b,f)}catch(s){fe(X("common.error"),X("export.failedExcel"),"error")}},className:"w-full px-6 py-4 bg-emerald-100 text-emerald-800 border border-emerald-300 rounded-lg hover:bg-emerald-200 hover:border-emerald-400 font-medium min-h-[48px] transition-all duration-150 flex items-center justify-center gap-2",children:[w.jsx(V,{className:"w-5 h-5",strokeWidth:2}),X("tools.exportExcel")]}),w.jsxs("button",{onClick:async()=>{try{const s=["Company Name","Person Name","Medical Date","Course Start Date","Course End Date","Group Number","Unique Number","Sent","Documents","Handed Over","Paid","Completed"],r=t.length>0?await e.groups.toArray():[],a=new Map(r.map(e=>[e.courseStartDate,e.groupNumber])),l=t.map(e=>[e.companyName,e.personName,o(e.medicalDate),o(e.courseStartDate),o(e.courseEndDate),a.get(e.courseStartDate)||"",e.uniqueNumber,e.sent?"Yes":"No",e.documents?"Yes":"No",e.handedOver?"Yes":"No",e.paid?"Yes":"No",(null!==e.completedOverride?e.completedOverride:e.completedComputed)?"Yes":"No"]),n=[s.join(","),...l.map(e=>e.map(e=>`"${e}"`).join(","))].join("\n"),i=new Blob([n],{type:"text/csv"}),c=`course-export-${(new Date).toISOString().split("T")[0]}.csv`;await k(i,c)}catch(s){fe(X("common.error"),X("export.failedCSV"),"error")}},className:"w-full px-6 py-4 bg-slate-100 text-slate-800 border border-slate-300 rounded-lg hover:bg-slate-200 hover:border-slate-400 font-medium min-h-[48px] transition-all duration-150 flex items-center justify-center gap-2",children:[w.jsx(K,{className:"w-5 h-5",strokeWidth:2}),X("tools.exportCSV")]})]}),w.jsx("p",{className:"text-xs text-slate-500 mt-3",children:X("tools.exportNote")})]}),w.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200",children:[w.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[w.jsx(J,{className:"w-5 h-5 text-blue-600",strokeWidth:2}),w.jsx("h3",{className:"text-lg font-bold text-blue-600",children:X("tools.importData")})]}),w.jsxs("div",{className:"space-y-3",children:[w.jsxs("label",{className:"w-full px-6 py-4 bg-blue-100 text-blue-800 border border-blue-300 rounded-lg hover:bg-blue-200 hover:border-blue-400 cursor-pointer text-center font-medium min-h-[48px] transition-all duration-150 flex items-center justify-center gap-2",children:[w.jsx(H,{className:"w-5 h-5",strokeWidth:2}),X("tools.importMerge"),w.jsx("input",{type:"file",accept:".json",onChange:e=>{var t;(null==(t=e.target.files)?void 0:t[0])&&(rt(e.target.files[0],"merge"),e.target.value="")},className:"hidden",disabled:te})]}),w.jsxs("label",{className:"w-full px-6 py-4 bg-amber-100 text-amber-800 border border-amber-300 rounded-lg hover:bg-amber-200 hover:border-amber-400 cursor-pointer text-center font-medium min-h-[48px] transition-all duration-150 flex items-center justify-center gap-2",children:[w.jsx(E,{className:"w-5 h-5",strokeWidth:2}),X("tools.importReplace"),w.jsx("input",{type:"file",accept:".json",onChange:e=>{var t;(null==(t=e.target.files)?void 0:t[0])&&(rt(e.target.files[0],"replace"),e.target.value="")},className:"hidden",disabled:te})]})]}),w.jsxs("p",{className:"text-xs text-slate-500 mt-3",children:[X("tools.importMergeNote")," ",w.jsx("br",{}),w.jsx("span",{className:"text-amber-600 font-semibold",children:X("tools.importReplaceWarning")})]}),te&&!Re.isOpen&&w.jsx("div",{className:"text-center mt-4 text-blue-600 font-medium animate-pulse",children:"Processing..."})]}),w.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-sm border border-slate-200 mb-6",children:[w.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[w.jsx(C,{className:"w-5 h-5 text-amber-600",strokeWidth:2}),w.jsx("h3",{className:"text-lg font-bold text-amber-600",children:X("security.title")})]}),w.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[w.jsxs("div",{children:[w.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[w.jsx("h4",{className:"font-semibold text-slate-700",children:X(Le?"security.enabled":"security.disabled")}),Le&&w.jsx("span",{className:"text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded font-medium",children:X("security.active")})]}),w.jsx("p",{className:"text-sm text-slate-500 max-w-md",children:X(Le?"security.descriptionEnabled":"security.descriptionDisabled")})]}),w.jsx("div",{className:"flex flex-col gap-2",children:Le?w.jsxs(w.Fragment,{children:[w.jsx("button",{onClick:()=>i(),className:"px-4 py-2 bg-slate-800 text-white hover:bg-slate-900 rounded-lg text-sm font-medium transition-colors shadow-sm",children:X("security.lockNow")}),w.jsx("button",{onClick:()=>Be("disable"),className:"px-4 py-2 text-red-600 hover:bg-red-50 border border-red-200 rounded-lg text-sm font-medium transition-colors",children:X("security.disable")})]}):w.jsx("button",{onClick:()=>Be("setup"),className:"px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg text-sm font-medium transition-colors shadow-sm",children:X("security.setPin")})})]})]}),w.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md border-2 border-orange-200",children:[w.jsxs("button",{onClick:()=>ae(!re),className:"w-full flex items-center justify-between py-2 min-h-[44px]",children:[w.jsxs("div",{className:"flex items-center gap-2",children:[w.jsx(Z,{className:"w-5 h-5 text-orange-600",strokeWidth:2}),w.jsx("h3",{className:"text-lg font-bold text-orange-600",children:X("tools.advancedSettings")})]}),w.jsx(B,{className:"w-6 h-6 transition-transform "+(re?"rotate-180":""),strokeWidth:2})]}),re&&w.jsxs("div",{className:"mt-4 pt-4 border-t border-orange-200 space-y-6",children:[w.jsx(ue,{onArchive:()=>Oe(!0),onViewArchives:()=>qe(!0)}),w.jsx(he,{showAlert:fe})]})]}),w.jsx("div",{className:"bg-white p-6 rounded-lg shadow-md border-2 border-blue-200",children:w.jsxs("button",{onClick:()=>Me(!0),className:"w-full flex items-center justify-between py-2 min-h-[44px]",children:[w.jsxs("div",{className:"flex items-center gap-2",children:[w.jsx(P,{className:"w-5 h-5 text-blue-600",strokeWidth:2}),w.jsx("h3",{className:"text-lg font-bold text-blue-600",children:X("about.title")})]}),w.jsx(Q,{className:"w-6 h-6 text-blue-600",strokeWidth:2})]})}),w.jsx(de,{isOpen:Ye,onClose:()=>Me(!1),entitlement:r,entitlementLoading:A,onSignOut:D}),Ee&&w.jsx(xe,{isOpen:Ee,onClose:()=>{Oe(!1),Pe("")},onConfirm:async()=>{try{const t=(new Date).getFullYear(),s=await e.groups.toArray(),r=await e.participants.toArray(),a=s.some(e=>"active"===e.status),o=new Set(r.map(e=>e.courseStartDate)),l=s.filter(e=>"planned"===e.status).some(e=>o.has(e.courseStartDate));if(a||l)return fe(X("common.warning"),X("tools.archiveGuardFail"),"warning"),Oe(!1),void Pe("");const n=s.filter(e=>{if("completed"!==e.status)return!1;return new Date(e.courseStartDate).getFullYear()===t});if(0===n.length)return fe(X("common.info"),X("archive.noGroupsToArchive"),"info"),Oe(!1),void Pe("");const i=new Set(n.map(e=>e.courseStartDate)),c=r.filter(e=>i.has(e.courseStartDate)),d=`archive-${t}`;await e.yearlyArchives.put({id:d,year:t,groups:n,participants:c,archivedAt:(new Date).toISOString()}),await e.groups.bulkDelete(n.map(e=>e.id)),await e.participants.bulkDelete(c.map(e=>e.id));const m=await e.settings.get(1);m&&await e.settings.update(1,{lastUniquePrefix:m.lastUniquePrefix+1,lastUniqueSeq:0,lastResetYear:t}),fe(X("common.success"),X("tools.archiveYearSuccess",{count:n.length.toString()}),"success"),Oe(!1),Pe("")}catch(t){fe(X("common.error"),X("archive.error"),"error")}},confirmText:We,onConfirmTextChange:Pe}),Te&&w.jsx(pe,{isOpen:Te,onClose:()=>qe(!1),archives:et||[],onRestoreGroup:(e,t)=>Fe({year:e,groupNumber:t})}),w.jsx(n,{isOpen:null!==$e,onClose:()=>Fe(null),onConfirm:()=>{$e&&(async(t,s)=>{try{const r=`archive-${t}`,a=await e.yearlyArchives.get(r);if(!a)return void fe(X("common.error"),X("tools.restoreGroupNotFound"),"error");const o=a.groups.find(e=>e.groupNumber===s);if(!o)return void fe(X("common.error"),X("tools.restoreGroupGroupNotFound"),"error");const l=a.participants.filter(e=>e.courseStartDate===o.courseStartDate);if(await e.groups.where("groupNumber").equals(s).first())return void fe(X("common.error"),X("tools.restoreGroupExists",{number:s.toString()}),"error");await e.groups.add({...o,updatedAt:(new Date).toISOString()});for(const t of l)await e.participants.add(t);const n=a.groups.filter(e=>e.groupNumber!==s),i=a.participants.filter(e=>e.courseStartDate!==o.courseStartDate);0===n.length?await e.yearlyArchives.delete(r):await e.yearlyArchives.update(r,{groups:n,participants:i}),fe(X("common.success"),X("tools.restoreGroupSuccess",{number:s.toString()}),"success"),Fe(null)}catch(r){fe(X("common.error"),X("tools.restoreGroupError",{error:r.message}),"error")}})($e.year,$e.groupNumber)},title:X("tools.restoreGroupTitle"),message:X("tools.restoreGroupMessage",{number:(null==(G=null==$e?void 0:$e.groupNumber)?void 0:G.toString())||""}),confirmText:X("tools.restoreGroupConfirm"),cancelText:X("common.cancel"),variant:"warning"}),oe&&w.jsx(c,{isOpen:oe.isOpen,onClose:()=>me(null),title:oe.title,message:oe.message,variant:oe.variant}),ge&&w.jsx(n,{isOpen:ge.isOpen,onClose:()=>be(null),onConfirm:ge.onConfirm,title:ge.title,message:ge.message,confirmText:ge.confirmText,cancelText:X("common.cancel"),variant:ge.variant}),Ie&&w.jsx(d,{mode:Ie,onSuccess:()=>{Be(null),_e(a()),"setup"===Ie?fe(X("common.success"),X("security.setupSuccess"),"success"):"disable"===Ie&&fe(X("common.success"),X("security.disableSuccess"),"info")},onCancel:()=>Be(null)})]})},ue=({onArchive:t,onViewArchives:r})=>{const{t:a}=s(),o=(new Date).getFullYear(),l=S(()=>e.groups.toArray(),[]),n=S(()=>e.participants.toArray(),[]),i=(null==l?void 0:l.filter(e=>"active"===e.status).length)||0,c=new Set((n||[]).map(e=>e.courseStartDate)),d=(null==l?void 0:l.filter(e=>"planned"===e.status&&c.has(e.courseStartDate)).length)||0,m=i>0||d>0,u=!m,x=(null==l?void 0:l.filter(e=>{if("completed"!==e.status)return!1;return new Date(e.courseStartDate).getFullYear()===o}))||[],p=(null==n?void 0:n.filter(e=>x.some(t=>t.courseStartDate===e.courseStartDate)).length)||0;return w.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg border-2 border-purple-300",children:[w.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[w.jsx(I,{className:"w-5 h-5 text-purple-600",strokeWidth:2}),w.jsx("h4",{className:"text-lg font-bold text-purple-600",children:a("archive.title")})]}),w.jsx("p",{className:"text-sm text-slate-700 mb-4",children:a("archive.description")}),w.jsxs("div",{className:"bg-white border border-slate-300 rounded-lg p-3 mb-4",children:[w.jsx("h5",{className:"text-sm font-semibold text-slate-800 mb-2",children:a("tools.archiveReadinessTitle")}),w.jsxs("div",{className:"space-y-1.5",children:[w.jsxs("div",{className:"flex items-center justify-between text-sm",children:[w.jsxs("div",{className:"flex items-center gap-2",children:[0===i?w.jsx(U,{className:"w-5 h-5 text-emerald-600",strokeWidth:2}):w.jsx(X,{className:"w-5 h-5 text-amber-600",strokeWidth:2}),w.jsx("span",{className:"text-slate-700",children:a("tools.archiveActiveGroups")})]}),w.jsx("span",{className:"font-semibold "+(0===i?"text-emerald-700":"text-amber-700"),children:i})]}),w.jsxs("div",{className:"flex items-center justify-between text-sm",children:[w.jsxs("div",{className:"flex items-center gap-2",children:[0===d?w.jsx(U,{className:"w-5 h-5 text-emerald-600",strokeWidth:2}):w.jsx(X,{className:"w-5 h-5 text-amber-600",strokeWidth:2}),w.jsx("span",{className:"text-slate-700",children:a("tools.archivePlannedGroups")})]}),w.jsx("span",{className:"font-semibold "+(0===d?"text-emerald-700":"text-amber-700"),children:d})]})]}),w.jsxs("div",{className:"mt-3 pt-3 border-t border-slate-200",children:[u?w.jsxs("p",{className:"text-xs text-emerald-700 flex items-start gap-1.5",children:[w.jsx("span",{className:"text-emerald-600 mt-0.5",children:"âœ“"}),w.jsx("span",{children:a("tools.archiveReady")})]}):w.jsxs("p",{className:"text-xs text-amber-800 flex items-start gap-1.5",children:[w.jsx(P,{className:"w-4 h-4 text-amber-600 mt-0.5 flex-shrink-0",strokeWidth:2}),w.jsx("span",{children:a("tools.archiveNotReady")})]}),w.jsx("p",{className:"text-[11px] text-slate-500 mt-2",children:a("tools.archiveAutoPlannedNote")})]})]}),x.length>0?w.jsxs("div",{className:"bg-white p-3 rounded mb-4 text-sm space-y-1",children:[w.jsxs("p",{children:[w.jsxs("strong",{children:[a("archive.currentYear"),":"]})," ",o]}),w.jsxs("p",{children:[w.jsxs("strong",{children:[a("archive.groupsToArchive"),":"]})," ",x.length]}),w.jsxs("p",{children:[w.jsxs("strong",{children:[a("archive.participantsToArchive"),":"]})," ",p]})]}):w.jsx("div",{className:"bg-white p-3 rounded mb-4 text-sm text-slate-600",children:a("archive.noGroupsToArchive")}),w.jsxs("div",{className:"space-y-2",children:[w.jsx("button",{onClick:t,disabled:0===x.length||m,className:"w-full px-6 py-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-slate-400 disabled:cursor-not-allowed font-bold min-h-[48px] transition-colors",title:m?"ÐŸÑ€Ð¸ÐºÐ»ÑŽÑ‡ÐµÑ‚Ðµ Ð²ÑÐ¸Ñ‡ÐºÐ¸ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¸ Ð¸ Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð°Ð½Ð¸ Ð³Ñ€ÑƒÐ¿Ð¸":"ÐÑ€Ñ…Ð¸Ð²Ð¸Ñ€Ð°Ð¹ Ð¸ Ð½ÑƒÐ»Ð¸Ñ€Ð°Ð¹ Ð³Ð¾Ð´Ð¸ÑˆÐ½Ð¸Ñ Ð½Ð¾Ð¼ÐµÑ€",children:a("archive.button")}),w.jsxs("button",{onClick:r,className:"w-full px-6 py-4 bg-slate-600 text-white rounded-lg hover:bg-slate-700 font-medium min-h-[48px] transition-colors",children:["ðŸ“š ",a("archive.viewArchives")]})]})]})},xe=({isOpen:t,onClose:r,onConfirm:a,confirmText:o,onConfirmTextChange:l})=>{const{t:n}=s(),i=(new Date).getFullYear(),c=S(()=>e.groups.toArray(),[]),d=S(()=>e.participants.toArray(),[]),m=(null==c?void 0:c.some(e=>"active"===e.status))||!1,u=new Set((d||[]).map(e=>e.courseStartDate)),x=(null==c?void 0:c.some(e=>"planned"===e.status&&u.has(e.courseStartDate)))||!1,p=m||x,h=(null==c?void 0:c.filter(e=>{if("completed"!==e.status)return!1;return new Date(e.courseStartDate).getFullYear()===i}))||[],g=(null==d?void 0:d.filter(e=>h.some(t=>t.courseStartDate===e.courseStartDate)).length)||0,b=`ARCHIVE-${i}`,f=o===b&&!p;return t?w.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:w.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full",children:[w.jsx("h3",{className:"text-xl font-bold text-purple-600 mb-4",children:n("archive.confirmTitle")}),p?w.jsxs("div",{className:"bg-red-50 border-2 border-red-400 p-4 rounded mb-4",children:[w.jsx("p",{className:"text-sm text-red-900 font-semibold mb-2",children:n("tools.archiveCannotArchive")}),w.jsx("p",{className:"text-sm text-red-800 mb-3",children:n("tools.archiveCannotArchiveMessage")}),m&&w.jsx("p",{className:"text-xs text-red-700",children:n("tools.archiveHasActiveGroups")}),x&&w.jsx("p",{className:"text-xs text-red-700",children:n("tools.archiveHasPlannedGroups")})]}):w.jsx("p",{className:"text-slate-700 mb-4",children:n("tools.archiveConfirmMessage",{groups:h.length.toString(),participants:g.toString(),year:i.toString()})}),!p&&w.jsxs("div",{className:"mb-6",children:[w.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:[n("archive.typeToConfirm")," ",w.jsx("code",{className:"bg-slate-200 px-2 py-1 rounded",children:b})," ",n("archive.toConfirm"),":"]}),w.jsx("input",{type:"text",value:o,onChange:e=>l(e.target.value),placeholder:b,className:"w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"})]}),w.jsxs("div",{className:"flex gap-3",children:[w.jsx("button",{onClick:r,className:"flex-1 px-4 py-3 border border-slate-200 rounded-lg hover:bg-slate-50",children:n(p?"tools.archiveCloseButton":"common.cancel")}),!p&&w.jsx("button",{onClick:a,disabled:!f,className:"flex-1 px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed font-bold",children:n("archive.button")})]})]})}):null},pe=({isOpen:e,onClose:t,archives:r,onRestoreGroup:a})=>{const{t:l}=s(),[n,i]=N.useState(null),[c,d]=N.useState(null);return e?w.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:w.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[w.jsxs("div",{className:"flex justify-between items-center mb-4",children:[w.jsx("h3",{className:"text-xl font-bold text-slate-900",children:l("archive.yearlyArchives")}),w.jsx("button",{onClick:t,className:"p-2 hover:bg-slate-100 rounded-lg transition-colors",children:w.jsx(T,{className:"w-6 h-6",strokeWidth:2})})]}),0===r.length?w.jsx("p",{className:"text-slate-600 text-center py-8",children:l("archive.noArchives")}):w.jsx("div",{className:"space-y-4",children:r.sort((e,t)=>t.year-e.year).map(e=>w.jsxs("div",{className:"border border-slate-300 rounded-lg",children:[w.jsxs("button",{onClick:()=>i(n===e.year?null:e.year),className:"w-full px-4 py-3 flex items-center justify-between hover:bg-slate-50 transition-colors rounded-lg",children:[w.jsxs("div",{className:"flex items-center gap-3",children:[w.jsx(Q,{className:"w-5 h-5 text-slate-600 transition-transform "+(n===e.year?"rotate-90":""),strokeWidth:2}),w.jsxs("div",{className:"text-left",children:[w.jsxs("div",{className:"font-bold text-slate-900",children:[l("archive.year")," ",e.year]}),w.jsxs("div",{className:"text-sm text-slate-600",children:[e.groups.length," ",l("archive.groups"),", ",e.participants.length," ",l("archive.participants")]})]})]}),w.jsxs("div",{className:"text-xs text-slate-500",children:[l("archive.archived"),": ",o(e.archivedAt.split("T")[0])]})]}),n===e.year&&w.jsx("div",{className:"border-t border-slate-200 p-4 space-y-2",children:e.groups.sort((e,t)=>t.groupNumber-e.groupNumber).map(t=>{const s=e.participants.filter(e=>e.groupNumber===t.groupNumber);return w.jsxs("div",{className:"border border-slate-200 rounded-lg",children:[w.jsxs("button",{onClick:()=>d(c===t.groupNumber?null:t.groupNumber),className:"w-full px-3 py-2 flex items-center justify-between hover:bg-slate-50 transition-colors rounded-lg",children:[w.jsxs("div",{className:"flex items-center gap-2",children:[w.jsx(Q,{className:"w-4 h-4 text-slate-600 transition-transform "+(c===t.groupNumber?"rotate-90":""),strokeWidth:2}),w.jsxs("div",{className:"text-left",children:[w.jsxs("div",{className:"font-semibold text-slate-900",children:[l("group.number")," ",t.groupNumber]}),w.jsxs("div",{className:"text-xs text-slate-600",children:[o(t.courseStartDate)," - ",o(t.courseEndDate)]})]})]}),w.jsxs("div",{className:"text-xs text-slate-600",children:[s.length," ",l("archive.participants")]})]}),c===t.groupNumber&&w.jsxs("div",{className:"border-t border-slate-200 p-3",children:[w.jsxs("div",{className:"mb-3",children:[w.jsxs("button",{onClick:()=>a(e.year,t.groupNumber),className:"w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium transition-colors flex items-center justify-center gap-2",children:[w.jsx(J,{className:"w-5 h-5",strokeWidth:2}),l("tools.restoreGroupConfirm")]}),w.jsx("p",{className:"text-xs text-slate-600 mt-2 text-center",children:l("tools.restoreGroupWillRestore")})]}),w.jsx("div",{className:"space-y-2",children:s.map(e=>w.jsxs("div",{className:"bg-slate-50 p-2 rounded text-sm",children:[w.jsx("div",{className:"font-semibold text-slate-900",children:e.personName}),w.jsx("div",{className:"text-slate-600",children:e.companyName}),w.jsxs("div",{className:"text-xs text-slate-500 mt-1",children:[l("participant.uniqueNumber"),": ",e.uniqueNumber]})]},e.id))})]})]},t.id)})})]},e.id))}),w.jsx("div",{className:"mt-6",children:w.jsx("button",{onClick:t,className:"w-full px-6 py-3 bg-slate-600 text-white rounded-lg hover:bg-slate-700 font-medium",children:l("common.close")})})]})}):null},he=({showAlert:t})=>{const{settings:r,resetYearlySequence:a}=ee(),{t:o}=s(),[l,n]=N.useState(!1),[i,c]=N.useState(""),[d,m]=N.useState(!1),u=S(()=>e.participants.toArray(),[]),x=(null==u?void 0:u.reduce((e,t)=>{const s=parseInt(t.uniqueNumber.split("-")[0],10);return s>e?s:e},0))||0,p=`RESET-${(new Date).getFullYear()}`,h=l&&i===p;return w.jsxs("div",{className:"bg-red-50 p-4 rounded-lg border-2 border-red-300",children:[w.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[w.jsx(E,{className:"w-5 h-5 text-red-600",strokeWidth:2}),w.jsx("h4",{className:"text-lg font-bold text-red-600",children:o("tools.dangerZone")})]}),w.jsx("p",{className:"text-sm text-slate-700 mb-4",children:o("tools.resetSequenceDescription2")}),r&&w.jsxs("div",{className:"bg-white p-3 rounded mb-4 text-sm",children:[w.jsxs("p",{children:[w.jsxs("strong",{children:[o("tools.current"),":"]})," ",r.lastUniquePrefix.toString().padStart(4,"0"),"-",r.lastUniqueSeq.toString().padStart(3,"0")]}),w.jsxs("p",{children:[w.jsxs("strong",{children:[o("tools.nextAfterReset"),":"]})," ",(x+1).toString().padStart(4,"0"),"-001"]})]}),w.jsxs("div",{className:"space-y-4",children:[w.jsxs("label",{className:"flex items-start gap-3 cursor-pointer min-h-[44px]",children:[w.jsx("input",{type:"checkbox",checked:l,onChange:e=>n(e.target.checked),className:"mt-1 w-5 h-5 text-red-600 rounded border-slate-300 focus:ring-red-500"}),w.jsx("span",{className:"text-sm text-slate-700 flex-1",children:o("tools.resetSequenceCheckbox")})]}),w.jsxs("div",{children:[w.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:[o("tools.typeToConfirm",{text:p}),": ",w.jsx("code",{className:"bg-slate-200 px-2 py-1 rounded",children:p})]}),w.jsx("input",{type:"text",value:i,onChange:e=>c(e.target.value),placeholder:p,className:"w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 min-h-[44px]",disabled:!l})]}),w.jsx("button",{onClick:()=>{m(!0)},disabled:!h,className:"w-full px-6 py-4 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed font-bold min-h-[48px]",children:o("tools.resetButton")})]}),d&&w.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:w.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full",children:[w.jsx("h3",{className:"text-xl font-bold text-red-600 mb-4",children:o("modal.finalConfirmation")}),w.jsx("p",{className:"text-slate-700 mb-6",children:o("tools.resetSequenceFinalConfirm")}),w.jsxs("div",{className:"flex gap-3",children:[w.jsx("button",{onClick:()=>m(!1),className:"flex-1 px-4 py-3 border border-slate-200 rounded-lg hover:bg-slate-50 min-h-[48px]",children:o("tools.resetSequenceCancel")}),w.jsx("button",{onClick:async()=>{try{await a(),t(o("common.success"),o("tools.resetSequenceSuccess"),"success"),n(!1),c(""),m(!1)}catch(e){t(o("common.error"),o("tools.resetSequenceFailed"),"error")}},className:"flex-1 px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold min-h-[48px]",children:o("tools.resetSequenceConfirmButton")})]})]})})]})};export{me as ToolsPage};
