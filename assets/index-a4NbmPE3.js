const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/certificateGenerator-BQdzjMuI.js","assets/vendor-misc-VdyTtt_u.js","assets/fileDownload-0ohKhoX7.js","assets/vendor-react-3uLv-P3n.js","assets/vendor-dexie-mu9yNVYX.js","assets/vendor-dates-Dk0ftcM6.js","assets/vendor-uuid-CtRu48qb.js","assets/vendor-icons-QXWXkYnp.js","assets/vendor-supabase-CXFbbOpx.js","assets/ToolsPage-Bx1A0yzC.js"])))=>i.map(i=>d[i]);
var Jt=Object.defineProperty;var Qt=(t,s,a)=>s in t?Jt(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a;var we=(t,s,a)=>Qt(t,typeof s!="symbol"?s+"":s,a);import{r as x,j as e,R as jt,c as Zt}from"./vendor-react-3uLv-P3n.js";import{X as es,u as ye}from"./vendor-dexie-mu9yNVYX.js";import{p as Re,f as ts,i as ss,a as as,s as yt}from"./vendor-dates-Dk0ftcM6.js";import{v as St}from"./vendor-uuid-CtRu48qb.js";import{I as kt,C as _e,T as et,A as rs,a as ns,b as os,c as ls,U as is,X as cs,H as ds,M as us,d as ms,e as ps,L as Dt,S as xs,D as hs,f as Ue,g as Ct,E as ut,h as mt,G as pt}from"./vendor-icons-QXWXkYnp.js";import{c as fs}from"./vendor-supabase-CXFbbOpx.js";import"./vendor-misc-VdyTtt_u.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const l of o)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function a(o){const l={};return o.integrity&&(l.integrity=o.integrity),o.referrerPolicy&&(l.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?l.credentials="include":o.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function n(o){if(o.ep)return;o.ep=!0;const l=a(o);fetch(o.href,l)}})();const bs="modulepreload",gs=function(t){return"/Certify-app/"+t},xt={},qe=function(s,a,n){let o=Promise.resolve();if(a&&a.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),i=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));o=Promise.allSettled(a.map(d=>{if(d=gs(d),d in xt)return;xt[d]=!0;const u=d.endsWith(".css"),m=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${m}`))return;const S=document.createElement("link");if(S.rel=u?"stylesheet":bs,u||(S.as="script"),S.crossOrigin="",S.href=d,i&&S.setAttribute("nonce",i),document.head.appendChild(S),u)return new Promise((N,$)=>{S.addEventListener("load",N),S.addEventListener("error",()=>$(new Error(`Unable to preload CSS for ${d}`)))})}))}function l(r){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=r,window.dispatchEvent(i),!i.defaultPrevented)throw r}return o.then(r=>{for(const i of r||[])i.status==="rejected"&&l(i.reason);return s().catch(l)})};function ws(t){const s=new Date(t),a=s.getDay();if(a===1)return s;const n=a===0?1:8-a;return s.setDate(s.getDate()+n),s}function ze(t){const s=new Date(t),a=ws(s),n=new Date(a);return n.setDate(n.getDate()+7),{courseStartDate:a.toISOString().split("T")[0],courseEndDate:n.toISOString().split("T")[0]}}function ya(t,s,a,n){if(!t)return n;const o=t instanceof Date?t:new Date(t);return Number.isNaN(o.getTime())?n:new Intl.DateTimeFormat(s,{timeZone:a,day:"2-digit",month:"2-digit",year:"numeric"}).format(o)}const Ns="APP_READ_ONLY_ERROR";let Et=!1;function De(t){Et=t}function Qe(){if(Et){const t=new Error("Read-only mode is enabled. Subscription access has expired.");throw t.name=Ns,t}}class vs extends es{constructor(){super("CourseManagementDB");we(this,"groups");we(this,"participants");we(this,"settings");we(this,"yearlyArchives");this.version(1).stores({groups:"id, groupNumber, courseStartDate",participants:"id, groupNumber, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}),this.version(2).stores({groups:"id, groupNumber, courseStartDate",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}).upgrade(a=>a.table("participants").toCollection().modify(n=>{n.autoGroup=n.groupNumber,n.manualGroup=null})),this.version(3).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}).upgrade(a=>{const n=new Date().toISOString();return a.table("groups").toCollection().modify(o=>{o.status=o.groupNumber===1?"active":"planned",o.createdAt=n,o.updatedAt=n})}),this.version(4).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}).upgrade(a=>{const n=new Date().toISOString();a.table("participants").toCollection().modify(o=>{o.createdAt=o.createdAt||n,o.updatedAt=o.updatedAt||n,(o.completedComputed||o.completedOverride===!0)&&(o.completedAt=o.completedAt||n)}),a.table("groups").toCollection().modify(o=>{o.isLocked=o.status==="completed"})}),this.version(5).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id",yearlyArchives:"id, year"}),this.version(6).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate, egn",settings:"id",yearlyArchives:"id, year"}).upgrade(a=>a.table("participants").toCollection().modify(n=>{n.egn=n.egn||"",n.birthPlace=n.birthPlace||"",n.citizenship=n.citizenship||"българско"})),this.version(7).stores({groups:"id, courseStartDate, status, groupNumber",participants:"id, courseStartDate, uniqueNumber, companyName, personName, egn",settings:"id",yearlyArchives:"id, year"}).upgrade(async a=>{await a.table("participants").toCollection().modify(n=>{delete n.groupNumber,delete n.autoGroup,delete n.manualGroup}),await a.table("groups").toCollection().modify(n=>{n.status==="planned"&&(n.groupNumber=null)})}),[this.groups,this.participants,this.settings,this.yearlyArchives].forEach(a=>{a.hook("creating",()=>{Qe()}),a.hook("updating",()=>{Qe()}),a.hook("deleting",()=>{Qe()})})}}const D=new vs;async function js(){try{if(await D.settings.count()===0)await D.settings.add({id:1,lastUniquePrefix:3533,lastUniqueSeq:0,lastResetYear:null});else{const s=await D.settings.get(1);s&&s.lastUniquePrefix<=3531&&(await D.settings.update(1,{lastUniquePrefix:3533,lastUniqueSeq:0}),console.log("✅ Updated unique number prefix to 3533 for 2026"))}}catch(t){console.error("Failed to initialize settings:",t)}}js().catch(t=>{console.error("CRITICAL DB INIT FAILURE:",t)});function fe(t,s){return`${t.toString().padStart(4,"0")}-${s}`}function Se(t){const s=t.match(/^(\d{4})-(\d+)$/);return s?{prefix:parseInt(s[1],10),seq:parseInt(s[2],10)}:null}async function Ye(t=!1){const s=await D.participants.toArray();let a=null;for(const n of s){if(!n.uniqueNumber)continue;const o=Se(n.uniqueNumber);o&&(a?(o.prefix>a.prefix||o.prefix===a.prefix&&o.seq>a.seq)&&(a=o):a=o)}if(!t){const n=await D.settings.get(1);if(n){const o={prefix:n.lastUniquePrefix,seq:n.lastUniqueSeq};a?(o.prefix>a.prefix||o.prefix===a.prefix&&o.seq>a.seq)&&(a=o):a=o}}return a}async function We(){const t=await D.settings.get(1);if(!t)throw new Error("Settings not initialized");let s=t.lastUniquePrefix,a=t.lastUniqueSeq;const n=await Ye();n&&(n.prefix>s?(s=n.prefix,a=n.seq):n.prefix===s&&n.seq>a&&(a=n.seq));const o=s+1,l=a+1;return fe(o,l)}async function At(t){const s=await D.groups.get(t);if(!s)return;if(s.status!=="active"){console.warn(`Attempted to assign numbers to non-active group ${t}`);return}const n=(await D.participants.where("courseStartDate").equals(s.courseStartDate).toArray()).filter(u=>!u.uniqueNumber);if(n.length===0)return;n.sort((u,m)=>{const S=new Date(u.createdAt||0).getTime(),N=new Date(m.createdAt||0).getTime();return S!==N?S-N:(u.id||"").localeCompare(m.id||"")});const o=await D.settings.get(1);if(!o)throw new Error("Settings not initialized");let l=o.lastUniquePrefix,r=o.lastUniqueSeq;const i=await Ye();i&&(i.prefix>l?(l=i.prefix,r=i.seq):i.prefix===l&&i.seq>r&&(r=i.seq));const d=[];for(const u of n){l++,r++;const m=fe(l,r);d.push({id:u.id,uniqueNumber:m})}for(const u of d)await D.participants.update(u.id,{uniqueNumber:u.uniqueNumber});await D.settings.update(1,{lastUniquePrefix:l,lastUniqueSeq:r})}async function Sa(){const t=await D.settings.get(1);if(!t)return;const s=t.lastUniquePrefix+1;await D.settings.update(1,{lastUniquePrefix:s,lastUniqueSeq:0,lastResetYear:new Date().getFullYear()})}async function ht(t){const s=Se(t);if(!s)return;const{prefix:a}=s,n=await D.participants.filter(r=>!!r.uniqueNumber).toArray(),o=[];for(const r of n){const i=Se(r.uniqueNumber);if(i&&i.prefix>a){const d=i.prefix-1,u=i.seq-1,m=fe(d,u);o.push({id:r.id,newNum:m,newPrefix:d,newSeq:u})}}for(const r of o)await D.participants.update(r.id,{uniqueNumber:r.newNum});const l=await Ye();l&&await D.settings.update(1,{lastUniquePrefix:l.prefix,lastUniqueSeq:l.seq})}async function tt(t,s){const n=await D.participants.where("uniqueNumber").equals(t).toArray();return s?n.length===0||n.length===1&&n[0].id===s:n.length===0}async function st(){const s=(await D.participants.toArray()).filter(n=>n.uniqueNumber).map(n=>Se(n.uniqueNumber)).filter(n=>n!==null).sort((n,o)=>n.prefix!==o.prefix?n.prefix-o.prefix:n.seq-o.seq);if(console.log("[checkForGaps] Numbers in DB:",s.map(n=>fe(n.prefix,n.seq))),s.length===0)return null;for(let n=0;n<s.length-1;n++){const o=s[n];if(s[n+1].prefix!==o.prefix+1){const r=fe(o.prefix+1,o.seq+1);return console.log("[checkForGaps] Gap found between numbers:",r),r}}const a=await D.settings.get(1);if(console.log("[checkForGaps] Settings:",a?`${a.lastUniquePrefix}-${a.lastUniqueSeq}`:"none"),a&&s.length>0){const n=s[s.length-1];if(console.log("[checkForGaps] Last in DB:",fe(n.prefix,n.seq)),a.lastUniquePrefix>n.prefix){const o=fe(n.prefix+1,n.seq+1);return console.log("[checkForGaps] Gap found after last number:",o),o}}return console.log("[checkForGaps] No gaps found"),null}function ys(t){return/^\d{4}-\d+$/.test(t)}async function Pt(t){const s=await D.participants.where("courseStartDate").equals(t).toArray();for(const n of s)n.uniqueNumber&&await D.participants.update(n.id,{uniqueNumber:""});const a=await Ye(!0);a&&await D.settings.update(1,{lastUniquePrefix:a.prefix,lastUniqueSeq:a.seq})}function Ss(t){const a=yt(new Date);return Re(t)>=a}function be(t,s){const a=Re(t),n=Re(s);if(!ss(a,n)&&!as(a,n))return!1;const o=yt(n);return a>=o}function L(t){try{const s=Re(t);return ts(s,"dd.MM.yyyy")}catch{return t}}const Be="Медицинското трябва да е в рамките на 6 месеца преди началото на курса.";async function ue(){return D.groups.where("status").equals("active").first()}async function ks(t){const s=await D.groups.where("courseStartDate").equals(t).first();s&&await At(s.id)}async function ka(){return D.groups.where("status").equals("planned").sortBy("courseStartDate")}async function Fe(t){const{courseStartDate:s}=ze(t),a=await D.groups.toArray(),n=a.find(r=>r.status==="active"),o=a.filter(r=>r.status==="planned").sort((r,i)=>r.courseStartDate.localeCompare(i.courseStartDate));if(n&&s<=n.courseStartDate&&be(t,n.courseStartDate))return{group:n,shouldCreate:!1};const l=a.find(r=>r.courseStartDate===s);if(l&&l.status==="completed"){const r=[];n&&r.push(n),r.push(...o),r.sort((d,u)=>d.courseStartDate.localeCompare(u.courseStartDate));const i=r.find(d=>d.courseStartDate<s?!1:be(t,d.courseStartDate));return i?{group:i,shouldCreate:!1}:{group:l,shouldCreate:!1}}return l?{group:l,shouldCreate:!1}:n&&s<n.courseStartDate?{group:{id:"stub_past",status:"completed",courseStartDate:s,courseEndDate:"",groupNumber:-1,createdAt:"",updatedAt:"",isLocked:!0},shouldCreate:!1}:{group:null,shouldCreate:!0,createsForDate:s}}async function at(t,s="planned"){const a=await D.groups.where("courseStartDate").equals(t).first();if(a)return a.status!==s&&s==="active"&&console.warn(`Group for ${t} already exists with status ${a.status}. Returning existing.`),a;let n=null;s==="active"&&(n=null);const o=new Date(t);o.setDate(o.getDate()+7);const l=new Date().toISOString(),r={id:St(),groupNumber:n,courseStartDate:t,courseEndDate:o.toISOString().split("T")[0],status:s,createdAt:l,updatedAt:l,isLocked:!1};return await D.groups.add(r),r}async function Da(){const t=await ue();if(!t)throw new Error("No active group to close");const s=new Date().toISOString();let a=t.groupNumber;if(a==null){const n=await D.groups.where("status").equals("completed").toArray(),o=new Set(n.map(r=>r.groupNumber).filter(r=>r!=null&&r>0));let l=1;for(;o.has(l);)l++;a=l,console.log(`Assigning Group Number ${a} to closed group (Gap filling/Next sequential)`)}await D.groups.update(t.id,{status:"completed",groupNumber:a,updatedAt:s,closedAt:s,isLocked:!0})}async function Ae(){const t=await D.participants.toArray(),s=await D.groups.toArray(),a=s.find(f=>f.status==="active");if(a&&(a.groupNumber===null||a.groupNumber===void 0)){const f=new Set(s.map(b=>b.groupNumber).filter(b=>b!=null&&b>0));let h=1;for(;f.has(h);)h++;await D.groups.update(a.id,{groupNumber:h,updatedAt:new Date().toISOString()}),console.log(`✅ Assigned Group Number ${h} to active group`)}const n=s.filter(f=>f.status==="active");for(const f of n)await ks(f.courseStartDate);for(const f of s){const h=new Date(f.courseStartDate);if(h.getDay()!==1){console.warn(`Found invalid group start date ${f.courseStartDate} (Day: ${h.getDay()}). Fixing to Monday.`);const b=h.getDay(),C=b===0?1:8-b,A=new Date(h);A.setDate(h.getDate()+C);const T=A.toISOString().split("T")[0];await D.groups.update(f.id,{courseStartDate:T,courseEndDate:new Date(A.getTime()+7*24*60*60*1e3).toISOString().split("T")[0]});const G=t.filter(_=>_.courseStartDate===f.courseStartDate);for(const _ of G)await D.participants.update(_.id,{courseStartDate:T,courseEndDate:new Date(A.getTime()+7*24*60*60*1e3).toISOString().split("T")[0]})}}const o=new Set;t.forEach(f=>o.add(f.courseStartDate));let l;if(a)l=new Date(a.courseStartDate);else{const f=new Date,h=f.getDay(),b=h===0?1:h===1?0:8-h;l=new Date(f),l.setHours(12,0,0,0),l.setDate(f.getDate()+b)}const r=new Date(l);r.setDate(r.getDate()+7);const i=new Date(l);i.setDate(i.getDate()+14),o.add(r.toISOString().split("T")[0]),o.add(i.toISOString().split("T")[0]);const d=new Set(s.map(f=>f.courseStartDate));for(const f of o)d.has(f)||(console.log(`Creating missing planned group for ${f}`),await at(f,"planned"));const u=await D.groups.toArray(),m=new Map;t.forEach(f=>{m.set(f.courseStartDate,(m.get(f.courseStartDate)||0)+1)});const S=new Map;u.forEach(f=>{const h=S.get(f.courseStartDate)||[];h.push(f),S.set(f.courseStartDate,h)});for(const[f,h]of S)if(h.length>1){console.warn(`Found ${h.length} duplicate groups for ${f}. Merging and cleaning up...`);const b=h.sort((T,G)=>{const _=U=>U.status==="completed"?3:U.status==="active"?2:1,q=_(T),M=_(G);return q!==M?M-q:0}),C=b[0],A=b.slice(1);for(const T of A)console.warn(`Merging participants from duplicate group ${T.id} to ${C.id}`),await D.groups.delete(T.id)}const N=await D.groups.toArray(),$=N.find(f=>f.status==="active");if($){const f=N.filter(h=>h.status==="planned"&&h.courseStartDate<$.courseStartDate&&(m.get(h.courseStartDate)||0)===0);for(const h of f)console.log(`Removing old empty planned group before active: ${h.courseStartDate}`),await D.groups.delete(h.id)}const P=(await D.groups.toArray()).filter(f=>f.status==="planned");if(P.length>2){const f=P.filter(b=>(m.get(b.courseStartDate)||0)===0);let h=P.length;f.sort((b,C)=>C.courseStartDate.localeCompare(b.courseStartDate));for(const b of f){if(h<=2)break;console.log(`Pruning excess empty planned group: ${b.courseStartDate}`),await D.groups.delete(b.id),h--}}}function Ce(t){return t?t.status==="completed"&&t.isLocked:!1}async function Ca(){return D.groups.where("status").equals("completed").reverse().sortBy("groupNumber")}async function Ea(t){const s=await D.groups.get(t);if(!s)throw new Error("Group not found");if(s.status==="active")return{success:!0};const a=await ue();return a&&a.id!==t?{success:!1,needsConfirm:!0,currentActive:a}:await Ot(t)}async function Ot(t,s=!1){const a=await D.groups.get(t);if(!a)throw new Error("Group not found");const n=new Date().toISOString();if(s){const l=await ue();l&&(await D.groups.update(l.id,{status:"planned",updatedAt:n,activatedAt:void 0,groupNumber:null}),await Pt(l.courseStartDate))}let o=a.groupNumber;if(a.status==="planned"&&o===null){const l=await D.groups.toArray(),r=new Set(l.map(d=>d.groupNumber).filter(d=>d!=null&&d>0));let i=1;for(;r.has(i);)i++;o=i,console.log(`Assigning Group Number ${o} to newly activated group`)}return await D.groups.update(t,{groupNumber:o,status:"active",activatedAt:n,updatedAt:n,isLocked:!1}),await At(t),{success:!0}}async function Aa(){const t=await ue();if(!t)throw new Error("No active group to set as planned");const s=new Date().toISOString();await D.groups.update(t.id,{status:"planned",updatedAt:s,activatedAt:void 0}),await Pt(t.courseStartDate)}async function Pa(t){const s=await D.groups.get(t);if(!s)throw new Error("Group not found");if(s.status!=="completed")throw new Error("Only archived groups can be reopened");const a=await ue();return a?{success:!1,needsConfirm:!0,currentActive:a}:await Ot(t)}async function Ds(){const t=await D.groups.where("status").equals("active").toArray();if(t.length<=1)return;console.warn(`⚠️ Found ${t.length} active groups! Fixing...`);const s=t.sort((l,r)=>new Date(r.updatedAt).getTime()-new Date(l.updatedAt).getTime()),a=s[0],n=s.slice(1),o=new Date().toISOString();for(const l of n)await D.groups.update(l.id,{status:"planned",updatedAt:o,activatedAt:void 0}),console.warn(`⚠️ Moved Group ${l.groupNumber} from active to planned`);console.log(`✅ Kept Group ${a.groupNumber} as active`)}async function Cs(){return D.participants.orderBy("courseStartDate").toArray()}async function Pe(t){return D.participants.get(t)}async function Es(t){await D.participants.add(t)}async function He(t,s){await D.participants.update(t,s)}async function As(t){await D.participants.delete(t)}async function Ps(t){return D.participants.where("courseStartDate").equals(t).count()}async function ft(){return(await D.groups.toArray()).sort((s,a)=>s.courseStartDate.localeCompare(a.courseStartDate))}async function Os(t){return D.groups.where("groupNumber").equals(t).first()}async function qs(t){return D.groups.where("courseStartDate").equals(t).toArray()}async function Ve(t){return D.groups.where("courseStartDate").equals(t).first()}function Ke(){return{participants:ye(()=>Cs()),addParticipant:async r=>{const{courseStartDate:i}=ze(r.medicalDate);if(!be(r.medicalDate,i))throw new Error(Be);const{group:d,shouldCreate:u,createsForDate:m}=await Fe(r.medicalDate),S=d?d.courseStartDate:m||i,N=(()=>{const b=new Date(S);return b.setDate(b.getDate()+7),b.toISOString().split("T")[0]})();if(!be(r.medicalDate,S))throw new Error(Be);if((await qs(S)).some(b=>b.status==="completed"))throw new Error("Не може да добавяте нови участници към приключила група (периодът е архивиран).");if((d==null?void 0:d.status)==="completed")throw new Error("Не може да добавяте нови участници към приключила група.");if(u){const C=await ue()?"planned":"active";await at(S,C)}let k;if(r.uniqueNumber){if(!await tt(r.uniqueNumber))throw new Error("Unique number already exists");k=r.uniqueNumber}else(d==null?void 0:d.status)==="active"?k=await We():k="";const P=!1,f=new Date().toISOString(),h={id:St(),companyName:r.companyName,personName:r.personName,egn:r.egn||"",birthPlace:r.birthPlace||"",citizenship:r.citizenship||"българско",medicalDate:r.medicalDate,courseStartDate:S,courseEndDate:N,uniqueNumber:k,sent:!1,documents:!1,handedOver:!1,paid:!1,completedOverride:null,completedComputed:P,createdAt:f,updatedAt:f};return await Es(h),await Ae(),h},updateParticipant:async(r,i)=>{const d=await Pe(r);if(!d)throw new Error("Participant not found");const u=await Ve(d.courseStartDate);if(Ce(u))throw new Error("Не може да редактирате участник от заключена група. Моля отключете групата първо от Tools.");const m={};let S=null;if(i.companyName!==void 0&&(m.companyName=i.companyName),i.personName!==void 0&&(m.personName=i.personName),i.egn!==void 0&&(m.egn=i.egn),i.birthPlace!==void 0&&(m.birthPlace=i.birthPlace),i.citizenship!==void 0&&(m.citizenship=i.citizenship),i.medicalDate&&i.medicalDate!==d.medicalDate){const{group:C,shouldCreate:A,createsForDate:T}=await Fe(i.medicalDate),{courseStartDate:G}=ze(i.medicalDate),_=C?C.courseStartDate:T||G,q=(()=>{const B=new Date(_);return B.setDate(B.getDate()+7),B.toISOString().split("T")[0]})();if(!be(i.medicalDate,_))throw new Error(Be);if((C==null?void 0:C.status)==="completed")throw new Error("Медицинският преглед отговаря на приключила група (периодът е архивиран).");if(A){const z=await ue()?"planned":"active";await at(_,z)}m.medicalDate=i.medicalDate,m.courseStartDate=_,m.courseEndDate=q;const M=await Ve(d.courseStartDate),U=(M==null?void 0:M.status)||"planned",v=(C==null?void 0:C.status)||"planned";if(v==="active"&&U!=="active"){const B=await st();B?m.uniqueNumber=B:m.uniqueNumber=await We()}else if(U==="active"&&v==="planned"){const B=d.uniqueNumber;m.uniqueNumber="",B&&(S=B)}}if(i.uniqueNumber&&i.uniqueNumber!==d.uniqueNumber){if(!await tt(i.uniqueNumber,r))throw new Error("Unique number already exists");m.uniqueNumber=i.uniqueNumber}i.sent!==void 0&&(m.sent=i.sent),i.documents!==void 0&&(m.documents=i.documents),i.handedOver!==void 0&&(m.handedOver=i.handedOver),i.paid!==void 0&&(m.paid=i.paid);const N=m.sent!==void 0?m.sent:d.sent,$=m.documents!==void 0?m.documents:d.documents,k=m.handedOver!==void 0?m.handedOver:d.handedOver,P=m.paid!==void 0?m.paid:d.paid,f=N&&$&&k&&P;m.completedComputed=f,m.updatedAt=new Date().toISOString();const h=d.completedOverride!==null?d.completedOverride:d.completedComputed,b=m.completedOverride!==void 0&&m.completedOverride!==null?m.completedOverride:m.completedOverride===null?f:d.completedOverride!==null?d.completedOverride:f;!h&&b&&(m.completedAt=new Date().toISOString()),await He(r,m),S&&await ht(S),await Ae()},deleteParticipant:async r=>{const i=await Pe(r);await As(r),i&&i.uniqueNumber&&await ht(i.uniqueNumber),await Ae()},resetCompletedOverride:async r=>{await He(r,{completedOverride:null})},getParticipant:async r=>Pe(r)}}function Ms(){return{groups:ye(async()=>ft()),getGroup:async n=>Os(n),getGroupsWithCounts:async()=>{const n=await ft();return await Promise.all(n.map(async l=>{const r=await Ps(l.courseStartDate);return{...l,participantCount:r}}))}}}const se={active:"groups-collapsed-active",planned:"groups-collapsed-planned",completed:"groups-collapsed-completed"};function Ls(){const[t,s]=x.useState(()=>{const i=localStorage.getItem(se.active),d=localStorage.getItem(se.planned),u=localStorage.getItem(se.completed);return d==="true"||i==="true"?(localStorage.setItem(se.active,"false"),localStorage.setItem(se.planned,"false"),localStorage.setItem(se.completed,"true"),{active:!1,planned:!1,completed:!0}):{active:i==="true",planned:d==="true",completed:u===null?!0:u==="true"}});return x.useEffect(()=>{localStorage.setItem(se.active,String(t.active)),localStorage.setItem(se.planned,String(t.planned)),localStorage.setItem(se.completed,String(t.completed))},[t]),{collapsedSections:t,toggleSection:i=>{s(d=>({...d,[i]:!d[i]}))},expandSection:i=>{s(d=>({...d,[i]:!1}))},expandAll:()=>{s({active:!1,planned:!1,completed:!1})},resetToDefaults:()=>{s({active:!1,planned:!1,completed:!0}),localStorage.setItem(se.active,"false"),localStorage.setItem(se.planned,"false"),localStorage.setItem(se.completed,"true")},setCollapsedState:i=>{s(i)}}}const Is=(t,s,a)=>{const n=t[s];return n?typeof n=="function"?n():Promise.resolve(n):new Promise((o,l)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(l.bind(null,new Error("Unknown variable dynamic import: "+s+(s.split("/").length!==a?". Note that variables only represent file names one level deep.":""))))})},qt=x.createContext(void 0),$s=({children:t})=>{const[s,a]=x.useState(()=>{const i=localStorage.getItem("app-language");return i==="bg"||i==="en"?i:"en"}),[n,o]=x.useState({});x.useEffect(()=>{(async()=>{const d=await Is(Object.assign({"../locales/bg.ts":()=>qe(()=>import("./bg-2-bdpX8K.js"),[]),"../locales/en.ts":()=>qe(()=>import("./en-BmU_mF-p.js"),[])}),`../locales/${s}.ts`,3);o(d.default)})()},[s]);const l=i=>{a(i),localStorage.setItem("app-language",i)},r=(i,d)=>{let u=n[i]||i;return d&&Object.entries(d).forEach(([m,S])=>{u=u.replace(`{${m}}`,S)}),u};return e.jsx(qt.Provider,{value:{language:s,setLanguage:l,t:r},children:t})},X=()=>{const t=x.useContext(qt);if(!t)throw new Error("useLanguage must be used within LanguageProvider");return t},Me=({isOpen:t,onClose:s,onConfirm:a,title:n,message:o,confirmText:l="Confirm",cancelText:r="Cancel",variant:i="info"})=>{if(x.useEffect(()=>{const S=N=>{N.key==="Escape"&&s()};if(t)return document.addEventListener("keydown",S),()=>document.removeEventListener("keydown",S)},[t,s]),!t)return null;const d=()=>{switch(i){case"danger":return e.jsx(et,{className:"w-6 h-6 text-red-600"});case"warning":return e.jsx(et,{className:"w-6 h-6 text-amber-600"});case"success":return e.jsx(_e,{className:"w-6 h-6 text-emerald-600"});default:return e.jsx(kt,{className:"w-6 h-6 text-blue-600"})}},u=()=>{switch(i){case"danger":return"bg-red-50 text-red-900 border-red-100";case"warning":return"bg-amber-50 text-amber-900 border-amber-100";case"success":return"bg-emerald-50 text-emerald-900 border-emerald-100";default:return"bg-blue-50 text-blue-900 border-blue-100"}},m=()=>{switch(i){case"danger":return"bg-red-600 hover:bg-red-700 focus:ring-red-500";case"warning":return"bg-amber-600 hover:bg-amber-700 focus:ring-amber-500";case"success":return"bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500";default:return"bg-blue-600 hover:bg-blue-700 focus:ring-blue-500"}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 transition-opacity",onClick:s}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden animate-scale-up transform transition-all",children:[e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:`p-3 rounded-full flex-shrink-0 ${u()} bg-opacity-50`,children:d()}),e.jsxs("div",{className:"flex-1 pt-1",children:[e.jsx("h3",{className:"text-xl font-bold text-slate-900 mb-2 leading-none",children:n}),e.jsx("p",{className:"text-slate-600 leading-relaxed text-sm",children:o})]})]})}),e.jsxs("div",{className:"p-4 bg-slate-50 flex gap-3 justify-end border-t border-slate-100",children:[e.jsx("button",{onClick:s,className:"px-5 py-2.5 bg-white text-slate-700 border border-slate-200 rounded-lg hover:bg-slate-50 hover:text-slate-900 font-medium transition-all duration-200 shadow-sm",children:r}),e.jsx("button",{onClick:()=>{a(),s()},className:`px-5 py-2.5 text-white rounded-lg font-medium shadow-md transition-all duration-200 transform hover:-translate-y-0.5 ${m()}`,children:l})]})]})})]})},Ts={Egida:"bg-violet-50 text-violet-700 ring-1 ring-violet-200/50","D-Max":"bg-orange-50 text-orange-700 ring-1 ring-orange-200/50",Multiforce:"bg-cyan-50 text-cyan-700 ring-1 ring-cyan-200/50"},Gs="bg-slate-50 text-slate-600 ring-1 ring-slate-200/50",Oe=({companyName:t,className:s=""})=>{const a=Ts[t]||Gs;return e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 text-xs rounded-full 
        font-medium tracking-normal transition-all duration-150 
        hover:ring-2 hover:shadow-sm ${a} ${s}`,"aria-label":`Company: ${t||"Unknown"}`,children:t||"Няма компания"})};function Bs(){return{bulkSetFlag:async(a,n,o)=>{const l={success:0,failed:0,errors:[]},r=new Date().toISOString();for(const i of a)try{const d=await Pe(i);if(!d){l.failed++,l.errors.push(`Participant ${i} not found`);continue}const u=await Ve(d.courseStartDate);if(u&&u.status==="completed"&&u.isLocked){l.failed++,l.errors.push(`Participant ${d.personName} belongs to locked group (${u.courseStartDate})`);continue}const m={[n]:o,updatedAt:r},S=n==="sent"?o:d.sent,N=n==="documents"?o:d.documents,$=n==="handedOver"?o:d.handedOver,k=n==="paid"?o:d.paid,P=S&&N&&$&&k;m.completedComputed=P;const f=d.completedOverride!==null?d.completedOverride:d.completedComputed,h=d.completedOverride!==null?d.completedOverride:P;!f&&h&&(m.completedAt=r),await He(i,m),l.success++}catch(d){l.failed++,l.errors.push(`Failed to update ${i}: ${d.message}`)}return l},bulkSetCompleted:async a=>{const n={success:0,failed:0,errors:[]},o=new Date().toISOString();for(const l of a)try{const r=await Pe(l);if(!r){n.failed++,n.errors.push(`Participant ${l} not found`);continue}const i=await Ve(r.courseStartDate);if(i&&i.status==="completed"&&i.isLocked){n.failed++,n.errors.push(`Participant ${r.personName} belongs to locked group (${i.courseStartDate})`);continue}if(!r.sent||!r.documents||!r.handedOver||!r.paid){n.failed++,n.errors.push(`Participant ${r.personName} does not have all 4 flags set`);continue}await He(l,{completedOverride:!0,updatedAt:o,completedAt:o}),n.success++}catch(r){n.failed++,n.errors.push(`Failed to update ${l}: ${r.message}`)}return n}}}const Mt=({selectedCount:t,selectedIds:s,onClearSelection:a,onActionComplete:n})=>{const{t:o}=X(),{bulkSetFlag:l}=Bs(),[r,i]=x.useState(!1),[d,u]=x.useState(!1),[m,S]=x.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}}),N=async(k,P)=>{i(!0);try{const f=await l(s,k,P);f.failed>0?alert(`${o("bulk.completed")}: ${f.success}
${o("bulk.failed")}: ${f.failed}
${f.errors.join(`
`)}`):alert(`${o("bulk.success")}: ${f.success} ${o("bulk.updated")}`),n()}catch(f){alert(`${o("bulk.error")}: ${f.message}`)}finally{i(!1)}},$=()=>{S({isOpen:!0,title:o("bulk.confirmPaidTitle"),message:o("bulk.confirmPaidMessage"),onConfirm:async()=>{S({...m,isOpen:!1}),await N("paid",!0)}})};return t===0?null:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block sticky top-0 bg-blue-600 text-white shadow-lg z-20 mb-4 rounded-lg",children:e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:a,className:"p-1 hover:bg-blue-700 rounded transition-colors","aria-label":"Clear selection",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsxs("span",{className:"font-semibold",children:[t," ",o("bulk.selected")]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>N("sent",!0),disabled:r,className:"px-3 py-1.5 bg-white text-blue-600 rounded text-sm font-medium hover:bg-blue-50 disabled:opacity-50 whitespace-nowrap",children:o("bulk.setSent")}),e.jsx("button",{onClick:()=>N("documents",!0),disabled:r,className:"px-3 py-1.5 bg-white text-blue-600 rounded text-sm font-medium hover:bg-blue-50 disabled:opacity-50 whitespace-nowrap",children:o("bulk.setDocuments")}),e.jsx("button",{onClick:()=>N("handedOver",!0),disabled:r,className:"px-3 py-1.5 bg-white text-blue-600 rounded text-sm font-medium hover:bg-blue-50 disabled:opacity-50 whitespace-nowrap",children:o("bulk.setHanded")}),e.jsx("button",{onClick:$,disabled:r,className:"px-3 py-1.5 bg-amber-100 text-amber-800 rounded text-sm font-medium hover:bg-amber-200 disabled:opacity-50 whitespace-nowrap",children:o("bulk.setPaid")}),e.jsx("div",{className:"w-px h-6 bg-blue-400"}),e.jsx("button",{onClick:()=>N("sent",!1),disabled:r,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:o("bulk.clearSent")}),e.jsx("button",{onClick:()=>N("documents",!1),disabled:r,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:o("bulk.clearDocuments")}),e.jsx("button",{onClick:()=>N("handedOver",!1),disabled:r,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:o("bulk.clearHanded")}),e.jsx("button",{onClick:()=>N("paid",!1),disabled:r,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:o("bulk.clearPaid")})]})]})}),e.jsxs("div",{className:"md:hidden fixed bottom-16 left-0 right-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-2xl z-20 rounded-t-2xl",style:{boxShadow:"0 -10px 25px -5px rgba(0, 0, 0, 0.3), 0 -8px 10px -6px rgba(0, 0, 0, 0.1)"},children:[e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:a,className:"p-1.5 hover:bg-white/20 rounded-full transition-all active:scale-95","aria-label":"Clear selection",children:e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M6 18L18 6M6 6l12 12"})})}),e.jsxs("div",{className:"flex items-baseline gap-1.5",children:[e.jsx("span",{className:"text-xl font-bold",children:t}),e.jsx("span",{className:"text-sm font-medium opacity-90",children:o("bulk.selected")})]})]}),e.jsxs("button",{onClick:()=>u(!d),className:"px-4 py-2.5 bg-white text-blue-700 rounded-full font-semibold text-sm hover:bg-blue-50 active:scale-95 transition-all shadow-md flex items-center gap-1.5",disabled:r,children:[o("bulk.actions"),e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M19 9l-7 7-7-7"})})]})]}),d&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-end pointer-events-auto",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40 pointer-events-auto",onClick:()=>u(!1)}),e.jsxs("div",{className:"relative w-full bg-white rounded-t-3xl shadow-2xl max-h-[80vh] overflow-hidden animate-slide-up pointer-events-auto z-10",children:[e.jsxs("div",{className:"sticky top-0 bg-white border-b border-slate-200 px-6 py-3 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-bold text-slate-900",children:o("bulk.actionTitle")}),e.jsxs("p",{className:"text-xs text-slate-600 mt-0",children:[o("bulk.forSelected"),": ",e.jsx("span",{className:"font-semibold",children:t})]})]}),e.jsx("button",{onClick:()=>u(!1),className:"p-2 hover:bg-slate-100 rounded-full transition-colors active:scale-95","aria-label":"Close",children:e.jsx("svg",{className:"w-6 h-6 text-slate-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"overflow-y-auto",children:[e.jsxs("div",{className:"px-6 pt-3 pb-1",children:[e.jsx("div",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider mb-2",children:o("bulk.set")}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("button",{onClick:()=>{N("sent",!0),u(!1)},disabled:r,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-blue-600 text-lg",children:"✓"}),e.jsx("span",{className:"flex-1 font-medium",children:o("bulk.setSent")})]}),e.jsxs("button",{onClick:()=>{N("documents",!0),u(!1)},disabled:r,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-blue-600 text-lg",children:"✓"}),e.jsx("span",{className:"flex-1 font-medium",children:o("bulk.setDocuments")})]}),e.jsxs("button",{onClick:()=>{N("handedOver",!0),u(!1)},disabled:r,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-blue-600 text-lg",children:"✓"}),e.jsx("span",{className:"flex-1 font-medium",children:o("bulk.setHanded")})]}),e.jsxs("button",{onClick:()=>{$(),u(!1)},disabled:r,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-amber-50 active:bg-amber-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-amber-600 text-lg",children:"✓"}),e.jsx("span",{className:"flex-1 font-medium",children:o("bulk.setPaid")})]})]})]}),e.jsx("div",{className:"my-2 mx-6 border-t border-slate-200"}),e.jsxs("div",{className:"px-6 pb-20",children:[e.jsx("div",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider mb-2",children:o("bulk.clear")}),e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("button",{onClick:()=>{N("sent",!1),u(!1)},disabled:r,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),e.jsx("span",{className:"flex-1",children:o("bulk.clearSent")})]}),e.jsxs("button",{onClick:()=>{N("documents",!1),u(!1)},disabled:r,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),e.jsx("span",{className:"flex-1",children:o("bulk.clearDocuments")})]}),e.jsxs("button",{onClick:()=>{N("handedOver",!1),u(!1)},disabled:r,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),e.jsx("span",{className:"flex-1",children:o("bulk.clearHanded")})]}),e.jsxs("button",{onClick:()=>{N("paid",!1),u(!1)},disabled:r,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[e.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),e.jsx("span",{className:"flex-1",children:o("bulk.clearPaid")})]})]})]})]})]})]})]}),e.jsx(Me,{isOpen:m.isOpen,onClose:()=>S({...m,isOpen:!1}),onConfirm:m.onConfirm,title:m.title,message:m.message,confirmText:o("common.confirm"),cancelText:o("common.cancel")})]})};function ve({title:t,count:s,groupNumbers:a,dateRange:n,participantCount:o,isCollapsed:l,onToggle:r,children:i,variant:d="active",showCount:u=!0}){const{t:m}=X(),N={active:{bg:"bg-blue-50",border:"border-blue-200",accent:"border-l-blue-400",text:"text-blue-900",countBg:"bg-blue-100",countText:"text-blue-700",icon:e.jsx(os,{className:"w-5 h-5 text-blue-600",strokeWidth:2})},planned:{bg:"bg-amber-50",border:"border-amber-200",accent:"border-l-amber-400",text:"text-amber-900",countBg:"bg-amber-100",countText:"text-amber-700",icon:e.jsx(ns,{className:"w-5 h-5 text-amber-600",strokeWidth:2})},completed:{bg:"bg-slate-50",border:"border-slate-200",accent:"border-l-slate-400",text:"text-slate-700",countBg:"bg-slate-100",countText:"text-slate-600",icon:e.jsx(rs,{className:"w-5 h-5 text-slate-600",strokeWidth:2})}}[d];return e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:`rounded-lg border ${N.border} ${N.bg} border-l-4 ${N.accent} overflow-hidden shadow-sm transition-shadow duration-150`,children:[e.jsxs("button",{onClick:r,className:`w-full flex items-center justify-between px-4 py-3.5 transition-all duration-150 hover:brightness-95 active:scale-[0.99] ${N.text}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex-shrink-0",children:N.icon}),e.jsx("span",{className:"font-bold text-base",children:t}),u&&a&&a.length>0&&e.jsx("span",{className:`px-2.5 py-0.5 ${N.countBg} ${N.countText} rounded-full text-xs font-semibold`,children:a.length===1?`№ ${a[0]}`:`№ ${a.join(", ")}`}),n&&e.jsx("span",{className:"text-sm font-medium opacity-75",children:n}),u&&!a&&d==="planned"&&e.jsx("span",{className:`px-2.5 py-0.5 ${N.countBg} ${N.countText} rounded-full text-xs font-semibold`,children:s})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[o!==void 0&&e.jsxs("span",{className:`px-2.5 py-1 ${N.countBg} ${N.countText} rounded-full text-xs font-bold`,children:[o," ",m(o===1?"group.participant_one":"group.participant_other")]}),e.jsx("svg",{className:`w-5 h-5 transition-transform duration-200 ease-out ${l?"":"rotate-180"}`,style:{transformOrigin:"center"},fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M19 9l-7 7-7-7"})})]})]}),e.jsx("div",{className:`grid transition-all duration-150 ease-in-out ${l?"grid-rows-[0fr] opacity-0":"grid-rows-[1fr] opacity-100"}`,style:{transitionProperty:"grid-template-rows, opacity",willChange:l?"auto":"grid-template-rows, opacity"},children:e.jsx("div",{className:"overflow-hidden",children:e.jsx("div",{className:`px-1.5 sm:px-2 pb-2 transition-transform duration-150 ease-out ${l?"translate-y-[-8px]":"translate-y-0"}`,style:{willChange:l?"auto":"transform"},children:i})})})]}),e.jsx("style",{children:`
        @media (prefers-reduced-motion: reduce) {
          .grid, button, svg {
            transition: none !important;
          }
        }
        
        @media (max-width: 768px) {
          .grid {
            transition-duration: 120ms !important;
          }
        }
      `})]})}const Lt=({groupNumber:t,courseStartDate:s,courseEndDate:a,participants:n,renderParticipantRow:o,mode:l="table",defaultExpanded:r=!1})=>{const{t:i}=X(),[d,u]=x.useState(r),[m,S]=x.useState({key:"uniqueNumber",direction:"desc"}),N=k=>{let P="asc";m.key===k&&m.direction==="asc"&&(P="desc"),S({key:k,direction:P})},$=jt.useMemo(()=>m.key?[...n].sort((k,P)=>{if(m.key==="uniqueNumber"){const f=k.uniqueNumber||"",h=P.uniqueNumber||"";return m.direction==="asc"?f.localeCompare(h):h.localeCompare(f)}return 0}):n,[n,m]);return e.jsxs("div",{className:"border border-slate-300 rounded-lg mb-2 bg-white shadow-sm transition-shadow duration-150",children:[e.jsxs("button",{onClick:()=>u(!d),className:"w-full px-4 py-3 flex items-center justify-between hover:bg-slate-50 transition-all duration-150 rounded-lg active:scale-[0.99]",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("svg",{className:`w-5 h-5 text-slate-600 transition-transform duration-200 ease-out ${d?"rotate-90":""}`,style:{transformOrigin:"center"},fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),e.jsxs("div",{className:"text-left",children:[e.jsxs("div",{className:"font-semibold text-slate-900",children:[i("group.group")," ",t]}),e.jsxs("div",{className:"text-sm text-slate-600",children:[L(s)," - ",L(a)]})]})]}),e.jsxs("div",{className:"text-sm text-slate-600 font-medium",children:[n.length," ",n.length===1?i("group.participant_one"):i("group.participant_other")]})]}),e.jsx("div",{className:`grid transition-all ease-in-out border-t border-slate-200 ${d?"grid-rows-[1fr] opacity-100":"grid-rows-[0fr] opacity-0"}`,style:{transitionDuration:"180ms",transitionProperty:"grid-template-rows, opacity",willChange:d?"grid-template-rows, opacity":"auto"},children:e.jsx("div",{className:"overflow-hidden",children:e.jsx("div",{className:`transition-transform duration-180 ease-out ${d?"translate-y-0":"translate-y-[-8px]"}`,style:{willChange:d?"transform":"auto"},children:l==="table"?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("participant.companyName")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("participant.personName")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors select-none",onClick:()=>N("uniqueNumber"),title:"Sort by Number",children:e.jsxs("div",{className:"flex items-center gap-1",children:[i("participant.uniqueNumber"),m.key==="uniqueNumber"&&e.jsx("span",{className:"text-slate-500",children:m.direction==="asc"?"↑":"↓"})]})}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("participant.medicalDate")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("participant.sent")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("participant.documents")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("participant.handedOver")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("participant.paid")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:i("filters.status")})]})}),e.jsx("tbody",{className:"divide-y divide-slate-200",children:$.map(o)})]})}):e.jsx("div",{className:"p-3 space-y-2",children:$.map(o)})})})}),e.jsx("style",{children:`
        @media (prefers-reduced-motion: reduce) {
          .grid, button, svg {
            transition: none !important;
          }
        }
      `})]})},Ne=({label:t,variant:s,icon:a})=>{const n={success:"bg-emerald-50 text-emerald-800 ring-1 ring-emerald-200 border-0",neutral:"bg-slate-100 text-slate-700 ring-1 ring-slate-200 border-0",info:"bg-blue-50 text-blue-800 ring-1 ring-blue-200 border-0"};return e.jsxs("span",{className:`
        inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium border
        ${n[s]}
      `,children:[a==="check"&&e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}),a==="manual"&&e.jsxs("svg",{className:"w-3 h-3",fill:"currentColor",viewBox:"0 0 16 16",children:[e.jsx("path",{d:"M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"}),e.jsx("path",{d:"M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"})]}),t]})},It=({isOpen:t,onClose:s,title:a,message:n,buttonText:o="OK",variant:l="info"})=>{if(x.useEffect(()=>{const u=m=>{m.key==="Escape"&&s()};if(t)return document.addEventListener("keydown",u),()=>document.removeEventListener("keydown",u)},[t,s]),x.useEffect(()=>{if(t){const u=setTimeout(()=>{s()},5e3);return()=>clearTimeout(u)}},[t,s]),!t)return null;const r=()=>{switch(l){case"danger":case"error":return e.jsx(ls,{className:"w-6 h-6 text-red-600"});case"warning":return e.jsx(et,{className:"w-6 h-6 text-amber-600"});case"success":return e.jsx(_e,{className:"w-6 h-6 text-emerald-600"});default:return e.jsx(kt,{className:"w-6 h-6 text-blue-600"})}},i=()=>{switch(l){case"danger":case"error":return"bg-red-50 text-red-900 border-red-100";case"warning":return"bg-amber-50 text-amber-900 border-amber-100";case"success":return"bg-emerald-50 text-emerald-900 border-emerald-100";default:return"bg-blue-50 text-blue-900 border-blue-100"}},d=()=>{switch(l){case"danger":case"error":return"bg-red-600 hover:bg-red-700 focus:ring-red-500";case"warning":return"bg-amber-600 hover:bg-amber-700 focus:ring-amber-500";case"success":return"bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500";default:return"bg-blue-600 hover:bg-blue-700 focus:ring-blue-500"}};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 transition-opacity",onClick:s}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-sm w-full md:max-w-md lg:max-w-lg overflow-hidden animate-scale-up transform transition-all",children:[e.jsxs("div",{className:"p-6 md:p-8 text-center",children:[e.jsx("div",{className:`mx-auto mb-4 w-12 h-12 rounded-full flex items-center justify-center ${i()}`,children:r()}),e.jsx("h3",{className:"text-xl font-bold text-slate-900 mb-2",children:a}),e.jsx("p",{className:"text-slate-600 text-sm leading-relaxed",children:n})]}),e.jsx("div",{className:"p-4 bg-slate-50 border-t border-slate-100",children:e.jsx("button",{onClick:s,className:`w-full px-5 py-2.5 text-white rounded-lg font-medium shadow-md transition-all duration-200 transform hover:-translate-y-0.5 ${d()}`,children:o})})]})})]})},Rs=({participants:t,onEdit:s,onDelete:a,collapsedSections:n,toggleSection:o,hasActiveFilters:l,onFilterChange:r,groupRefreshKey:i=0})=>{var F;const{updateParticipant:d}=Ke(),{t:u}=X(),[m,S]=x.useState("uniqueNumber"),[N,$]=x.useState("asc"),[k,P]=x.useState(new Set),[f,h]=x.useState({isOpen:!1,participant:void 0}),[b,C]=x.useState(null),[A,T]=x.useState({isOpen:!1,title:"",message:"",variant:"info"}),G=(c,g)=>{const j=c.currentTarget.getBoundingClientRect();C({participant:g,x:j.left,y:j.top-8})},_=()=>{C(null)},q=ye(()=>D.groups.toArray(),[i]),M=x.useMemo(()=>q?new Map(q.map(c=>[c.courseStartDate,c])):new Map,[q]),U=x.useMemo(()=>[...t].sort((g,j)=>{let w=0;return m==="courseStartDate"||m==="groupNumber"?w=g.courseStartDate.localeCompare(j.courseStartDate):m==="uniqueNumber"&&(w=g.uniqueNumber.localeCompare(j.uniqueNumber)),N==="asc"?w:-w}),[t,m,N]),v=x.useMemo(()=>{const c=[],g=[],j=[];return U.forEach(w=>{const H=M.get(w.courseStartDate);if(!H){g.push(w);return}H.status==="active"?c.push(w):H.status==="planned"?g.push(w):H.status==="completed"&&j.push(w)}),{active:c,planned:g,completed:j}},[U,M]),B=x.useMemo(()=>q==null?void 0:q.find(c=>c.status==="active"),[q]),z=B!=null&&B.groupNumber?[B.groupNumber]:[],W=B?`${L(B.courseStartDate)} - ${L(B.courseEndDate)}`:void 0,V=x.useMemo(()=>{const c=new Map;return q==null||q.forEach(g=>{g.status==="active"&&c.set(g.courseStartDate,{group:g,participants:[]})}),v.active.forEach(g=>{const j=c.get(g.courseStartDate);if(j)j.participants.push(g);else{const w=M.get(g.courseStartDate)||{id:"virt-active-"+g.courseStartDate,courseStartDate:g.courseStartDate,courseEndDate:g.courseEndDate,status:"active",groupNumber:null,isLocked:!1,createdAt:"",updatedAt:""};c.set(g.courseStartDate,{group:w,participants:[g]})}}),Array.from(c.values()).sort((g,j)=>g.group.courseStartDate.localeCompare(j.group.courseStartDate))},[v.active,q,M]),Q=x.useMemo(()=>{const c=new Map;!l&&q&&q.forEach(w=>{w.status==="planned"&&c.set(w.courseStartDate,{group:w,participants:[]})}),v.planned.forEach(w=>{let H=M.get(w.courseStartDate);if(H&&!c.has(w.courseStartDate)&&c.set(w.courseStartDate,{group:H,participants:[]}),!H&&!c.has(w.courseStartDate)){const K={id:"virtual-planned-"+w.courseStartDate,groupNumber:null,courseStartDate:w.courseStartDate,courseEndDate:w.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""};c.set(w.courseStartDate,{group:K,participants:[]})}c.has(w.courseStartDate)&&c.get(w.courseStartDate).participants.push(w)});const g=Array.from(c.entries()).sort(([w],[H])=>w.localeCompare(H));return(l?g:g.slice(0,2)).map(([w,H])=>({courseStartDate:w,...H}))},[v.planned,M,q,l]),le=x.useMemo(()=>{const c=new Map;return v.completed.forEach(g=>{const j=M.get(g.courseStartDate);j&&(c.has(g.courseStartDate)||c.set(g.courseStartDate,{group:j,participants:[]}),c.get(g.courseStartDate).participants.push(g))}),Array.from(c.entries()).sort(([g],[j])=>j.localeCompare(g)).map(([g,j])=>({courseStartDate:g,...j}))},[v.completed,M]),ee=x.useMemo(()=>{const c=new Set,g=new Set,j=new Set;return V.forEach(w=>c.add(w.group.courseStartDate)),!l&&q&&q.forEach(w=>{w.status==="active"&&c.add(w.courseStartDate),w.status==="planned"&&g.add(w.courseStartDate),w.status==="completed"&&j.add(w.courseStartDate)}),v.active.forEach(w=>c.add(w.courseStartDate)),v.planned.forEach(w=>g.add(w.courseStartDate)),v.completed.forEach(w=>j.add(w.courseStartDate)),{active:{count:c.size,numbers:[]},planned:{count:g.size,numbers:[]},completed:{count:j.size,numbers:[]}}},[v,q,V,l]);x.useEffect(()=>{(async()=>{await Ae()})()},[]);const ie=c=>{m===c?$(g=>g==="asc"?"desc":"asc"):(S(c),$("asc"))},ae=async(c,g)=>{const j=M.get(c.courseStartDate);if(Ce(j)){T({isOpen:!0,title:u("common.info"),message:u("lock.lockedInfo"),variant:"info"});return}try{await d(c.id,{[g]:!c[g]})}catch(w){console.error("Error updating participant:",w),T({isOpen:!0,title:u("common.error"),message:u("error.updateParticipantFailed"),variant:"error"})}},Z=async c=>{const g=M.get(c.courseStartDate);if(Ce(g)){T({isOpen:!0,title:u("common.info"),message:u("lock.lockedInfo"),variant:"info"});return}const j=c.completedOverride!==null?c.completedOverride:c.completedComputed;try{await d(c.id,{completedOverride:!j})}catch(w){console.error("Error updating completed status:",w),T({isOpen:!0,title:u("common.error"),message:u("error.updateCompletedFailed"),variant:"error"})}},ce=async c=>{const g=M.get(c.courseStartDate);if(Ce(g)){T({isOpen:!0,title:u("common.info"),message:u("lock.lockedInfo"),variant:"info"});return}try{await d(c.id,{completedOverride:null})}catch(j){console.error("Error resetting completed status:",j),T({isOpen:!0,title:u("common.error"),message:u("error.resetCompletedFailed"),variant:"error"})}},me=c=>c.completedOverride!==null?c.completedOverride:c.completedComputed,te=c=>c.completedOverride!==null,re=async c=>{try{let g=M.get(c.courseStartDate);g||(g={id:"virtual-cert",groupNumber:null,courseStartDate:c.courseStartDate,courseEndDate:c.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""});const{generateCertificate:j}=await qe(async()=>{const{generateCertificate:w}=await import("./certificateGenerator-BQdzjMuI.js");return{generateCertificate:w}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));await j(c,g),T({isOpen:!0,title:u("common.success"),message:u("certificate.generated"),variant:"success"})}catch(g){T({isOpen:!0,title:u("common.error"),message:u("certificate.error")+": "+g.message,variant:"error"})}},ne=()=>{f.participant&&a(f.participant.id),h({isOpen:!1,participant:void 0})},pe=c=>{const g=M.get(c.courseStartDate),j=E(c),w=["hover:bg-slate-100 transition-colors duration-150",(g==null?void 0:g.status)==="active"?"bg-slate-50":"",(g==null?void 0:g.status)==="completed"?"opacity-90":""].filter(Boolean).join(" ");return e.jsxs("tr",{className:w,children:[e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:k.has(c.id),onChange:()=>p(c.id),disabled:j,className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed","aria-label":`Select ${c.personName}`})}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Oe,{companyName:c.companyName}),j&&e.jsx("span",{className:"text-xs text-slate-500",title:u("lock.lockedInfo"),children:"🔒"})]})}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:e.jsx("div",{className:"max-w-xs truncate cursor-help",onMouseEnter:H=>G(H,c),onMouseLeave:_,children:c.personName})}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:L(c.medicalDate)}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:L(c.courseStartDate)}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:L(c.courseEndDate)}),e.jsx("td",{className:"px-3 py-3 text-sm",children:e.jsx("span",{className:"font-mono text-xs bg-slate-100 px-2 py-0.5 rounded inline-block text-slate-700 cursor-help",title:`Уникален номер на удостоверение
Протокол: ${g!=null&&g.groupNumber?g.groupNumber*5:"---"}`,children:c.uniqueNumber||"---"})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:c.sent,onChange:()=>ae(c,"sent"),disabled:j,title:"Данните са изпратени към фирмата",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:c.documents,onChange:()=>ae(c,"documents"),disabled:j,title:"Получени са всички документи",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:c.handedOver,onChange:()=>ae(c,"handedOver"),disabled:j,title:"Удостоверението е предадено",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:c.paid,onChange:()=>ae(c,"paid"),disabled:j,title:"Таксата е платена",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("button",{onClick:()=>Z(c),disabled:j,className:`px-3 py-1 rounded-md text-xs font-medium transition-colors duration-150 ring-1 disabled:opacity-50 disabled:cursor-not-allowed ${me(c)?"bg-emerald-50 text-emerald-800 ring-emerald-200 hover:bg-emerald-100":"bg-slate-100 text-slate-700 ring-slate-200 hover:bg-slate-200"}`,title:j?u("lock.lockedInfo"):"Click to toggle",children:me(c)?u("completed.done"):u("completed.pending")}),te(c)&&!j&&e.jsx("button",{onClick:()=>ce(c),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-50 transition-colors duration-150",title:"Reset to auto","aria-label":"Reset completed to automatic",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})})]})}),e.jsx("td",{className:"px-3 py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("button",{onClick:()=>s(c),disabled:j,className:"p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-100 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:u(j?"lock.lockedInfo":"common.edit"),"aria-label":`Edit ${c.personName}`,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),e.jsx("button",{onClick:()=>re(c),className:"p-2 text-green-600 hover:text-green-800 hover:bg-green-50 rounded-lg transition-colors duration-150",title:"Генерирай сертификат","aria-label":`Generate certificate for ${c.personName}`,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),e.jsx("button",{onClick:()=>h({isOpen:!0,participant:c}),disabled:j,className:"p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:u(j?"lock.lockedInfo":"common.delete"),"aria-label":`Delete ${c.personName}`,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})})]},c.id)},xe=c=>{const g=E(c);return e.jsxs("tr",{className:"hover:bg-slate-100 transition-colors duration-150",children:[e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:k.has(c.id),onChange:()=>p(c.id),disabled:g,className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed","aria-label":`Select ${c.personName}`})}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:e.jsx(Oe,{companyName:c.companyName})}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:e.jsx("div",{className:"max-w-xs truncate cursor-help",onMouseEnter:w=>G(w,c),onMouseLeave:_,children:c.personName})}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:L(c.medicalDate)}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:L(c.courseStartDate)}),e.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:L(c.courseEndDate)}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:c.documents,onChange:()=>ae(c,"documents"),disabled:g,title:"Получени са всички документи",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),e.jsx("td",{className:"px-3 py-3 text-center",children:e.jsx("input",{type:"checkbox",checked:c.paid,onChange:()=>ae(c,"paid"),disabled:g,title:"Таксата е платена",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),e.jsx("td",{className:"px-3 py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("button",{onClick:()=>s(c),disabled:g,className:"p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-100 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:u(g?"lock.lockedInfo":"common.edit"),"aria-label":`Edit ${c.personName}`,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),e.jsx("button",{onClick:()=>h({isOpen:!0,participant:c}),disabled:g,className:"p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:u(g?"lock.lockedInfo":"common.delete"),"aria-label":`Delete ${c.personName}`,children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})})]},c.id)},he=c=>{const g=M.get(c.courseStartDate),j=me(c);return e.jsxs("tr",{className:"hover:bg-slate-50 transition-colors",children:[e.jsx("td",{className:"px-3 py-2 text-sm text-slate-900",children:e.jsx(Oe,{companyName:c.companyName})}),e.jsx("td",{className:"px-3 py-2 text-sm text-slate-900",children:e.jsx("div",{className:"cursor-help",onMouseEnter:w=>G(w,c),onMouseLeave:_,children:c.personName})}),e.jsx("td",{className:"px-3 py-2 text-sm",children:e.jsx("span",{className:"font-mono text-xs bg-slate-100 px-2 py-0.5 rounded inline-block text-slate-700 cursor-help",title:`Уникален номер на удостоверение
Протокол: ${g!=null&&g.groupNumber?g.groupNumber*5:"---"}`,children:c.uniqueNumber})}),e.jsx("td",{className:"px-3 py-2 text-sm text-slate-600",children:L(c.medicalDate)}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:c.sent,disabled:!0,title:"Данните са изпратени към фирмата",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:c.documents,disabled:!0,title:"Получени са всички документи",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:c.handedOver,disabled:!0,title:"Удостоверението е предадено",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:c.paid,disabled:!0,title:"Таксата е платена",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[j&&e.jsx(Ne,{label:u("participant.completedBadge"),variant:"success",icon:"check"}),te(c)&&e.jsx(Ne,{label:u("participant.manual"),variant:"info",icon:"manual"}),!j&&!te(c)&&e.jsx("span",{className:"text-xs text-slate-400 italic",children:u("completed.pending")})]})})]},c.id)},p=c=>{const g=new Set(k);g.has(c)?g.delete(c):g.add(c),P(g)},y=()=>{P(new Set)},I=()=>{P(new Set)},E=c=>{const g=M.get(c.courseStartDate);return Ce(g)};return U.length===0?e.jsx("div",{className:"text-center py-12 text-slate-500",children:u("participants.noResults")}):e.jsxs(e.Fragment,{children:[e.jsx(Mt,{selectedCount:k.size,selectedIds:Array.from(k),onClearSelection:y,onActionComplete:I}),e.jsx(It,{isOpen:A.isOpen,onClose:()=>T(c=>({...c,isOpen:!1})),title:A.title,message:A.message,variant:A.variant}),e.jsxs("div",{className:"space-y-4",children:[(v.active.length>0||!l)&&e.jsx(ve,{title:u("groups.activeSection"),count:ee.active.count,groupNumbers:V.length<=1?z:[],dateRange:V.length<=1?W:void 0,participantCount:v.active.length,isCollapsed:n.active,onToggle:()=>o("active"),variant:"active",children:V.length===0?e.jsx("div",{className:"text-center py-8 text-slate-500 bg-slate-50 border border-dashed border-slate-200 rounded-lg",children:u("participants.noActive")}):e.jsx("div",{className:"space-y-8",children:V.map(c=>e.jsxs("div",{className:"space-y-3",children:[V.length>1&&e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-blue-100",children:[e.jsxs("span",{className:"font-bold text-blue-900",children:[L(c.group.courseStartDate)," - ",L(c.group.courseEndDate)]}),c.group.groupNumber&&e.jsxs("span",{className:"px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs font-bold",children:["№ ",c.group.groupNumber]})]}),e.jsx("div",{className:"overflow-x-auto max-h-[400px] overflow-y-auto relative rounded-lg border border-slate-200",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-slate-100 sticky top-0 z-10 shadow-sm",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 border-b border-slate-200 w-12",children:e.jsx("input",{type:"checkbox",checked:c.participants.length>0&&c.participants.every(g=>k.has(g.id)),onChange:g=>{const j=new Set(k);g.target.checked?c.participants.filter(w=>!E(w)).forEach(w=>j.add(w.id)):c.participants.forEach(w=>j.delete(w.id)),P(j)},className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer"})}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.companyName")}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.personName")}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.medicalDate")}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.courseStart")}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.courseEnd")}),e.jsxs("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200 cursor-pointer hover:bg-slate-200 transition-colors duration-150",onClick:()=>ie("uniqueNumber"),children:[u("participant.uniqueNumber")," ",m==="uniqueNumber"&&(N==="asc"?"↑":"↓")]}),e.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.sent")}),e.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.documents")}),e.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.handedOver")}),e.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.paid")}),e.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("filters.status")}),e.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("common.delete")})]})}),e.jsx("tbody",{className:"divide-y divide-slate-200",children:c.participants.length>0?c.participants.map(pe):e.jsx("tr",{children:e.jsx("td",{colSpan:13,className:"text-center py-8 text-slate-400 italic",children:u("participants.noParticipantsInGroup")})})})]})})]},c.group.courseStartDate))})}),(v.planned.length>0||!l)&&Q.length>0&&e.jsx(ve,{title:u("groups.plannedSection"),count:ee.planned.count,groupNumbers:Q.map(c=>c.group.groupNumber).filter(c=>c!==null),isCollapsed:n.planned,onToggle:()=>o("planned"),variant:"planned",children:e.jsx("div",{className:"space-y-6",children:Q.map(({courseStartDate:c,group:g,participants:j})=>e.jsxs("div",{className:"bg-white border border-amber-200 rounded-lg overflow-hidden",children:[e.jsx("div",{className:"bg-amber-50 px-4 py-2 border-b border-amber-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[g.groupNumber&&e.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-900 rounded text-xs font-semibold",children:["№ ",g.groupNumber]}),e.jsxs("span",{className:"font-semibold text-amber-900",children:[L(g.courseStartDate)," - ",L(g.courseEndDate)]})]}),e.jsxs("span",{className:"text-sm text-amber-700 font-medium",children:[j.length," ",j.length===1?u("group.participant_one"):u("group.participant_other")]})]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full bg-white",children:[e.jsx("thead",{className:"bg-slate-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 border-b border-slate-200 w-12",children:e.jsx("input",{type:"checkbox",checked:j.length>0&&j.every(w=>k.has(w.id)),onChange:w=>{const H=new Set(k);w.target.checked?j.forEach(K=>H.add(K.id)):j.forEach(K=>H.delete(K.id)),P(H)},className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer"})}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.companyName")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.personName")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.medicalDate")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.courseStart")}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.courseEnd")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.documents")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("participant.paid")}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:u("common.delete")})]})}),e.jsx("tbody",{className:"divide-y divide-slate-200",children:j.length>0?j.map(xe):e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"text-center py-4 text-slate-400 italic",children:u("participants.noParticipantsInGroup")})})})]})})]},c))})}),(v.completed.length>0||!l)&&le.length>0&&e.jsx(ve,{title:u("groups.completedSection"),count:ee.completed.count,groupNumbers:ee.completed.numbers,isCollapsed:n.completed,onToggle:()=>o("completed"),variant:"completed",children:e.jsx("div",{className:"space-y-4",children:le.map(({courseStartDate:c,group:g,participants:j})=>e.jsx("div",{children:e.jsx(Lt,{groupNumber:g.groupNumber||0,courseStartDate:g.courseStartDate,courseEndDate:g.courseEndDate,participants:j,renderParticipantRow:he,defaultExpanded:l})},c))})})]}),l&&t.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 text-center",children:[e.jsx("div",{className:"text-6xl mb-4",children:"🔍"}),e.jsx("h3",{className:"text-lg font-semibold text-slate-700 mb-2",children:"Няма намерени резултати"}),e.jsx("p",{className:"text-sm text-slate-500 mb-6",children:"Опитай да промениш филтрите или ги изчисти"}),e.jsx("button",{onClick:()=>{r({searchTerm:"",courseStartDate:null,category:null,status:"all"})},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium",children:"Изчисти филтрите"})]}),e.jsx(Me,{isOpen:f.isOpen,onClose:()=>h({isOpen:!1,participant:void 0}),onConfirm:ne,title:u("modal.deleteTitle"),message:e.jsxs(e.Fragment,{children:[u("modal.deleteMessage").split("{name}")[0],e.jsx("strong",{className:"font-bold text-slate-900",children:((F=f.participant)==null?void 0:F.personName)||""}),u("modal.deleteMessage").split("{name}")[1]]}),confirmText:u("common.delete"),cancelText:u("common.cancel"),variant:"danger"}),b&&e.jsxs("div",{className:"fixed z-50 bg-slate-800 text-white text-xs p-3 rounded shadow-lg pointer-events-none transform -translate-y-full filter drop-shadow-md",style:{left:b.x,top:b.y,minWidth:"220px"},children:[e.jsx("div",{className:"font-bold mb-2 border-b border-slate-600 pb-1 text-slate-100",children:b.participant.personName}),e.jsxs("div",{className:"grid grid-cols-[auto_1fr] gap-x-3 gap-y-1.5",children:[e.jsxs("span",{className:"text-slate-400 text-right",children:[u("participant.egn"),":"]}),e.jsx("span",{className:"font-mono",children:b.participant.egn||"-"}),e.jsxs("span",{className:"text-slate-400 text-right",children:[u("participant.birthPlace"),":"]}),e.jsx("span",{children:b.participant.birthPlace||"-"}),e.jsxs("span",{className:"text-slate-400 text-right",children:[u("participant.added"),":"]}),e.jsx("span",{children:b.participant.createdAt?L(b.participant.createdAt):"-"}),e.jsxs("span",{className:"text-slate-400 text-right",children:[u("participant.modified"),":"]}),e.jsx("span",{children:b.participant.updatedAt?L(b.participant.updatedAt):"-"})]})]})]})},bt=({onEdit:t,onDetails:s,onGenerate:a,onDelete:n})=>{const[o,l]=x.useState(!1),r=x.useRef(null);return x.useEffect(()=>{const i=u=>{r.current&&!r.current.contains(u.target)&&l(!1)},d=u=>{u.key==="Escape"&&l(!1)};if(o)return document.addEventListener("mousedown",i),document.addEventListener("keydown",d),()=>{document.removeEventListener("mousedown",i),document.removeEventListener("keydown",d)}},[o]),e.jsxs("div",{className:"relative",ref:r,children:[e.jsx("button",{onClick:()=>l(!o),className:"p-2 hover:bg-slate-100 rounded-lg transition-colors duration-150 min-h-[44px] min-w-[44px] flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-blue-500","aria-label":"More options","aria-expanded":o,children:e.jsxs("svg",{className:"w-5 h-5 text-slate-600",fill:"currentColor",viewBox:"0 0 16 16",children:[e.jsx("circle",{cx:"8",cy:"2",r:"1.5"}),e.jsx("circle",{cx:"8",cy:"8",r:"1.5"}),e.jsx("circle",{cx:"8",cy:"14",r:"1.5"})]})}),o&&e.jsxs("div",{className:"absolute right-0 top-12 bg-white rounded-lg shadow-lg border border-slate-200 py-1 min-w-[140px] z-10 animate-scale-up",children:[t&&e.jsxs("button",{onClick:()=>{t(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-100 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),"Редактирай"]}),s&&e.jsxs("button",{onClick:()=>{s(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-blue-700 hover:bg-blue-50 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),"Детайли"]}),a&&e.jsxs("button",{onClick:()=>{a(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-green-700 hover:bg-green-50 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Генерирай"]}),n&&e.jsxs("button",{onClick:()=>{n(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),"Изтрий"]})]})]})},_s=({isOpen:t,onClose:s,participant:a})=>{const{t:n}=X();return x.useEffect(()=>{const o=l=>{l.key==="Escape"&&s()};if(t)return document.addEventListener("keydown",o),()=>document.removeEventListener("keydown",o)},[t,s]),!t||!a?null:e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 transition-opacity",onClick:s}),e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden animate-scale-up pointer-events-auto",children:[e.jsxs("div",{className:"relative bg-slate-50 px-6 py-4 border-b border-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center shrink-0",children:e.jsx(is,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900 truncate pr-6",children:a.personName}),e.jsx("p",{className:"text-xs text-slate-500 truncate",children:a.companyName})]})]}),e.jsx("button",{onClick:s,className:"absolute right-4 top-4 p-1 rounded-full hover:bg-slate-200 transition-colors text-slate-400 hover:text-slate-600",children:e.jsx(cs,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[e.jsx(ds,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:n("participant.egn")})]}),e.jsx("div",{className:"text-sm font-mono text-slate-900 bg-slate-50 px-2 py-1 rounded",children:a.egn||"---"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[e.jsx(us,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:n("participant.birthPlace")})]}),e.jsx("div",{className:"text-sm font-medium text-slate-900 truncate",children:a.birthPlace||"---"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[e.jsx(ms,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:n("participant.added")})]}),e.jsx("div",{className:"text-xs text-slate-900",children:a.createdAt?L(a.createdAt):"---"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[e.jsx(ps,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:n("participant.modified")})]}),e.jsx("div",{className:"text-xs text-slate-900",children:a.updatedAt?L(a.updatedAt):"---"})]})]})]}),e.jsx("div",{className:"px-6 py-4 bg-slate-50 flex justify-end",children:e.jsx("button",{onClick:s,className:"px-4 py-2 bg-white text-slate-700 border border-slate-200 rounded-lg hover:bg-slate-100 font-medium text-sm transition-all",children:n("common.close")})})]})})]})},$e=({label:t,isActive:s})=>e.jsxs("div",{className:`
        flex items-center justify-center gap-1 px-1.5 py-1 rounded text-xs font-medium
        transition-all duration-150 min-h-[32px] w-full
        ${s?"bg-emerald-700 border border-emerald-700 text-white":"bg-white border border-slate-300 text-slate-700"}
      `,children:[s&&e.jsx("svg",{className:"w-3 h-3 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}),e.jsx("span",{className:"text-[10px] whitespace-nowrap",children:t})]}),Us=({participants:t,onEdit:s,onDelete:a,onSelectionChange:n,collapsedSections:o,toggleSection:l,expandSection:r,hasActiveFilters:i})=>{var he;const{t:d}=X(),{updateParticipant:u}=Ke(),[m,S]=x.useState(new Set),[N,$]=x.useState(null),[k,P]=x.useState({isOpen:!1,participant:void 0}),[f,h]=x.useState({isOpen:!1,participant:void 0}),b=ye(()=>D.groups.toArray(),[]),C=x.useMemo(()=>b?new Map(b.map(p=>[p.courseStartDate,p])):new Map,[b]),A=x.useMemo(()=>{const p=[],y=[],I=[];return t.forEach(E=>{const F=C.get(E.courseStartDate);if(!F){y.push(E);return}F.status==="active"?p.push(E):F.status==="planned"?y.push(E):F.status==="completed"&&I.push(E)}),{active:p,planned:y,completed:I}},[t,C]),T=x.useMemo(()=>{const p=new Map;!i&&b&&b.forEach(E=>{E.status==="planned"&&p.set(E.courseStartDate,{group:E,participants:[]})}),A.planned.forEach(E=>{let F=C.get(E.courseStartDate);if(F&&!p.has(E.courseStartDate)&&p.set(E.courseStartDate,{group:F,participants:[]}),!F&&!p.has(E.courseStartDate)){const c={id:"virtual-"+E.courseStartDate,groupNumber:null,courseStartDate:E.courseStartDate,courseEndDate:E.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""};p.set(E.courseStartDate,{group:c,participants:[]})}p.has(E.courseStartDate)&&p.get(E.courseStartDate).participants.push(E)});const y=Array.from(p.entries()).sort(([E],[F])=>E.localeCompare(F));return(i?y:y.slice(0,2)).map(([E,F])=>({courseStartDate:E,...F}))},[A.planned,C,b,i]),G=x.useMemo(()=>{const p=new Map;return A.completed.forEach(y=>{const I=C.get(y.courseStartDate);I&&(p.has(y.courseStartDate)||p.set(y.courseStartDate,{group:I,participants:[]}),p.get(y.courseStartDate).participants.push(y))}),Array.from(p.entries()).sort(([y],[I])=>I.localeCompare(y)).map(([y,I])=>({courseStartDate:y,...I}))},[A.completed,C]),_=x.useMemo(()=>b==null?void 0:b.find(p=>p.status==="active"),[b]),q=_!=null&&_.groupNumber?[_.groupNumber]:[],M=_?`${L(_.courseStartDate)} - ${L(_.courseEndDate)}`:void 0,U=x.useMemo(()=>{const p=new Map;return b==null||b.forEach(y=>{y.status==="active"&&p.set(y.courseStartDate,{group:y,participants:[]})}),A.active.forEach(y=>{const I=p.get(y.courseStartDate);if(I)I.participants.push(y);else{const E=C.get(y.courseStartDate)||{id:"virt-active-"+y.courseStartDate,courseStartDate:y.courseStartDate,courseEndDate:y.courseEndDate,status:"active",groupNumber:null,isLocked:!1,createdAt:"",updatedAt:""};p.set(y.courseStartDate,{group:E,participants:[y]})}}),Array.from(p.values()).sort((y,I)=>y.group.courseStartDate.localeCompare(I.group.courseStartDate))},[A.active,b,C]),v=x.useMemo(()=>{const p=new Set,y=new Set,I=new Set;return A.active.forEach(E=>p.add(E.courseStartDate)),!i&&b&&b.forEach(E=>{E.status==="planned"&&y.add(E.courseStartDate)}),A.planned.forEach(E=>y.add(E.courseStartDate)),A.completed.forEach(E=>I.add(E.courseStartDate)),{active:{count:p.size,periods:Array.from(p).sort()},planned:{count:i?y.size:Math.min(y.size,2),periods:Array.from(y).sort()},completed:{count:I.size,periods:Array.from(I).sort()}}},[A,b,i]),B=x.useRef(t);x.useEffect(()=>{B.current!==t&&i&&(A.active.length>0&&o.active&&r("active"),A.planned.length>0&&o.planned&&r("planned"),A.completed.length>0&&o.completed&&r("completed"),B.current=t)},[t,A,o,r,i]),x.useEffect(()=>{n==null||n(m.size>0)},[m.size,n]);const z=async(p,y)=>{const I=C.get(p.courseStartDate);if(I&&I.status==="completed"&&I.isLocked){alert(d("lock.lockedInfo"));return}try{await u(p.id,{[y]:!p[y]})}catch(E){console.error("Error updating participant:",E)}},W=p=>p.completedOverride!==null?p.completedOverride:p.completedComputed,V=p=>p.completedOverride!==null,Q=p=>{const y=C.get(p.courseStartDate);return y?y.status==="completed"&&y.isLocked:!1},le=(p,y)=>{if(Q(y))return;const I=setTimeout(()=>{S(new Set([p]))},500);$(I)},ee=()=>{N&&(clearTimeout(N),$(null))},ie=(p,y)=>{const I=Q(y);if(m.size>0){if(I)return;const E=new Set(m);E.has(p)?E.delete(p):E.add(p),S(E)}},ae=()=>{S(new Set)},Z=()=>{S(new Set)},ce=p=>{P({isOpen:!0,participant:p})},me=()=>{k.participant&&a(k.participant.id),P({isOpen:!1,participant:void 0})},[te,re]=x.useState({isOpen:!1,title:"",message:"",variant:"info"}),ne=async p=>{try{let y=C.get(p.courseStartDate);y||(y={id:"virtual",groupNumber:null,courseStartDate:p.courseStartDate,courseEndDate:p.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""});const{generateCertificate:I}=await qe(async()=>{const{generateCertificate:E}=await import("./certificateGenerator-BQdzjMuI.js");return{generateCertificate:E}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));await I(p,y),re({isOpen:!0,title:d("common.success"),message:d("certificate.generated"),variant:"success"})}catch(y){re({isOpen:!0,title:d("common.error"),message:d("certificate.error")+": "+y.message,variant:"error"})}},pe=(p,y)=>{var F;const I=m.has(p.id),E=Q(p);return e.jsxs("div",{onClick:()=>ie(p.id,p),onTouchStart:()=>le(p.id,p),onTouchEnd:ee,onMouseDown:()=>le(p.id,p),onMouseUp:ee,onMouseLeave:ee,className:`bg-white rounded-lg shadow-sm p-3 md:p-4 border transition-all duration-150 ${I?"border-blue-500 ring-2 ring-blue-200":"border-slate-200"} ${E?"opacity-75":"cursor-pointer hover:shadow-md"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"mb-1",children:e.jsx(Oe,{companyName:p.companyName})}),e.jsxs("div",{className:"flex items-center gap-2",children:[I&&e.jsx("div",{className:"w-5 h-5 bg-blue-600 rounded flex items-center justify-center shrink-0",children:e.jsx("svg",{className:"w-3 h-3 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}),e.jsx("h3",{className:"font-bold text-lg text-slate-900 leading-tight truncate",children:p.personName}),E&&e.jsx("span",{className:"text-xs text-slate-500 shrink-0",title:d("lock.lockedInfo"),children:"🔒"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col gap-1 items-end",children:[p.uniqueNumber&&e.jsx("span",{className:"text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-700",children:p.uniqueNumber}),e.jsxs("div",{className:"flex gap-1",children:[W(p)?e.jsx(Ne,{label:d("participant.completedBadge"),variant:"success",icon:"check"}):e.jsx("span",{className:"text-[10px] text-slate-400 italic font-medium",children:d("completed.pending")}),V(p)&&e.jsx(Ne,{label:d("participant.manual"),variant:"info",icon:"manual"})]})]}),!E&&e.jsx(bt,{onEdit:()=>s(p),onDetails:()=>h({isOpen:!0,participant:p}),onGenerate:((F=C.get(p.courseStartDate))==null?void 0:F.status)==="active"?()=>ne(p):void 0,onDelete:()=>ce(p)})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-x-2 gap-y-2 mb-3",children:[e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:d("participant.medical")}),e.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:L(p.medicalDate)})]}),e.jsxs("div",{className:"flex flex-col min-w-0 text-right",children:[e.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:d("participant.period")}),e.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:L(p.courseStartDate)})]}),e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:d("participant.courseStart")}),e.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:L(p.courseStartDate)})]}),e.jsxs("div",{className:"flex flex-col min-w-0 text-right",children:[e.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:d("participant.courseEnd")}),e.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:L(p.courseEndDate)})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-1.5 sm:gap-1",children:[e.jsx("button",{onClick:c=>{c.stopPropagation(),z(p,"sent")},disabled:E,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx($e,{label:d("participant.sent"),isActive:p.sent})}),e.jsx("button",{onClick:c=>{c.stopPropagation(),z(p,"documents")},disabled:E,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx($e,{label:d("participant.documents"),isActive:p.documents})}),e.jsx("button",{onClick:c=>{c.stopPropagation(),z(p,"handedOver")},disabled:E,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx($e,{label:d("participant.handed"),isActive:p.handedOver})}),e.jsx("button",{onClick:c=>{c.stopPropagation(),z(p,"paid")},disabled:E,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx($e,{label:d("participant.paid"),isActive:p.paid})})]})]},p.id)},xe=p=>e.jsxs("div",{className:"bg-white rounded-lg p-3 border border-slate-200",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{className:"flex-1 min-w-0 pr-2",children:[e.jsx("div",{className:"mb-1",children:e.jsx(Oe,{companyName:p.companyName})}),e.jsx("h4",{className:"font-semibold text-slate-900 truncate",children:p.personName})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex flex-col gap-1 items-end shrink-0",children:[p.uniqueNumber&&e.jsx("span",{className:"text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-700",children:p.uniqueNumber}),e.jsxs("div",{className:"flex gap-1",children:[W(p)?e.jsx(Ne,{label:d("participant.completedBadge"),variant:"success",icon:"check"}):e.jsx("span",{className:"text-[10px] text-slate-400 italic font-medium",children:d("completed.pending")}),V(p)&&e.jsx(Ne,{label:d("participant.manual"),variant:"info",icon:"manual"})]})]}),e.jsx(bt,{onDetails:()=>h({isOpen:!0,participant:p})})]})]}),e.jsx("div",{className:"text-sm text-slate-600 mb-2",children:e.jsxs("div",{className:"text-[10px] text-slate-500 uppercase tracking-wider font-semibold mb-1",children:[d("participant.medical"),": ",L(p.medicalDate)]})}),e.jsxs("div",{className:"flex flex-nowrap justify-between items-center gap-0.5 mt-auto pt-2 border-t border-slate-50 overflow-hidden",children:[e.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[e.jsx("input",{type:"checkbox",checked:p.sent,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),d("participant.sent")]}),e.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[e.jsx("input",{type:"checkbox",checked:p.documents,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),d("participant.documents")]}),e.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[e.jsx("input",{type:"checkbox",checked:p.handedOver,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),d("participant.handed")]}),e.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[e.jsx("input",{type:"checkbox",checked:p.paid,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),d("participant.paid")]})]})]},p.id);return t.length===0?e.jsx("div",{className:"text-center py-12 text-slate-500",children:d("participants.noResults")}):e.jsxs(e.Fragment,{children:[e.jsx(Mt,{selectedCount:m.size,selectedIds:Array.from(m),onClearSelection:ae,onActionComplete:Z}),e.jsx(_s,{isOpen:f.isOpen,onClose:()=>h({isOpen:!1,participant:void 0}),participant:f.participant}),e.jsx(It,{isOpen:te.isOpen,onClose:()=>re(p=>({...p,isOpen:!1})),title:te.title,message:te.message,variant:te.variant==="error"?"danger":te.variant}),e.jsxs("div",{className:"space-y-4 pb-32",children:[(A.active.length>0||!i)&&e.jsx(ve,{title:d("groups.activeSection"),count:v.active.count,groupNumbers:U.length<=1&&q.length>0?q:[],dateRange:U.length<=1?M:void 0,participantCount:A.active.length,isCollapsed:o.active,onToggle:()=>l("active"),showCount:U.length<=1?Math.max(q.length,0)>0:!0,variant:"active",children:U.length===0?e.jsx("div",{className:"text-center py-8 text-slate-500 bg-slate-50/50 rounded-lg border border-dashed border-slate-200",children:e.jsx("p",{children:d("participants.noActive")})}):e.jsx("div",{className:"space-y-8",children:U.map(p=>e.jsxs("div",{className:"space-y-4",children:[U.length>1&&e.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-blue-100",children:[e.jsxs("span",{className:"font-semibold text-blue-900",children:[L(p.group.courseStartDate)," - ",L(p.group.courseEndDate)]}),p.group.groupNumber&&e.jsxs("span",{className:"px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-bold",children:["№ ",p.group.groupNumber]})]}),p.participants.length>0?e.jsx("div",{className:"space-y-4",children:p.participants.map((y,I)=>pe(y))}):e.jsx("div",{className:"text-center py-4 italic text-slate-400 bg-white/50 rounded border border-dashed border-slate-100",children:d("participants.noParticipantsInGroup")})]},p.group.courseStartDate))})}),(A.planned.length>0||!i)&&e.jsx(ve,{title:d("groups.plannedSection"),count:v.planned.count,groupNumbers:T.map(p=>p.group.groupNumber).filter(p=>p!==null),participantCount:A.planned.length,isCollapsed:o.planned,onToggle:()=>l("planned"),variant:"planned",children:T.length>0?e.jsx("div",{className:"space-y-3",children:T.map(({courseStartDate:p,group:y,participants:I})=>e.jsxs("div",{className:"bg-white border-2 border-amber-200 rounded-lg overflow-hidden",children:[e.jsx("div",{className:"bg-amber-50 px-3 py-2 border-b border-amber-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[y.groupNumber&&e.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-900 rounded text-xs font-semibold",children:["№ ",y.groupNumber]}),e.jsxs("span",{className:"font-semibold text-amber-900",children:[L(y.courseStartDate)," - ",L(y.courseEndDate)]})]}),e.jsxs("span",{className:"text-xs text-amber-700 font-medium",children:[I.length," ",I.length===1?d("group.participant_one"):d("group.participant_other")]})]})}),e.jsx("div",{className:"p-2 space-y-2",children:I.map((E,F)=>pe(E))})]},p))}):e.jsx("div",{className:"text-center py-8 text-slate-500",children:d("participants.noParticipantsInGroup")})}),(A.completed.length>0||!i)&&e.jsx(ve,{title:d("groups.completedSection"),count:v.completed.count,participantCount:A.completed.length,isCollapsed:o.completed,onToggle:()=>l("completed"),variant:"completed",children:G.length>0?e.jsx("div",{className:"space-y-2",children:G.map(({courseStartDate:p,group:y,participants:I})=>e.jsx(Lt,{groupNumber:y.groupNumber||0,courseStartDate:y.courseStartDate,courseEndDate:y.courseEndDate,participants:I,renderParticipantRow:xe,mode:"cards",defaultExpanded:i},p))}):e.jsx("div",{className:"text-center py-8 text-slate-500",children:"Няма приключени групи"})})]}),i&&t.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 text-center",children:[e.jsx("div",{className:"text-6xl mb-4",children:"🔍"}),e.jsx("h3",{className:"text-lg font-semibold text-slate-700 mb-2",children:"Няма намерени резултати"}),e.jsx("p",{className:"text-sm text-slate-500 mb-6",children:"Опитай да промениш филтрите"})]}),e.jsx(Me,{isOpen:k.isOpen,onClose:()=>P({isOpen:!1,participant:void 0}),onConfirm:me,title:d("modal.deleteTitle"),message:d("modal.deleteMessage",{name:((he=k.participant)==null?void 0:he.personName)||""}),confirmText:d("common.delete"),cancelText:d("common.cancel"),variant:"danger"})]})},zs=({isOpen:t,onClose:s,participant:a})=>{const{addParticipant:n,updateParticipant:o}=Ke(),{t:l}=X(),[r,i]=x.useState({companyName:"",personName:"",egn:"",birthPlace:"",citizenship:"българско",medicalDate:"",groupAssignmentMode:"auto",selectedGroupId:"",uniqueNumber:""}),[d,u]=x.useState({courseStartDate:"",courseEndDate:""}),[m,S]=x.useState({}),[N,$]=x.useState(!1),[k,P]=x.useState(""),[f,h]=x.useState(null),[b,C]=x.useState({isOpen:!1,message:"",onConfirm:()=>{}}),A=ye(()=>ue(),[]),T=ye(()=>D.groups.orderBy("groupNumber").toArray(),[]),[G,_]=x.useState(null);x.useEffect(()=>{if(!r.medicalDate){_(null);return}Fe(r.medicalDate).then(v=>{if(v.group)_(v.group);else if(v.createsForDate){const B=new Date(v.createsForDate),z=new Date(B);z.setDate(B.getDate()+7),_({groupNumber:null,courseStartDate:v.createsForDate,courseEndDate:z.toISOString().split("T")[0],status:"planned"})}else _(null)})},[r.medicalDate]),x.useEffect(()=>{a?(i({companyName:a.companyName,personName:a.personName,egn:a.egn||"",birthPlace:a.birthPlace||"",citizenship:a.citizenship||"българско",medicalDate:a.medicalDate,groupAssignmentMode:"auto",selectedGroupId:"",uniqueNumber:a.uniqueNumber}),u({courseStartDate:a.courseStartDate,courseEndDate:a.courseEndDate}),P("")):(i({companyName:"",personName:"",egn:"",birthPlace:"",citizenship:"българско",medicalDate:"",groupAssignmentMode:"auto",selectedGroupId:"",uniqueNumber:""}),u({courseStartDate:"",courseEndDate:""}),t&&Promise.all([We(),st()]).then(([v,B])=>{P(v),h(B)}).catch(v=>{console.error("Failed to generate next unique number:",v),P(""),h(null)})),S({})},[a,t]),x.useEffect(()=>{if(G)u({courseStartDate:G.courseStartDate,courseEndDate:G.courseEndDate}),G.status==="active"?Promise.all([We(),st()]).then(([v,B])=>{P(B||v),h(B),a&&i(W=>({...W,uniqueNumber:""}))}).catch(v=>{console.error("Failed to get unique number:",v)}):(P(""),h(null));else if(r.medicalDate)try{const v=ze(r.medicalDate);u(v)}catch(v){console.error("Error computing dates:",v)}},[r.medicalDate,G,a]);const q=async()=>{const v={};if(r.companyName.trim()||(v.companyName=l("modal.companyNameRequired")),r.personName.trim()||(v.personName=l("modal.personNameRequired")),r.egn.trim()?/^\d{10}$/.test(r.egn)||(v.egn=l("modal.egnInvalid")):v.egn=l("modal.egnRequired"),r.birthPlace.trim()||(v.birthPlace=l("modal.birthPlaceRequired")),r.medicalDate?Ss(r.medicalDate)||(v.medicalDate=Be):v.medicalDate=l("modal.medicalDateRequired"),r.uniqueNumber){if(!ys(r.uniqueNumber))v.uniqueNumber=l("modal.uniqueNumberInvalid");else if(!await tt(r.uniqueNumber,a==null?void 0:a.id))v.uniqueNumber=l("modal.uniqueNumberExists");else if(f&&!a){const z=Se(r.uniqueNumber),W=Se(f);z&&W&&(z.prefix>W.prefix||z.prefix===W.prefix&&z.seq>W.seq)&&(v.uniqueNumber=l("modal.cannotSkipGap",{number:f}))}}return S(v),Object.keys(v).length===0},M=async v=>{if(v.preventDefault(),!!await q()){if(r.groupAssignmentMode==="manual"&&r.selectedGroupId){const z=parseInt(r.selectedGroupId,10),W=T==null?void 0:T.find(V=>V.groupNumber===z);if((W==null?void 0:W.status)==="completed"){S(V=>({...V,selectedGroupId:l("modal.completedGroupError")}));return}if(!be(r.medicalDate,W.courseStartDate)){S(V=>({...V,medicalDate:l("modal.medicalDateCourseValidation")}));return}}else if(!be(r.medicalDate,d.courseStartDate)){S(z=>({...z,medicalDate:l("modal.medicalDateCourseValidation")}));return}if(r.groupAssignmentMode==="manual"&&r.selectedGroupId){const z=parseInt(r.selectedGroupId,10),W=await Fe(d.courseStartDate);if(W.group&&W.group.groupNumber!==z){const V=T==null?void 0:T.find(Q=>Q.groupNumber===z);C({isOpen:!0,message:l("modal.groupWarningMessage",{selected:String(z),selectedDate:L(V.courseStartDate),suggested:String(W.group.groupNumber??""),suggestedDate:L(W.group.courseStartDate)}),onConfirm:()=>{C({isOpen:!1,message:"",onConfirm:()=>{}}),U()}});return}}await U()}},U=async()=>{$(!0);try{const v={companyName:r.companyName.trim(),personName:r.personName.trim(),egn:r.egn.trim(),birthPlace:r.birthPlace.trim(),citizenship:r.citizenship.trim()||"българско",medicalDate:r.medicalDate,uniqueNumber:r.uniqueNumber.trim()||f||void 0};a?await o(a.id,v):await n(v),s()}catch(v){console.error("Error saving participant:",v),alert(`${l("error.saveFailed")}: ${v.message}`)}finally{$(!1)}};return t?e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",onClick:s,children:[e.jsxs("div",{className:"w-full max-w-2xl p-16 cursor-default",onClick:v=>v.stopPropagation(),children:[e.jsx("div",{className:"bg-white rounded-lg w-full max-h-[85vh] overflow-y-auto shadow-xl",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:l(a?"modal.editParticipant":"modal.addParticipant")}),a&&e.jsx("div",{className:"mb-4 p-3 bg-slate-50 rounded-lg border border-slate-200",children:e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[a.createdAt&&e.jsxs("div",{children:[e.jsxs("span",{className:"text-slate-600",children:[l("timestamp.createdAt"),":"]}),e.jsxs("span",{className:"ml-2 font-medium text-slate-900",children:[L(a.createdAt.split("T")[0])," ",new Date(a.createdAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})]})]}),a.updatedAt&&e.jsxs("div",{children:[e.jsxs("span",{className:"text-slate-600",children:[l("timestamp.updatedAt"),":"]}),e.jsxs("span",{className:"ml-2 font-medium text-slate-900",children:[L(a.updatedAt.split("T")[0])," ",new Date(a.updatedAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})]})]}),a.completedAt&&e.jsxs("div",{className:"col-span-2",children:[e.jsxs("span",{className:"text-emerald-600",children:[l("timestamp.completedAt"),":"]}),e.jsxs("span",{className:"ml-2 font-medium text-emerald-800",children:[L(a.completedAt.split("T")[0])," ",new Date(a.completedAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})]})]})]})}),e.jsxs("form",{onSubmit:M,children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:[l("modal.companyName")," *"]}),e.jsxs("select",{value:r.companyName,onChange:v=>i({...r,companyName:v.target.value}),className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:l("modal.selectCompany")}),e.jsx("option",{value:"Egida",children:"Egida"}),e.jsx("option",{value:"D-Max",children:"D-Max"}),e.jsx("option",{value:"Multiforce",children:"Multiforce"})]}),m.companyName&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.companyName})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:[l("modal.personName")," *"]}),e.jsx("input",{type:"text",value:r.personName,onChange:v=>i({...r,personName:v.target.value}),className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),m.personName&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.personName})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"ЕГН *"}),e.jsx("input",{type:"text",value:r.egn,onChange:v=>i({...r,egn:v.target.value}),placeholder:"XXXXXXXXXX",maxLength:10,className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),m.egn&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.egn})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Месторождение *"}),e.jsx("input",{type:"text",value:r.birthPlace,onChange:v=>i({...r,birthPlace:v.target.value}),placeholder:"гр./с. ...",className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),m.birthPlace&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.birthPlace})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Гражданство"}),e.jsx("input",{type:"text",value:r.citizenship,onChange:v=>i({...r,citizenship:v.target.value}),placeholder:"българско",className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:[l("modal.medicalDate")," *"]}),e.jsx("input",{type:"date",value:r.medicalDate,onChange:v=>i({...r,medicalDate:v.target.value}),onClick:v=>{var B,z;return(z=(B=v.target).showPicker)==null?void 0:z.call(B)},className:`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer ${m.medicalDate?"border-red-500":"border-slate-300"}`}),m.medicalDate&&e.jsx("p",{className:"text-red-600 text-sm mt-1 font-medium",children:m.medicalDate}),r.medicalDate&&!m.medicalDate&&e.jsxs("p",{className:"text-emerald-600 text-sm mt-1",children:["✓ ",l("modal.medicalValid"),": ",L(r.medicalDate)]})]}),d.courseStartDate&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 p-4 rounded-md",children:[e.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:l("modal.courseDates")}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-blue-700 mb-1",children:l("modal.courseStart")}),e.jsx("div",{className:"text-lg font-semibold text-blue-900",children:L(d.courseStartDate)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-blue-700 mb-1",children:l("modal.courseEnd")}),e.jsx("div",{className:"text-lg font-semibold text-blue-900",children:L(d.courseEndDate)})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:l("modal.groupAssignment")}),e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("button",{type:"button",onClick:()=>i({...r,groupAssignmentMode:"auto",selectedGroupId:""}),className:`flex-1 px-3 py-2 rounded-md border ${r.groupAssignmentMode==="auto"?"bg-blue-700 text-white border-blue-700":"bg-white text-slate-700 border-slate-300 hover:bg-slate-50"}`,children:l("modal.auto")}),e.jsx("button",{type:"button",onClick:()=>i({...r,groupAssignmentMode:"manual"}),className:`flex-1 px-3 py-2 rounded-md border ${r.groupAssignmentMode==="manual"?"bg-blue-700 text-white border-blue-700":"bg-white text-slate-700 border-slate-300 hover:bg-slate-50"}`,children:l("modal.manual")})]}),r.groupAssignmentMode==="auto"&&G&&e.jsx(e.Fragment,{children:G.status==="completed"?e.jsx("div",{className:"bg-red-50 border border-red-200 p-3 rounded-md",children:e.jsxs("p",{className:"text-sm text-red-800 font-medium",children:["⛔ ",l("modal.periodClosed"),e.jsx("br",{}),e.jsxs("span",{className:"text-xs font-normal mt-1 block",children:[l("modal.cannotAddComp",{date:L(G.courseStartDate)}),e.jsx("br",{}),l("modal.selectOtherDate")]})]})}):e.jsx("div",{className:"bg-emerald-50 border border-emerald-200 p-3 rounded-md",children:e.jsxs("p",{className:"text-sm text-emerald-800",children:["✓ ",l("modal.willBeAssigned")," ",e.jsxs("span",{className:"font-semibold",children:[l("group.number")," ",G.groupNumber||"-"]})," ","(",L(G.courseStartDate)," - ",L(G.courseEndDate),")"," ",e.jsx("span",{className:`inline-block px-2 py-0.5 rounded text-xs font-semibold ${G.status==="active"?"bg-blue-100 text-blue-700":"bg-slate-100 text-slate-700"}`,children:G.status==="active"?l("modal.active"):l("modal.planned")})]})})}),r.groupAssignmentMode==="manual"&&e.jsxs("select",{value:r.selectedGroupId,onChange:v=>i({...r,selectedGroupId:v.target.value}),className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:l("modal.selectGroup")}),A&&e.jsxs("option",{value:(A.groupNumber||"").toString(),children:[l("group.number")," ",A.groupNumber||"-"," - ",L(A.courseStartDate)," (",l("modal.active"),")"]}),T==null?void 0:T.filter(v=>v.status==="planned").map(v=>e.jsxs("option",{value:(v.groupNumber||"").toString(),children:[l("group.number")," ",v.groupNumber||"-"," - ",L(v.courseStartDate)," (",l("modal.planned"),")"]},v.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:l("modal.uniqueNumberAuto")}),f&&a&&e.jsx("div",{className:"mb-2 p-2 bg-amber-50 border border-amber-300 rounded-md",children:e.jsxs("p",{className:"text-amber-800 text-sm font-medium",children:["⚠️ Участникът ще получи попълващ номер: ",f]})}),a&&(G==null?void 0:G.status)==="active"&&k&&!f&&e.jsx("div",{className:"mb-2 p-2 bg-blue-50 border border-blue-300 rounded-md",children:e.jsxs("p",{className:"text-blue-800 text-sm font-medium",children:["ℹ️ Преместване в активна група → Уникален номер: ",e.jsx("span",{className:"font-bold",children:k})]})}),e.jsx("input",{type:"text",value:r.uniqueNumber,onChange:v=>i({...r,uniqueNumber:v.target.value}),placeholder:k?`${l("modal.uniqueNumberNext")}: ${k}`:"e.g., 3534-001",className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono"}),m.uniqueNumber&&e.jsx("p",{className:"text-red-600 text-sm mt-1",children:m.uniqueNumber})]})]}),e.jsxs("div",{className:"mt-6 flex gap-3 justify-end pb-2 md:pb-0",children:[e.jsx("button",{type:"button",onClick:s,className:"px-4 py-2 border border-slate-200 rounded-md text-slate-700 hover:bg-slate-50",disabled:N,children:l("common.cancel")}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-700 text-white rounded-md hover:bg-blue-800 disabled:opacity-50 disabled:cursor-not-allowed",disabled:N||r.groupAssignmentMode==="auto"&&(G==null?void 0:G.status)==="completed",children:l(N?"common.saving":a?"modal.update":"common.add")})]})]})]})})," "]})," ",e.jsx(Me,{isOpen:b.isOpen,onClose:()=>C({isOpen:!1,message:"",onConfirm:()=>{}}),onConfirm:b.onConfirm,title:"Предупреждение за група",message:b.message,confirmText:"Продължи",cancelText:"Отказ",variant:"warning"})]}):null},Ws=({isOpen:t,onClose:s,searchText:a,onSearchTextChange:n,selectedGroup:o,onSelectedGroupChange:l,statusFilters:r,onStatusFilterChange:i,dateRange:d,onDateRangeChange:u,groups:m,onResetToDefaults:S,visibleCount:N,totalCount:$})=>{const{t:k}=X(),P=h=>{h.key==="Enter"&&s()};x.useEffect(()=>{const h=b=>{b.key==="Escape"&&s()};if(t)return document.addEventListener("keydown",h),()=>document.removeEventListener("keydown",h)},[t,s]);const f=({label:h,value:b,onChange:C})=>e.jsxs("div",{className:"mb-3",children:[e.jsx("span",{className:"text-sm font-medium text-slate-700 mb-1.5 block",children:h}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx("button",{onClick:()=>C(null),className:`px-2 py-1.5 text-sm rounded-lg min-h-[36px] font-medium transition-colors duration-150 ${b===null?"bg-slate-500 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:k("filters.all")}),e.jsx("button",{onClick:()=>C(!0),className:`px-2 py-1.5 text-sm rounded-lg min-h-[36px] font-medium transition-colors duration-150 ${b===!0?"bg-emerald-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:k("filters.yes")}),e.jsx("button",{onClick:()=>C(!1),className:`px-2 py-1.5 text-sm rounded-lg min-h-[36px] font-medium transition-colors duration-150 ${b===!1?"bg-red-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"}`,children:k("filters.no")})]})]});return t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 bg-black/30 z-40 transition-opacity",onClick:s}),e.jsxs("div",{className:`fixed z-50 bg-white shadow-2xl transition-transform
          md:top-0 md:left-0 md:bottom-auto md:right-auto md:h-auto md:max-h-[calc(100vh-16px)] md:w-[360px] lg:w-[420px] md:max-w-[480px] md:translate-x-0
          bottom-0 left-0 right-0 max-h-[90vh] rounded-t-3xl md:rounded-none flex flex-col
          ${t?"translate-y-0":"translate-y-full md:translate-y-0 md:-translate-x-full"}
        `,children:[e.jsx("div",{className:"md:hidden flex justify-center pt-3 pb-2",children:e.jsx("div",{className:"w-12 h-1.5 bg-slate-300 rounded-full"})}),e.jsxs("div",{className:"sticky top-0 bg-white flex items-center justify-between p-4 border-b border-slate-200 z-10",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-900",children:k("filters.title")}),N!==void 0&&$!==void 0&&e.jsxs("span",{className:"text-sm font-medium text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full",children:[N," / ",$]})]}),e.jsx("button",{onClick:s,className:"p-2 hover:bg-slate-100 rounded-lg min-w-[44px] min-h-[44px] transition-colors duration-150",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"p-4 pb-4 flex-1 md:flex-none overflow-y-auto overscroll-contain",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:k("filters.search")}),e.jsx("input",{type:"text",value:a,onChange:h=>n(h.target.value),onKeyDown:P,placeholder:k("filters.searchPlaceholder"),className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:k("filters.group")}),e.jsxs("select",{value:o,onChange:h=>l(h.target.value),className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150",children:[e.jsx("option",{value:"",children:k("filters.allGroups")}),m.map(h=>e.jsx("option",{value:h.groupNumber.toString(),children:k("filters.groupOption",{number:h.groupNumber.toString(),date:h.courseStartDate})},h.groupNumber))]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:k("filters.dateRange")}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("input",{type:"date",value:d.start,onChange:h=>u({...d,start:h.target.value}),onClick:h=>{var b,C;return(C=(b=h.target).showPicker)==null?void 0:C.call(b)},className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150 cursor-pointer"}),e.jsx("input",{type:"date",value:d.end,onChange:h=>u({...d,end:h.target.value}),onClick:h=>{var b,C;return(C=(b=h.target).showPicker)==null?void 0:C.call(b)},className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150 cursor-pointer"})]})]}),e.jsxs("div",{className:"border-t border-slate-200 pt-4 mt-4",children:[e.jsx("h4",{className:"font-medium text-slate-900 mb-4",children:k("filters.statusFilters")}),e.jsx(f,{label:k("participant.sent"),value:r.sent,onChange:h=>i("sent",h)}),e.jsx(f,{label:k("participant.documents"),value:r.documents,onChange:h=>i("documents",h)}),e.jsx(f,{label:k("participant.handed"),value:r.handedOver,onChange:h=>i("handedOver",h)}),e.jsx(f,{label:k("participant.paid"),value:r.paid,onChange:h=>i("paid",h)}),e.jsx(f,{label:k("participant.completed"),value:r.completed,onChange:h=>i("completed",h)})]}),e.jsxs("div",{className:"mt-6 mb-6 pb-8 flex gap-3",children:[e.jsx("button",{onClick:()=>{n(""),l(""),u({start:"",end:""}),i("sent",null),i("documents",null),i("handedOver",null),i("paid",null),i("completed",null),S()},className:"flex-1 px-4 py-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 font-medium min-h-[48px] transition-colors duration-150",children:k("filters.clearAll")}),e.jsx("button",{onClick:s,className:"flex-1 px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium min-h-[48px] transition-colors duration-150",children:k("filters.apply")})]})]})]})]}):null},Fs=({activeFilters:t,onRemoveFilter:s})=>{var o,l;const{t:a}=X(),n=[];return t.searchText&&n.push({label:`${a("filters.search")}: "${t.searchText}"`,type:"search"}),t.selectedGroup&&n.push({label:`${a("filters.group")}: ${t.selectedGroup}`,type:"group"}),(o=t.dateRange)!=null&&o.start&&n.push({label:`${a("filters.from")}: ${L(t.dateRange.start)}`,type:"dateStart"}),(l=t.dateRange)!=null&&l.end&&n.push({label:`${a("filters.to")}: ${L(t.dateRange.end)}`,type:"dateEnd"}),t.statusFilters&&Object.entries(t.statusFilters).forEach(([r,i])=>{if(i!==null){const d=`participant.${r}`;n.push({label:`${a(d)}: ${a(i?"filters.yes":"filters.no")}`,type:"status",value:r})}}),n.length===0?null:e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[n.map((r,i)=>e.jsxs("button",{onClick:()=>s(r.type,r.value),className:"inline-flex items-center gap-2 px-3 py-1.5 bg-blue-100 text-blue-800 rounded-full text-sm hover:bg-blue-200 transition-colors duration-150",children:[e.jsx("span",{children:r.label}),e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]},i)),e.jsx("button",{onClick:()=>s("all"),className:"px-3 py-1.5 bg-slate-200 text-slate-700 rounded-full text-sm hover:bg-slate-300 transition-colors duration-150",children:"Clear All"})]})},Hs=3e5,Vs=16,Ys="SHA-256",Ks=256,Xe="app_pin_config";function gt(t){const s=new Uint8Array(t);let a="";const n=s.byteLength,o=8192;for(let l=0;l<n;l+=o)a+=String.fromCharCode.apply(null,s.subarray(l,l+o));return window.btoa(a)}function Xs(t){try{const s=window.atob(t),a=s.length,n=new Uint8Array(a);for(let o=0;o<a;o++)n[o]=s.charCodeAt(o);return n}catch{throw new Error("Invalid Base64 string")}}async function $t(t,s){let a;s?a=Xs(s):a=window.crypto.getRandomValues(new Uint8Array(Vs));const n=new TextEncoder,o=await window.crypto.subtle.importKey("raw",n.encode(t),{name:"PBKDF2"},!1,["deriveBits","deriveKey"]),l=await window.crypto.subtle.deriveBits({name:"PBKDF2",salt:a,iterations:Hs,hash:Ys},o,Ks);return{hash:gt(l),salt:gt(a.buffer)}}async function wt(t,s){try{const{hash:a}=await $t(t,s.salt);return a===s.hash}catch(a){return console.error("PIN verification failed:",a),!1}}function Js(t){localStorage.setItem(Xe,JSON.stringify(t))}function Nt(){const t=localStorage.getItem(Xe);if(!t)return null;try{return JSON.parse(t)}catch{return null}}function rt(){localStorage.removeItem(Xe)}function Ee(){return!!localStorage.getItem(Xe)}const Qs=({mode:t,onSuccess:s,onCancel:a,onResetData:n})=>{const{t:o}=X(),[l,r]=x.useState(""),[i,d]=x.useState(""),[u,m]=x.useState("enter"),[S,N]=x.useState(null),[$,k]=x.useState(!1),[P,f]=x.useState(!1);x.useEffect(()=>{r(""),d(""),m("enter"),N(null)},[t]);const h=q=>{if($)return;N(null);const M=u==="enter"?l:i;if(M.length<4){const U=M+q.toString();u==="enter"?r(U):d(U),U.length===4&&C(U)}},b=()=>{$||(N(null),u==="enter"?r(q=>q.slice(0,-1)):d(q=>q.slice(0,-1)))},C=async q=>{k(!0),await new Promise(M=>setTimeout(M,100));try{if(t==="unlock"){const M=Nt();if(!M){s();return}await wt(q,M)?s():(N(o("security.incorrectPin")),r(""))}else if(t==="setup")if(u==="enter"){m("confirm"),k(!1);return}else if(q===l){const{hash:M,salt:U}=await $t(q);Js({version:1,hash:M,salt:U,algo:"PBKDF2-SHA-256",createdAt:new Date().toISOString()}),s()}else N(o("security.pinMismatch")),r(""),d(""),m("enter");else if(t==="disable"){const M=Nt();M&&await wt(q,M)?(rt(),s()):(N(o("security.incorrectPin")),r(""))}}catch(M){console.error(M),N(o("security.error"))}finally{k(!1)}},A=()=>e.jsxs("div",{className:"grid grid-cols-3 gap-4 max-w-[280px] mx-auto mt-8",children:[[1,2,3,4,5,6,7,8,9].map(q=>e.jsx("button",{onClick:()=>h(q),className:"w-16 h-16 rounded-full bg-slate-100 text-slate-700 text-2xl font-bold hover:bg-slate-200 active:bg-slate-300 transition-colors flex items-center justify-center shadow-sm",children:q},q)),e.jsx("div",{className:"w-16 h-16 flex items-center justify-center",children:t==="unlock"&&e.jsx("button",{onClick:()=>f(!0),className:"text-xs text-slate-400 font-medium hover:text-red-500 transition-colors",children:o("security.forgot")})}),e.jsx("button",{onClick:()=>h(0),className:"w-16 h-16 rounded-full bg-slate-100 text-slate-700 text-2xl font-bold hover:bg-slate-200 active:bg-slate-300 transition-colors flex items-center justify-center shadow-sm",children:"0"}),e.jsx("button",{onClick:b,className:"w-16 h-16 rounded-full text-slate-500 hover:text-slate-700 hover:bg-slate-100 active:bg-slate-200 transition-colors flex items-center justify-center",children:e.jsx(hs,{className:"w-6 h-6"})})]}),T=q=>e.jsx("div",{className:"flex gap-4 justify-center mb-6",children:[0,1,2,3].map(M=>e.jsx("div",{className:`w-4 h-4 rounded-full border-2 transition-all duration-200 ${M<q.length?"bg-blue-600 border-blue-600":"bg-transparent border-slate-300"} ${S?"border-red-400 bg-red-50":""}`},M))}),G=()=>o(t==="setup"?u==="enter"?"security.setPinTitle":"security.confirmPinTitle":t==="disable"?"security.enterPinToDisable":"security.appLocked"),_=()=>S||o(t==="setup"?u==="enter"?"security.enter4DigitPin":"security.reEnterToConfirm":"security.enterYourPin");return e.jsxs("div",{className:"fixed inset-0 bg-slate-50 z-[100] flex flex-col items-center justify-center p-4 animate-in fade-in duration-300",children:[e.jsxs("div",{className:"w-full max-w-sm text-center",children:[e.jsx("div",{className:"mb-6 flex justify-center",children:e.jsx("div",{className:`p-4 rounded-full ${S?"bg-red-100":"bg-blue-100"}`,children:t==="unlock"?e.jsx(Dt,{className:`w-8 h-8 ${S?"text-red-600":"text-blue-600"}`}):e.jsx(xs,{className:"w-8 h-8 text-blue-600"})})}),e.jsx("h2",{className:`text-2xl font-bold mb-2 ${S?"text-red-600":"text-slate-800"}`,children:G()}),e.jsx("p",{className:`text-sm mb-8 font-medium ${S?"text-red-500":"text-slate-500"}`,children:_()}),T(u==="enter"?l:i),A(),a&&e.jsx("button",{onClick:a,className:"mt-8 text-slate-500 hover:text-slate-700 font-medium text-sm",children:o("common.cancel")})]}),P&&e.jsx(Me,{isOpen:P,onClose:()=>f(!1),onConfirm:()=>{n&&(rt(),n()),f(!1)},title:o("security.resetDataTitle"),message:o("security.resetDataMessage"),confirmText:o("security.resetDataConfirm"),variant:"danger"})]})},vt=10*60*1e3,Zs=({children:t})=>{const[s,a]=x.useState(!1),[n,o]=x.useState(!1),l=x.useRef(Date.now()),r=x.useRef(null);x.useEffect(()=>{Ee()&&a(!0),o(!0)},[]);const i=x.useCallback(()=>{Ee()&&a(!0)},[]),d=x.useCallback(()=>{a(!1),l.current=Date.now()},[]);x.useEffect(()=>{if(s)return;const m=()=>{l.current=Date.now()},S=["mousedown","keydown","touchstart","scroll","mousemove"];let N=null;const $=()=>{N||(m(),N=setTimeout(()=>{N=null},1e3))};S.forEach(P=>window.addEventListener(P,$));const k=()=>{!document.hidden&&Ee()&&Date.now()-l.current>vt&&a(!0)};return document.addEventListener("visibilitychange",k),r.current=setInterval(()=>{if(document.hidden)return;Date.now()-l.current>vt&&Ee()&&a(!0)},5e3),()=>{S.forEach(P=>window.removeEventListener(P,$)),document.removeEventListener("visibilitychange",k),r.current&&clearInterval(r.current),N&&clearTimeout(N)}},[s]),x.useEffect(()=>{const m=()=>i();return window.addEventListener("app-lock-manual",m),()=>window.removeEventListener("app-lock-manual",m)},[i]);const u=async()=>{try{await D.delete(),await D.open(),rt(),window.location.reload()}catch(m){console.error("Failed to reset data",m),alert("Failed to reset data. Please clear browser storage manually.")}};return n?s?e.jsx(Qs,{mode:"unlock",onSuccess:d,onResetData:u}):e.jsx(e.Fragment,{children:t}):null},ea=()=>{window.dispatchEvent(new Event("app-lock-manual"))},ta=({activeTab:t,onTabChange:s,onBack:a})=>{const{t:n}=X();return e.jsx("header",{className:"bg-blue-700 text-white shadow-sm sticky top-0 z-40",children:e.jsx("div",{className:"container mx-auto px-4 py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[a&&e.jsx("button",{onClick:a,className:"md:hidden p-2 hover:bg-blue-700 rounded-lg",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("div",{className:"flex-shrink-0 w-14 h-14 md:w-16 md:h-16 bg-white rounded-md flex items-center justify-center overflow-hidden",children:e.jsx("img",{src:"./Logo.svg",alt:"Logo",className:"w-full h-full object-cover scale-[2.4]"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"CERTIFY"}),e.jsx("p",{className:"text-sm md:text-base text-blue-100",children:n("nav.subtitle")})]}),e.jsxs("div",{className:"hidden md:flex gap-2",children:[e.jsxs("button",{onClick:()=>s("participants"),className:`px-6 py-2 rounded-lg font-medium transition-colors duration-150 flex items-center gap-2 ${t==="participants"?"bg-white text-blue-800":"bg-blue-700/30 text-white hover:bg-blue-700/50"}`,children:[e.jsx(Ue,{className:"w-5 h-5",strokeWidth:2}),n("nav.participants")]}),e.jsxs("button",{onClick:()=>s("tools"),className:`px-6 py-2 rounded-lg font-medium transition-colors duration-150 flex items-center gap-2 ${t==="tools"?"bg-white text-blue-800":"bg-blue-700/30 text-white hover:bg-blue-700/50"}`,children:[e.jsx(Ct,{className:"w-5 h-5",strokeWidth:2}),n("nav.tools")]}),Ee()&&e.jsxs("button",{onClick:()=>ea(),className:"px-4 py-2 ml-2 rounded-lg font-medium bg-indigo-600 text-white hover:bg-indigo-500 border border-indigo-400/50 shadow-sm transition-all duration-150 flex items-center gap-2",title:n("nav.lock"),children:[e.jsx(Dt,{className:"w-5 h-5",strokeWidth:2}),e.jsx("span",{className:"hidden lg:inline",children:n("nav.lock")})]})]})]})})})},sa=({totalParticipants:t,visibleParticipants:s,totalCourses:a,visibleCourses:n,completedCount:o})=>{const{t:l}=X(),[r,i]=x.useState(!1);return e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"md:hidden",children:[e.jsxs("button",{onClick:()=>i(!r),className:"w-full bg-white rounded-lg px-2 py-2 shadow-sm border border-slate-200 flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"text-[11px] font-medium text-slate-500",children:l("participants.showing")}),e.jsxs("div",{className:"text-lg font-bold text-blue-600",children:[s,"/",t]})]}),e.jsxs("div",{className:"text-left",children:[e.jsx("div",{className:"text-[11px] font-medium text-slate-500",children:l("participant.completed")}),e.jsx("div",{className:"text-lg font-bold text-emerald-700",children:o})]})]}),e.jsx("svg",{className:`w-4 h-4 text-slate-500 transition-transform duration-200 ${r?"rotate-180":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),r&&e.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-1",children:[e.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-slate-400",children:[e.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-slate-900 font-semibold whitespace-nowrap",children:l("participants.total")}),e.jsx("div",{className:"text-[9px] text-transparent font-medium mt-0.5 select-none",children:" "})]}),e.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:e.jsx(Ue,{className:"w-3.5 h-3.5 text-slate-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-2xl font-semibold tracking-tight text-slate-900",children:t})]}),e.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-blue-500",children:[e.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-blue-600 font-semibold whitespace-nowrap",children:l("participants.showing")}),e.jsx("div",{className:"text-[9px] text-slate-500 font-medium mt-0.5",children:l("participants.showingSubtext")})]}),e.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:e.jsx(ut,{className:"w-3.5 h-3.5 text-blue-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-2xl font-semibold tracking-tight text-blue-600",children:s})]}),e.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-indigo-500",children:[e.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-indigo-600 font-semibold whitespace-nowrap",children:l("participants.totalCourses")}),e.jsx("div",{className:"text-[9px] text-slate-500 font-medium mt-0.5",children:l("participants.totalCoursesSubtext")})]}),e.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:e.jsx(mt,{className:"w-3.5 h-3.5 text-indigo-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-2xl font-semibold tracking-tight text-indigo-600",children:a})]}),e.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-cyan-500",children:[e.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-cyan-600 font-semibold whitespace-nowrap",children:l("participants.visibleCourses")}),e.jsx("div",{className:"text-[9px] text-slate-500 font-medium mt-0.5",children:l("participants.visibleCoursesSubtext")})]}),e.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:e.jsx(_e,{className:"w-3.5 h-3.5 text-cyan-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-2xl font-semibold tracking-tight text-cyan-600",children:n})]}),e.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-amber-500 col-span-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("div",{className:"text-xs uppercase tracking-wide text-amber-600 font-semibold whitespace-nowrap",children:l("participants.completed")}),e.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:e.jsx(pt,{className:"w-3.5 h-3.5 text-amber-600",strokeWidth:2})})]}),e.jsxs("div",{className:"flex items-baseline gap-1",children:[e.jsx("div",{className:"text-xl font-semibold tracking-tight text-amber-600",children:o}),e.jsxs("div",{className:"text-xs text-slate-500",children:["/ ",s," (",s>0?Math.round(o/s*100):0,"%)"]})]})]})]})]}),e.jsxs("div",{className:"hidden md:grid grid-cols-5 gap-4 mb-2",children:[e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-slate-400 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"text-sm uppercase tracking-wide text-slate-900 font-semibold whitespace-nowrap",children:l("participants.total")}),e.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:e.jsx(Ue,{className:"w-[18px] h-[18px] text-slate-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-3xl font-semibold tracking-tight text-slate-900 mt-auto",children:t})]}),e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-blue-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base uppercase tracking-wide text-blue-600 font-semibold whitespace-nowrap",children:l("participants.showing")}),e.jsx("div",{className:"text-[10px] text-slate-500 font-medium mt-0.5",children:l("participants.showingSubtext")})]}),e.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:e.jsx(ut,{className:"w-[18px] h-[18px] text-blue-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-4xl font-semibold tracking-tight text-blue-600 mt-auto",children:s})]}),e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-indigo-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base uppercase tracking-wide text-indigo-600 font-semibold whitespace-nowrap",children:l("participants.totalCourses")}),e.jsx("div",{className:"text-[10px] text-slate-500 font-medium mt-0.5",children:l("participants.totalCoursesSubtext")})]}),e.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:e.jsx(mt,{className:"w-[18px] h-[18px] text-indigo-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-3xl font-semibold tracking-tight text-indigo-600 mt-auto",children:a})]}),e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-cyan-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base uppercase tracking-wide text-cyan-600 font-semibold whitespace-nowrap",children:l("participants.visibleCourses")}),e.jsx("div",{className:"text-[10px] text-slate-500 font-medium mt-0.5",children:l("participants.visibleCoursesSubtext")})]}),e.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:e.jsx(_e,{className:"w-[18px] h-[18px] text-cyan-600",strokeWidth:2})})]}),e.jsx("div",{className:"text-4xl font-semibold tracking-tight text-cyan-600 mt-auto",children:n})]}),e.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-amber-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("div",{className:"text-sm uppercase tracking-wide text-amber-600 font-semibold whitespace-nowrap",children:l("participants.completed")}),e.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:e.jsx(pt,{className:"w-[18px] h-[18px] text-amber-600",strokeWidth:2})})]}),e.jsxs("div",{className:"flex items-baseline gap-2 mt-auto",children:[e.jsx("div",{className:"text-3xl font-semibold tracking-tight text-amber-600",children:o}),e.jsxs("div",{className:"text-sm text-slate-500",children:["/ ",s," (",s>0?Math.round(o/s*100):0,"%)"]})]})]})]})]})},aa=({activeTab:t,onTabChange:s})=>{const{t:a}=X();return e.jsx("nav",{className:"md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-sm z-50",children:e.jsxs("div",{className:"flex",children:[e.jsxs("button",{onClick:()=>s("participants"),className:`flex-1 flex flex-col items-center justify-center py-3 transition-colors duration-150 ${t==="participants"?"text-blue-700":"text-slate-400"}`,children:[e.jsx(Ue,{className:"w-6 h-6 mb-1",strokeWidth:2}),e.jsx("span",{className:`text-xs ${t==="participants"?"font-semibold":"font-medium"}`,children:a("nav.participants")})]}),e.jsxs("button",{onClick:()=>s("tools"),className:`flex-1 flex flex-col items-center justify-center py-3 transition-colors duration-150 ${t==="tools"?"text-blue-700":"text-slate-400"}`,children:[e.jsx(Ct,{className:"w-6 h-6 mb-1",strokeWidth:2}),e.jsx("span",{className:`text-xs ${t==="tools"?"font-semibold":"font-medium"}`,children:a("nav.tools")})]})]})})},ra=({onClick:t})=>{const{t:s}=X();return e.jsx("button",{onClick:t,className:"md:hidden fixed bottom-24 right-6 w-14 h-14 bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white rounded-full shadow-lg flex items-center justify-center z-40 active:scale-95 transition-all duration-150",style:{minWidth:"56px",minHeight:"56px"},"aria-label":s("participants.add"),children:e.jsx("svg",{className:"w-7 h-7",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M12 4v16m8-8H4"})})})};let Te;function na(){return Te!==void 0||(Te=fs("https://xxkqorvdmksyeyoftlgu.supabase.co","sb_publishable_F6tEV-grkbpwT4Ndhg5r8A__mNzR53l",{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}})),Te}const Tt="spi.entitlement.cache.v1",je={configured:!1,authenticated:!1,status:"unknown",readOnly:!1,planCode:null,daysUntilReadOnly:null,currentPeriodEnd:null,graceUntil:null,error:null,lastCheckedAt:null},Gt=x.createContext(void 0);function oa(t){if(!t)return"Entitlement check failed.";if(t instanceof Error)return t.message;if(typeof t=="object"&&t!==null){const s=t.message;if(typeof s=="string"&&s.trim().length>0)return s}return"Entitlement check failed."}function la(){try{const t=localStorage.getItem(Tt);if(!t)return je;const s=JSON.parse(t);return{...je,...s,error:null}}catch{return je}}function Ge(t){localStorage.setItem(Tt,JSON.stringify(t))}const ia=({children:t})=>{const s=x.useMemo(()=>na(),[]),[a,n]=x.useState(()=>la()),[o,l]=x.useState(!1),[r,i]=x.useState(!1),[d,u]=x.useState(null);x.useEffect(()=>{const f=window.location.hash;if(!f||f.length<2)return;const h=new URLSearchParams(f.slice(1)),b=h.get("error_description");b&&u(b.replace(/\+/g," "));const C=h.get("type"),A=!!(h.get("access_token")||h.get("code"));C==="recovery"&&A&&(i(!0),u(null))},[]),x.useEffect(()=>{De(a.readOnly)},[a.readOnly]);const m=x.useCallback(async()=>{if(!s){const f={...je,configured:!1,readOnly:!1,lastCheckedAt:new Date().toISOString()};n(f),Ge(f),De(!1);return}l(!0);try{const{data:f,error:h}=await s.auth.getSession();if(h)throw h;if(!f.session){const G={...je,configured:!0,authenticated:!1,readOnly:!1,lastCheckedAt:new Date().toISOString()};n(G),Ge(G),De(!1);return}const{data:b,error:C}=await s.rpc("entitlement_me",{p_tenant_id:null});if(C)throw C;const A=Array.isArray(b)?b[0]:b;if(!A)throw new Error("Entitlement data is missing.");const T={configured:!0,authenticated:!0,status:A.status||"unknown",readOnly:!!A.read_only,planCode:A.plan_code||null,daysUntilReadOnly:typeof A.days_until_read_only=="number"?A.days_until_read_only:null,currentPeriodEnd:A.current_period_end||null,graceUntil:A.grace_until||null,error:null,lastCheckedAt:new Date().toISOString()};n(T),Ge(T),De(T.readOnly)}catch(f){const h=oa(f),b=h.toLowerCase();if(b.includes("jwt")||b.includes("refresh token")||b.includes("session")||b.includes("invalid token")){await s.auth.signOut();const C={...je,configured:!0,authenticated:!1,readOnly:!1,error:null,lastCheckedAt:new Date().toISOString()};n(C),Ge(C),De(!1);return}n(C=>({...C,configured:!0,error:h,lastCheckedAt:new Date().toISOString()}))}finally{l(!1)}},[s]),S=x.useCallback(async(f,h)=>{if(!s)throw new Error("Supabase is not configured.");const{error:b}=await s.auth.signInWithPassword({email:f,password:h});if(b)throw b;await m()},[m,s]),N=x.useCallback(async()=>{if(!s)return;const{error:f}=await s.auth.signOut();if(f)throw f;await m()},[m,s]),$=x.useCallback(async f=>{if(!s)throw new Error("Supabase is not configured.");const h=window.location.pathname.endsWith("/")?window.location.pathname:`${window.location.pathname}/`,{error:b}=await s.auth.resetPasswordForEmail(f,{redirectTo:`${window.location.origin}${h}`});if(b)throw b},[s]),k=x.useCallback(async f=>{if(!s)throw new Error("Supabase is not configured.");const{error:h}=await s.auth.updateUser({password:f});if(h)throw h;i(!1),window.history.replaceState({},document.title,window.location.pathname+window.location.search),await m()},[m,s]),P=x.useCallback(()=>{u(null),window.location.hash&&window.history.replaceState({},document.title,window.location.pathname+window.location.search)},[]);return x.useEffect(()=>{let f=!0;const h=async()=>{f&&await m()};h();const b=window.setInterval(()=>{h()},5*60*1e3),{data:{subscription:C}}=s?s.auth.onAuthStateChange(A=>{A==="PASSWORD_RECOVERY"&&(i(!0),u(null)),A==="SIGNED_OUT"&&i(!1),h()}):{data:{subscription:{unsubscribe:()=>{}}}};return()=>{f=!1,window.clearInterval(b),C.unsubscribe()}},[m,s]),e.jsx(Gt.Provider,{value:{entitlement:a,loading:o,recoveryMode:r,authLinkError:d,refresh:m,signInWithPassword:S,signOut:N,requestPasswordReset:$,updatePassword:k,clearAuthLinkError:P},children:t})},ca=()=>{const t=x.useContext(Gt);if(!t)throw new Error("useEntitlement must be used within EntitlementProvider");return t},da=x.lazy(()=>qe(()=>import("./ToolsPage-Bx1A0yzC.js"),__vite__mapDeps([9,3,1,4,2,7,5,6,8])).then(t=>({default:t.ToolsPage})));function Ze(t,s){const a=t.toLowerCase();return a.includes("invalid login credentials")?s("auth.invalidCredentials"):a.includes("email not confirmed")?s("auth.emailNotConfirmed"):a.includes("too many requests")?s("auth.rateLimited"):s("auth.failed")}function ua(){const{t}=X(),{entitlement:s,loading:a,signInWithPassword:n,signOut:o,requestPasswordReset:l,updatePassword:r,recoveryMode:i,authLinkError:d,clearAuthLinkError:u}=ca(),{participants:m,deleteParticipant:S}=Ke(),{groups:N}=Ms(),{collapsedSections:$,toggleSection:k,expandSection:P,resetToDefaults:f,setCollapsedState:h}=Ls(),b=s.readOnly,[C,A]=x.useState("participants"),[T,G]=x.useState(!1),[_,q]=x.useState(),[M,U]=x.useState(!1),[v,B]=x.useState(!1),[z]=x.useState(0),[W,V]=x.useState(""),[Q,le]=x.useState(""),[ee,ie]=x.useState(!1),[ae,Z]=x.useState(null),[ce,me]=x.useState(!1),[te,re]=x.useState(null),[ne,pe]=x.useState(""),[xe,he]=x.useState(""),[p,y]=x.useState(!1),[I,E]=x.useState(null);x.useEffect(()=>{setTimeout(async()=>{try{console.log("App initializing..."),await Ds(),await Ae(),console.log("App initialization complete.")}catch(R){console.error("CRITICAL: Failed to initialize groups:",R)}},100)},[]);const[F,c]=x.useState(""),[g,j]=x.useState(""),[w,H]=x.useState({sent:null,documents:null,handedOver:null,paid:null,completed:null}),[K,ke]=x.useState({start:"",end:""}),[Je,nt]=x.useState(null),ge=x.useMemo(()=>F!==""||g!==""||w.sent!==null||w.documents!==null||w.handedOver!==null||w.paid!==null||w.completed!==null||K.start!==""||K.end!=="",[F,g,w,K]);x.useEffect(()=>{ge?(Je||nt({...$}),$.active&&P("active"),$.planned&&P("planned"),$.completed&&P("completed")):Je&&(h(Je),nt(null))},[ge]);const ot=x.useMemo(()=>new Map((N??[]).map(O=>[O.courseStartDate,O])),[N]),lt=x.useMemo(()=>(N??[]).filter(O=>O.groupNumber!==null&&O.groupNumber!==void 0).map(O=>({...O,groupNumber:O.groupNumber})),[N]),de=x.useMemo(()=>{if(!m)return[];const O=new Date().getFullYear();return m.filter(R=>{const Y=ot.get(R.courseStartDate);if((R.completedOverride!==null?R.completedOverride:R.completedComputed)&&(Y==null?void 0:Y.status)==="completed"&&new Date(R.courseStartDate).getFullYear()!==O)return!1;if(F){const oe=F.toLowerCase();if(!(R.companyName.toLowerCase().includes(oe)||R.personName.toLowerCase().includes(oe)||R.uniqueNumber.toLowerCase().includes(oe)))return!1}if(g){const oe=parseInt(g,10);if(Y&&Y.groupNumber!==oe||!Y)return!1}return!(K.start&&R.courseStartDate<K.start||K.end&&R.courseStartDate>=K.end||w.sent!==null&&R.sent!==w.sent||w.documents!==null&&R.documents!==w.documents||w.handedOver!==null&&R.handedOver!==w.handedOver||w.paid!==null&&R.paid!==w.paid||w.completed!==null&&(R.completedOverride!==null?R.completedOverride:R.completedComputed)!==w.completed)})},[m,ot,F,g,w,K]),Le=(m==null?void 0:m.length)||0,Ie=de.length,Bt=(N==null?void 0:N.length)||0,Rt=x.useMemo(()=>{if(!N||N.length===0)return 0;const O=new Set,R=new Map(N.map(Y=>[Y.courseStartDate,Y]));return de.forEach(Y=>{const J=R.get(Y.courseStartDate);J&&O.add(J.courseStartDate)}),ge||(N.forEach(J=>{J.status==="active"&&O.add(J.courseStartDate)}),N.filter(J=>J.status==="planned").map(J=>J.courseStartDate).sort((J,oe)=>J.localeCompare(oe)).slice(0,2).forEach(J=>O.add(J))),O.size},[N,de,ge]),_t=x.useMemo(()=>de.filter(O=>O.completedOverride!==null?O.completedOverride:O.completedComputed).length,[de]),it=()=>{if(b){alert(t("entitlement.readOnlyAction"));return}q(void 0),G(!0)},ct=O=>{if(b){alert(t("entitlement.readOnlyAction"));return}q(O),G(!0)},dt=async O=>{if(b){alert(t("entitlement.readOnlyAction"));return}await S(O)},Ut=()=>{G(!1),q(void 0)},zt=(O,R)=>{H(Y=>({...Y,[O]:R}))},Wt=()=>{c(""),j(""),H({sent:null,documents:null,handedOver:null,paid:null,completed:null}),ke({start:"",end:""})},Ft=O=>{c(O.searchTerm),j(O.courseStartDate||""),H({sent:null,documents:null,handedOver:null,paid:null,completed:null}),ke({start:"",end:""})},Ht=(O,R)=>{switch(O){case"search":c("");break;case"group":j("");break;case"dateStart":ke(Y=>({...Y,start:""}));break;case"dateEnd":ke(Y=>({...Y,end:""}));break;case"status":R&&H(Y=>({...Y,[R]:null}));break;case"all":Wt();break}},Vt=async O=>{if(O.preventDefault(),Z(null),!W.trim()||!Q.trim()){Z(t("auth.required"));return}re(null),ie(!0);try{await n(W.trim(),Q),le("")}catch(R){R instanceof Error?Z(Ze(R.message,t)):Z(t("auth.failed"))}finally{ie(!1)}},Yt=async()=>{try{await o()}catch(O){alert(O instanceof Error?O.message:t("auth.signOutFailed"))}},Kt=async O=>{if(O.preventDefault(),Z(null),re(null),!W.trim()){Z(t("auth.emailRequired"));return}ie(!0);try{await l(W.trim()),re(t("auth.resetSent"))}catch(R){R instanceof Error?Z(Ze(R.message,t)):Z(t("auth.failed"))}finally{ie(!1)}},Xt=async O=>{if(O.preventDefault(),E(null),!ne||!xe){E(t("auth.resetPasswordRequired"));return}if(ne.length<6){E(t("auth.resetPasswordTooShort"));return}if(ne!==xe){E(t("auth.resetPasswordsMismatch"));return}y(!0);try{await r(ne),pe(""),he("")}catch(R){R instanceof Error?E(Ze(R.message,t)):E(t("auth.failed"))}finally{y(!1)}};return i?e.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center px-4",children:e.jsxs("div",{className:"w-full max-w-md bg-white rounded-xl shadow p-6 space-y-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900",children:t("auth.resetTitle")}),e.jsx("p",{className:"text-sm text-slate-600",children:t("auth.resetSubtitle")}),e.jsxs("form",{onSubmit:Xt,className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:t("auth.newPassword")}),e.jsx("input",{type:"password",value:ne,onChange:O=>pe(O.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:t("auth.passwordPlaceholder"),autoComplete:"new-password"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:t("auth.confirmPassword")}),e.jsx("input",{type:"password",value:xe,onChange:O=>he(O.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:t("auth.passwordPlaceholder"),autoComplete:"new-password"})]}),I&&e.jsx("p",{className:"text-sm text-red-600",children:I}),e.jsx("button",{type:"submit",disabled:p,className:`w-full py-2.5 rounded-lg font-medium ${p?"bg-slate-300 text-slate-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:t(p?"common.loading":"auth.updatePassword")})]})]})}):s.configured&&!s.authenticated?e.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center px-4",children:e.jsxs("div",{className:"w-full max-w-md bg-white rounded-xl shadow p-6 space-y-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-slate-900",children:t("auth.title")}),e.jsx("p",{className:"text-sm text-slate-600",children:t("auth.subtitle")}),e.jsxs("form",{onSubmit:ce?Kt:Vt,className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:t("auth.email")}),e.jsx("input",{type:"email",value:W,onChange:O=>V(O.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:t("auth.emailPlaceholder"),autoComplete:"email"})]}),!ce&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:t("auth.password")}),e.jsx("input",{type:"password",value:Q,onChange:O=>le(O.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:t("auth.passwordPlaceholder"),autoComplete:"current-password"})]}),ae&&e.jsx("p",{className:"text-sm text-red-600",children:ae}),te&&e.jsx("p",{className:"text-sm text-emerald-700",children:te}),d&&e.jsx("p",{className:"text-sm text-red-600",children:d}),s.error&&e.jsx("p",{className:"text-sm text-red-600",children:s.error}),e.jsx("button",{type:"submit",disabled:ee||a,className:`w-full py-2.5 rounded-lg font-medium ${ee||a?"bg-slate-300 text-slate-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"}`,children:t(ee?"common.loading":ce?"auth.sendReset":"auth.signIn")}),e.jsx("button",{type:"button",onClick:()=>{me(O=>!O),Z(null),re(null),u()},className:"w-full py-2 text-sm text-blue-700 hover:text-blue-800",children:t(ce?"auth.backToLogin":"auth.forgotPassword")})]})]})}):e.jsx("div",{className:"min-h-screen bg-slate-50",children:e.jsxs(Zs,{children:[e.jsx(ta,{activeTab:C,onTabChange:A}),s.configured&&s.authenticated&&(s.status==="grace"||b)&&e.jsx("div",{className:`border-b ${b?"bg-red-50 border-red-200":"bg-amber-50 border-amber-200"}`,children:e.jsx("div",{className:"container mx-auto px-4 py-2 text-sm",children:e.jsxs("div",{children:[e.jsx("p",{className:`font-medium ${b?"text-red-700":"text-amber-800"}`,children:t(b?"entitlement.readOnlyBannerTitle":"entitlement.graceBannerTitle")}),!b&&s.daysUntilReadOnly!==null&&e.jsx("p",{className:"text-amber-700",children:t("entitlement.graceBannerMessage",{days:String(s.daysUntilReadOnly)})}),b&&e.jsx("p",{className:"text-red-700",children:t("entitlement.readOnlyBannerMessage")}),a&&e.jsx("p",{className:"text-slate-500",children:t("common.loading")})]})})}),C==="participants"?e.jsxs("main",{className:"container mx-auto px-4 py-6 pb-24 md:pb-6",children:[e.jsx(sa,{totalParticipants:Le,visibleParticipants:Ie,totalCourses:Bt,visibleCourses:Rt,completedCount:_t}),e.jsx(Fs,{activeFilters:{searchText:F,selectedGroup:g,dateRange:K,statusFilters:w},onRemoveFilter:Ht,groups:lt}),e.jsxs("div",{className:"hidden md:flex flex-wrap gap-3 mb-6",children:[e.jsxs("button",{onClick:it,disabled:b,className:`px-6 py-3 rounded-lg shadow font-medium ${b?"bg-slate-300 text-slate-600 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700"}`,children:["+ ",t("participants.add")]}),e.jsx("button",{onClick:()=>U(!0),className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow font-medium",children:t("filters.title")})]}),e.jsx("div",{className:"md:hidden mb-4",children:e.jsxs("button",{onClick:()=>U(!0),className:"w-full px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow font-medium min-h-[48px]",children:["🔍 ",t("filters.title")]})}),e.jsxs("div",{className:"md:bg-white md:rounded-lg md:shadow",children:[e.jsxs("div",{className:"hidden md:block",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsxs("h2",{className:"text-xl font-semibold text-slate-900",children:[t("participants.title")," ",Ie<Le&&`(${Ie} ${t("participants.of")} ${Le})`]})}),e.jsx("div",{className:"p-4",children:e.jsx(Rs,{participants:de,onEdit:ct,onDelete:dt,collapsedSections:$,toggleSection:k,expandSection:P,hasActiveFilters:ge,onFilterChange:Ft,groupRefreshKey:z})})]}),e.jsx("div",{className:"md:hidden",children:e.jsx(Us,{participants:de,onEdit:ct,onDelete:dt,onSelectionChange:B,collapsedSections:$,toggleSection:k,expandSection:P,hasActiveFilters:ge})})]})]}):e.jsx("main",{className:"container mx-auto px-4 py-6",children:e.jsx(x.Suspense,{fallback:e.jsx("div",{className:"text-sm text-slate-500",children:t("common.loading")}),children:e.jsx(da,{filteredParticipants:de,entitlement:s,entitlementLoading:a,onSignOut:Yt})})}),e.jsx(Ws,{isOpen:M,onClose:()=>U(!1),searchText:F,onSearchTextChange:c,selectedGroup:g,onSelectedGroupChange:j,statusFilters:w,onStatusFilterChange:zt,dateRange:K,onDateRangeChange:ke,groups:lt,onResetToDefaults:f,visibleCount:Ie,totalCount:Le}),e.jsx(zs,{isOpen:T,onClose:Ut,participant:_}),C==="participants"&&!v&&!b&&e.jsx(ra,{onClick:it}),e.jsx(aa,{activeTab:C,onTabChange:A})]})})}function ma(){return e.jsx(ia,{children:e.jsx($s,{children:e.jsx(ua,{})})})}class pa extends x.Component{constructor(){super(...arguments);we(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(a){return{hasError:!0,error:a}}componentDidCatch(a,n){console.error("Uncaught error:",a,n)}render(){var a;return this.state.hasError?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 p-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white shadow-lg rounded-lg p-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"Something went wrong"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"The application encountered an unexpected error. This might be due to a data consistency issue."}),e.jsx("div",{className:"bg-gray-100 p-3 rounded mb-4 overflow-auto max-h-32 text-xs font-mono text-red-800",children:(a=this.state.error)==null?void 0:a.message}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>window.location.reload(),className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition",children:"Reload Application"}),e.jsx("button",{onClick:()=>{window.confirm("Delete all local data and reset? This cannot be undone.")&&(indexedDB.deleteDatabase("CourseManagementDB"),localStorage.clear(),window.location.reload())},className:"flex-1 px-4 py-2 bg-red-100 text-red-700 border border-red-200 rounded hover:bg-red-200 transition",children:"Reset Data"})]})]})}):this.props.children}}Zt.createRoot(document.getElementById("root")).render(e.jsx(jt.StrictMode,{children:e.jsx(pa,{children:e.jsx(ma,{})})}));export{It as A,Me as C,Qs as L,qe as _,L as a,Ot as b,Da as c,D as d,at as e,ya as f,ue as g,Pa as h,Ee as i,tt as j,ka as k,Ca as l,Ea as m,Sa as r,Aa as s,ea as t,X as u};
