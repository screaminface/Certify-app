const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/certificateGenerator-ByYTOvTD.js","assets/vendor-misc-DSrITObC.js","assets/fileDownload-D0s8ICu7.js","assets/vendor-react-BvoEKvLG.js","assets/vendor-dexie-JKmga9jS.js","assets/vendor-dates-qyqZJmaY.js","assets/vendor-uuid-P-OY1HC2.js","assets/vendor-icons-BX-4-bzZ.js","assets/vendor-supabase-BRwdPCI1.js","assets/ToolsPage-DeKVOeQe.js"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,t=(t,s,a)=>((t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a)(t,"symbol"!=typeof s?s+"":s,a);import{r as s,j as a,R as r,c as n}from"./vendor-react-BvoEKvLG.js";import{X as i,u as l}from"./vendor-dexie-JKmga9jS.js";import{p as o,f as c,i as d,a as u,s as m}from"./vendor-dates-qyqZJmaY.js";import{v as p}from"./vendor-uuid-P-OY1HC2.js";import{I as x,C as h,T as b,A as g,a as f,b as v,c as w,U as N,X as j,H as y,M as S,d as k,e as D,L as C,S as E,D as O,f as A,g as q,E as P,h as L,G as M}from"./vendor-icons-BX-4-bzZ.js";import{c as T}from"./vendor-supabase-BRwdPCI1.js";import"./vendor-misc-DSrITObC.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();const I={},$=function(e,t,s){let a=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const e=document.querySelector("meta[property=csp-nonce]"),s=(null==e?void 0:e.nonce)||(null==e?void 0:e.getAttribute("nonce"));a=Promise.allSettled(t.map(e=>{if((e=function(e){return"/Certify-app/"+e}(e))in I)return;I[e]=!0;const t=e.endsWith(".css"),a=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${a}`))return;const r=document.createElement("link");return r.rel=t?"stylesheet":"modulepreload",t||(r.as="script"),r.crossOrigin="",r.href=e,s&&r.setAttribute("nonce",s),document.head.appendChild(r),t?new Promise((t,s)=>{r.addEventListener("load",t),r.addEventListener("error",()=>s(new Error(`Unable to preload CSS for ${e}`)))}):void 0}))}function r(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return a.then(t=>{for(const e of t||[])"rejected"===e.status&&r(e.reason);return e().catch(r)})};function R(e){const t=function(e){const t=new Date(e),s=t.getDay();if(1===s)return t;const a=0===s?1:8-s;return t.setDate(t.getDate()+a),t}(new Date(e)),s=new Date(t);return s.setDate(s.getDate()+7),{courseStartDate:t.toISOString().split("T")[0],courseEndDate:s.toISOString().split("T")[0]}}function B(e,t,s,a){if(!e)return a;const r=e instanceof Date?e:new Date(e);return Number.isNaN(r.getTime())?a:new Intl.DateTimeFormat(t,{timeZone:s,day:"2-digit",month:"2-digit",year:"numeric"}).format(r)}let z=!1;function _(e){z=e}function F(){if(z){const e=new Error("Read-only mode is enabled. Subscription access has expired.");throw e.name="APP_READ_ONLY_ERROR",e}}const W=new class extends i{constructor(){super("CourseManagementDB"),t(this,"groups"),t(this,"participants"),t(this,"settings"),t(this,"yearlyArchives"),this.version(1).stores({groups:"id, groupNumber, courseStartDate",participants:"id, groupNumber, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}),this.version(2).stores({groups:"id, groupNumber, courseStartDate",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}).upgrade(e=>e.table("participants").toCollection().modify(e=>{e.autoGroup=e.groupNumber,e.manualGroup=null})),this.version(3).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}).upgrade(e=>{const t=(new Date).toISOString();return e.table("groups").toCollection().modify(e=>{e.status=1===e.groupNumber?"active":"planned",e.createdAt=t,e.updatedAt=t})}),this.version(4).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id"}).upgrade(e=>{const t=(new Date).toISOString();e.table("participants").toCollection().modify(e=>{e.createdAt=e.createdAt||t,e.updatedAt=e.updatedAt||t,(e.completedComputed||!0===e.completedOverride)&&(e.completedAt=e.completedAt||t)}),e.table("groups").toCollection().modify(e=>{e.isLocked="completed"===e.status})}),this.version(5).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate",settings:"id",yearlyArchives:"id, year"}),this.version(6).stores({groups:"id, groupNumber, courseStartDate, status",participants:"id, groupNumber, autoGroup, uniqueNumber, companyName, personName, courseStartDate, egn",settings:"id",yearlyArchives:"id, year"}).upgrade(e=>e.table("participants").toCollection().modify(e=>{e.egn=e.egn||"",e.birthPlace=e.birthPlace||"",e.citizenship=e.citizenship||"българско"})),this.version(7).stores({groups:"id, courseStartDate, status, groupNumber",participants:"id, courseStartDate, uniqueNumber, companyName, personName, egn",settings:"id",yearlyArchives:"id, year"}).upgrade(async e=>{await e.table("participants").toCollection().modify(e=>{delete e.groupNumber,delete e.autoGroup,delete e.manualGroup}),await e.table("groups").toCollection().modify(e=>{"planned"===e.status&&(e.groupNumber=null)})}),[this.groups,this.participants,this.settings,this.yearlyArchives].forEach(e=>{e.hook("creating",()=>{F()}),e.hook("updating",()=>{F()}),e.hook("deleting",()=>{F()})})}};function G(e,t){return`${e.toString().padStart(4,"0")}-${t}`}function U(e){const t=e.match(/^(\d{4})-(\d+)$/);return t?{prefix:parseInt(t[1],10),seq:parseInt(t[2],10)}:null}async function V(e=!1){const t=await W.participants.toArray();let s=null;for(const r of t){if(!r.uniqueNumber)continue;const e=U(r.uniqueNumber);e&&(s?(e.prefix>s.prefix||e.prefix===s.prefix&&e.seq>s.seq)&&(s=e):s=e)}const a=await W.yearlyArchives.toArray();for(const r of a)for(const e of r.participants){if(!e.uniqueNumber)continue;const t=U(e.uniqueNumber);t&&(s?(t.prefix>s.prefix||t.prefix===s.prefix&&t.seq>s.seq)&&(s=t):s=t)}if(!e){const e=await W.settings.get(1);if(e){const t={prefix:e.lastUniquePrefix,seq:e.lastUniqueSeq};s?(t.prefix>s.prefix||t.prefix===s.prefix&&t.seq>s.seq)&&(s=t):s=t}}return s}async function H(){const e=await W.settings.get(1);if(!e)throw new Error("Settings not initialized");let t=e.lastUniquePrefix,s=e.lastUniqueSeq;const a=await V();a&&(a.prefix>t?(t=a.prefix,s=a.seq):a.prefix===t&&a.seq>s&&(s=a.seq));return G(t+1,s+1)}async function X(e){const t=await W.groups.get(e);if(!t)return;if("active"!==t.status)return;const s=(await W.participants.where("courseStartDate").equals(t.courseStartDate).toArray()).filter(e=>!e.uniqueNumber);if(0===s.length)return;s.sort((e,t)=>{const s=new Date(e.createdAt||0).getTime(),a=new Date(t.createdAt||0).getTime();return s!==a?s-a:(e.id||"").localeCompare(t.id||"")});const a=await W.settings.get(1);if(!a)throw new Error("Settings not initialized");let r=a.lastUniquePrefix,n=a.lastUniqueSeq;const i=await V();i&&(i.prefix>r?(r=i.prefix,n=i.seq):i.prefix===r&&i.seq>n&&(n=i.seq));const l=[];for(const o of s){r++,n++;const e=G(r,n);l.push({id:o.id,uniqueNumber:e})}for(const o of l)await W.participants.update(o.id,{uniqueNumber:o.uniqueNumber});await W.settings.update(1,{lastUniquePrefix:r,lastUniqueSeq:n})}async function K(){const e=await W.settings.get(1);if(!e)return;const t=e.lastUniquePrefix+1;await W.settings.update(1,{lastUniquePrefix:t,lastUniqueSeq:0,lastResetYear:(new Date).getFullYear()})}async function Y(e){const t=U(e);if(!t)return;const{prefix:s}=t,a=await W.participants.filter(e=>!!e.uniqueNumber).toArray(),r=[];for(const i of a){const e=U(i.uniqueNumber);if(e&&e.prefix>s){const t=e.prefix-1,s=e.seq-1,a=G(t,s);r.push({id:i.id,newNum:a,newPrefix:t,newSeq:s})}}for(const i of r)await W.participants.update(i.id,{uniqueNumber:i.newNum});const n=await V();n&&await W.settings.update(1,{lastUniquePrefix:n.prefix,lastUniqueSeq:n.seq})}async function J(e,t){const s=W.participants.where("uniqueNumber").equals(e),a=await s.toArray();if(t){if(a.length>0&&(a.length>1||a[0].id!==t))return!1}else if(a.length>0)return!1;const r=await W.yearlyArchives.toArray();for(const n of r)for(const s of n.participants)if(s.uniqueNumber===e){if(t&&s.id===t)continue;return!1}return!0}async function Z(){const e=await W.participants.toArray(),t=await W.yearlyArchives.toArray(),s=[...e];for(const n of t)s.push(...n.participants);const a=s.filter(e=>e.uniqueNumber).map(e=>U(e.uniqueNumber)).filter(e=>null!==e).sort((e,t)=>e.prefix!==t.prefix?e.prefix-t.prefix:e.seq-t.seq);if(0===a.length)return null;for(let n=0;n<a.length-1;n++){const e=a[n];if(a[n+1].prefix!==e.prefix+1)return G(e.prefix+1,e.seq+1)}const r=await W.settings.get(1);if(r&&a.length>0){const e=a[a.length-1];if(r.lastUniquePrefix>e.prefix)return G(e.prefix+1,e.seq+1)}return null}async function Q(e){const t=await W.participants.where("courseStartDate").equals(e).toArray();for(const a of t)a.uniqueNumber&&await W.participants.update(a.id,{uniqueNumber:""});const s=await V(!0);s&&await W.settings.update(1,{lastUniquePrefix:s.prefix,lastUniqueSeq:s.seq})}function ee(e,t){const s=o(e),a=o(t);if(!d(s,a)&&!u(s,a))return!1;return s>=m(a)}function te(e){try{const t=o(e);return c(t,"dd.MM.yyyy")}catch{return e}}(async function(){try{if(0===await W.settings.count())await W.settings.add({id:1,lastUniquePrefix:3533,lastUniqueSeq:0,lastResetYear:null});else{const e=await W.settings.get(1);e&&e.lastUniquePrefix<=3531&&await W.settings.update(1,{lastUniquePrefix:3533,lastUniqueSeq:0})}}catch(e){}})().catch(e=>{});const se="Медицинското трябва да е в рамките на 6 месеца преди началото на курса.";async function ae(){return W.groups.where("status").equals("active").first()}async function re(e){const t=await W.groups.where("courseStartDate").equals(e).first();t&&await X(t.id)}async function ne(){return W.groups.where("status").equals("planned").sortBy("courseStartDate")}async function ie(e){const{courseStartDate:t}=R(e),s=await W.groups.toArray(),a=s.find(e=>"active"===e.status),r=s.filter(e=>"planned"===e.status).sort((e,t)=>e.courseStartDate.localeCompare(t.courseStartDate));if(a&&t<=a.courseStartDate&&ee(e,a.courseStartDate))return{group:a,shouldCreate:!1};const n=s.find(e=>e.courseStartDate===t);if(n&&"completed"===n.status){const s=[];a&&s.push(a),s.push(...r),s.sort((e,t)=>e.courseStartDate.localeCompare(t.courseStartDate));const i=s.find(s=>!(s.courseStartDate<t)&&ee(e,s.courseStartDate));return i?{group:i,shouldCreate:!1}:{group:n,shouldCreate:!1}}return n?{group:n,shouldCreate:!1}:a&&t<a.courseStartDate?{group:{id:"stub_past",status:"completed",courseStartDate:t,courseEndDate:"",groupNumber:-1,createdAt:"",updatedAt:"",isLocked:!0},shouldCreate:!1}:{group:null,shouldCreate:!0,createsForDate:t}}async function le(e,t="planned"){const s=await W.groups.where("courseStartDate").equals(e).first();if(s)return s.status,s;let a=null;"active"===t&&(a=null);const r=new Date(e);r.setDate(r.getDate()+7);const n=(new Date).toISOString(),i={id:p(),groupNumber:a,courseStartDate:e,courseEndDate:r.toISOString().split("T")[0],status:t,createdAt:n,updatedAt:n,isLocked:!1};return await W.groups.add(i),i}async function oe(){const e=await ae();if(!e)throw new Error("No active group to close");const t=(new Date).toISOString();let s=e.groupNumber;if(null==s){const e=await W.groups.where("status").equals("completed").toArray(),t=new Set(e.map(e=>e.groupNumber).filter(e=>null!=e&&e>0));let a=1;for(;t.has(a);)a++;s=a}await W.groups.update(e.id,{status:"completed",groupNumber:s,updatedAt:t,closedAt:t,isLocked:!0})}async function ce(){const e=await W.participants.toArray(),t=await W.groups.toArray(),s=t.find(e=>"active"===e.status);if(s&&(null===s.groupNumber||void 0===s.groupNumber)){const e=new Set(t.map(e=>e.groupNumber).filter(e=>null!=e&&e>0));let a=1;for(;e.has(a);)a++;await W.groups.update(s.id,{groupNumber:a,updatedAt:(new Date).toISOString()})}const a=t.filter(e=>"active"===e.status);for(const h of a)await re(h.courseStartDate);for(const h of t){const t=new Date(h.courseStartDate);if(1!==t.getDay()){const s=t.getDay(),a=0===s?1:8-s,r=new Date(t);r.setDate(t.getDate()+a);const n=r.toISOString().split("T")[0];await W.groups.update(h.id,{courseStartDate:n,courseEndDate:new Date(r.getTime()+6048e5).toISOString().split("T")[0]});const i=e.filter(e=>e.courseStartDate===h.courseStartDate);for(const e of i)await W.participants.update(e.id,{courseStartDate:n,courseEndDate:new Date(r.getTime()+6048e5).toISOString().split("T")[0]})}}const r=new Set;let n;if(e.forEach(e=>r.add(e.courseStartDate)),s)n=new Date(s.courseStartDate);else{const e=new Date,t=e.getDay(),s=0===t?1:1===t?0:8-t;n=new Date(e),n.setHours(12,0,0,0),n.setDate(e.getDate()+s)}const i=new Date(n);i.setDate(i.getDate()+7);const l=new Date(n);l.setDate(l.getDate()+14),r.add(i.toISOString().split("T")[0]),r.add(l.toISOString().split("T")[0]);const o=new Set(t.map(e=>e.courseStartDate));for(const h of r)o.has(h)||await le(h,"planned");const c=await W.groups.toArray(),d=new Map;e.forEach(e=>{d.set(e.courseStartDate,(d.get(e.courseStartDate)||0)+1)});const u=new Map;c.forEach(e=>{const t=u.get(e.courseStartDate)||[];t.push(e),u.set(e.courseStartDate,t)});for(const[h,b]of u)if(b.length>1){const e=b.sort((e,t)=>{const s=e=>"completed"===e.status?3:"active"===e.status?2:1,a=s(e),r=s(t);return a!==r?r-a:0}),t=(e[0],e.slice(1));for(const s of t)await W.groups.delete(s.id)}const m=await W.groups.toArray(),p=m.find(e=>"active"===e.status);if(p){const e=m.filter(e=>"planned"===e.status&&e.courseStartDate<p.courseStartDate&&0===(d.get(e.courseStartDate)||0));for(const t of e)await W.groups.delete(t.id)}const x=(await W.groups.toArray()).filter(e=>"planned"===e.status);if(x.length>2){const e=x.filter(e=>0===(d.get(e.courseStartDate)||0));let t=x.length;e.sort((e,t)=>t.courseStartDate.localeCompare(e.courseStartDate));for(const s of e){if(t<=2)break;await W.groups.delete(s.id),t--}}}function de(e){return!!e&&("completed"===e.status&&e.isLocked)}async function ue(){return W.groups.where("status").equals("completed").reverse().sortBy("groupNumber")}async function me(e){const t=await W.groups.get(e);if(!t)throw new Error("Group not found");if("active"===t.status)return{success:!0};const s=await ae();return s&&s.id!==e?{success:!1,needsConfirm:!0,currentActive:s}:await pe(e)}async function pe(e,t=!1){const s=await W.groups.get(e);if(!s)throw new Error("Group not found");const a=(new Date).toISOString();if(t){const e=await ae();e&&(await W.groups.update(e.id,{status:"planned",updatedAt:a,activatedAt:void 0,groupNumber:null}),await Q(e.courseStartDate))}let r=s.groupNumber;if("planned"===s.status&&null===r){const e=await W.groups.toArray(),t=new Set(e.map(e=>e.groupNumber).filter(e=>null!=e&&e>0));let s=1;for(;t.has(s);)s++;r=s}return await W.groups.update(e,{groupNumber:r,status:"active",activatedAt:a,updatedAt:a,isLocked:!1}),await X(e),{success:!0}}async function xe(){const e=await ae();if(!e)throw new Error("No active group to set as planned");const t=(new Date).toISOString();await W.groups.update(e.id,{status:"planned",updatedAt:t,activatedAt:void 0}),await Q(e.courseStartDate)}async function he(e){const t=await W.groups.get(e);if(!t)throw new Error("Group not found");if("completed"!==t.status)throw new Error("Only archived groups can be reopened");const s=await ae();return s?{success:!1,needsConfirm:!0,currentActive:s}:await pe(e)}async function be(e){return W.participants.get(e)}async function ge(e,t){await W.participants.update(e,t)}async function fe(){return(await W.groups.toArray()).sort((e,t)=>e.courseStartDate.localeCompare(t.courseStartDate))}async function ve(e){return W.groups.where("courseStartDate").equals(e).first()}function we(){return{participants:l(()=>async function(){return W.participants.orderBy("courseStartDate").toArray()}()),addParticipant:async e=>{const{courseStartDate:t}=R(e.medicalDate);if(!ee(e.medicalDate,t))throw new Error(se);const{group:s,shouldCreate:a,createsForDate:r}=await ie(e.medicalDate),n=s?s.courseStartDate:r||t,i=(()=>{const e=new Date(n);return e.setDate(e.getDate()+7),e.toISOString().split("T")[0]})();if(!ee(e.medicalDate,n))throw new Error(se);const l=await async function(e){return W.groups.where("courseStartDate").equals(e).toArray()}(n);if(l.some(e=>"completed"===e.status))throw new Error("Не може да добавяте нови участници към приключила група (периодът е архивиран).");if("completed"===(null==s?void 0:s.status))throw new Error("Не може да добавяте нови участници към приключила група.");if(a){const e=await ae()?"planned":"active";await le(n,e)}let o;if(e.uniqueNumber){if(!(await J(e.uniqueNumber)))throw new Error("Unique number already exists");o=e.uniqueNumber}else o="active"===(null==s?void 0:s.status)?await H():"";const c=(new Date).toISOString(),d={id:p(),companyName:e.companyName,personName:e.personName,egn:e.egn||"",birthPlace:e.birthPlace||"",citizenship:e.citizenship||"българско",medicalDate:e.medicalDate,courseStartDate:n,courseEndDate:i,uniqueNumber:o,sent:!1,documents:!1,handedOver:!1,paid:!1,completedOverride:null,completedComputed:!1,createdAt:c,updatedAt:c};return await async function(e){await W.participants.add(e)}(d),await ce(),d},updateParticipant:async(e,t)=>{const s=await be(e);if(!s)throw new Error("Participant not found");if(de(await ve(s.courseStartDate)))throw new Error("Не може да редактирате участник от заключена група. Моля отключете групата първо от Tools.");const a={};let r=null;if(void 0!==t.companyName&&(a.companyName=t.companyName),void 0!==t.personName&&(a.personName=t.personName),void 0!==t.egn&&(a.egn=t.egn),void 0!==t.birthPlace&&(a.birthPlace=t.birthPlace),void 0!==t.citizenship&&(a.citizenship=t.citizenship),t.medicalDate&&t.medicalDate!==s.medicalDate){const{group:e,shouldCreate:n,createsForDate:i}=await ie(t.medicalDate),{courseStartDate:l}=R(t.medicalDate),o=e?e.courseStartDate:i||l,c=(()=>{const e=new Date(o);return e.setDate(e.getDate()+7),e.toISOString().split("T")[0]})();if(!ee(t.medicalDate,o))throw new Error(se);if("completed"===(null==e?void 0:e.status))throw new Error("Медицинският преглед отговаря на приключила група (периодът е архивиран).");if(n){const e=await ae()?"planned":"active";await le(o,e)}a.medicalDate=t.medicalDate,a.courseStartDate=o,a.courseEndDate=c;const d=await ve(s.courseStartDate),u=(null==d?void 0:d.status)||"planned",m=(null==e?void 0:e.status)||"planned";if("active"===m&&"active"!==u){const e=await Z();a.uniqueNumber=e||await H()}else if("active"===u&&"planned"===m){const e=s.uniqueNumber;a.uniqueNumber="",e&&(r=e)}}if(t.uniqueNumber&&t.uniqueNumber!==s.uniqueNumber){if(!(await J(t.uniqueNumber,e)))throw new Error("Unique number already exists");a.uniqueNumber=t.uniqueNumber}void 0!==t.sent&&(a.sent=t.sent),void 0!==t.documents&&(a.documents=t.documents),void 0!==t.handedOver&&(a.handedOver=t.handedOver),void 0!==t.paid&&(a.paid=t.paid);const n=void 0!==a.sent?a.sent:s.sent,i=void 0!==a.documents?a.documents:s.documents,l=void 0!==a.handedOver?a.handedOver:s.handedOver,o=void 0!==a.paid?a.paid:s.paid,c=n&&i&&l&&o;a.completedComputed=c,a.updatedAt=(new Date).toISOString();const d=null!==s.completedOverride?s.completedOverride:s.completedComputed,u=void 0!==a.completedOverride&&null!==a.completedOverride?a.completedOverride:null===a.completedOverride?c:null!==s.completedOverride?s.completedOverride:c;!d&&u&&(a.completedAt=(new Date).toISOString()),await ge(e,a),r&&await Y(r),await ce()},deleteParticipant:async e=>{const t=await be(e);await async function(e){await W.participants.delete(e)}(e),t&&t.uniqueNumber&&await Y(t.uniqueNumber),await ce()},resetCompletedOverride:async e=>{await ge(e,{completedOverride:null})},getParticipant:async e=>be(e)}}function Ne(){return{groups:l(async()=>fe()),getGroup:async e=>async function(e){return W.groups.where("groupNumber").equals(e).first()}(e),getGroupsWithCounts:async()=>{const e=await fe();return await Promise.all(e.map(async e=>{const t=await async function(e){return W.participants.where("courseStartDate").equals(e).count()}(e.courseStartDate);return{...e,participantCount:t}}))}}}const je="groups-collapsed-active",ye="groups-collapsed-planned",Se="groups-collapsed-completed";const ke=s.createContext(void 0),De=({children:e})=>{const[t,r]=s.useState(()=>{var e;const t=localStorage.getItem("spi.language");if("bg"===t||"en"===t)return t;return(navigator.language||(null==(e=navigator.languages)?void 0:e[0])||"en").toLowerCase().startsWith("bg")?"bg":"en"}),[n,i]=s.useState({});s.useEffect(()=>{(async()=>{const e=await((e,t,s)=>{const a=e[t];return a?"function"==typeof a?a():Promise.resolve(a):new Promise((e,a)=>{("function"==typeof queueMicrotask?queueMicrotask:setTimeout)(a.bind(null,new Error("Unknown variable dynamic import: "+t+(t.split("/").length!==s?". Note that variables only represent file names one level deep.":""))))})})(Object.assign({"../locales/bg.ts":()=>$(()=>import("./bg-2-bdpX8K.js"),[]),"../locales/en.ts":()=>$(()=>import("./en-BmU_mF-p.js"),[])}),`../locales/${t}.ts`,3);i(e.default)})()},[t]);return a.jsx(ke.Provider,{value:{language:t,setLanguage:e=>{r(e),localStorage.setItem("spi.language",e)},t:(e,t)=>{let s=n[e]||e;return t&&Object.entries(t).forEach(([e,t])=>{s=s.replace(`{${e}}`,t)}),s}},children:e})},Ce=()=>{const e=s.useContext(ke);if(!e)throw new Error("useLanguage must be used within LanguageProvider");return e},Ee=({isOpen:e,onClose:t,onConfirm:r,title:n,message:i,confirmText:l="Confirm",cancelText:o="Cancel",variant:c="info"})=>{if(s.useEffect(()=>{const s=e=>{"Escape"===e.key&&t()};if(e)return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[e,t]),!e)return null;return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 transition-opacity",onClick:t}),a.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden animate-scale-up transform transition-all",children:[a.jsx("div",{className:"p-6",children:a.jsxs("div",{className:"flex items-start gap-4",children:[a.jsx("div",{className:`p-3 rounded-full flex-shrink-0 ${(()=>{switch(c){case"danger":return"bg-red-50 text-red-900 border-red-100";case"warning":return"bg-amber-50 text-amber-900 border-amber-100";case"success":return"bg-emerald-50 text-emerald-900 border-emerald-100";default:return"bg-blue-50 text-blue-900 border-blue-100"}})()} bg-opacity-50`,children:(()=>{switch(c){case"danger":return a.jsx(b,{className:"w-6 h-6 text-red-600"});case"warning":return a.jsx(b,{className:"w-6 h-6 text-amber-600"});case"success":return a.jsx(h,{className:"w-6 h-6 text-emerald-600"});default:return a.jsx(x,{className:"w-6 h-6 text-blue-600"})}})()}),a.jsxs("div",{className:"flex-1 pt-1",children:[a.jsx("h3",{className:"text-xl font-bold text-slate-900 mb-2 leading-none",children:n}),a.jsx("p",{className:"text-slate-600 leading-relaxed text-sm",children:i})]})]})}),a.jsxs("div",{className:"p-4 bg-slate-50 flex gap-3 justify-end border-t border-slate-100",children:[a.jsx("button",{onClick:t,className:"px-5 py-2.5 bg-white text-slate-700 border border-slate-200 rounded-lg hover:bg-slate-50 hover:text-slate-900 font-medium transition-all duration-200 shadow-sm",children:o}),a.jsx("button",{onClick:()=>{r(),t()},className:`px-5 py-2.5 text-white rounded-lg font-medium shadow-md transition-all duration-200 transform hover:-translate-y-0.5 ${(()=>{switch(c){case"danger":return"bg-red-600 hover:bg-red-700 focus:ring-red-500";case"warning":return"bg-amber-600 hover:bg-amber-700 focus:ring-amber-500";case"success":return"bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500";default:return"bg-blue-600 hover:bg-blue-700 focus:ring-blue-500"}})()}`,children:l})]})]})})]})},Oe={Egida:"bg-violet-50 text-violet-700 ring-1 ring-violet-200/50","D-Max":"bg-orange-50 text-orange-700 ring-1 ring-orange-200/50",Multiforce:"bg-cyan-50 text-cyan-700 ring-1 ring-cyan-200/50"},Ae=({companyName:e,className:t=""})=>{const s=Oe[e]||"bg-slate-50 text-slate-600 ring-1 ring-slate-200/50";return a.jsx("span",{className:`inline-flex items-center px-2 py-0.5 text-xs rounded-full \n        font-medium tracking-normal transition-all duration-150 \n        hover:ring-2 hover:shadow-sm ${s} ${t}`,"aria-label":`Company: ${e||"Unknown"}`,children:e||"Няма компания"})};const qe=({selectedCount:e,selectedIds:t,onClearSelection:r,onActionComplete:n})=>{const{t:i}=Ce(),{bulkSetFlag:l}={bulkSetFlag:async(e,t,s)=>{const a={success:0,failed:0,errors:[]},r=(new Date).toISOString();for(const i of e)try{const e=await be(i);if(!e){a.failed++,a.errors.push(`Participant ${i} not found`);continue}const n=await ve(e.courseStartDate);if(n&&"completed"===n.status&&n.isLocked){a.failed++,a.errors.push(`Participant ${e.personName} belongs to locked group (${n.courseStartDate})`);continue}const l={[t]:s,updatedAt:r},o="sent"===t?s:e.sent,c="documents"===t?s:e.documents,d="handedOver"===t?s:e.handedOver,u="paid"===t?s:e.paid,m=o&&c&&d&&u;l.completedComputed=m;const p=null!==e.completedOverride?e.completedOverride:e.completedComputed,x=null!==e.completedOverride?e.completedOverride:m;!p&&x&&(l.completedAt=r),await ge(i,l),a.success++}catch(n){a.failed++,a.errors.push(`Failed to update ${i}: ${n.message}`)}return a},bulkSetCompleted:async e=>{const t={success:0,failed:0,errors:[]},s=(new Date).toISOString();for(const r of e)try{const e=await be(r);if(!e){t.failed++,t.errors.push(`Participant ${r} not found`);continue}const a=await ve(e.courseStartDate);if(a&&"completed"===a.status&&a.isLocked){t.failed++,t.errors.push(`Participant ${e.personName} belongs to locked group (${a.courseStartDate})`);continue}if(!(e.sent&&e.documents&&e.handedOver&&e.paid)){t.failed++,t.errors.push(`Participant ${e.personName} does not have all 4 flags set`);continue}const n={completedOverride:!0,updatedAt:s,completedAt:s};await ge(r,n),t.success++}catch(a){t.failed++,t.errors.push(`Failed to update ${r}: ${a.message}`)}return t}},[o,c]=s.useState(!1),[d,u]=s.useState(!1),[m,p]=s.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}}),x=async(e,s)=>{c(!0);try{const a=await l(t,e,s);a.failed>0?alert(`${i("bulk.completed")}: ${a.success}\n${i("bulk.failed")}: ${a.failed}\n${a.errors.join("\n")}`):alert(`${i("bulk.success")}: ${a.success} ${i("bulk.updated")}`),n()}catch(a){alert(`${i("bulk.error")}: ${a.message}`)}finally{c(!1)}},h=()=>{p({isOpen:!0,title:i("bulk.confirmPaidTitle"),message:i("bulk.confirmPaidMessage"),onConfirm:async()=>{p({...m,isOpen:!1}),await x("paid",!0)}})};return 0===e?null:a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"hidden md:block sticky top-0 bg-blue-600 text-white shadow-lg z-20 mb-4 rounded-lg",children:a.jsxs("div",{className:"px-4 py-3 flex items-center justify-between gap-4",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("button",{onClick:r,className:"p-1 hover:bg-blue-700 rounded transition-colors","aria-label":"Clear selection",children:a.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),a.jsxs("span",{className:"font-semibold",children:[e," ",i("bulk.selected")]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("button",{onClick:()=>x("sent",!0),disabled:o,className:"px-3 py-1.5 bg-white text-blue-600 rounded text-sm font-medium hover:bg-blue-50 disabled:opacity-50 whitespace-nowrap",children:i("bulk.setSent")}),a.jsx("button",{onClick:()=>x("documents",!0),disabled:o,className:"px-3 py-1.5 bg-white text-blue-600 rounded text-sm font-medium hover:bg-blue-50 disabled:opacity-50 whitespace-nowrap",children:i("bulk.setDocuments")}),a.jsx("button",{onClick:()=>x("handedOver",!0),disabled:o,className:"px-3 py-1.5 bg-white text-blue-600 rounded text-sm font-medium hover:bg-blue-50 disabled:opacity-50 whitespace-nowrap",children:i("bulk.setHanded")}),a.jsx("button",{onClick:h,disabled:o,className:"px-3 py-1.5 bg-amber-100 text-amber-800 rounded text-sm font-medium hover:bg-amber-200 disabled:opacity-50 whitespace-nowrap",children:i("bulk.setPaid")}),a.jsx("div",{className:"w-px h-6 bg-blue-400"}),a.jsx("button",{onClick:()=>x("sent",!1),disabled:o,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:i("bulk.clearSent")}),a.jsx("button",{onClick:()=>x("documents",!1),disabled:o,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:i("bulk.clearDocuments")}),a.jsx("button",{onClick:()=>x("handedOver",!1),disabled:o,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:i("bulk.clearHanded")}),a.jsx("button",{onClick:()=>x("paid",!1),disabled:o,className:"px-3 py-1.5 bg-blue-700 text-white rounded text-sm font-medium hover:bg-blue-800 disabled:opacity-50 whitespace-nowrap",children:i("bulk.clearPaid")})]})]})}),a.jsxs("div",{className:"md:hidden fixed bottom-16 left-0 right-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-2xl z-20 rounded-t-2xl",style:{boxShadow:"0 -10px 25px -5px rgba(0, 0, 0, 0.3), 0 -8px 10px -6px rgba(0, 0, 0, 0.1)"},children:[a.jsxs("div",{className:"px-4 py-3 flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("button",{onClick:r,className:"p-1.5 hover:bg-white/20 rounded-full transition-all active:scale-95","aria-label":"Clear selection",children:a.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M6 18L18 6M6 6l12 12"})})}),a.jsxs("div",{className:"flex items-baseline gap-1.5",children:[a.jsx("span",{className:"text-xl font-bold",children:e}),a.jsx("span",{className:"text-sm font-medium opacity-90",children:i("bulk.selected")})]})]}),a.jsxs("button",{onClick:()=>u(!d),className:"px-4 py-2.5 bg-white text-blue-700 rounded-full font-semibold text-sm hover:bg-blue-50 active:scale-95 transition-all shadow-md flex items-center gap-1.5",disabled:o,children:[i("bulk.actions"),a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M19 9l-7 7-7-7"})})]})]}),d&&a.jsxs("div",{className:"fixed inset-0 z-50 flex items-end pointer-events-auto",children:[a.jsx("div",{className:"absolute inset-0 bg-black/40 pointer-events-auto",onClick:()=>u(!1)}),a.jsxs("div",{className:"relative w-full bg-white rounded-t-3xl shadow-2xl max-h-[80vh] overflow-hidden animate-slide-up pointer-events-auto z-10",children:[a.jsxs("div",{className:"sticky top-0 bg-white border-b border-slate-200 px-6 py-3 flex items-center justify-between",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"text-base font-bold text-slate-900",children:i("bulk.actionTitle")}),a.jsxs("p",{className:"text-xs text-slate-600 mt-0",children:[i("bulk.forSelected"),": ",a.jsx("span",{className:"font-semibold",children:e})]})]}),a.jsx("button",{onClick:()=>u(!1),className:"p-2 hover:bg-slate-100 rounded-full transition-colors active:scale-95","aria-label":"Close",children:a.jsx("svg",{className:"w-6 h-6 text-slate-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),a.jsxs("div",{className:"overflow-y-auto",children:[a.jsxs("div",{className:"px-6 pt-3 pb-1",children:[a.jsx("div",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider mb-2",children:i("bulk.set")}),a.jsxs("div",{className:"space-y-0.5",children:[a.jsxs("button",{onClick:()=>{x("sent",!0),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-blue-600 text-lg",children:"✓"}),a.jsx("span",{className:"flex-1 font-medium",children:i("bulk.setSent")})]}),a.jsxs("button",{onClick:()=>{x("documents",!0),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-blue-600 text-lg",children:"✓"}),a.jsx("span",{className:"flex-1 font-medium",children:i("bulk.setDocuments")})]}),a.jsxs("button",{onClick:()=>{x("handedOver",!0),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-blue-600 text-lg",children:"✓"}),a.jsx("span",{className:"flex-1 font-medium",children:i("bulk.setHanded")})]}),a.jsxs("button",{onClick:()=>{h(),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-900 hover:bg-amber-50 active:bg-amber-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-amber-600 text-lg",children:"✓"}),a.jsx("span",{className:"flex-1 font-medium",children:i("bulk.setPaid")})]})]})]}),a.jsx("div",{className:"my-2 mx-6 border-t border-slate-200"}),a.jsxs("div",{className:"px-6 pb-20",children:[a.jsx("div",{className:"text-xs font-bold text-slate-500 uppercase tracking-wider mb-2",children:i("bulk.clear")}),a.jsxs("div",{className:"space-y-0.5",children:[a.jsxs("button",{onClick:()=>{x("sent",!1),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),a.jsx("span",{className:"flex-1",children:i("bulk.clearSent")})]}),a.jsxs("button",{onClick:()=>{x("documents",!1),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),a.jsx("span",{className:"flex-1",children:i("bulk.clearDocuments")})]}),a.jsxs("button",{onClick:()=>{x("handedOver",!1),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),a.jsx("span",{className:"flex-1",children:i("bulk.clearHanded")})]}),a.jsxs("button",{onClick:()=>{x("paid",!1),u(!1)},disabled:o,className:"w-full flex items-center gap-3 px-4 py-2.5 text-left text-slate-700 hover:bg-slate-50 active:bg-slate-200 rounded-xl disabled:opacity-50 transition-all duration-150",children:[a.jsx("span",{className:"text-slate-500 text-lg",children:"✕"}),a.jsx("span",{className:"flex-1",children:i("bulk.clearPaid")})]})]})]})]})]})]})]}),a.jsx(Ee,{isOpen:m.isOpen,onClose:()=>p({...m,isOpen:!1}),onConfirm:m.onConfirm,title:m.title,message:m.message,confirmText:i("common.confirm"),cancelText:i("common.cancel")})]})};function Pe({title:e,count:t,groupNumbers:s,dateRange:r,participantCount:n,isCollapsed:i,onToggle:l,children:o,variant:c="active",showCount:d=!0}){const{t:u}=Ce(),m={active:{bg:"bg-blue-50",border:"border-blue-200",accent:"border-l-blue-400",text:"text-blue-900",countBg:"bg-blue-100",countText:"text-blue-700",icon:a.jsx(v,{className:"w-5 h-5 text-blue-600",strokeWidth:2})},planned:{bg:"bg-amber-50",border:"border-amber-200",accent:"border-l-amber-400",text:"text-amber-900",countBg:"bg-amber-100",countText:"text-amber-700",icon:a.jsx(f,{className:"w-5 h-5 text-amber-600",strokeWidth:2})},completed:{bg:"bg-slate-50",border:"border-slate-200",accent:"border-l-slate-400",text:"text-slate-700",countBg:"bg-slate-100",countText:"text-slate-600",icon:a.jsx(g,{className:"w-5 h-5 text-slate-600",strokeWidth:2})}}[c];return a.jsxs("div",{className:"mb-4",children:[a.jsxs("div",{className:`rounded-lg border ${m.border} ${m.bg} border-l-4 ${m.accent} overflow-hidden shadow-sm transition-shadow duration-150`,children:[a.jsxs("button",{onClick:l,className:`w-full flex items-center justify-between px-4 py-3.5 transition-all duration-150 hover:brightness-95 active:scale-[0.99] ${m.text}`,children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"flex-shrink-0",children:m.icon}),a.jsx("span",{className:"font-bold text-base",children:e}),d&&s&&s.length>0&&a.jsx("span",{className:`px-2.5 py-0.5 ${m.countBg} ${m.countText} rounded-full text-xs font-semibold`,children:1===s.length?`№ ${s[0]}`:`№ ${s.join(", ")}`}),r&&a.jsx("span",{className:"text-sm font-medium opacity-75",children:r}),d&&!s&&"planned"===c&&a.jsx("span",{className:`px-2.5 py-0.5 ${m.countBg} ${m.countText} rounded-full text-xs font-semibold`,children:t})]}),a.jsxs("div",{className:"flex items-center gap-3",children:[void 0!==n&&a.jsxs("span",{className:`px-2.5 py-1 ${m.countBg} ${m.countText} rounded-full text-xs font-bold`,children:[n," ",u(1===n?"group.participant_one":"group.participant_other")]}),a.jsx("svg",{className:"w-5 h-5 transition-transform duration-200 ease-out "+(i?"":"rotate-180"),style:{transformOrigin:"center"},fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M19 9l-7 7-7-7"})})]})]}),a.jsx("div",{className:"grid transition-all duration-150 ease-in-out "+(i?"grid-rows-[0fr] opacity-0":"grid-rows-[1fr] opacity-100"),style:{transitionProperty:"grid-template-rows, opacity",willChange:i?"auto":"grid-template-rows, opacity"},children:a.jsx("div",{className:"overflow-hidden",children:a.jsx("div",{className:"px-1.5 sm:px-2 pb-2 transition-transform duration-150 ease-out "+(i?"translate-y-[-8px]":"translate-y-0"),style:{willChange:i?"auto":"transform"},children:o})})})]}),a.jsx("style",{children:"\n        @media (prefers-reduced-motion: reduce) {\n          .grid, button, svg {\n            transition: none !important;\n          }\n        }\n        \n        @media (max-width: 768px) {\n          .grid {\n            transition-duration: 120ms !important;\n          }\n        }\n      "})]})}const Le=({groupNumber:e,courseStartDate:t,courseEndDate:n,participants:i,renderParticipantRow:l,mode:o="table",defaultExpanded:c=!1})=>{const{t:d}=Ce(),[u,m]=s.useState(c),[p,x]=s.useState({key:"uniqueNumber",direction:"desc"}),h=r.useMemo(()=>p.key?[...i].sort((e,t)=>{if("uniqueNumber"===p.key){const s=e.uniqueNumber||"",a=t.uniqueNumber||"";return"asc"===p.direction?s.localeCompare(a):a.localeCompare(s)}return 0}):i,[i,p]);return a.jsxs("div",{className:"border border-slate-300 rounded-lg mb-2 bg-white shadow-sm transition-shadow duration-150",children:[a.jsxs("button",{onClick:()=>m(!u),className:"w-full px-4 py-3 flex items-center justify-between hover:bg-slate-50 transition-all duration-150 rounded-lg active:scale-[0.99]",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("svg",{className:"w-5 h-5 text-slate-600 transition-transform duration-200 ease-out "+(u?"rotate-90":""),style:{transformOrigin:"center"},fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),a.jsxs("div",{className:"text-left",children:[a.jsxs("div",{className:"font-semibold text-slate-900",children:[d("group.group")," ",e]}),a.jsxs("div",{className:"text-sm text-slate-600",children:[te(t)," - ",te(n)]})]})]}),a.jsxs("div",{className:"text-sm text-slate-600 font-medium",children:[i.length," ",1===i.length?d("group.participant_one"):d("group.participant_other")]})]}),a.jsx("div",{className:"grid transition-all ease-in-out border-t border-slate-200 "+(u?"grid-rows-[1fr] opacity-100":"grid-rows-[0fr] opacity-0"),style:{transitionDuration:"180ms",transitionProperty:"grid-template-rows, opacity",willChange:u?"grid-template-rows, opacity":"auto"},children:a.jsx("div",{className:"overflow-hidden",children:a.jsx("div",{className:"transition-transform duration-180 ease-out "+(u?"translate-y-0":"translate-y-[-8px]"),style:{willChange:u?"transform":"auto"},children:"table"===o?a.jsx("div",{className:"overflow-x-auto",children:a.jsxs("table",{className:"min-w-full bg-white",children:[a.jsx("thead",{className:"bg-slate-50",children:a.jsxs("tr",{children:[a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.companyName")}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.personName")}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors select-none",onClick:()=>(e=>{let t="asc";p.key===e&&"asc"===p.direction&&(t="desc"),x({key:e,direction:t})})("uniqueNumber"),title:"Sort by Number",children:a.jsxs("div",{className:"flex items-center gap-1",children:[d("participant.uniqueNumber"),"uniqueNumber"===p.key&&a.jsx("span",{className:"text-slate-500",children:"asc"===p.direction?"↑":"↓"})]})}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.medicalDate")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.sent")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.documents")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.handedOver")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("participant.paid")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:d("filters.status")})]})}),a.jsx("tbody",{className:"divide-y divide-slate-200",children:h.map(l)})]})}):a.jsx("div",{className:"p-3 space-y-2",children:h.map(l)})})})}),a.jsx("style",{children:"\n        @media (prefers-reduced-motion: reduce) {\n          .grid, button, svg {\n            transition: none !important;\n          }\n        }\n      "})]})},Me=({label:e,variant:t,icon:s})=>a.jsxs("span",{className:`\n        inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs font-medium border\n        ${{success:"bg-emerald-50 text-emerald-800 ring-1 ring-emerald-200 border-0",neutral:"bg-slate-100 text-slate-700 ring-1 ring-slate-200 border-0",info:"bg-blue-50 text-blue-800 ring-1 ring-blue-200 border-0"}[t]}\n      `,children:["check"===s&&a.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}),"manual"===s&&a.jsxs("svg",{className:"w-3 h-3",fill:"currentColor",viewBox:"0 0 16 16",children:[a.jsx("path",{d:"M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"}),a.jsx("path",{d:"M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"})]}),e]}),Te=({isOpen:e,onClose:t,title:r,message:n,buttonText:i="OK",variant:l="info"})=>{if(s.useEffect(()=>{const s=e=>{"Escape"===e.key&&t()};if(e)return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[e,t]),s.useEffect(()=>{if(e){const e=setTimeout(()=>{t()},5e3);return()=>clearTimeout(e)}},[e,t]),!e)return null;return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 transition-opacity",onClick:t}),a.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:a.jsxs("div",{className:"bg-white rounded-xl shadow-2xl max-w-sm w-full md:max-w-md lg:max-w-lg overflow-hidden animate-scale-up transform transition-all",children:[a.jsxs("div",{className:"p-6 md:p-8 text-center",children:[a.jsx("div",{className:`mx-auto mb-4 w-12 h-12 rounded-full flex items-center justify-center ${(()=>{switch(l){case"danger":case"error":return"bg-red-50 text-red-900 border-red-100";case"warning":return"bg-amber-50 text-amber-900 border-amber-100";case"success":return"bg-emerald-50 text-emerald-900 border-emerald-100";default:return"bg-blue-50 text-blue-900 border-blue-100"}})()}`,children:(()=>{switch(l){case"danger":case"error":return a.jsx(w,{className:"w-6 h-6 text-red-600"});case"warning":return a.jsx(b,{className:"w-6 h-6 text-amber-600"});case"success":return a.jsx(h,{className:"w-6 h-6 text-emerald-600"});default:return a.jsx(x,{className:"w-6 h-6 text-blue-600"})}})()}),a.jsx("h3",{className:"text-xl font-bold text-slate-900 mb-2",children:r}),a.jsx("p",{className:"text-slate-600 text-sm leading-relaxed",children:n})]}),a.jsx("div",{className:"p-4 bg-slate-50 border-t border-slate-100",children:a.jsx("button",{onClick:t,className:`w-full px-5 py-2.5 text-white rounded-lg font-medium shadow-md transition-all duration-200 transform hover:-translate-y-0.5 ${(()=>{switch(l){case"danger":case"error":return"bg-red-600 hover:bg-red-700 focus:ring-red-500";case"warning":return"bg-amber-600 hover:bg-amber-700 focus:ring-amber-500";case"success":return"bg-emerald-600 hover:bg-emerald-700 focus:ring-emerald-500";default:return"bg-blue-600 hover:bg-blue-700 focus:ring-blue-500"}})()}`,children:i})})]})})]})},Ie=({participants:e,onEdit:t,onDelete:r,collapsedSections:n,toggleSection:i,hasActiveFilters:o,onFilterChange:c,groupRefreshKey:d=0})=>{var u;const{updateParticipant:m}=we(),{t:p}=Ce(),[x,h]=s.useState("uniqueNumber"),[b,g]=s.useState("asc"),[f,v]=s.useState(new Set),[w,N]=s.useState({isOpen:!1,participant:void 0}),[j,y]=s.useState(null),[S,k]=s.useState({isOpen:!1,title:"",message:"",variant:"info"}),D=(e,t)=>{const s=e.currentTarget.getBoundingClientRect();y({participant:t,x:s.left,y:s.top-8})},C=()=>{y(null)},E=l(()=>W.groups.toArray(),[d]),O=s.useMemo(()=>E?new Map(E.map(e=>[e.courseStartDate,e])):new Map,[E]),A=s.useMemo(()=>[...e].sort((e,t)=>{let s=0;return"courseStartDate"===x||"groupNumber"===x?s=e.courseStartDate.localeCompare(t.courseStartDate):"uniqueNumber"===x&&(s=e.uniqueNumber.localeCompare(t.uniqueNumber)),"asc"===b?s:-s}),[e,x,b]),q=s.useMemo(()=>{const e=[],t=[],s=[];return A.forEach(a=>{const r=O.get(a.courseStartDate);r?"active"===r.status?e.push(a):"planned"===r.status?t.push(a):"completed"===r.status&&s.push(a):t.push(a)}),{active:e,planned:t,completed:s}},[A,O]),P=s.useMemo(()=>null==E?void 0:E.find(e=>"active"===e.status),[E]),L=(null==P?void 0:P.groupNumber)?[P.groupNumber]:[],M=P?`${te(P.courseStartDate)} - ${te(P.courseEndDate)}`:void 0,T=s.useMemo(()=>{const e=new Map;return null==E||E.forEach(t=>{"active"===t.status&&e.set(t.courseStartDate,{group:t,participants:[]})}),q.active.forEach(t=>{const s=e.get(t.courseStartDate);if(s)s.participants.push(t);else{const s=O.get(t.courseStartDate)||{id:"virt-active-"+t.courseStartDate,courseStartDate:t.courseStartDate,courseEndDate:t.courseEndDate,status:"active",groupNumber:null,isLocked:!1,createdAt:"",updatedAt:""};e.set(t.courseStartDate,{group:s,participants:[t]})}}),Array.from(e.values()).sort((e,t)=>e.group.courseStartDate.localeCompare(t.group.courseStartDate))},[q.active,E,O]),I=s.useMemo(()=>{const e=new Map;!o&&E&&E.forEach(t=>{"planned"===t.status&&e.set(t.courseStartDate,{group:t,participants:[]})}),q.planned.forEach(t=>{let s=O.get(t.courseStartDate);if(s&&!e.has(t.courseStartDate)&&e.set(t.courseStartDate,{group:s,participants:[]}),!s&&!e.has(t.courseStartDate)){const s={id:"virtual-planned-"+t.courseStartDate,groupNumber:null,courseStartDate:t.courseStartDate,courseEndDate:t.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""};e.set(t.courseStartDate,{group:s,participants:[]})}e.has(t.courseStartDate)&&e.get(t.courseStartDate).participants.push(t)});const t=Array.from(e.entries()).sort(([e],[t])=>e.localeCompare(t));return(o?t:t.slice(0,2)).map(([e,t])=>({courseStartDate:e,...t,participants:t.participants.sort((e,t)=>t.createdAt.localeCompare(e.createdAt))}))},[q.planned,O,E,o]),R=s.useMemo(()=>{const e=new Map;return q.completed.forEach(t=>{const s=O.get(t.courseStartDate);s&&(e.has(t.courseStartDate)||e.set(t.courseStartDate,{group:s,participants:[]}),e.get(t.courseStartDate).participants.push(t))}),Array.from(e.entries()).sort(([e],[t])=>t.localeCompare(e)).map(([e,t])=>({courseStartDate:e,...t}))},[q.completed,O]),B=s.useMemo(()=>{const e=new Set,t=new Set,s=new Set;return T.forEach(t=>e.add(t.group.courseStartDate)),!o&&E&&E.forEach(a=>{"active"===a.status&&e.add(a.courseStartDate),"planned"===a.status&&t.add(a.courseStartDate),"completed"===a.status&&s.add(a.courseStartDate)}),q.active.forEach(t=>e.add(t.courseStartDate)),q.planned.forEach(e=>t.add(e.courseStartDate)),q.completed.forEach(e=>s.add(e.courseStartDate)),{active:{count:e.size,numbers:[]},planned:{count:t.size,numbers:[]},completed:{count:s.size,numbers:[]}}},[q,E,T,o]);s.useEffect(()=>{(async()=>{await ce()})()},[]);const z=async(e,t)=>{if(de(O.get(e.courseStartDate)))k({isOpen:!0,title:p("common.info"),message:p("lock.lockedInfo"),variant:"info"});else try{await m(e.id,{[t]:!e[t]})}catch(s){k({isOpen:!0,title:p("common.error"),message:p("error.updateParticipantFailed"),variant:"error"})}},_=e=>null!==e.completedOverride?e.completedOverride:e.completedComputed,F=e=>null!==e.completedOverride,G=e=>{const s=O.get(e.courseStartDate),r=X(e),n=["hover:bg-slate-100 transition-colors duration-150","active"===(null==s?void 0:s.status)?"bg-slate-50":"","completed"===(null==s?void 0:s.status)?"opacity-90":""].filter(Boolean).join(" ");return a.jsxs("tr",{className:n,children:[a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:f.has(e.id),onChange:()=>H(e.id),disabled:r,className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed","aria-label":`Select ${e.personName}`})}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(Ae,{companyName:e.companyName}),r&&a.jsx("span",{className:"text-xs text-slate-500",title:p("lock.lockedInfo"),children:"🔒"})]})}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:a.jsx("div",{className:"max-w-xs truncate cursor-help",onMouseEnter:t=>D(t,e),onMouseLeave:C,children:e.personName})}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:te(e.medicalDate)}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:te(e.courseStartDate)}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:te(e.courseEndDate)}),a.jsx("td",{className:"px-3 py-3 text-sm",children:a.jsx("span",{className:"font-mono text-xs bg-slate-100 px-2 py-0.5 rounded inline-block text-slate-700 cursor-help",title:`Уникален номер на удостоверение\nПротокол: ${(null==s?void 0:s.groupNumber)?5*s.groupNumber:"---"}`,children:e.uniqueNumber||"---"})}),a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:e.sent,onChange:()=>z(e,"sent"),disabled:r,title:"Данните са изпратени към фирмата",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:e.documents,onChange:()=>z(e,"documents"),disabled:r,title:"Получени са всички документи",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:e.handedOver,onChange:()=>z(e,"handedOver"),disabled:r,title:"Удостоверението е предадено",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:e.paid,onChange:()=>z(e,"paid"),disabled:r,title:"Таксата е платена",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsxs("div",{className:"flex items-center justify-center gap-1",children:[a.jsx("button",{onClick:()=>(async e=>{if(de(O.get(e.courseStartDate)))return void k({isOpen:!0,title:p("common.info"),message:p("lock.lockedInfo"),variant:"info"});const t=null!==e.completedOverride?e.completedOverride:e.completedComputed;try{await m(e.id,{completedOverride:!t})}catch(s){k({isOpen:!0,title:p("common.error"),message:p("error.updateCompletedFailed"),variant:"error"})}})(e),disabled:r,className:"px-3 py-1 rounded-md text-xs font-medium transition-colors duration-150 ring-1 disabled:opacity-50 disabled:cursor-not-allowed "+(_(e)?"bg-emerald-50 text-emerald-800 ring-emerald-200 hover:bg-emerald-100":"bg-slate-100 text-slate-700 ring-slate-200 hover:bg-slate-200"),title:r?p("lock.lockedInfo"):"Click to toggle",children:_(e)?p("completed.done"):p("completed.pending")}),F(e)&&!r&&a.jsx("button",{onClick:()=>(async e=>{if(de(O.get(e.courseStartDate)))k({isOpen:!0,title:p("common.info"),message:p("lock.lockedInfo"),variant:"info"});else try{await m(e.id,{completedOverride:null})}catch(t){k({isOpen:!0,title:p("common.error"),message:p("error.resetCompletedFailed"),variant:"error"})}})(e),className:"text-blue-600 hover:text-blue-800 p-1 rounded hover:bg-blue-50 transition-colors duration-150",title:"Reset to auto","aria-label":"Reset completed to automatic",children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})})})]})}),a.jsx("td",{className:"px-3 py-3",children:a.jsxs("div",{className:"flex items-center justify-center gap-1",children:[a.jsx("button",{onClick:()=>t(e),disabled:r,className:"p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-100 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:p(r?"lock.lockedInfo":"common.edit"),"aria-label":`Edit ${e.personName}`,children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),a.jsx("button",{onClick:()=>(async e=>{try{let t=O.get(e.courseStartDate);t||(t={id:"virtual-cert",groupNumber:null,courseStartDate:e.courseStartDate,courseEndDate:e.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""});const{generateCertificate:s}=await $(async()=>{const{generateCertificate:e}=await import("./certificateGenerator-ByYTOvTD.js");return{generateCertificate:e}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));await s(e,t),k({isOpen:!0,title:p("common.success"),message:p("certificate.generated"),variant:"success"})}catch(t){k({isOpen:!0,title:p("common.error"),message:p("certificate.error")+": "+t.message,variant:"error"})}})(e),className:"p-2 text-green-600 hover:text-green-800 hover:bg-green-50 rounded-lg transition-colors duration-150",title:"Генерирай сертификат","aria-label":`Generate certificate for ${e.personName}`,children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})})}),a.jsx("button",{onClick:()=>N({isOpen:!0,participant:e}),disabled:r,className:"p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:p(r?"lock.lockedInfo":"common.delete"),"aria-label":`Delete ${e.personName}`,children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})})]},e.id)},U=e=>{const s=X(e);return a.jsxs("tr",{className:"hover:bg-slate-100 transition-colors duration-150",children:[a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:f.has(e.id),onChange:()=>H(e.id),disabled:s,className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed","aria-label":`Select ${e.personName}`})}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:a.jsx(Ae,{companyName:e.companyName})}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-900",children:a.jsx("div",{className:"max-w-xs truncate cursor-help",onMouseEnter:t=>D(t,e),onMouseLeave:C,children:e.personName})}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:te(e.medicalDate)}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:te(e.courseStartDate)}),a.jsx("td",{className:"px-3 py-3 text-sm text-slate-600",children:te(e.courseEndDate)}),a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:e.documents,onChange:()=>z(e,"documents"),disabled:s,title:"Получени са всички документи",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),a.jsx("td",{className:"px-3 py-3 text-center",children:a.jsx("input",{type:"checkbox",checked:e.paid,onChange:()=>z(e,"paid"),disabled:s,title:"Таксата е платена",className:"w-5 h-5 text-emerald-600 rounded focus:ring-2 focus:ring-emerald-300 cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"})}),a.jsx("td",{className:"px-3 py-3",children:a.jsxs("div",{className:"flex items-center justify-center gap-1",children:[a.jsx("button",{onClick:()=>t(e),disabled:s,className:"p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-100 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:p(s?"lock.lockedInfo":"common.edit"),"aria-label":`Edit ${e.personName}`,children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})})}),a.jsx("button",{onClick:()=>N({isOpen:!0,participant:e}),disabled:s,className:"p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-lg transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed",title:p(s?"lock.lockedInfo":"common.delete"),"aria-label":`Delete ${e.personName}`,children:a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]})})]},e.id)},V=e=>{const t=O.get(e.courseStartDate),s=_(e);return a.jsxs("tr",{className:"hover:bg-slate-50 transition-colors",children:[a.jsx("td",{className:"px-3 py-2 text-sm text-slate-900",children:a.jsx(Ae,{companyName:e.companyName})}),a.jsx("td",{className:"px-3 py-2 text-sm text-slate-900",children:a.jsx("div",{className:"cursor-help",onMouseEnter:t=>D(t,e),onMouseLeave:C,children:e.personName})}),a.jsx("td",{className:"px-3 py-2 text-sm",children:a.jsx("span",{className:"font-mono text-xs bg-slate-100 px-2 py-0.5 rounded inline-block text-slate-700 cursor-help",title:`Уникален номер на удостоверение\nПротокол: ${(null==t?void 0:t.groupNumber)?5*t.groupNumber:"---"}`,children:e.uniqueNumber})}),a.jsx("td",{className:"px-3 py-2 text-sm text-slate-600",children:te(e.medicalDate)}),a.jsx("td",{className:"px-3 py-2 text-center",children:a.jsx("input",{type:"checkbox",checked:e.sent,disabled:!0,title:"Данните са изпратени към фирмата",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),a.jsx("td",{className:"px-3 py-2 text-center",children:a.jsx("input",{type:"checkbox",checked:e.documents,disabled:!0,title:"Получени са всички документи",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),a.jsx("td",{className:"px-3 py-2 text-center",children:a.jsx("input",{type:"checkbox",checked:e.handedOver,disabled:!0,title:"Удостоверението е предадено",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),a.jsx("td",{className:"px-3 py-2 text-center",children:a.jsx("input",{type:"checkbox",checked:e.paid,disabled:!0,title:"Таксата е платена",className:"w-4 h-4 text-emerald-600 rounded opacity-60 cursor-not-allowed"})}),a.jsx("td",{className:"px-3 py-2 text-center",children:a.jsxs("div",{className:"flex items-center justify-center gap-1",children:[s&&a.jsx(Me,{label:p("participant.completedBadge"),variant:"success",icon:"check"}),F(e)&&a.jsx(Me,{label:p("participant.manual"),variant:"info",icon:"manual"}),!s&&!F(e)&&a.jsx("span",{className:"text-xs text-slate-400 italic",children:p("completed.pending")})]})})]},e.id)},H=e=>{const t=new Set(f);t.has(e)?t.delete(e):t.add(e),v(t)},X=e=>de(O.get(e.courseStartDate));return 0===A.length?a.jsx("div",{className:"text-center py-12 text-slate-500",children:p("participants.noResults")}):a.jsxs(a.Fragment,{children:[a.jsx(qe,{selectedCount:f.size,selectedIds:Array.from(f),onClearSelection:()=>{v(new Set)},onActionComplete:()=>{v(new Set)}}),a.jsx(Te,{isOpen:S.isOpen,onClose:()=>k(e=>({...e,isOpen:!1})),title:S.title,message:S.message,variant:S.variant}),a.jsxs("div",{className:"space-y-4",children:[(q.active.length>0||!o)&&a.jsx(Pe,{title:p("groups.activeSection"),count:B.active.count,groupNumbers:T.length<=1?L:[],dateRange:T.length<=1?M:void 0,participantCount:q.active.length,isCollapsed:n.active,onToggle:()=>i("active"),variant:"active",children:0===T.length?a.jsx("div",{className:"text-center py-8 text-slate-500 bg-slate-50 border border-dashed border-slate-200 rounded-lg",children:p("participants.noActive")}):a.jsx("div",{className:"space-y-8",children:T.map(e=>a.jsxs("div",{className:"space-y-3",children:[T.length>1&&a.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-blue-100",children:[a.jsxs("span",{className:"font-bold text-blue-900",children:[te(e.group.courseStartDate)," - ",te(e.group.courseEndDate)]}),e.group.groupNumber&&a.jsxs("span",{className:"px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs font-bold",children:["№ ",e.group.groupNumber]})]}),a.jsx("div",{className:"overflow-x-auto max-h-[400px] overflow-y-auto relative rounded-lg border border-slate-200",children:a.jsxs("table",{className:"min-w-full bg-white",children:[a.jsx("thead",{className:"bg-slate-100 sticky top-0 z-10 shadow-sm",children:a.jsxs("tr",{children:[a.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 border-b border-slate-200 w-12",children:a.jsx("input",{type:"checkbox",checked:e.participants.length>0&&e.participants.every(e=>f.has(e.id)),onChange:t=>{const s=new Set(f);t.target.checked?e.participants.filter(e=>!X(e)).forEach(e=>s.add(e.id)):e.participants.forEach(e=>s.delete(e.id)),v(s)},className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer"})}),a.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.companyName")}),a.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.personName")}),a.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.medicalDate")}),a.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.courseStart")}),a.jsx("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.courseEnd")}),a.jsxs("th",{className:"px-3 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200 cursor-pointer hover:bg-slate-200 transition-colors duration-150",onClick:()=>{var e;x===(e="uniqueNumber")?g(e=>"asc"===e?"desc":"asc"):(h(e),g("asc"))},children:[p("participant.uniqueNumber")," ","uniqueNumber"===x&&("asc"===b?"↑":"↓")]}),a.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.sent")}),a.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.documents")}),a.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.handedOver")}),a.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.paid")}),a.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("filters.status")}),a.jsx("th",{className:"px-3 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("common.delete")})]})}),a.jsx("tbody",{className:"divide-y divide-slate-200",children:e.participants.length>0?e.participants.map(G):a.jsx("tr",{children:a.jsx("td",{colSpan:13,className:"text-center py-8 text-slate-400 italic",children:p("participants.noParticipantsInGroup")})})})]})})]},e.group.courseStartDate))})}),(q.planned.length>0||!o)&&I.length>0&&a.jsx(Pe,{title:p("groups.plannedSection"),count:B.planned.count,groupNumbers:I.map(e=>e.group.groupNumber).filter(e=>null!==e),isCollapsed:n.planned,onToggle:()=>i("planned"),variant:"planned",children:a.jsx("div",{className:"space-y-6",children:I.map(({courseStartDate:e,group:t,participants:s})=>a.jsxs("div",{className:"bg-white border border-amber-200 rounded-lg overflow-hidden",children:[a.jsx("div",{className:"bg-amber-50 px-4 py-2 border-b border-amber-200",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[t.groupNumber&&a.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-900 rounded text-xs font-semibold",children:["№ ",t.groupNumber]}),a.jsxs("span",{className:"font-semibold text-amber-900",children:[te(t.courseStartDate)," - ",te(t.courseEndDate)]})]}),a.jsxs("span",{className:"text-sm text-amber-700 font-medium",children:[s.length," ",1===s.length?p("group.participant_one"):p("group.participant_other")]})]})}),a.jsx("div",{className:"overflow-x-auto",children:a.jsxs("table",{className:"min-w-full bg-white",children:[a.jsx("thead",{className:"bg-slate-50",children:a.jsxs("tr",{children:[a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 border-b border-slate-200 w-12",children:a.jsx("input",{type:"checkbox",checked:s.length>0&&s.every(e=>f.has(e.id)),onChange:e=>{const t=new Set(f);e.target.checked?s.forEach(e=>t.add(e.id)):s.forEach(e=>t.delete(e.id)),v(t)},className:"w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-300 cursor-pointer"})}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.companyName")}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.personName")}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.medicalDate")}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.courseStart")}),a.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.courseEnd")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.documents")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("participant.paid")}),a.jsx("th",{className:"px-3 py-2 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider border-b border-slate-200",children:p("common.delete")})]})}),a.jsx("tbody",{className:"divide-y divide-slate-200",children:s.length>0?s.map(U):a.jsx("tr",{children:a.jsx("td",{colSpan:10,className:"text-center py-4 text-slate-400 italic",children:p("participants.noParticipantsInGroup")})})})]})})]},e))})}),(q.completed.length>0||!o)&&R.length>0&&a.jsx(Pe,{title:p("groups.completedSection"),count:B.completed.count,groupNumbers:B.completed.numbers,isCollapsed:n.completed,onToggle:()=>i("completed"),variant:"completed",children:a.jsx("div",{className:"space-y-4",children:R.map(({courseStartDate:e,group:t,participants:s})=>a.jsx("div",{children:a.jsx(Le,{groupNumber:t.groupNumber||0,courseStartDate:t.courseStartDate,courseEndDate:t.courseEndDate,participants:s,renderParticipantRow:V,defaultExpanded:o})},e))})})]}),o&&0===e.length&&a.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 text-center",children:[a.jsx("div",{className:"text-6xl mb-4",children:"🔍"}),a.jsx("h3",{className:"text-lg font-semibold text-slate-700 mb-2",children:"Няма намерени резултати"}),a.jsx("p",{className:"text-sm text-slate-500 mb-6",children:"Опитай да промениш филтрите или ги изчисти"}),a.jsx("button",{onClick:()=>{c({searchTerm:"",courseStartDate:null,category:null,status:"all"})},className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium",children:"Изчисти филтрите"})]}),a.jsx(Ee,{isOpen:w.isOpen,onClose:()=>N({isOpen:!1,participant:void 0}),onConfirm:()=>{w.participant&&r(w.participant.id),N({isOpen:!1,participant:void 0})},title:p("modal.deleteTitle"),message:a.jsxs(a.Fragment,{children:[p("modal.deleteMessage").split("{name}")[0],a.jsx("strong",{className:"font-bold text-slate-900",children:(null==(u=w.participant)?void 0:u.personName)||""}),p("modal.deleteMessage").split("{name}")[1]]}),confirmText:p("common.delete"),cancelText:p("common.cancel"),variant:"danger"}),j&&a.jsxs("div",{className:"fixed z-50 bg-slate-800 text-white text-xs p-3 rounded shadow-lg pointer-events-none transform -translate-y-full filter drop-shadow-md",style:{left:j.x,top:j.y,minWidth:"220px"},children:[a.jsx("div",{className:"font-bold mb-2 border-b border-slate-600 pb-1 text-slate-100",children:j.participant.personName}),a.jsxs("div",{className:"grid grid-cols-[auto_1fr] gap-x-3 gap-y-1.5",children:[a.jsxs("span",{className:"text-slate-400 text-right",children:[p("participant.egn"),":"]}),a.jsx("span",{className:"font-mono",children:j.participant.egn||"-"}),a.jsxs("span",{className:"text-slate-400 text-right",children:[p("participant.birthPlace"),":"]}),a.jsx("span",{children:j.participant.birthPlace||"-"}),a.jsxs("span",{className:"text-slate-400 text-right",children:[p("participant.added"),":"]}),a.jsx("span",{children:j.participant.createdAt?te(j.participant.createdAt):"-"}),a.jsxs("span",{className:"text-slate-400 text-right",children:[p("participant.modified"),":"]}),a.jsx("span",{children:j.participant.updatedAt?te(j.participant.updatedAt):"-"})]})]})]})},$e=({onEdit:e,onDetails:t,onGenerate:r,onDelete:n})=>{const[i,l]=s.useState(!1),o=s.useRef(null);return s.useEffect(()=>{const e=e=>{o.current&&!o.current.contains(e.target)&&l(!1)},t=e=>{"Escape"===e.key&&l(!1)};if(i)return document.addEventListener("mousedown",e),document.addEventListener("keydown",t),()=>{document.removeEventListener("mousedown",e),document.removeEventListener("keydown",t)}},[i]),a.jsxs("div",{className:"relative",ref:o,children:[a.jsx("button",{onClick:()=>l(!i),className:"p-2 hover:bg-slate-100 rounded-lg transition-colors duration-150 min-h-[44px] min-w-[44px] flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-blue-500","aria-label":"More options","aria-expanded":i,children:a.jsxs("svg",{className:"w-5 h-5 text-slate-600",fill:"currentColor",viewBox:"0 0 16 16",children:[a.jsx("circle",{cx:"8",cy:"2",r:"1.5"}),a.jsx("circle",{cx:"8",cy:"8",r:"1.5"}),a.jsx("circle",{cx:"8",cy:"14",r:"1.5"})]})}),i&&a.jsxs("div",{className:"absolute right-0 top-12 bg-white rounded-lg shadow-lg border border-slate-200 py-1 min-w-[140px] z-10 animate-scale-up",children:[e&&a.jsxs("button",{onClick:()=>{e(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-slate-100 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),"Редактирай"]}),t&&a.jsxs("button",{onClick:()=>{t(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-blue-700 hover:bg-blue-50 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),"Детайли"]}),r&&a.jsxs("button",{onClick:()=>{r(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-green-700 hover:bg-green-50 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Генерирай"]}),n&&a.jsxs("button",{onClick:()=>{n(),l(!1)},className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 transition-colors duration-150 min-h-[44px]",children:[a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),"Изтрий"]})]})]})},Re=({isOpen:e,onClose:t,participant:r})=>{const{t:n}=Ce();return s.useEffect(()=>{const s=e=>{"Escape"===e.key&&t()};if(e)return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[e,t]),e&&r?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 transition-opacity",onClick:t}),a.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none",children:a.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden animate-scale-up pointer-events-auto",children:[a.jsxs("div",{className:"relative bg-slate-50 px-6 py-4 border-b border-slate-100",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center shrink-0",children:a.jsx(N,{className:"w-5 h-5 text-blue-600"})}),a.jsxs("div",{className:"min-w-0",children:[a.jsx("h3",{className:"text-lg font-bold text-slate-900 truncate pr-6",children:r.personName}),a.jsx("p",{className:"text-xs text-slate-500 truncate",children:r.companyName})]})]}),a.jsx("button",{onClick:t,className:"absolute right-4 top-4 p-1 rounded-full hover:bg-slate-200 transition-colors text-slate-400 hover:text-slate-600",children:a.jsx(j,{className:"w-5 h-5"})})]}),a.jsxs("div",{className:"p-6 space-y-4",children:[a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[a.jsx(y,{className:"w-3.5 h-3.5"}),a.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:n("participant.egn")})]}),a.jsx("div",{className:"text-sm font-mono text-slate-900 bg-slate-50 px-2 py-1 rounded",children:r.egn||"---"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[a.jsx(S,{className:"w-3.5 h-3.5"}),a.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:n("participant.birthPlace")})]}),a.jsx("div",{className:"text-sm font-medium text-slate-900 truncate",children:r.birthPlace||"---"})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-4 pt-2",children:[a.jsxs("div",{className:"space-y-1",children:[a.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[a.jsx(k,{className:"w-3.5 h-3.5"}),a.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:n("participant.added")})]}),a.jsx("div",{className:"text-xs text-slate-900",children:r.createdAt?te(r.createdAt):"---"})]}),a.jsxs("div",{className:"space-y-1",children:[a.jsxs("div",{className:"flex items-center gap-1.5 text-slate-500",children:[a.jsx(D,{className:"w-3.5 h-3.5"}),a.jsx("span",{className:"text-[10px] uppercase tracking-wider font-semibold",children:n("participant.modified")})]}),a.jsx("div",{className:"text-xs text-slate-900",children:r.updatedAt?te(r.updatedAt):"---"})]})]})]}),a.jsx("div",{className:"px-6 py-4 bg-slate-50 flex justify-end",children:a.jsx("button",{onClick:t,className:"px-4 py-2 bg-white text-slate-700 border border-slate-200 rounded-lg hover:bg-slate-100 font-medium text-sm transition-all",children:n("common.close")})})]})})]}):null},Be=({label:e,isActive:t})=>a.jsxs("div",{className:`\n        flex items-center justify-center gap-1 px-1.5 py-1 rounded text-xs font-medium\n        transition-all duration-150 min-h-[32px] w-full\n        ${t?"bg-emerald-700 border border-emerald-700 text-white":"bg-white border border-slate-300 text-slate-700"}\n      `,children:[t&&a.jsx("svg",{className:"w-3 h-3 flex-shrink-0",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})}),a.jsx("span",{className:"text-[10px] whitespace-nowrap",children:e})]}),ze=({participants:e,onEdit:t,onDelete:r,onSelectionChange:n,collapsedSections:i,toggleSection:o,expandSection:c,hasActiveFilters:d})=>{var u;const{t:m}=Ce(),{updateParticipant:p}=we(),[x,h]=s.useState(new Set),[b,g]=s.useState(null),[f,v]=s.useState({isOpen:!1,participant:void 0}),[w,N]=s.useState({isOpen:!1,participant:void 0}),j=l(()=>W.groups.toArray(),[]),y=s.useMemo(()=>j?new Map(j.map(e=>[e.courseStartDate,e])):new Map,[j]),S=s.useMemo(()=>{const t=[],s=[],a=[];return e.forEach(e=>{const r=y.get(e.courseStartDate);r?"active"===r.status?t.push(e):"planned"===r.status?s.push(e):"completed"===r.status&&a.push(e):s.push(e)}),{active:t,planned:s,completed:a}},[e,y]),k=s.useMemo(()=>{const e=new Map;!d&&j&&j.forEach(t=>{"planned"===t.status&&e.set(t.courseStartDate,{group:t,participants:[]})}),S.planned.forEach(t=>{let s=y.get(t.courseStartDate);if(s&&!e.has(t.courseStartDate)&&e.set(t.courseStartDate,{group:s,participants:[]}),!s&&!e.has(t.courseStartDate)){const s={id:"virtual-"+t.courseStartDate,groupNumber:null,courseStartDate:t.courseStartDate,courseEndDate:t.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""};e.set(t.courseStartDate,{group:s,participants:[]})}e.has(t.courseStartDate)&&e.get(t.courseStartDate).participants.push(t)});const t=Array.from(e.entries()).sort(([e],[t])=>e.localeCompare(t));return(d?t:t.slice(0,2)).map(([e,t])=>({courseStartDate:e,...t,participants:t.participants.sort((e,t)=>t.createdAt.localeCompare(e.createdAt))}))},[S.planned,y,j,d]),D=s.useMemo(()=>{const e=new Map;return S.completed.forEach(t=>{const s=y.get(t.courseStartDate);s&&(e.has(t.courseStartDate)||e.set(t.courseStartDate,{group:s,participants:[]}),e.get(t.courseStartDate).participants.push(t))}),Array.from(e.entries()).sort(([e],[t])=>t.localeCompare(e)).map(([e,t])=>({courseStartDate:e,...t}))},[S.completed,y]),C=s.useMemo(()=>null==j?void 0:j.find(e=>"active"===e.status),[j]),E=(null==C?void 0:C.groupNumber)?[C.groupNumber]:[],O=C?`${te(C.courseStartDate)} - ${te(C.courseEndDate)}`:void 0,A=s.useMemo(()=>{const e=new Map;return null==j||j.forEach(t=>{"active"===t.status&&e.set(t.courseStartDate,{group:t,participants:[]})}),S.active.forEach(t=>{const s=e.get(t.courseStartDate);if(s)s.participants.push(t);else{const s=y.get(t.courseStartDate)||{id:"virt-active-"+t.courseStartDate,courseStartDate:t.courseStartDate,courseEndDate:t.courseEndDate,status:"active",groupNumber:null,isLocked:!1,createdAt:"",updatedAt:""};e.set(t.courseStartDate,{group:s,participants:[t]})}}),Array.from(e.values()).sort((e,t)=>e.group.courseStartDate.localeCompare(t.group.courseStartDate)).map(e=>({...e,participants:e.participants.sort((e,t)=>t.uniqueNumber.localeCompare(e.uniqueNumber))}))},[S.active,j,y]),q=s.useMemo(()=>{const e=new Set,t=new Set,s=new Set;return S.active.forEach(t=>e.add(t.courseStartDate)),!d&&j&&j.forEach(e=>{"planned"===e.status&&t.add(e.courseStartDate)}),S.planned.forEach(e=>t.add(e.courseStartDate)),S.completed.forEach(e=>s.add(e.courseStartDate)),{active:{count:e.size,periods:Array.from(e).sort()},planned:{count:d?t.size:Math.min(t.size,2),periods:Array.from(t).sort()},completed:{count:s.size,periods:Array.from(s).sort()}}},[S,j,d]),P=s.useRef(e);s.useEffect(()=>{P.current!==e&&d&&(S.active.length>0&&i.active&&c("active"),S.planned.length>0&&i.planned&&c("planned"),S.completed.length>0&&i.completed&&c("completed"),P.current=e)},[e,S,i,c,d]),s.useEffect(()=>{null==n||n(x.size>0)},[x.size,n]);const L=async(e,t)=>{const s=y.get(e.courseStartDate);if(s&&"completed"===s.status&&s.isLocked)alert(m("lock.lockedInfo"));else try{await p(e.id,{[t]:!e[t]})}catch(a){}},M=e=>null!==e.completedOverride?e.completedOverride:e.completedComputed,T=e=>null!==e.completedOverride,I=e=>{const t=y.get(e.courseStartDate);return!!t&&("completed"===t.status&&t.isLocked)},R=(e,t)=>{if(I(t))return;const s=setTimeout(()=>{h(new Set([e]))},500);g(s)},B=()=>{b&&(clearTimeout(b),g(null))},[z,_]=s.useState({isOpen:!1,title:"",message:"",variant:"info"}),F=(e,s)=>{var r;const n=x.has(e.id),i=I(e);return a.jsxs("div",{onClick:()=>((e,t)=>{const s=I(t);if(x.size>0){if(s)return;const t=new Set(x);t.has(e)?t.delete(e):t.add(e),h(t)}})(e.id,e),onTouchStart:()=>R(e.id,e),onTouchEnd:B,onMouseDown:()=>R(e.id,e),onMouseUp:B,onMouseLeave:B,className:`bg-white rounded-lg shadow-sm p-3 md:p-4 border transition-all duration-150 ${n?"border-blue-500 ring-2 ring-blue-200":"border-slate-200"} ${i?"opacity-75":"cursor-pointer hover:shadow-md"}`,children:[a.jsxs("div",{className:"flex justify-between items-start mb-3",children:[a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("div",{className:"mb-1",children:a.jsx(Ae,{companyName:e.companyName})}),a.jsxs("div",{className:"flex items-center gap-2",children:[n&&a.jsx("div",{className:"w-5 h-5 bg-blue-600 rounded flex items-center justify-center shrink-0",children:a.jsx("svg",{className:"w-3 h-3 text-white",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})}),a.jsx("h3",{className:"font-bold text-lg text-slate-900 leading-tight truncate",children:e.personName}),i&&a.jsx("span",{className:"text-xs text-slate-500 shrink-0",title:m("lock.lockedInfo"),children:"🔒"})]})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("div",{className:"flex flex-col gap-1 items-end",children:[e.uniqueNumber&&a.jsx("span",{className:"text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-700",children:e.uniqueNumber}),a.jsxs("div",{className:"flex gap-1",children:[M(e)?a.jsx(Me,{label:m("participant.completedBadge"),variant:"success",icon:"check"}):a.jsx("span",{className:"text-[10px] text-slate-400 italic font-medium",children:m("completed.pending")}),T(e)&&a.jsx(Me,{label:m("participant.manual"),variant:"info",icon:"manual"})]})]}),!i&&a.jsx($e,{onEdit:()=>t(e),onDetails:()=>N({isOpen:!0,participant:e}),onGenerate:"active"===(null==(r=y.get(e.courseStartDate))?void 0:r.status)?()=>(async e=>{try{let t=y.get(e.courseStartDate);t||(t={id:"virtual",groupNumber:null,courseStartDate:e.courseStartDate,courseEndDate:e.courseEndDate,status:"planned",isLocked:!1,createdAt:"",updatedAt:""});const{generateCertificate:s}=await $(async()=>{const{generateCertificate:e}=await import("./certificateGenerator-ByYTOvTD.js");return{generateCertificate:e}},__vite__mapDeps([0,1,2,3,4,5,6,7,8]));await s(e,t),_({isOpen:!0,title:m("common.success"),message:m("certificate.generated"),variant:"success"})}catch(t){_({isOpen:!0,title:m("common.error"),message:m("certificate.error")+": "+t.message,variant:"error"})}})(e):void 0,onDelete:()=>(e=>{v({isOpen:!0,participant:e})})(e)})]})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-x-2 gap-y-2 mb-3",children:[a.jsxs("div",{className:"flex flex-col min-w-0",children:[a.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:m("participant.medical")}),a.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:te(e.medicalDate)})]}),a.jsxs("div",{className:"flex flex-col min-w-0 text-right",children:[a.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:m("participant.period")}),a.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:te(e.courseStartDate)})]}),a.jsxs("div",{className:"flex flex-col min-w-0",children:[a.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:m("participant.courseStart")}),a.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:te(e.courseStartDate)})]}),a.jsxs("div",{className:"flex flex-col min-w-0 text-right",children:[a.jsx("span",{className:"text-slate-500 text-[10px] sm:text-[11px] uppercase tracking-wider font-semibold truncate",children:m("participant.courseEnd")}),a.jsx("span",{className:"font-bold text-sm text-slate-900 truncate",children:te(e.courseEndDate)})]})]}),a.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-1.5 sm:gap-1",children:[a.jsx("button",{onClick:t=>{t.stopPropagation(),L(e,"sent")},disabled:i,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:a.jsx(Be,{label:m("participant.sent"),isActive:e.sent})}),a.jsx("button",{onClick:t=>{t.stopPropagation(),L(e,"documents")},disabled:i,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:a.jsx(Be,{label:m("participant.documents"),isActive:e.documents})}),a.jsx("button",{onClick:t=>{t.stopPropagation(),L(e,"handedOver")},disabled:i,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:a.jsx(Be,{label:m("participant.handed"),isActive:e.handedOver})}),a.jsx("button",{onClick:t=>{t.stopPropagation(),L(e,"paid")},disabled:i,className:"active:scale-95 transition-transform duration-150 flex-1 disabled:opacity-50 disabled:cursor-not-allowed",children:a.jsx(Be,{label:m("participant.paid"),isActive:e.paid})})]})]},e.id)},G=e=>a.jsxs("div",{className:"bg-white rounded-lg p-3 border border-slate-200",children:[a.jsxs("div",{className:"flex justify-between items-start mb-2",children:[a.jsxs("div",{className:"flex-1 min-w-0 pr-2",children:[a.jsx("div",{className:"mb-1",children:a.jsx(Ae,{companyName:e.companyName})}),a.jsx("h4",{className:"font-semibold text-slate-900 truncate",children:e.personName})]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("div",{className:"flex flex-col gap-1 items-end shrink-0",children:[e.uniqueNumber&&a.jsx("span",{className:"text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-700",children:e.uniqueNumber}),a.jsxs("div",{className:"flex gap-1",children:[M(e)?a.jsx(Me,{label:m("participant.completedBadge"),variant:"success",icon:"check"}):a.jsx("span",{className:"text-[10px] text-slate-400 italic font-medium",children:m("completed.pending")}),T(e)&&a.jsx(Me,{label:m("participant.manual"),variant:"info",icon:"manual"})]})]}),a.jsx($e,{onDetails:()=>N({isOpen:!0,participant:e})})]})]}),a.jsx("div",{className:"text-sm text-slate-600 mb-2",children:a.jsxs("div",{className:"text-[10px] text-slate-500 uppercase tracking-wider font-semibold mb-1",children:[m("participant.medical"),": ",te(e.medicalDate)]})}),a.jsxs("div",{className:"flex flex-nowrap justify-between items-center gap-0.5 mt-auto pt-2 border-t border-slate-50 overflow-hidden",children:[a.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[a.jsx("input",{type:"checkbox",checked:e.sent,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),m("participant.sent")]}),a.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[a.jsx("input",{type:"checkbox",checked:e.documents,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),m("participant.documents")]}),a.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[a.jsx("input",{type:"checkbox",checked:e.handedOver,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),m("participant.handed")]}),a.jsxs("label",{className:"flex items-center gap-0.5 text-[8px] sm:text-[9px] text-slate-500 whitespace-nowrap",children:[a.jsx("input",{type:"checkbox",checked:e.paid,disabled:!0,className:"w-2.5 h-2.5 sm:w-3 sm:h-3 text-emerald-600 rounded opacity-60 cursor-not-allowed"}),m("participant.paid")]})]})]},e.id);return 0===e.length?a.jsx("div",{className:"text-center py-12 text-slate-500",children:m("participants.noResults")}):a.jsxs(a.Fragment,{children:[a.jsx(qe,{selectedCount:x.size,selectedIds:Array.from(x),onClearSelection:()=>{h(new Set)},onActionComplete:()=>{h(new Set)}}),a.jsx(Re,{isOpen:w.isOpen,onClose:()=>N({isOpen:!1,participant:void 0}),participant:w.participant}),a.jsx(Te,{isOpen:z.isOpen,onClose:()=>_(e=>({...e,isOpen:!1})),title:z.title,message:z.message,variant:"error"===z.variant?"danger":z.variant}),a.jsxs("div",{className:"space-y-4 pb-32",children:[(S.active.length>0||!d)&&a.jsx(Pe,{title:m("groups.activeSection"),count:q.active.count,groupNumbers:A.length<=1&&E.length>0?E:[],dateRange:A.length<=1?O:void 0,participantCount:S.active.length,isCollapsed:i.active,onToggle:()=>o("active"),showCount:!(A.length<=1)||Math.max(E.length,0)>0,variant:"active",children:0===A.length?a.jsx("div",{className:"text-center py-8 text-slate-500 bg-slate-50/50 rounded-lg border border-dashed border-slate-200",children:a.jsx("p",{children:m("participants.noActive")})}):a.jsx("div",{className:"space-y-8",children:A.map(e=>a.jsxs("div",{className:"space-y-4",children:[A.length>1&&a.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-blue-100",children:[a.jsxs("span",{className:"font-semibold text-blue-900",children:[te(e.group.courseStartDate)," - ",te(e.group.courseEndDate)]}),e.group.groupNumber&&a.jsxs("span",{className:"px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-bold",children:["№ ",e.group.groupNumber]})]}),e.participants.length>0?a.jsx("div",{className:"space-y-4",children:e.participants.map((e,t)=>F(e))}):a.jsx("div",{className:"text-center py-4 italic text-slate-400 bg-white/50 rounded border border-dashed border-slate-100",children:m("participants.noParticipantsInGroup")})]},e.group.courseStartDate))})}),(S.planned.length>0||!d)&&a.jsx(Pe,{title:m("groups.plannedSection"),count:q.planned.count,groupNumbers:k.map(e=>e.group.groupNumber).filter(e=>null!==e),participantCount:S.planned.length,isCollapsed:i.planned,onToggle:()=>o("planned"),variant:"planned",children:k.length>0?a.jsx("div",{className:"space-y-3",children:k.map(({courseStartDate:e,group:t,participants:s})=>a.jsxs("div",{className:"bg-white border-2 border-amber-200 rounded-lg overflow-hidden",children:[a.jsx("div",{className:"bg-amber-50 px-3 py-2 border-b border-amber-200",children:a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[t.groupNumber&&a.jsxs("span",{className:"px-2 py-0.5 bg-amber-200 text-amber-900 rounded text-xs font-semibold",children:["№ ",t.groupNumber]}),a.jsxs("span",{className:"font-semibold text-amber-900",children:[te(t.courseStartDate)," - ",te(t.courseEndDate)]})]}),a.jsxs("span",{className:"text-xs text-amber-700 font-medium",children:[s.length," ",1===s.length?m("group.participant_one"):m("group.participant_other")]})]})}),a.jsx("div",{className:"p-2 space-y-2",children:s.map((e,t)=>F(e))})]},e))}):a.jsx("div",{className:"text-center py-8 text-slate-500",children:m("participants.noParticipantsInGroup")})}),(S.completed.length>0||!d)&&a.jsx(Pe,{title:m("groups.completedSection"),count:q.completed.count,participantCount:S.completed.length,isCollapsed:i.completed,onToggle:()=>o("completed"),variant:"completed",children:D.length>0?a.jsx("div",{className:"space-y-2",children:D.map(({courseStartDate:e,group:t,participants:s})=>a.jsx(Le,{groupNumber:t.groupNumber||0,courseStartDate:t.courseStartDate,courseEndDate:t.courseEndDate,participants:s,renderParticipantRow:G,mode:"cards",defaultExpanded:d},e))}):a.jsx("div",{className:"text-center py-8 text-slate-500",children:"Няма приключени групи"})})]}),d&&0===e.length&&a.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4 text-center",children:[a.jsx("div",{className:"text-6xl mb-4",children:"🔍"}),a.jsx("h3",{className:"text-lg font-semibold text-slate-700 mb-2",children:"Няма намерени резултати"}),a.jsx("p",{className:"text-sm text-slate-500 mb-6",children:"Опитай да промениш филтрите"})]}),a.jsx(Ee,{isOpen:f.isOpen,onClose:()=>v({isOpen:!1,participant:void 0}),onConfirm:()=>{f.participant&&r(f.participant.id),v({isOpen:!1,participant:void 0})},title:m("modal.deleteTitle"),message:m("modal.deleteMessage",{name:(null==(u=f.participant)?void 0:u.personName)||""}),confirmText:m("common.delete"),cancelText:m("common.cancel"),variant:"danger"})]})},_e=({isOpen:e,onClose:t,participant:r})=>{const{addParticipant:n,updateParticipant:i}=we(),{t:c}=Ce(),[d,u]=s.useState({companyName:"",personName:"",egn:"",birthPlace:"",citizenship:"българско",medicalDate:"",groupAssignmentMode:"auto",selectedGroupId:"",uniqueNumber:""}),[p,x]=s.useState({courseStartDate:"",courseEndDate:""}),[h,b]=s.useState({}),[g,f]=s.useState(!1),[v,w]=s.useState(""),[N,j]=s.useState(null),[y,S]=s.useState({isOpen:!1,message:"",onConfirm:()=>{}}),k=l(()=>ae(),[]),D=l(()=>W.groups.orderBy("groupNumber").toArray(),[]),[C,E]=s.useState(null);s.useEffect(()=>{d.medicalDate?ie(d.medicalDate).then(e=>{if(e.group)E(e.group);else if(e.createsForDate){const t=new Date(e.createsForDate),s=new Date(t);s.setDate(t.getDate()+7),E({groupNumber:null,courseStartDate:e.createsForDate,courseEndDate:s.toISOString().split("T")[0],status:"planned"})}else E(null)}):E(null)},[d.medicalDate]),s.useEffect(()=>{r?(u({companyName:r.companyName,personName:r.personName,egn:r.egn||"",birthPlace:r.birthPlace||"",citizenship:r.citizenship||"българско",medicalDate:r.medicalDate,groupAssignmentMode:"auto",selectedGroupId:"",uniqueNumber:r.uniqueNumber}),x({courseStartDate:r.courseStartDate,courseEndDate:r.courseEndDate}),w("")):(u({companyName:"",personName:"",egn:"",birthPlace:"",citizenship:"българско",medicalDate:"",groupAssignmentMode:"auto",selectedGroupId:"",uniqueNumber:""}),x({courseStartDate:"",courseEndDate:""}),e&&Promise.all([H(),Z()]).then(([e,t])=>{w(e),j(t)}).catch(e=>{w(""),j(null)})),b({})},[r,e]),s.useEffect(()=>{if(C)x({courseStartDate:C.courseStartDate,courseEndDate:C.courseEndDate}),"active"===C.status?Promise.all([H(),Z()]).then(([e,t])=>{w(t||e),j(t),r&&u(e=>({...e,uniqueNumber:""}))}).catch(e=>{}):(w(""),j(null));else if(d.medicalDate)try{const e=R(d.medicalDate);x(e)}catch(e){}},[d.medicalDate,C,r]);const O=async()=>{const e={};if(d.companyName.trim()||(e.companyName=c("modal.companyNameRequired")),d.personName.trim()||(e.personName=c("modal.personNameRequired")),d.egn.trim()?/^\d{10}$/.test(d.egn)||(e.egn=c("modal.egnInvalid")):e.egn=c("modal.egnRequired"),d.birthPlace.trim()||(e.birthPlace=c("modal.birthPlaceRequired")),d.medicalDate?function(e){const t=m(new Date);return o(e)>=t}(d.medicalDate)||(e.medicalDate=se):e.medicalDate=c("modal.medicalDateRequired"),d.uniqueNumber)if(t=d.uniqueNumber,/^\d{4}-\d+$/.test(t)){if(await J(d.uniqueNumber,null==r?void 0:r.id)){if(N&&!r){const t=U(d.uniqueNumber),s=U(N);t&&s&&(t.prefix>s.prefix||t.prefix===s.prefix&&t.seq>s.seq)&&(e.uniqueNumber=c("modal.cannotSkipGap",{number:N}))}}else e.uniqueNumber=c("modal.uniqueNumberExists")}else e.uniqueNumber=c("modal.uniqueNumberInvalid");var t;return b(e),0===Object.keys(e).length},A=async()=>{f(!0);try{const e={companyName:d.companyName.trim(),personName:d.personName.trim(),egn:d.egn.trim(),birthPlace:d.birthPlace.trim(),citizenship:d.citizenship.trim()||"българско",medicalDate:d.medicalDate,uniqueNumber:d.uniqueNumber.trim()||N||void 0};r?await i(r.id,e):await n(e),t()}catch(e){alert(`${c("error.saveFailed")}: ${e.message}`)}finally{f(!1)}};return e?a.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",onClick:t,children:[a.jsxs("div",{className:"w-full max-w-2xl p-16 cursor-default",onClick:e=>e.stopPropagation(),children:[a.jsx("div",{className:"bg-white rounded-lg w-full max-h-[85vh] overflow-y-auto shadow-xl",children:a.jsxs("div",{className:"p-6",children:[a.jsx("h2",{className:"text-2xl font-bold mb-4",children:c(r?"modal.editParticipant":"modal.addParticipant")}),r&&a.jsx("div",{className:"mb-4 p-3 bg-slate-50 rounded-lg border border-slate-200",children:a.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[r.createdAt&&a.jsxs("div",{children:[a.jsxs("span",{className:"text-slate-600",children:[c("timestamp.createdAt"),":"]}),a.jsxs("span",{className:"ml-2 font-medium text-slate-900",children:[te(r.createdAt.split("T")[0])," ",new Date(r.createdAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})]})]}),r.updatedAt&&a.jsxs("div",{children:[a.jsxs("span",{className:"text-slate-600",children:[c("timestamp.updatedAt"),":"]}),a.jsxs("span",{className:"ml-2 font-medium text-slate-900",children:[te(r.updatedAt.split("T")[0])," ",new Date(r.updatedAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})]})]}),r.completedAt&&a.jsxs("div",{className:"col-span-2",children:[a.jsxs("span",{className:"text-emerald-600",children:[c("timestamp.completedAt"),":"]}),a.jsxs("span",{className:"ml-2 font-medium text-emerald-800",children:[te(r.completedAt.split("T")[0])," ",new Date(r.completedAt).toLocaleTimeString("bg-BG",{hour:"2-digit",minute:"2-digit"})]})]})]})}),a.jsxs("form",{onSubmit:async e=>{e.preventDefault();if(await O()){if("manual"===d.groupAssignmentMode&&d.selectedGroupId){const e=parseInt(d.selectedGroupId,10),t=null==D?void 0:D.find(t=>t.groupNumber===e);if("completed"===(null==t?void 0:t.status))return void b(e=>({...e,selectedGroupId:c("modal.completedGroupError")}));if(!ee(d.medicalDate,t.courseStartDate))return void b(e=>({...e,medicalDate:c("modal.medicalDateCourseValidation")}))}else if(!ee(d.medicalDate,p.courseStartDate))return void b(e=>({...e,medicalDate:c("modal.medicalDateCourseValidation")}));if("manual"===d.groupAssignmentMode&&d.selectedGroupId){const e=parseInt(d.selectedGroupId,10),t=await ie(p.courseStartDate);if(t.group&&t.group.groupNumber!==e){const s=null==D?void 0:D.find(t=>t.groupNumber===e);return void S({isOpen:!0,message:c("modal.groupWarningMessage",{selected:String(e),selectedDate:te(s.courseStartDate),suggested:String(t.group.groupNumber??""),suggestedDate:te(t.group.courseStartDate)}),onConfirm:()=>{S({isOpen:!1,message:"",onConfirm:()=>{}}),A()}})}}await A()}},children:[a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:[c("modal.companyName")," *"]}),a.jsxs("select",{value:d.companyName,onChange:e=>u({...d,companyName:e.target.value}),className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[a.jsx("option",{value:"",children:c("modal.selectCompany")}),a.jsx("option",{value:"Egida",children:"Egida"}),a.jsx("option",{value:"D-Max",children:"D-Max"}),a.jsx("option",{value:"Multiforce",children:"Multiforce"})]}),h.companyName&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:h.companyName})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:[c("modal.personName")," *"]}),a.jsx("input",{type:"text",value:d.personName,onChange:e=>u({...d,personName:e.target.value}),className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),h.personName&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:h.personName})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"ЕГН *"}),a.jsx("input",{type:"text",value:d.egn,onChange:e=>u({...d,egn:e.target.value}),placeholder:"XXXXXXXXXX",maxLength:10,className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),h.egn&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:h.egn})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Месторождение *"}),a.jsx("input",{type:"text",value:d.birthPlace,onChange:e=>u({...d,birthPlace:e.target.value}),placeholder:"гр./с. ...",className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"}),h.birthPlace&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:h.birthPlace})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:"Гражданство"}),a.jsx("input",{type:"text",value:d.citizenship,onChange:e=>u({...d,citizenship:e.target.value}),placeholder:"българско",className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:[c("modal.medicalDate")," *"]}),a.jsx("input",{type:"date",value:d.medicalDate,onChange:e=>u({...d,medicalDate:e.target.value}),onClick:e=>{var t,s;return null==(s=(t=e.target).showPicker)?void 0:s.call(t)},className:"w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer "+(h.medicalDate?"border-red-500":"border-slate-300")}),h.medicalDate&&a.jsx("p",{className:"text-red-600 text-sm mt-1 font-medium",children:h.medicalDate}),d.medicalDate&&!h.medicalDate&&a.jsxs("p",{className:"text-emerald-600 text-sm mt-1",children:["✓ ",c("modal.medicalValid"),": ",te(d.medicalDate)]})]}),p.courseStartDate&&a.jsxs("div",{className:"bg-blue-50 border border-blue-200 p-4 rounded-md",children:[a.jsx("h3",{className:"font-semibold text-blue-900 mb-2",children:c("modal.courseDates")}),a.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-blue-700 mb-1",children:c("modal.courseStart")}),a.jsx("div",{className:"text-lg font-semibold text-blue-900",children:te(p.courseStartDate)})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-blue-700 mb-1",children:c("modal.courseEnd")}),a.jsx("div",{className:"text-lg font-semibold text-blue-900",children:te(p.courseEndDate)})]})]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:c("modal.groupAssignment")}),a.jsxs("div",{className:"flex gap-2 mb-3",children:[a.jsx("button",{type:"button",onClick:()=>u({...d,groupAssignmentMode:"auto",selectedGroupId:""}),className:"flex-1 px-3 py-2 rounded-md border "+("auto"===d.groupAssignmentMode?"bg-blue-700 text-white border-blue-700":"bg-white text-slate-700 border-slate-300 hover:bg-slate-50"),children:c("modal.auto")}),a.jsx("button",{type:"button",onClick:()=>u({...d,groupAssignmentMode:"manual"}),className:"flex-1 px-3 py-2 rounded-md border "+("manual"===d.groupAssignmentMode?"bg-blue-700 text-white border-blue-700":"bg-white text-slate-700 border-slate-300 hover:bg-slate-50"),children:c("modal.manual")})]}),"auto"===d.groupAssignmentMode&&C&&a.jsx(a.Fragment,{children:"completed"===C.status?a.jsx("div",{className:"bg-red-50 border border-red-200 p-3 rounded-md",children:a.jsxs("p",{className:"text-sm text-red-800 font-medium",children:["⛔ ",c("modal.periodClosed"),a.jsx("br",{}),a.jsxs("span",{className:"text-xs font-normal mt-1 block",children:[c("modal.cannotAddComp",{date:te(C.courseStartDate)}),a.jsx("br",{}),c("modal.selectOtherDate")]})]})}):a.jsx("div",{className:"bg-emerald-50 border border-emerald-200 p-3 rounded-md",children:a.jsxs("p",{className:"text-sm text-emerald-800",children:["✓ ",c("modal.willBeAssigned")," ",a.jsxs("span",{className:"font-semibold",children:[c("group.number")," ",C.groupNumber||"-"]})," ","(",te(C.courseStartDate)," - ",te(C.courseEndDate),")"," ",a.jsx("span",{className:"inline-block px-2 py-0.5 rounded text-xs font-semibold "+("active"===C.status?"bg-blue-100 text-blue-700":"bg-slate-100 text-slate-700"),children:"active"===C.status?c("modal.active"):c("modal.planned")})]})})}),"manual"===d.groupAssignmentMode&&a.jsxs("select",{value:d.selectedGroupId,onChange:e=>u({...d,selectedGroupId:e.target.value}),className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[a.jsx("option",{value:"",children:c("modal.selectGroup")}),k&&a.jsxs("option",{value:(k.groupNumber||"").toString(),children:[c("group.number")," ",k.groupNumber||"-"," - ",te(k.courseStartDate)," (",c("modal.active"),")"]}),null==D?void 0:D.filter(e=>"planned"===e.status).map(e=>a.jsxs("option",{value:(e.groupNumber||"").toString(),children:[c("group.number")," ",e.groupNumber||"-"," - ",te(e.courseStartDate)," (",c("modal.planned"),")"]},e.id))]})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:c("modal.uniqueNumberAuto")}),N&&r&&a.jsx("div",{className:"mb-2 p-2 bg-amber-50 border border-amber-300 rounded-md",children:a.jsxs("p",{className:"text-amber-800 text-sm font-medium",children:["⚠️ Участникът ще получи попълващ номер: ",N]})}),r&&"active"===(null==C?void 0:C.status)&&v&&!N&&a.jsx("div",{className:"mb-2 p-2 bg-blue-50 border border-blue-300 rounded-md",children:a.jsxs("p",{className:"text-blue-800 text-sm font-medium",children:["ℹ️ Преместване в активна група → Уникален номер: ",a.jsx("span",{className:"font-bold",children:v})]})}),a.jsx("input",{type:"text",value:d.uniqueNumber,onChange:e=>u({...d,uniqueNumber:e.target.value}),placeholder:v?`${c("modal.uniqueNumberNext")}: ${v}`:"e.g., 3534-001",className:"w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono"}),h.uniqueNumber&&a.jsx("p",{className:"text-red-600 text-sm mt-1",children:h.uniqueNumber})]})]}),a.jsxs("div",{className:"mt-6 flex gap-3 justify-end pb-2 md:pb-0",children:[a.jsx("button",{type:"button",onClick:t,className:"px-4 py-2 border border-slate-200 rounded-md text-slate-700 hover:bg-slate-50",disabled:g,children:c("common.cancel")}),a.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-700 text-white rounded-md hover:bg-blue-800 disabled:opacity-50 disabled:cursor-not-allowed",disabled:g||"auto"===d.groupAssignmentMode&&"completed"===(null==C?void 0:C.status),children:c(g?"common.saving":r?"modal.update":"common.add")})]})]})]})})," "]})," ",a.jsx(Ee,{isOpen:y.isOpen,onClose:()=>S({isOpen:!1,message:"",onConfirm:()=>{}}),onConfirm:y.onConfirm,title:"Предупреждение за група",message:y.message,confirmText:"Продължи",cancelText:"Отказ",variant:"warning"})]}):null},Fe=({isOpen:e,onClose:t,searchText:r,onSearchTextChange:n,selectedGroup:i,onSelectedGroupChange:l,statusFilters:o,onStatusFilterChange:c,dateRange:d,onDateRangeChange:u,groups:m,onResetToDefaults:p,visibleCount:x,totalCount:h})=>{const{t:b}=Ce();s.useEffect(()=>{const s=e=>{"Escape"===e.key&&t()};if(e)return document.addEventListener("keydown",s),()=>document.removeEventListener("keydown",s)},[e,t]);const g=({label:e,value:t,onChange:s})=>a.jsxs("div",{className:"mb-3",children:[a.jsx("span",{className:"text-sm font-medium text-slate-700 mb-1.5 block",children:e}),a.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[a.jsx("button",{onClick:()=>s(null),className:"px-2 py-1.5 text-sm rounded-lg min-h-[36px] font-medium transition-colors duration-150 "+(null===t?"bg-slate-500 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"),children:b("filters.all")}),a.jsx("button",{onClick:()=>s(!0),className:"px-2 py-1.5 text-sm rounded-lg min-h-[36px] font-medium transition-colors duration-150 "+(!0===t?"bg-emerald-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"),children:b("filters.yes")}),a.jsx("button",{onClick:()=>s(!1),className:"px-2 py-1.5 text-sm rounded-lg min-h-[36px] font-medium transition-colors duration-150 "+(!1===t?"bg-red-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"),children:b("filters.no")})]})]});return e?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 bg-black/30 z-40 transition-opacity",onClick:t}),a.jsxs("div",{className:`fixed z-50 bg-white shadow-2xl transition-transform\n          md:top-0 md:left-0 md:bottom-auto md:right-auto md:h-auto md:max-h-[calc(100vh-16px)] md:w-[360px] lg:w-[420px] md:max-w-[480px] md:translate-x-0\n          bottom-0 left-0 right-0 max-h-[90vh] rounded-t-3xl md:rounded-none flex flex-col\n          ${e?"translate-y-0":"translate-y-full md:translate-y-0 md:-translate-x-full"}\n        `,children:[a.jsx("div",{className:"md:hidden flex justify-center pt-3 pb-2",children:a.jsx("div",{className:"w-12 h-1.5 bg-slate-300 rounded-full"})}),a.jsxs("div",{className:"sticky top-0 bg-white flex items-center justify-between p-4 border-b border-slate-200 z-10",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("h3",{className:"text-lg font-bold text-slate-900",children:b("filters.title")}),void 0!==x&&void 0!==h&&a.jsxs("span",{className:"text-sm font-medium text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full",children:[x," / ",h]})]}),a.jsx("button",{onClick:t,className:"p-2 hover:bg-slate-100 rounded-lg min-w-[44px] min-h-[44px] transition-colors duration-150",children:a.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),a.jsxs("div",{className:"p-4 pb-4 flex-1 md:flex-none overflow-y-auto overscroll-contain",children:[a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:b("filters.search")}),a.jsx("input",{type:"text",value:r,onChange:e=>n(e.target.value),onKeyDown:e=>{"Enter"===e.key&&t()},placeholder:b("filters.searchPlaceholder"),className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150"})]}),a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:b("filters.group")}),a.jsxs("select",{value:i,onChange:e=>l(e.target.value),className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150",children:[a.jsx("option",{value:"",children:b("filters.allGroups")}),m.map(e=>a.jsx("option",{value:e.groupNumber.toString(),children:b("filters.groupOption",{number:e.groupNumber.toString(),date:e.courseStartDate})},e.groupNumber))]})]}),a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-2",children:b("filters.dateRange")}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("input",{type:"date",value:d.start,onChange:e=>u({...d,start:e.target.value}),onClick:e=>{var t,s;return null==(s=(t=e.target).showPicker)?void 0:s.call(t)},className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150 cursor-pointer"}),a.jsx("input",{type:"date",value:d.end,onChange:e=>u({...d,end:e.target.value}),onClick:e=>{var t,s;return null==(s=(t=e.target).showPicker)?void 0:s.call(t)},className:"w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 min-h-[44px] transition-colors duration-150 cursor-pointer"})]})]}),a.jsxs("div",{className:"border-t border-slate-200 pt-4 mt-4",children:[a.jsx("h4",{className:"font-medium text-slate-900 mb-4",children:b("filters.statusFilters")}),a.jsx(g,{label:b("participant.sent"),value:o.sent,onChange:e=>c("sent",e)}),a.jsx(g,{label:b("participant.documents"),value:o.documents,onChange:e=>c("documents",e)}),a.jsx(g,{label:b("participant.handed"),value:o.handedOver,onChange:e=>c("handedOver",e)}),a.jsx(g,{label:b("participant.paid"),value:o.paid,onChange:e=>c("paid",e)}),a.jsx(g,{label:b("participant.completed"),value:o.completed,onChange:e=>c("completed",e)})]}),a.jsxs("div",{className:"mt-6 mb-6 pb-8 flex gap-3",children:[a.jsx("button",{onClick:()=>{n(""),l(""),u({start:"",end:""}),c("sent",null),c("documents",null),c("handedOver",null),c("paid",null),c("completed",null),p()},className:"flex-1 px-4 py-3 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 font-medium min-h-[48px] transition-colors duration-150",children:b("filters.clearAll")}),a.jsx("button",{onClick:t,className:"flex-1 px-4 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-medium min-h-[48px] transition-colors duration-150",children:b("filters.apply")})]})]})]})]}):null},We=({activeFilters:e,onRemoveFilter:t})=>{var s,r;const{t:n}=Ce(),i=[];return e.searchText&&i.push({label:`${n("filters.search")}: "${e.searchText}"`,type:"search"}),e.selectedGroup&&i.push({label:`${n("filters.group")}: ${e.selectedGroup}`,type:"group"}),(null==(s=e.dateRange)?void 0:s.start)&&i.push({label:`${n("filters.from")}: ${te(e.dateRange.start)}`,type:"dateStart"}),(null==(r=e.dateRange)?void 0:r.end)&&i.push({label:`${n("filters.to")}: ${te(e.dateRange.end)}`,type:"dateEnd"}),e.statusFilters&&Object.entries(e.statusFilters).forEach(([e,t])=>{if(null!==t){const s=`participant.${e}`;i.push({label:`${n(s)}: ${n(t?"filters.yes":"filters.no")}`,type:"status",value:e})}}),0===i.length?null:a.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[i.map((e,s)=>a.jsxs("button",{onClick:()=>t(e.type,e.value),className:"inline-flex items-center gap-2 px-3 py-1.5 bg-blue-100 text-blue-800 rounded-full text-sm hover:bg-blue-200 transition-colors duration-150",children:[a.jsx("span",{children:e.label}),a.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]},s)),a.jsx("button",{onClick:()=>t("all"),className:"px-3 py-1.5 bg-slate-200 text-slate-700 rounded-full text-sm hover:bg-slate-300 transition-colors duration-150",children:"Clear All"})]})},Ge="app_pin_config";function Ue(e){const t=new Uint8Array(e);let s="";const a=t.byteLength;for(let r=0;r<a;r+=8192)s+=String.fromCharCode.apply(null,t.subarray(r,r+8192));return window.btoa(s)}async function Ve(e,t){let s;s=t?function(e){try{const t=window.atob(e),s=t.length,a=new Uint8Array(s);for(let e=0;e<s;e++)a[e]=t.charCodeAt(e);return a}catch(t){throw new Error("Invalid Base64 string")}}(t):window.crypto.getRandomValues(new Uint8Array(16));const a=new TextEncoder,r=await window.crypto.subtle.importKey("raw",a.encode(e),{name:"PBKDF2"},!1,["deriveBits","deriveKey"]);return{hash:Ue(await window.crypto.subtle.deriveBits({name:"PBKDF2",salt:s,iterations:3e5,hash:"SHA-256"},r,256)),salt:Ue(s.buffer)}}async function He(e,t){try{const{hash:s}=await Ve(e,t.salt);return s===t.hash}catch(s){return!1}}function Xe(){const e=localStorage.getItem(Ge);if(!e)return null;try{return JSON.parse(e)}catch(t){return null}}function Ke(){localStorage.removeItem(Ge)}function Ye(){return!!localStorage.getItem(Ge)}const Je=({mode:e,onSuccess:t,onCancel:r,onResetData:n})=>{const{t:i}=Ce(),[l,o]=s.useState(""),[c,d]=s.useState(""),[u,m]=s.useState("enter"),[p,x]=s.useState(null),[h,b]=s.useState(!1),[g,f]=s.useState(!1);s.useEffect(()=>{o(""),d(""),m("enter"),x(null)},[e]);const v=e=>{if(h)return;x(null);const t="enter"===u?l:c;if(t.length<4){const s=t+e.toString();"enter"===u?o(s):d(s),4===s.length&&N(s)}},w=()=>{h||(x(null),"enter"===u?o(e=>e.slice(0,-1)):d(e=>e.slice(0,-1)))},N=async s=>{b(!0),await new Promise(e=>setTimeout(e,100));try{if("unlock"===e){const e=Xe();if(!e)return void t();await He(s,e)?t():(x(i("security.incorrectPin")),o(""))}else if("setup"===e){if("enter"===u)return m("confirm"),void b(!1);if(s===l){const{hash:e,salt:r}=await Ve(s);a={version:1,hash:e,salt:r,algo:"PBKDF2-SHA-256",createdAt:(new Date).toISOString()},localStorage.setItem(Ge,JSON.stringify(a)),t()}else x(i("security.pinMismatch")),o(""),d(""),m("enter")}else if("disable"===e){const e=Xe();e&&await He(s,e)?(Ke(),t()):(x(i("security.incorrectPin")),o(""))}}catch(r){x(i("security.error"))}finally{b(!1)}var a};return a.jsxs("div",{className:"fixed inset-0 bg-slate-50 z-[100] flex flex-col items-center justify-center p-4 animate-in fade-in duration-300",children:[a.jsxs("div",{className:"w-full max-w-sm text-center",children:[a.jsx("div",{className:"mb-6 flex justify-center",children:a.jsx("div",{className:"p-4 rounded-full "+(p?"bg-red-100":"bg-blue-100"),children:"unlock"===e?a.jsx(C,{className:"w-8 h-8 "+(p?"text-red-600":"text-blue-600")}):a.jsx(E,{className:"w-8 h-8 text-blue-600"})})}),a.jsx("h2",{className:"text-2xl font-bold mb-2 "+(p?"text-red-600":"text-slate-800"),children:i("setup"===e?"enter"===u?"security.setPinTitle":"security.confirmPinTitle":"disable"===e?"security.enterPinToDisable":"security.appLocked")}),a.jsx("p",{className:"text-sm mb-8 font-medium "+(p?"text-red-500":"text-slate-500"),children:p||i("setup"===e?"enter"===u?"security.enter4DigitPin":"security.reEnterToConfirm":"security.enterYourPin")}),(j="enter"===u?l:c,a.jsx("div",{className:"flex gap-4 justify-center mb-6",children:[0,1,2,3].map(e=>a.jsx("div",{className:`w-4 h-4 rounded-full border-2 transition-all duration-200 ${e<j.length?"bg-blue-600 border-blue-600":"bg-transparent border-slate-300"} ${p?"border-red-400 bg-red-50":""}`},e))})),a.jsxs("div",{className:"grid grid-cols-3 gap-4 max-w-[280px] mx-auto mt-8",children:[[1,2,3,4,5,6,7,8,9].map(e=>a.jsx("button",{onClick:()=>v(e),className:"w-16 h-16 rounded-full bg-slate-100 text-slate-700 text-2xl font-bold hover:bg-slate-200 active:bg-slate-300 transition-colors flex items-center justify-center shadow-sm",children:e},e)),a.jsx("div",{className:"w-16 h-16 flex items-center justify-center",children:"unlock"===e&&a.jsx("button",{onClick:()=>f(!0),className:"text-xs text-slate-400 font-medium hover:text-red-500 transition-colors",children:i("security.forgot")})}),a.jsx("button",{onClick:()=>v(0),className:"w-16 h-16 rounded-full bg-slate-100 text-slate-700 text-2xl font-bold hover:bg-slate-200 active:bg-slate-300 transition-colors flex items-center justify-center shadow-sm",children:"0"}),a.jsx("button",{onClick:w,className:"w-16 h-16 rounded-full text-slate-500 hover:text-slate-700 hover:bg-slate-100 active:bg-slate-200 transition-colors flex items-center justify-center",children:a.jsx(O,{className:"w-6 h-6"})})]}),r&&a.jsx("button",{onClick:r,className:"mt-8 text-slate-500 hover:text-slate-700 font-medium text-sm",children:i("common.cancel")})]}),g&&a.jsx(Ee,{isOpen:g,onClose:()=>f(!1),onConfirm:()=>{n&&(Ke(),n()),f(!1)},title:i("security.resetDataTitle"),message:i("security.resetDataMessage"),confirmText:i("security.resetDataConfirm"),variant:"danger"})]});var j},Ze=6e5,Qe=({children:e})=>{const[t,r]=s.useState(!1),[n,i]=s.useState(!1),l=s.useRef(Date.now()),o=s.useRef(null);s.useEffect(()=>{Ye()&&r(!0),i(!0)},[]);const c=s.useCallback(()=>{Ye()&&r(!0)},[]),d=s.useCallback(()=>{r(!1),l.current=Date.now()},[]);s.useEffect(()=>{if(t)return;const e=["mousedown","keydown","touchstart","scroll","mousemove"];let s=null;const a=()=>{s||(l.current=Date.now(),s=setTimeout(()=>{s=null},1e3))};e.forEach(e=>window.addEventListener(e,a));const n=()=>{if(!document.hidden&&Ye()){Date.now()-l.current>Ze&&r(!0)}};return document.addEventListener("visibilitychange",n),o.current=setInterval(()=>{if(document.hidden)return;Date.now()-l.current>Ze&&Ye()&&r(!0)},5e3),()=>{e.forEach(e=>window.removeEventListener(e,a)),document.removeEventListener("visibilitychange",n),o.current&&clearInterval(o.current),s&&clearTimeout(s)}},[t]),s.useEffect(()=>{const e=()=>c();return window.addEventListener("app-lock-manual",e),()=>window.removeEventListener("app-lock-manual",e)},[c]);const u=async()=>{try{await W.delete(),await W.open(),Ke(),window.location.reload()}catch(e){alert("Failed to reset data. Please clear browser storage manually.")}};return n?t?a.jsx(Je,{mode:"unlock",onSuccess:d,onResetData:u}):a.jsx(a.Fragment,{children:e}):null},et=()=>{window.dispatchEvent(new Event("app-lock-manual"))},tt=({activeTab:e,onTabChange:t,onBack:s})=>{const{t:r}=Ce();return a.jsx("header",{className:"bg-blue-700 text-white shadow-sm sticky top-0 z-40",children:a.jsx("div",{className:"container mx-auto px-4 py-4",children:a.jsxs("div",{className:"flex items-center gap-3",children:[s&&a.jsx("button",{onClick:s,className:"md:hidden p-2 hover:bg-blue-700 rounded-lg",children:a.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),a.jsx("div",{className:"flex-shrink-0 w-14 h-14 md:w-16 md:h-16 bg-white rounded-md flex items-center justify-center overflow-hidden",children:a.jsx("img",{src:"./Logo.svg",alt:"Logo",className:"w-full h-full object-cover scale-[2.4]"})}),a.jsxs("div",{className:"flex-1",children:[a.jsx("h1",{className:"text-2xl md:text-3xl font-bold",children:"CERTIFY"}),a.jsx("p",{className:"text-sm md:text-base text-blue-100",children:r("nav.subtitle")})]}),a.jsxs("div",{className:"hidden md:flex gap-2",children:[a.jsxs("button",{onClick:()=>t("participants"),className:"px-6 py-2 rounded-lg font-medium transition-colors duration-150 flex items-center gap-2 "+("participants"===e?"bg-white text-blue-800":"bg-blue-700/30 text-white hover:bg-blue-700/50"),children:[a.jsx(A,{className:"w-5 h-5",strokeWidth:2}),r("nav.participants")]}),a.jsxs("button",{onClick:()=>t("tools"),className:"px-6 py-2 rounded-lg font-medium transition-colors duration-150 flex items-center gap-2 "+("tools"===e?"bg-white text-blue-800":"bg-blue-700/30 text-white hover:bg-blue-700/50"),children:[a.jsx(q,{className:"w-5 h-5",strokeWidth:2}),r("nav.tools")]}),Ye()&&a.jsxs("button",{onClick:()=>et(),className:"px-4 py-2 ml-2 rounded-lg font-medium bg-indigo-600 text-white hover:bg-indigo-500 border border-indigo-400/50 shadow-sm transition-all duration-150 flex items-center gap-2",title:r("nav.lock"),children:[a.jsx(C,{className:"w-5 h-5",strokeWidth:2}),a.jsx("span",{className:"hidden lg:inline",children:r("nav.lock")})]})]})]})})})},st=({totalParticipants:e,visibleParticipants:t,totalCourses:r,visibleCourses:n,completedCount:i})=>{const{t:l}=Ce(),[o,c]=s.useState(!1);return a.jsxs("div",{className:"mb-4",children:[a.jsxs("div",{className:"md:hidden",children:[a.jsxs("button",{onClick:()=>c(!o),className:"w-full bg-white rounded-lg px-2 py-2 shadow-sm border border-slate-200 flex items-center justify-between mb-1",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs("div",{className:"text-left",children:[a.jsx("div",{className:"text-[11px] font-medium text-slate-500",children:l("participants.showing")}),a.jsxs("div",{className:"text-lg font-bold text-blue-600",children:[t,"/",e]})]}),a.jsxs("div",{className:"text-left",children:[a.jsx("div",{className:"text-[11px] font-medium text-slate-500",children:l("participant.completed")}),a.jsx("div",{className:"text-lg font-bold text-emerald-700",children:i})]})]}),a.jsx("svg",{className:"w-4 h-4 text-slate-500 transition-transform duration-200 "+(o?"rotate-180":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})]}),o&&a.jsxs("div",{className:"grid grid-cols-2 gap-2 mb-1",children:[a.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-slate-400",children:[a.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-xs uppercase tracking-wide text-slate-900 font-semibold whitespace-nowrap",children:l("participants.total")}),a.jsx("div",{className:"text-[9px] text-transparent font-medium mt-0.5 select-none",children:" "})]}),a.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:a.jsx(A,{className:"w-3.5 h-3.5 text-slate-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-2xl font-semibold tracking-tight text-slate-900",children:e})]}),a.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-blue-500",children:[a.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-xs uppercase tracking-wide text-blue-600 font-semibold whitespace-nowrap",children:l("participants.showing")}),a.jsx("div",{className:"text-[9px] text-slate-500 font-medium mt-0.5",children:l("participants.showingSubtext")})]}),a.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:a.jsx(P,{className:"w-3.5 h-3.5 text-blue-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-2xl font-semibold tracking-tight text-blue-600",children:t})]}),a.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-indigo-500",children:[a.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-xs uppercase tracking-wide text-indigo-600 font-semibold whitespace-nowrap",children:l("participants.totalCourses")}),a.jsx("div",{className:"text-[9px] text-slate-500 font-medium mt-0.5",children:l("participants.totalCoursesSubtext")})]}),a.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:a.jsx(L,{className:"w-3.5 h-3.5 text-indigo-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-2xl font-semibold tracking-tight text-indigo-600",children:r})]}),a.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-cyan-500",children:[a.jsxs("div",{className:"flex items-center justify-between mb-0.5",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-xs uppercase tracking-wide text-cyan-600 font-semibold whitespace-nowrap",children:l("participants.visibleCourses")}),a.jsx("div",{className:"text-[9px] text-slate-500 font-medium mt-0.5",children:l("participants.visibleCoursesSubtext")})]}),a.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:a.jsx(h,{className:"w-3.5 h-3.5 text-cyan-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-2xl font-semibold tracking-tight text-cyan-600",children:n})]}),a.jsxs("div",{className:"bg-white rounded-xl p-2 shadow-sm border border-slate-200 border-l-4 border-l-amber-500 col-span-2",children:[a.jsxs("div",{className:"flex items-center justify-between mb-1",children:[a.jsx("div",{className:"text-xs uppercase tracking-wide text-amber-600 font-semibold whitespace-nowrap",children:l("participants.completed")}),a.jsx("div",{className:"bg-slate-50 rounded-full p-1",children:a.jsx(M,{className:"w-3.5 h-3.5 text-amber-600",strokeWidth:2})})]}),a.jsxs("div",{className:"flex items-baseline gap-1",children:[a.jsx("div",{className:"text-xl font-semibold tracking-tight text-amber-600",children:i}),a.jsxs("div",{className:"text-xs text-slate-500",children:["/ ",t," (",t>0?Math.round(i/t*100):0,"%)"]})]})]})]})]}),a.jsxs("div",{className:"hidden md:grid grid-cols-5 gap-4 mb-2",children:[a.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-slate-400 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[a.jsxs("div",{className:"flex items-center justify-between mb-3",children:[a.jsx("div",{className:"text-sm uppercase tracking-wide text-slate-900 font-semibold whitespace-nowrap",children:l("participants.total")}),a.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:a.jsx(A,{className:"w-[18px] h-[18px] text-slate-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-3xl font-semibold tracking-tight text-slate-900 mt-auto",children:e})]}),a.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-blue-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[a.jsxs("div",{className:"flex items-center justify-between mb-2",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-base uppercase tracking-wide text-blue-600 font-semibold whitespace-nowrap",children:l("participants.showing")}),a.jsx("div",{className:"text-[10px] text-slate-500 font-medium mt-0.5",children:l("participants.showingSubtext")})]}),a.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:a.jsx(P,{className:"w-[18px] h-[18px] text-blue-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-4xl font-semibold tracking-tight text-blue-600 mt-auto",children:t})]}),a.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-indigo-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[a.jsxs("div",{className:"flex items-center justify-between mb-2",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-base uppercase tracking-wide text-indigo-600 font-semibold whitespace-nowrap",children:l("participants.totalCourses")}),a.jsx("div",{className:"text-[10px] text-slate-500 font-medium mt-0.5",children:l("participants.totalCoursesSubtext")})]}),a.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:a.jsx(L,{className:"w-[18px] h-[18px] text-indigo-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-3xl font-semibold tracking-tight text-indigo-600 mt-auto",children:r})]}),a.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-cyan-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[a.jsxs("div",{className:"flex items-center justify-between mb-2",children:[a.jsxs("div",{children:[a.jsx("div",{className:"text-base uppercase tracking-wide text-cyan-600 font-semibold whitespace-nowrap",children:l("participants.visibleCourses")}),a.jsx("div",{className:"text-[10px] text-slate-500 font-medium mt-0.5",children:l("participants.visibleCoursesSubtext")})]}),a.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:a.jsx(h,{className:"w-[18px] h-[18px] text-cyan-600",strokeWidth:2})})]}),a.jsx("div",{className:"text-4xl font-semibold tracking-tight text-cyan-600 mt-auto",children:n})]}),a.jsxs("div",{className:"bg-white rounded-xl p-5 shadow-sm border border-slate-200 border-l-4 border-l-amber-500 hover:shadow-md transition-shadow duration-200 min-h-[120px] flex flex-col",children:[a.jsxs("div",{className:"flex items-center justify-between mb-3",children:[a.jsx("div",{className:"text-sm uppercase tracking-wide text-amber-600 font-semibold whitespace-nowrap",children:l("participants.completed")}),a.jsx("div",{className:"bg-slate-50 rounded-full p-2.5",children:a.jsx(M,{className:"w-[18px] h-[18px] text-amber-600",strokeWidth:2})})]}),a.jsxs("div",{className:"flex items-baseline gap-2 mt-auto",children:[a.jsx("div",{className:"text-3xl font-semibold tracking-tight text-amber-600",children:i}),a.jsxs("div",{className:"text-sm text-slate-500",children:["/ ",t," (",t>0?Math.round(i/t*100):0,"%)"]})]})]})]})]})},at=({activeTab:e,onTabChange:t})=>{const{t:s}=Ce();return a.jsx("nav",{className:"md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-sm z-50",children:a.jsxs("div",{className:"flex",children:[a.jsxs("button",{onClick:()=>t("participants"),className:"flex-1 flex flex-col items-center justify-center py-3 transition-colors duration-150 "+("participants"===e?"text-blue-700":"text-slate-400"),children:[a.jsx(A,{className:"w-6 h-6 mb-1",strokeWidth:2}),a.jsx("span",{className:"text-xs "+("participants"===e?"font-semibold":"font-medium"),children:s("nav.participants")})]}),a.jsxs("button",{onClick:()=>t("tools"),className:"flex-1 flex flex-col items-center justify-center py-3 transition-colors duration-150 "+("tools"===e?"text-blue-700":"text-slate-400"),children:[a.jsx(q,{className:"w-6 h-6 mb-1",strokeWidth:2}),a.jsx("span",{className:"text-xs "+("tools"===e?"font-semibold":"font-medium"),children:s("nav.tools")})]})]})})},rt=({onClick:e})=>{const{t:t}=Ce();return a.jsx("button",{onClick:e,className:"md:hidden fixed bottom-24 right-6 w-14 h-14 bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white rounded-full shadow-lg flex items-center justify-center z-40 active:scale-95 transition-all duration-150",style:{minWidth:"56px",minHeight:"56px"},"aria-label":t("participants.add"),children:a.jsx("svg",{className:"w-7 h-7",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:a.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2.5,d:"M12 4v16m8-8H4"})})})};let nt;const it=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,lt=/[<>'"`;\\]/;function ot(e){return e.trim().toLowerCase()}function ct(e){return[/(\bOR\b|\bAND\b)\s*['"]?\d+['"]?\s*=\s*['"]?\d+/i,/UNION\s+SELECT/i,/DROP\s+TABLE/i,/INSERT\s+INTO/i,/DELETE\s+FROM/i,/UPDATE\s+\w+\s+SET/i,/--\s*$/m,/\/\*.*\*\//s,/;\s*DROP/i,/'\s*OR\s*'/i,/admin'\s*--/i].some(t=>t.test(e))}function dt(e,t){const s=function(e){if(!e||0===e.trim().length)return{isValid:!1,error:"Email is required"};const t=ot(e);return t.length>254?{isValid:!1,error:"Email is too long"}:it.test(t)?lt.test(t)?{isValid:!1,error:"Email contains invalid characters"}:{isValid:!0}:{isValid:!1,error:"Invalid email format"}}(e),a=function(e,t="Password"){return e&&0!==e.length?e.length<8?{isValid:!1,error:`${t} must be at least 8 characters`}:e.length>128?{isValid:!1,error:`${t} is too long`}:{isValid:!0}:{isValid:!1,error:`${t} is required`}}(t);return ct(e)||ct(t)?{isValid:!1,emailError:"Invalid characters detected",passwordError:"Invalid characters detected"}:{isValid:s.isValid&&a.isValid,emailError:s.error,passwordError:a.error}}const ut="spi.entitlement.cache.v1",mt={configured:!1,authenticated:!1,status:"unknown",readOnly:!1,planCode:null,daysUntilReadOnly:null,currentPeriodEnd:null,graceUntil:null,error:null,lastCheckedAt:null},pt=s.createContext(void 0);function xt(e){localStorage.setItem(ut,JSON.stringify(e))}const ht=({children:e})=>{const t=s.useMemo(()=>(void 0!==nt||(nt=T("https://xxkqorvdmksyeyoftlgu.supabase.co","sb_publishable_F6tEV-grkbpwT4Ndhg5r8A__mNzR53l",{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}})),nt),[]),[r,n]=s.useState(()=>function(){try{const e=localStorage.getItem(ut);if(!e)return mt;const t=JSON.parse(e);return{...mt,...t,error:null}}catch{return mt}}()),[i,l]=s.useState(!1),[o,c]=s.useState(!1),[d,u]=s.useState(null);s.useEffect(()=>{const e=window.location.hash;if(!e||e.length<2)return;const t=new URLSearchParams(e.slice(1)),s=t.get("error_description");s&&u(s.replace(/\+/g," "));const a=t.get("type"),r=Boolean(t.get("access_token")||t.get("code"));"recovery"===a&&r&&(c(!0),u(null))},[]),s.useEffect(()=>{_(r.readOnly)},[r.readOnly]);const m=s.useCallback(async(e=!1)=>{if(!t){const e={...mt,configured:!1,readOnly:!1,lastCheckedAt:(new Date).toISOString()};return n(e),xt(e),void _(!1)}e||l(!0);try{const{data:e,error:s}=await t.auth.getSession();if(s)throw s;if(!e.session){const e={...mt,configured:!0,authenticated:!1,readOnly:!1,lastCheckedAt:(new Date).toISOString()};return n(e),xt(e),void _(!1)}const{data:a,error:r}=await t.rpc("entitlement_me",{p_tenant_id:null});if(r)throw r;const i=Array.isArray(a)?a[0]:a;if(!i)throw new Error("Entitlement data is missing.");const l={configured:!0,authenticated:!0,status:i.status||"unknown",readOnly:Boolean(i.read_only),planCode:i.plan_code||null,daysUntilReadOnly:"number"==typeof i.days_until_read_only?i.days_until_read_only:null,currentPeriodEnd:i.current_period_end||null,graceUntil:i.grace_until||null,error:null,lastCheckedAt:(new Date).toISOString()};n(l),xt(l),_(l.readOnly)}catch(s){const a=function(e){if(!e)return"Entitlement check failed.";if(e instanceof Error)return e.message;if("object"==typeof e&&null!==e){const t=e.message;if("string"==typeof t&&t.trim().length>0)return t}return"Entitlement check failed."}(s),r=a.toLowerCase();if(r.includes("jwt")||r.includes("refresh token")||r.includes("session")||r.includes("invalid token")){await t.auth.signOut();const e={...mt,configured:!0,authenticated:!1,readOnly:!1,error:null,lastCheckedAt:(new Date).toISOString()};return n(e),xt(e),void _(!1)}e||n(e=>({...e,configured:!0,error:a,lastCheckedAt:(new Date).toISOString()}))}finally{e||l(!1)}},[t]),p=s.useCallback(async(e,s)=>{if(!t)throw new Error("Supabase is not configured.");const a=dt(e,s);if(!a.isValid){const e=a.emailError||a.passwordError||"Invalid credentials";throw new Error(e)}const{error:r}=await t.auth.signInWithPassword({email:ot(e),password:s});if(r)throw r;await m()},[m,t]),x=s.useCallback(async()=>{if(!t)return;const{error:e}=await t.auth.signOut();if(e)throw e;await m()},[m,t]),h=s.useCallback(async e=>{if(!t)throw new Error("Supabase is not configured.");const s=dt(e,"dummy-password-for-email-only");if(s.emailError)throw new Error(s.emailError);const a=window.location.pathname.endsWith("/")?window.location.pathname:`${window.location.pathname}/`,{error:r}=await t.auth.resetPasswordForEmail(ot(e),{redirectTo:`${window.location.origin}${a}`});if(r)throw r},[t]),b=s.useCallback(async e=>{if(!t)throw new Error("Supabase is not configured.");const s=dt("dummy@email.com",e);if(s.passwordError)throw new Error(s.passwordError);const{error:a}=await t.auth.updateUser({password:e});if(a)throw a;c(!1),window.history.replaceState({},document.title,window.location.pathname+window.location.search),await m()},[m,t]),g=s.useCallback(()=>{u(null),window.location.hash&&window.history.replaceState({},document.title,window.location.pathname+window.location.search)},[]);return s.useEffect(()=>{let e=!0,s=0;const a=async(t=!1)=>{e&&(await m(t),s=Date.now())};a(!1);const r=window.setInterval(()=>{a(!0)},12e4),n=()=>{Date.now()-s>1e4&&a(!0)};window.addEventListener("focus",n);const{data:{subscription:i}}=t?t.auth.onAuthStateChange(e=>{"PASSWORD_RECOVERY"===e&&(c(!0),u(null)),"SIGNED_OUT"===e&&c(!1),a(!1)}):{data:{subscription:{unsubscribe:()=>{}}}};return()=>{e=!1,window.clearInterval(r),window.removeEventListener("focus",n),i.unsubscribe()}},[m,t]),a.jsx(pt.Provider,{value:{entitlement:r,loading:i,recoveryMode:o,authLinkError:d,refresh:m,signInWithPassword:p,signOut:x,requestPasswordReset:h,updatePassword:b,clearAuthLinkError:g},children:e})},bt=s.lazy(()=>$(()=>import("./ToolsPage-DeKVOeQe.js"),__vite__mapDeps([9,3,1,4,2,7,5,6,8])).then(e=>({default:e.ToolsPage})));function gt(e,t){const s=e.toLowerCase();return s.includes("invalid login credentials")?t("auth.invalidCredentials"):s.includes("email not confirmed")?t("auth.emailNotConfirmed"):s.includes("too many requests")?t("auth.rateLimited"):t("auth.failed")}function ft(){const{t:e,language:t,setLanguage:r}=Ce(),{entitlement:n,loading:i,signInWithPassword:l,signOut:o,requestPasswordReset:c,updatePassword:d,recoveryMode:u,authLinkError:m,clearAuthLinkError:p}=(()=>{const e=s.useContext(pt);if(!e)throw new Error("useEntitlement must be used within EntitlementProvider");return e})(),{participants:x,deleteParticipant:h}=we(),{groups:b}=Ne(),{collapsedSections:g,toggleSection:f,expandSection:v,resetToDefaults:w,setCollapsedState:N}=function(){const[e,t]=s.useState(()=>{const e=localStorage.getItem(je),t=localStorage.getItem(ye),s=localStorage.getItem(Se);return"true"===t||"true"===e?(localStorage.setItem(je,"false"),localStorage.setItem(ye,"false"),localStorage.setItem(Se,"true"),{active:!1,planned:!1,completed:!0}):{active:"true"===e,planned:"true"===t,completed:null===s||"true"===s}});return s.useEffect(()=>{localStorage.setItem(je,String(e.active)),localStorage.setItem(ye,String(e.planned)),localStorage.setItem(Se,String(e.completed))},[e]),{collapsedSections:e,toggleSection:e=>{t(t=>({...t,[e]:!t[e]}))},expandSection:e=>{t(t=>({...t,[e]:!1}))},expandAll:()=>{t({active:!1,planned:!1,completed:!1})},resetToDefaults:()=>{t({active:!1,planned:!1,completed:!0}),localStorage.setItem(je,"false"),localStorage.setItem(ye,"false"),localStorage.setItem(Se,"true")},setCollapsedState:e=>{t(e)}}}(),j=n.readOnly,[y,S]=s.useState("participants"),[k,D]=s.useState(!1),[C,E]=s.useState(),[O,A]=s.useState(!1),[q,P]=s.useState(!1),[L]=s.useState(0),[M,T]=s.useState(""),[I,$]=s.useState(""),[R,B]=s.useState(!1),[z,_]=s.useState(null),[F,G]=s.useState(!1),[U,V]=s.useState(null),[H,X]=s.useState(""),[K,Y]=s.useState(""),[J,Z]=s.useState(!1),[Q,ee]=s.useState(null);s.useEffect(()=>{setTimeout(async()=>{try{await async function(){const e=await W.groups.where("status").equals("active").toArray();if(e.length<=1)return;const t=e.sort((e,t)=>new Date(t.updatedAt).getTime()-new Date(e.updatedAt).getTime()),s=(t[0],t.slice(1)),a=(new Date).toISOString();for(const r of s)await W.groups.update(r.id,{status:"planned",updatedAt:a,activatedAt:void 0})}(),await ce()}catch(e){}},100)},[]);const[te,se]=s.useState(""),[ae,re]=s.useState(""),[ne,ie]=s.useState({sent:null,documents:null,handedOver:null,paid:null,completed:null}),[le,oe]=s.useState({start:"",end:""}),[de,ue]=s.useState(null),me=s.useMemo(()=>""!==te||""!==ae||null!==ne.sent||null!==ne.documents||null!==ne.handedOver||null!==ne.paid||null!==ne.completed||""!==le.start||""!==le.end,[te,ae,ne,le]);s.useEffect(()=>{me?(de||ue({...g}),g.active&&v("active"),g.planned&&v("planned"),g.completed&&v("completed")):de&&(N(de),ue(null))},[me]);const pe=s.useMemo(()=>new Map((b??[]).map(e=>[e.courseStartDate,e])),[b]),xe=s.useMemo(()=>(b??[]).filter(e=>null!==e.groupNumber&&void 0!==e.groupNumber).map(e=>({...e,groupNumber:e.groupNumber})),[b]),he=s.useMemo(()=>{if(!x)return[];const e=(new Date).getFullYear();return x.filter(t=>{const s=pe.get(t.courseStartDate);if((null!==t.completedOverride?t.completedOverride:t.completedComputed)&&"completed"===(null==s?void 0:s.status)){if(new Date(t.courseStartDate).getFullYear()!==e)return!1}if(te){const e=te.toLowerCase();if(!(t.companyName.toLowerCase().includes(e)||t.personName.toLowerCase().includes(e)||t.uniqueNumber.toLowerCase().includes(e)))return!1}if(ae){const e=parseInt(ae,10);if(s&&s.groupNumber!==e)return!1;if(!s)return!1}if(le.start&&t.courseStartDate<le.start)return!1;if(le.end&&t.courseStartDate>=le.end)return!1;if(null!==ne.sent&&t.sent!==ne.sent)return!1;if(null!==ne.documents&&t.documents!==ne.documents)return!1;if(null!==ne.handedOver&&t.handedOver!==ne.handedOver)return!1;if(null!==ne.paid&&t.paid!==ne.paid)return!1;if(null!==ne.completed){if((null!==t.completedOverride?t.completedOverride:t.completedComputed)!==ne.completed)return!1}return!0})},[x,pe,te,ae,ne,le]),be=(null==x?void 0:x.length)||0,ge=he.length,fe=(null==b?void 0:b.length)||0,ve=s.useMemo(()=>{if(!b||0===b.length)return 0;const e=new Set,t=new Map(b.map(e=>[e.courseStartDate,e]));if(he.forEach(s=>{const a=t.get(s.courseStartDate);a&&e.add(a.courseStartDate)}),!me){b.forEach(t=>{"active"===t.status&&e.add(t.courseStartDate)});b.filter(e=>"planned"===e.status).map(e=>e.courseStartDate).sort((e,t)=>e.localeCompare(t)).slice(0,2).forEach(t=>e.add(t))}return e.size},[b,he,me]),ke=s.useMemo(()=>he.filter(e=>null!==e.completedOverride?e.completedOverride:e.completedComputed).length,[he]),De=()=>{j?alert(e("entitlement.readOnlyAction")):(E(void 0),D(!0))},Ee=t=>{j?alert(e("entitlement.readOnlyAction")):(E(t),D(!0))},Oe=async t=>{j?alert(e("entitlement.readOnlyAction")):await h(t)},Ae=async t=>{if(t.preventDefault(),_(null),M.trim()&&I.trim()){V(null),B(!0);try{await l(M.trim(),I),$("")}catch(s){s instanceof Error?_(gt(s.message,e)):_(e("auth.failed"))}finally{B(!1)}}else _(e("auth.required"))},qe=async t=>{if(t.preventDefault(),_(null),V(null),M.trim()){B(!0);try{await c(M.trim()),V(e("auth.resetSent"))}catch(s){s instanceof Error?_(gt(s.message,e)):_(e("auth.failed"))}finally{B(!1)}}else _(e("auth.emailRequired"))},Pe=async t=>{if(t.preventDefault(),ee(null),H&&K)if(H.length<6)ee(e("auth.resetPasswordTooShort"));else if(H===K){Z(!0);try{await d(H),X(""),Y("")}catch(s){s instanceof Error?ee(gt(s.message,e)):ee(e("auth.failed"))}finally{Z(!1)}}else ee(e("auth.resetPasswordsMismatch"));else ee(e("auth.resetPasswordRequired"))};return u?a.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center px-4",children:a.jsxs("div",{className:"w-full max-w-md bg-white rounded-xl shadow p-6 space-y-4 relative",children:[a.jsxs("div",{className:"absolute top-4 right-4 flex gap-1",children:[a.jsx("button",{type:"button",onClick:()=>r("bg"),className:"px-2.5 py-1 text-xs font-medium rounded "+("bg"===t?"bg-blue-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"),children:"BG"}),a.jsx("button",{type:"button",onClick:()=>r("en"),className:"px-2.5 py-1 text-xs font-medium rounded "+("en"===t?"bg-blue-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"),children:"EN"})]}),a.jsx("h1",{className:"text-2xl font-bold text-slate-900",children:e("auth.resetTitle")}),a.jsx("p",{className:"text-sm text-slate-600",children:e("auth.resetSubtitle")}),a.jsxs("form",{onSubmit:Pe,className:"space-y-3",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:e("auth.newPassword")}),a.jsx("input",{type:"password",value:H,onChange:e=>X(e.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:e("auth.passwordPlaceholder"),autoComplete:"new-password"})]}),a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:e("auth.confirmPassword")}),a.jsx("input",{type:"password",value:K,onChange:e=>Y(e.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:e("auth.passwordPlaceholder"),autoComplete:"new-password"})]}),Q&&a.jsx("p",{className:"text-sm text-red-600",children:Q}),a.jsx("button",{type:"submit",disabled:J,className:"w-full py-2.5 rounded-lg font-medium "+(J?"bg-slate-300 text-slate-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"),children:e(J?"common.loading":"auth.updatePassword")})]})]})}):n.configured&&!n.authenticated?a.jsx("div",{className:"min-h-screen bg-slate-50 flex items-center justify-center px-4",children:a.jsxs("div",{className:"w-full max-w-md bg-white rounded-xl shadow p-6 space-y-4 relative",children:[a.jsxs("div",{className:"absolute top-4 right-4 flex gap-1",children:[a.jsx("button",{type:"button",onClick:()=>r("bg"),className:"px-2.5 py-1 text-xs font-medium rounded "+("bg"===t?"bg-blue-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"),children:"BG"}),a.jsx("button",{type:"button",onClick:()=>r("en"),className:"px-2.5 py-1 text-xs font-medium rounded "+("en"===t?"bg-blue-600 text-white":"bg-slate-100 text-slate-600 hover:bg-slate-200"),children:"EN"})]}),a.jsx("h1",{className:"text-2xl font-bold text-slate-900",children:e("auth.title")}),a.jsx("p",{className:"text-sm text-slate-600",children:e("auth.subtitle")}),a.jsxs("form",{onSubmit:F?qe:Ae,className:"space-y-3",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:e("auth.email")}),a.jsx("input",{type:"email",value:M,onChange:e=>T(e.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:e("auth.emailPlaceholder"),autoComplete:"email"})]}),!F&&a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm font-medium text-slate-700 mb-1",children:e("auth.password")}),a.jsx("input",{type:"password",value:I,onChange:e=>$(e.target.value),className:"w-full border border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:e("auth.passwordPlaceholder"),autoComplete:"current-password"})]}),z&&a.jsx("p",{className:"text-sm text-red-600",children:z}),U&&a.jsx("p",{className:"text-sm text-emerald-700",children:U}),m&&a.jsx("p",{className:"text-sm text-red-600",children:m}),n.error&&a.jsx("p",{className:"text-sm text-red-600",children:n.error}),a.jsx("button",{type:"submit",disabled:R||i,className:"w-full py-2.5 rounded-lg font-medium "+(R||i?"bg-slate-300 text-slate-600 cursor-not-allowed":"bg-blue-600 text-white hover:bg-blue-700"),children:e(R?"common.loading":F?"auth.sendReset":"auth.signIn")}),a.jsx("button",{type:"button",onClick:()=>{G(e=>!e),_(null),V(null),p()},className:"w-full py-2 text-sm text-blue-700 hover:text-blue-800",children:e(F?"auth.backToLogin":"auth.forgotPassword")})]})]})}):a.jsx("div",{className:"min-h-screen bg-slate-50",children:a.jsxs(Qe,{children:[a.jsx(tt,{activeTab:y,onTabChange:S}),n.configured&&n.authenticated&&("grace"===n.status||j)&&a.jsx("div",{className:"border-b "+(j?"bg-red-50 border-red-200":"bg-amber-50 border-amber-200"),children:a.jsx("div",{className:"container mx-auto px-4 py-2 text-sm",children:a.jsxs("div",{children:[a.jsx("p",{className:"font-medium "+(j?"text-red-700":"text-amber-800"),children:e(j?"entitlement.readOnlyBannerTitle":"entitlement.graceBannerTitle")}),!j&&null!==n.daysUntilReadOnly&&a.jsx("p",{className:"text-amber-700",children:e("entitlement.graceBannerMessage",{days:String(n.daysUntilReadOnly)})}),j&&a.jsx("p",{className:"text-red-700",children:e("entitlement.readOnlyBannerMessage")}),i&&a.jsx("p",{className:"text-slate-500",children:e("common.loading")})]})})}),"participants"===y?a.jsxs("main",{className:"container mx-auto px-4 py-6 pb-24 md:pb-6",children:[a.jsx(st,{totalParticipants:be,visibleParticipants:ge,totalCourses:fe,visibleCourses:ve,completedCount:ke}),a.jsx(We,{activeFilters:{searchText:te,selectedGroup:ae,dateRange:le,statusFilters:ne},onRemoveFilter:(e,t)=>{switch(e){case"search":se("");break;case"group":re("");break;case"dateStart":oe(e=>({...e,start:""}));break;case"dateEnd":oe(e=>({...e,end:""}));break;case"status":t&&ie(e=>({...e,[t]:null}));break;case"all":se(""),re(""),ie({sent:null,documents:null,handedOver:null,paid:null,completed:null}),oe({start:"",end:""})}},groups:xe}),a.jsxs("div",{className:"hidden md:flex flex-wrap gap-3 mb-6",children:[a.jsxs("button",{onClick:De,disabled:j,className:"px-6 py-3 rounded-lg shadow font-medium "+(j?"bg-slate-300 text-slate-600 cursor-not-allowed":"bg-green-600 text-white hover:bg-green-700"),children:["+ ",e("participants.add")]}),a.jsx("button",{onClick:()=>A(!0),className:"px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow font-medium",children:e("filters.title")})]}),a.jsx("div",{className:"md:hidden mb-4",children:a.jsxs("button",{onClick:()=>A(!0),className:"w-full px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow font-medium min-h-[48px]",children:["🔍 ",e("filters.title")]})}),a.jsxs("div",{className:"md:bg-white md:rounded-lg md:shadow",children:[a.jsxs("div",{className:"hidden md:block",children:[a.jsx("div",{className:"p-4 border-b",children:a.jsxs("h2",{className:"text-xl font-semibold text-slate-900",children:[e("participants.title")," ",ge<be&&`(${ge} ${e("participants.of")} ${be})`]})}),a.jsx("div",{className:"p-4",children:a.jsx(Ie,{participants:he,onEdit:Ee,onDelete:Oe,collapsedSections:g,toggleSection:f,expandSection:v,hasActiveFilters:me,onFilterChange:e=>{se(e.searchTerm),re(e.courseStartDate||""),ie({sent:null,documents:null,handedOver:null,paid:null,completed:null}),oe({start:"",end:""})},groupRefreshKey:L})})]}),a.jsx("div",{className:"md:hidden",children:a.jsx(ze,{participants:he,onEdit:Ee,onDelete:Oe,onSelectionChange:P,collapsedSections:g,toggleSection:f,expandSection:v,hasActiveFilters:me})})]})]}):a.jsx("main",{className:"container mx-auto px-4 py-6",children:a.jsx(s.Suspense,{fallback:a.jsx("div",{className:"text-sm text-slate-500",children:e("common.loading")}),children:a.jsx(bt,{filteredParticipants:he,entitlement:n,entitlementLoading:i,onSignOut:async()=>{try{await o()}catch(t){alert(t instanceof Error?t.message:e("auth.signOutFailed"))}}})})}),a.jsx(Fe,{isOpen:O,onClose:()=>A(!1),searchText:te,onSearchTextChange:se,selectedGroup:ae,onSelectedGroupChange:re,statusFilters:ne,onStatusFilterChange:(e,t)=>{ie(s=>({...s,[e]:t}))},dateRange:le,onDateRangeChange:oe,groups:xe,onResetToDefaults:w,visibleCount:ge,totalCount:be}),a.jsx(_e,{isOpen:k,onClose:()=>{D(!1),E(void 0)},participant:C}),"participants"===y&&!q&&!j&&a.jsx(rt,{onClick:De}),a.jsx(at,{activeTab:y,onTabChange:S})]})})}function vt(){return a.jsx(ht,{children:a.jsx(De,{children:a.jsx(ft,{})})})}class wt extends s.Component{constructor(){super(...arguments),t(this,"state",{hasError:!1,error:null})}static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){}render(){var e;return this.state.hasError?a.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 p-4",children:a.jsxs("div",{className:"max-w-md w-full bg-white shadow-lg rounded-lg p-6",children:[a.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-4",children:"Something went wrong"}),a.jsx("p",{className:"text-gray-600 mb-4",children:"The application encountered an unexpected error. This might be due to a data consistency issue."}),a.jsx("div",{className:"bg-gray-100 p-3 rounded mb-4 overflow-auto max-h-32 text-xs font-mono text-red-800",children:null==(e=this.state.error)?void 0:e.message}),a.jsxs("div",{className:"flex gap-3",children:[a.jsx("button",{onClick:()=>window.location.reload(),className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition",children:"Reload Application"}),a.jsx("button",{onClick:()=>{window.confirm("Delete all local data and reset? This cannot be undone.")&&(indexedDB.deleteDatabase("CourseManagementDB"),localStorage.clear(),window.location.reload())},className:"flex-1 px-4 py-2 bg-red-100 text-red-700 border border-red-200 rounded hover:bg-red-200 transition",children:"Reset Data"})]})]})}):this.props.children}}const Nt="2.1.1",jt="spi.app.version";if(localStorage.getItem(jt)!==Nt){const e={};["spi.db.initialized","spi.language"].forEach(t=>{const s=localStorage.getItem(t);null!==s&&(e[t]=s)}),localStorage.clear(),Object.entries(e).forEach(([e,t])=>{localStorage.setItem(e,t)}),localStorage.setItem(jt,Nt)}n.createRoot(document.getElementById("root")).render(a.jsx(r.StrictMode,{children:a.jsx(wt,{children:a.jsx(vt,{})})}));export{Te as A,Ee as C,Je as L,$ as _,te as a,pe as b,oe as c,W as d,le as e,B as f,ae as g,he as h,Ye as i,J as j,ne as k,ue as l,me as m,K as r,xe as s,et as t,Ce as u};
